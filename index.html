<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invictus Game Studio</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600&display=swap');

:root {
  --bg-base:#0d0d0d; --bg-panel:#141414; --bg-sidebar:#111;
  --bg-card:#1a1a1a; --bg-input:#0f0f0f; --border:#2a2a2a;
  --gold:#c9a227; --gold-light:#f0c844; --gold-dim:#8a6e1a;
  --text-primary:#e8e0cc; --text-secondary:#7a7060; --text-muted:#3a3530;
  --blue:#4a9eff; --green:#4ecb71; --red:#e05252; --orange:#e07820; --purple:#9b6bde;
  --sidebar-w:210px; --topbar-h:48px;
  --fu:'Rajdhani',sans-serif; --fm:'Share Tech Mono',monospace; --fb:'Barlow',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html{height:100%;overflow:hidden}
body{height:100%;overflow:hidden;background:var(--bg-base);color:var(--text-primary);font-family:var(--fb);font-size:13px;display:flex;flex-direction:column}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar{height:var(--topbar-h);background:#080808;border-bottom:1px solid var(--gold);display:flex;align-items:center;padding:0 14px;gap:10px;flex-shrink:0;position:relative;z-index:50}
.tb-logo{display:flex;align-items:center;gap:8px;font-family:var(--fu);font-weight:700;font-size:15px;color:var(--gold);letter-spacing:2px;text-transform:uppercase;white-space:nowrap}
.tb-logo svg{width:30px;height:30px}
.tb-div{width:1px;height:28px;background:var(--border);flex-shrink:0}
.tb-select{background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:4px 10px;color:var(--text-primary);font-family:var(--fu);font-size:12px;cursor:pointer;min-width:140px}
.tb-select:focus{outline:none;border-color:var(--gold-dim)}
#tb-search{background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:4px 10px;color:var(--text-primary);font-size:12px;font-family:var(--fb);flex:1;max-width:240px}
#tb-search:focus{outline:none;border-color:var(--gold-dim)}
.tb-spacer{flex:1}
.lang-btn{background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:4px 10px;color:var(--text-secondary);font-family:var(--fu);font-size:12px;cursor:pointer;transition:all .15s;letter-spacing:1px}
.lang-btn.active,.lang-btn:hover{border-color:var(--gold);color:var(--gold)}
#save-ind{font-family:var(--fm);font-size:11px;color:var(--text-secondary);white-space:nowrap;min-width:130px}
#save-ind.saving{color:var(--orange)}
#save-ind.saved{color:var(--green)}
.btn-save{background:var(--gold);color:#000;border:none;border-radius:4px;padding:5px 16px;font-family:var(--fu);font-weight:700;font-size:12px;letter-spacing:1px;cursor:pointer;transition:background .15s;text-transform:uppercase}
.btn-save:hover{background:var(--gold-light)}

/* â”€â”€ ARGENTINA CLOCK â”€â”€ */
#ar-clock-wrap{padding:0}
#ar-clock{font-family:var(--fm);font-size:16px;font-weight:700;letter-spacing:2px;position:relative;overflow:hidden}
#ar-clock-digits{display:flex;gap:0;align-items:center}
.digit{display:inline-flex;flex-direction:column;overflow:hidden;height:22px;width:13px}
.digit-inner{display:flex;flex-direction:column;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.digit-char{height:22px;display:flex;align-items:center;justify-content:center;font-size:16px;font-family:var(--fm);font-weight:700;color:var(--green);text-shadow:0 0 10px rgba(78,203,113,.7)}
.colon-sep{font-family:var(--fm);font-size:16px;color:var(--green);opacity:.8;animation:blink 1s step-end infinite;margin:0 1px;line-height:22px;text-shadow:0 0 6px rgba(78,203,113,.5);flex-shrink:0}
@keyframes blink{50%{opacity:0.2}}
#ar-flag{font-size:14px}
#ar-label{font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase}

/* â”€â”€ LIFECYCLE â”€â”€ */
#lifecycle{background:linear-gradient(90deg,#0a0a0a,#120f06);border-bottom:1px solid var(--border);padding:6px 18px;display:flex;align-items:center;gap:0;flex-shrink:0;overflow-x:auto}
#lc-title{font-family:var(--fu);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--gold);text-transform:uppercase;margin-right:14px;white-space:nowrap;opacity:.7}
.lc-step{display:flex;align-items:center;gap:0;cursor:pointer;white-space:nowrap}
.lc-label{font-family:var(--fu);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary);padding:4px 12px;border:1px solid var(--border);border-radius:3px;transition:all .15s}
.lc-step:hover .lc-label,.lc-step.active .lc-label{color:var(--gold);border-color:var(--gold);background:rgba(201,162,39,.08)}
.lc-arrow{color:var(--gold-dim);font-size:12px;margin:0 3px}

/* â”€â”€ MAIN â”€â”€ */
#main{display:flex;flex:1;overflow:hidden;min-height:0}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{width:var(--sidebar-w);background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.sb-sec{font-family:var(--fu);font-size:9px;letter-spacing:2px;color:var(--text-muted);padding:14px 14px 4px;text-transform:uppercase}
.sb-item{display:flex;align-items:center;gap:9px;padding:8px 14px;cursor:pointer;font-family:var(--fu);font-size:13px;font-weight:500;color:var(--text-secondary);border-left:2px solid transparent;transition:all .12s;text-transform:uppercase;letter-spacing:.5px;user-select:none}
.sb-item:hover{color:var(--text-primary);background:rgba(201,162,39,.04)}
.sb-item.active{color:var(--gold);border-left-color:var(--gold);background:rgba(201,162,39,.08)}
.sb-item svg{width:14px;height:14px;flex-shrink:0}
.sb-bottom{margin-top:auto;padding:14px;border-top:1px solid var(--border)}
.sb-offline{display:flex;align-items:center;gap:5px;font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--green);text-transform:uppercase;margin-bottom:6px}
.sb-offline-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(78,203,113,.4)}50%{box-shadow:0 0 0 4px rgba(78,203,113,0)}}

/* â”€â”€ CONTENT â”€â”€ */
#content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.module{display:none;flex:1;overflow:hidden;flex-direction:column}
.module.active{display:flex}
.mod-hdr{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;background:#0d0d0d}
.mod-title{font-family:var(--fu);font-size:18px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase}
.mod-sub{font-size:11px;color:var(--text-secondary);margin-left:4px}
.mod-body{flex:1;overflow-y:auto;padding:16px 20px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);border-radius:4px;padding:5px 12px;font-family:var(--fu);font-size:12px;font-weight:500;cursor:pointer;transition:all .12s;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
.btn:hover{border-color:var(--gold-dim);color:var(--gold)}
.btn-gold{background:transparent;border-color:var(--gold);color:var(--gold)}
.btn-gold:hover{background:var(--gold);color:#000}
.btn-sm{padding:3px 8px;font-size:11px}
.btn-xs{padding:2px 6px;font-size:10px}
.btn-danger{border-color:var(--red);color:var(--red)}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-green{border-color:var(--green);color:var(--green)}
.btn-green:hover{background:var(--green);color:#000}

/* â”€â”€ PANEL â”€â”€ */
.panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:14px}
.panel-title{font-family:var(--fu);font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--gold);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:6px}

/* â”€â”€ GRIDS â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;font-family:var(--fu);font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.b-backlog{background:rgba(85,85,85,.2);color:#999;border:1px solid #555}
.b-todo{background:rgba(74,158,255,.15);color:var(--blue);border:1px solid rgba(74,158,255,.4)}
.b-progress{background:rgba(224,120,32,.15);color:var(--orange);border:1px solid rgba(224,120,32,.4)}
.b-review{background:rgba(155,107,222,.15);color:var(--purple);border:1px solid rgba(155,107,222,.4)}
.b-blocked{background:rgba(224,82,82,.15);color:var(--red);border:1px solid rgba(224,82,82,.4)}
.b-done{background:rgba(78,203,113,.15);color:var(--green);border:1px solid rgba(78,203,113,.4)}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:10px}
.fl{display:block;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px}
.fi,.fs,.fta{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--text-primary);font-family:var(--fb);font-size:12px;transition:border-color .15s}
.fi:focus,.fs:focus,.fta:focus{outline:none;border-color:var(--gold-dim)}
.fta{resize:vertical;min-height:80px;line-height:1.6}
.fs option{background:var(--bg-panel)}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg-base)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--gold-dim)}

/* â”€â”€ DASHBOARD â”€â”€ */
.stat-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:14px;position:relative;overflow:hidden;transition:border-color .2s}
.stat-card:hover{border-color:var(--gold-dim)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.sc-gold::before{background:var(--gold)}
.stat-card.sc-green::before{background:var(--green)}
.stat-card.sc-orange::before{background:var(--orange)}
.stat-card.sc-red::before{background:var(--red)}
.stat-val{font-family:var(--fm);font-size:28px;line-height:1}
.stat-lbl{font-family:var(--fu);font-size:10px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase;margin-top:4px}
.pbar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:6px}
.pfill{height:100%;border-radius:2px;transition:width .6s ease}

/* â”€â”€ TASK TABLE â”€â”€ */
.ttable{width:100%;border-collapse:collapse}
.ttable th{font-family:var(--fu);font-size:10px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase;padding:6px 10px;border-bottom:1px solid var(--border);text-align:left;background:var(--bg-panel);position:sticky;top:0;white-space:nowrap}
.ttable td{padding:7px 10px;border-bottom:1px solid rgba(42,42,42,.5);vertical-align:middle;font-size:12px}
.ttable tr:hover td{background:rgba(201,162,39,.04);cursor:pointer}

/* â”€â”€ KANBAN â”€â”€ */
.kb-board{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;height:100%}
.kb-col{min-width:220px;flex-shrink:0;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;max-height:100%}
.kb-col-hdr{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-family:var(--fu);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;flex-shrink:0}
.kb-col-body{padding:8px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:6px}
.kb-card{background:var(--bg-card);border:1px solid var(--border);border-radius:5px;padding:9px;cursor:pointer;transition:all .12s;border-left:3px solid var(--border)}
.kb-card:hover{border-color:var(--gold-dim);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.4)}
.kb-card-title{font-size:12px;font-weight:500;margin-bottom:5px;line-height:1.3}
.kb-card-meta{display:flex;gap:5px;flex-wrap:wrap;align-items:center}

/* â”€â”€ CALENDAR â”€â”€ */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-hdr{font-family:var(--fu);font-size:10px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase;text-align:center;padding:6px}
.cal-cell{background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;min-height:85px;padding:6px;cursor:pointer;transition:all .15s;position:relative}
.cal-cell:hover{border-color:var(--gold-dim);background:rgba(201,162,39,.04)}
.cal-cell.today{border-color:var(--gold);box-shadow:inset 0 0 0 1px rgba(201,162,39,.2)}
.cal-cell.other-month{opacity:.3}
.cal-day-num{font-family:var(--fm);font-size:11px;color:var(--text-secondary);margin-bottom:3px}
.cal-cell.today .cal-day-num{color:var(--gold);font-weight:700}
.cal-ev{font-size:9px;padding:2px 4px;border-radius:2px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:rgba(201,162,39,.15);color:var(--gold-light);border:1px solid rgba(201,162,39,.25);cursor:pointer;transition:background .1s}
.cal-ev:hover{background:rgba(201,162,39,.3)}
.cal-ev.cal-task{background:rgba(74,158,255,.1);color:var(--blue);border-color:rgba(74,158,255,.25)}
.cal-ev.cal-task:hover{background:rgba(74,158,255,.2)}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:14px}
.tab{padding:6px 14px;font-family:var(--fu);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:all .12s}
.tab:hover{color:var(--text-primary)}
.tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.tc{display:none}
.tc.active{display:block}

/* â”€â”€ DOC EDITOR â”€â”€ */
.doc-layout{display:flex;overflow:hidden;flex:1}
.doc-nav{width:200px;background:var(--bg-panel);border-right:1px solid var(--border);padding:10px;flex-shrink:0;overflow-y:auto}
.doc-nav-grp{font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;padding:10px 8px 4px}
.doc-nav-item{padding:7px 10px;cursor:pointer;font-family:var(--fu);font-size:12px;font-weight:500;color:var(--text-secondary);border-radius:4px;border-left:2px solid transparent;transition:all .1s;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:6px;margin-bottom:1px}
.doc-nav-item:hover{color:var(--text-primary);background:rgba(255,255,255,.03)}
.doc-nav-item.active{color:var(--gold);border-left-color:var(--gold);background:rgba(201,162,39,.08)}
.doc-content{flex:1;overflow-y:auto;padding:20px;background:var(--bg-base)}
.doc-section{display:none;animation:fadeIn .2s ease}
.doc-section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.doc-sec-title{font-family:var(--fu);font-size:20px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.doc-field-wrap{margin-bottom:20px;transition:all .2s}
.doc-field-wrap:focus-within{transform:translateX(2px)}
.doc-field-label{font-family:var(--fu);font-size:10px;letter-spacing:2px;color:var(--gold-dim);text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.doc-field-label::before{content:'';width:8px;height:1px;background:var(--gold-dim);display:inline-block}
.doc-ta{width:100%;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:12px 14px;color:var(--text-primary);font-family:var(--fb);font-size:13px;line-height:1.7;resize:vertical;min-height:100px;transition:all .2s}
.doc-ta:focus{outline:none;border-color:var(--gold-dim);background:#141008;box-shadow:0 0 0 2px rgba(201,162,39,.08)}
.doc-divider{height:1px;background:linear-gradient(90deg,var(--gold-dim),transparent);margin:20px 0;opacity:.4}
.doc-hint{font-size:11px;color:var(--text-muted);font-style:italic;margin-top:4px;padding-left:4px}
.doc-checklist{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:10px;display:flex;flex-direction:column;gap:4px}
.doc-check-item{display:flex;align-items:center;gap:8px;padding:5px 4px;border-radius:3px;transition:background .1s}
.doc-check-item:hover{background:rgba(255,255,255,.03)}
.doc-check-item input[type="checkbox"]{accent-color:var(--gold);width:14px;height:14px;flex-shrink:0}
.doc-check-item.done span{text-decoration:line-through;color:var(--text-muted)}
.doc-check-input{background:transparent;border:none;border-bottom:1px solid transparent;color:var(--text-primary);font-family:var(--fb);font-size:12px;width:100%;padding:1px 4px;transition:border-color .15s}
.doc-check-input:focus{outline:none;border-bottom-color:var(--gold-dim)}
.doc-info-box{background:rgba(201,162,39,.05);border:1px solid rgba(201,162,39,.2);border-radius:6px;padding:10px 14px;margin-bottom:14px;font-size:11px;color:var(--text-secondary);line-height:1.6}
.doc-info-box strong{color:var(--gold);font-family:var(--fu);letter-spacing:.5px}
.doc-guide-q{font-size:11px;color:rgba(201,162,39,.6);font-style:italic;margin-bottom:5px;padding:4px 8px;background:rgba(201,162,39,.04);border-left:2px solid rgba(201,162,39,.2);border-radius:0 3px 3px 0;line-height:1.5}
/* Study note rich content */
.study-note-content h3{font-family:var(--fu);font-size:14px;font-weight:700;color:var(--gold);letter-spacing:1px;margin:16px 0 6px;text-transform:uppercase}
.study-note-content h2{font-family:var(--fu);font-size:16px;font-weight:700;color:var(--gold-light);letter-spacing:1px;margin:20px 0 8px}
.study-note-content strong{color:var(--text-primary);font-weight:600}
.study-note-content em{color:var(--text-secondary);font-style:italic}
.study-note-content blockquote{border-left:3px solid var(--gold-dim);padding:8px 14px;background:rgba(201,162,39,.04);margin:10px 0;font-size:12px;color:var(--text-secondary);font-style:italic}
.study-note-content a{color:var(--gold);text-decoration:none}.study-note-content a:hover{text-decoration:underline}
.study-note-content p{margin:0 0 10px;line-height:1.8}
.study-note-content ul,.study-note-content ol{margin:6px 0 10px;padding-left:18px}
.study-note-content li{margin-bottom:4px;line-height:1.7}
/* Flowchart node styles */
.fnode-selected{box-shadow:0 0 0 2px #c9a227,0 0 16px rgba(201,162,39,.3) !important}
.fnode-connecting{box-shadow:0 0 0 2px #4a9eff,0 0 16px rgba(74,158,255,.3) !important;animation:nodeFlash .5s ease infinite alternate}
@keyframes nodeFlash{from{box-shadow:0 0 0 2px #4a9eff}to{box-shadow:0 0 0 3px #4a9eff,0 0 20px rgba(74,158,255,.5)}}
.fnode-btn{font-family:var(--fm);font-size:9px;cursor:pointer;padding:2px 6px;border:1px solid;border-radius:3px;line-height:1.4;transition:background .1s;display:inline-block}
.fnode-btn:hover{background:rgba(255,255,255,.08)}

/* â”€â”€ GDD/LDD SAVE TOAST â”€â”€ */
.field-saved{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(78,203,113,.15);border:1px solid var(--green);color:var(--green);font-family:var(--fu);font-size:11px;letter-spacing:1px;padding:6px 16px;border-radius:4px;z-index:400;opacity:0;transition:opacity .3s;pointer-events:none}
.field-saved.show{opacity:1}

/* â”€â”€ NOTES/CHECKLIST MODULE â”€â”€ */
.notes-list-row{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:3px;cursor:pointer;font-family:var(--fu);font-size:11px;color:var(--text-secondary);letter-spacing:.5px;border-left:2px solid transparent;transition:all .1s}
.notes-list-row:hover{color:var(--text-primary);background:rgba(255,255,255,.03)}
.notes-list-row.active{color:var(--gold);border-left-color:var(--gold);background:rgba(201,162,39,.06)}
.note-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:5px;border:1px solid var(--border);background:var(--bg-card);margin-bottom:5px;transition:all .12s;cursor:default}
.note-item:hover{border-color:var(--gold-dim)}
.note-item.done{opacity:.55}
.note-item input[type="checkbox"]{accent-color:var(--gold);width:15px;height:15px;flex-shrink:0;cursor:pointer}
.note-item-text{flex:1;font-family:var(--fb);font-size:13px;color:var(--text-primary);outline:none;background:transparent;border:none;border-bottom:1px solid transparent;transition:border-color .15s;padding:1px 3px}
.note-item-text:focus{border-bottom-color:var(--gold-dim)}
.note-item.done .note-item-text{text-decoration:line-through;color:var(--text-muted)}
.note-del-btn{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text-muted);cursor:pointer;border-radius:3px;opacity:0;transition:all .1s;flex-shrink:0}
.note-item:hover .note-del-btn{opacity:1}
.note-del-btn:hover{background:rgba(224,82,82,.15);color:var(--red)}
#notes-quick-input{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:5px;padding:9px 12px;color:var(--text-primary);font-family:var(--fb);font-size:13px;transition:border-color .15s}
#notes-quick-input:focus{outline:none;border-color:var(--gold)}

/* â”€â”€ STUDYING FOCUS MODE â”€â”€ */
body.focus-mode #sidebar,body.focus-mode .topbar,body.focus-mode #study-topics-nav,body.focus-mode [id="study-topics-nav"]~*{display:none!important}
body.focus-mode #study-webview-panel{position:fixed!important;inset:0!important;z-index:800!important;display:flex!important}
body.focus-mode #map-left-panel,body.focus-mode #map-right-panel{display:none!important}
#focus-btn{position:fixed;top:8px;right:8px;z-index:900;display:none}
body.focus-mode #focus-btn{display:flex}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP EDITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#map-editor-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
#map-toolbar-top{height:44px;background:#0a0a0a;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:4px;flex-shrink:0}
.map-tool-group{display:flex;gap:2px;padding:0 6px;border-right:1px solid var(--border)}
.map-tool-group:last-child{border-right:none}
.mt{width:32px;height:32px;border:1px solid transparent;border-radius:4px;background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .12s;font-family:var(--fm);position:relative;flex-shrink:0}
.mt:hover{border-color:var(--border);color:var(--text-primary);background:rgba(255,255,255,.04)}
.mt.active{border-color:var(--gold);color:var(--gold);background:rgba(201,162,39,.1)}
.mt.toggled{border-color:var(--blue);color:var(--blue);background:rgba(74,158,255,.1)}
.mt[title]:hover::after{content:attr(title);position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);background:#000;border:1px solid var(--border);color:var(--text-primary);font-size:10px;padding:2px 6px;border-radius:3px;white-space:nowrap;pointer-events:none;z-index:200;font-family:var(--fb)}
#map-main{flex:1;display:flex;overflow:hidden}
/* â”€â”€ LEFT SHAPES PANEL â”€â”€ */
#map-left-panel{width:190px;background:var(--bg-panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#map-left-panel-hdr{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:4px}
#map-shapes-body{flex:1;overflow-y:auto;padding:4px 6px}
.shape-cat{font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;padding:8px 4px 3px;margin-top:2px}
.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;margin-bottom:4px}
.shape-btn{background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:5px 2px 3px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:1px;transition:all .12s;font-size:17px;min-width:0}
.shape-btn:hover{border-color:var(--gold-dim);background:rgba(201,162,39,.08)}
.shape-btn.active-shape{border-color:var(--gold);background:rgba(201,162,39,.15)}
.shape-btn span{font-family:var(--fu);font-size:7.5px;color:var(--text-muted);letter-spacing:.3px;text-align:center;line-height:1.2;overflow:hidden;width:100%}
/* Canvas area */
#map-canvas-area{flex:1;overflow:hidden;position:relative;background:#080808}
#map-canvas{display:block;position:absolute;top:0;left:0}
/* â”€â”€ RIGHT PANEL (Properties + Layers) â”€â”€ */
#map-right-panel{width:220px;border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#map-props-panel{background:var(--bg-panel);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;border-bottom:1px solid var(--border);max-height:46%}
/* â”€â”€ LAYERS PANEL (now part of right panel) â”€â”€ */
#map-layers-panel{background:var(--bg-panel);display:flex;flex-direction:column;flex:1;overflow:hidden}
#map-layers-hdr{padding:8px 10px 6px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:4px}
#map-layers-list{flex:1;overflow-y:auto;padding:4px}
.layer-row{display:flex;align-items:center;gap:3px;padding:5px 5px;border-radius:4px;cursor:pointer;border:1px solid transparent;border-top:2px solid transparent;border-bottom:2px solid transparent;transition:background .12s,border-color .12s,transform .1s,opacity .12s;margin-bottom:1px;position:relative}
.layer-row:hover{background:rgba(255,255,255,.045);border-color:rgba(255,255,255,.05)}
.layer-row.active{border-color:var(--gold-dim)!important;background:rgba(201,162,39,.09)}
/* Drag states */
.layer-row.dragging{opacity:.3;transform:scale(.96);pointer-events:none}
.layer-row.drag-over-top{border-top:2px solid var(--gold)!important;background:rgba(201,162,39,.05)}
.layer-row.drag-over-bottom{border-bottom:2px solid var(--gold)!important;background:rgba(201,162,39,.05)}
/* Name */
.layer-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--fb);font-size:10px;color:var(--text-secondary);letter-spacing:.1px}
.layer-row.active .layer-name{color:var(--gold);font-weight:600}
/* Type icon â€” default block types */
.layer-type-icon{font-size:11px;flex-shrink:0;width:16px;text-align:center;color:var(--text-muted);line-height:1}
/* Text type: italic gold T */
.layer-type-text{flex-shrink:0;width:14px;text-align:center;font-family:var(--fu);font-size:10px;font-weight:700;font-style:italic;color:var(--gold);letter-spacing:-1px;line-height:1}
/* Visibility / lock icon buttons */
.layer-icon-btn{width:15px;height:15px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:2px;transition:background .1s,color .1s;flex-shrink:0;color:var(--text-muted);opacity:.7}
.layer-icon-btn:hover{background:rgba(255,255,255,.1);color:var(--text-primary);opacity:1}
/* Lock states */
.layer-lock-open{color:#555!important;opacity:.5!important}
.layer-lock-closed{color:#c9a227!important;opacity:1!important}
/* Hidden row */
.layer-row.hidden-obj{opacity:.35}
/* Color swatch */
.layer-color-swatch{width:8px;height:8px;border-radius:2px;flex-shrink:0;border:1px solid rgba(255,255,255,.18);margin-right:1px}
/* Type badge for non-block types */
.layer-type-badge{font-family:var(--fu);font-size:7px;letter-spacing:.5px;padding:1px 3px;border-radius:2px;flex-shrink:0;text-transform:uppercase;background:rgba(255,255,255,.07);color:var(--text-muted)}
/* Text layer name â€” italic gold */
.layer-name-text{font-style:italic;color:#d4b75a!important}
#map-layers-footer{padding:6px 8px;border-top:1px solid var(--border);flex-shrink:0}
#map-props-hdr{padding:10px 12px 6px;border-bottom:1px solid var(--border);flex-shrink:0;font-family:var(--fu);font-size:11px;font-weight:700;letter-spacing:1px;color:var(--gold);text-transform:uppercase}
#map-props-body{flex:1;overflow-y:auto;padding:10px}
.mp-section{margin-bottom:10px}
.mp-section-title{font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid var(--border)}
.mp-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.mp-label{font-family:var(--fu);font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;min-width:44px}
.mp-input{flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;padding:3px 6px;color:var(--text-primary);font-family:var(--fm);font-size:11px;transition:border-color .15s;width:100%;min-width:0}
.mp-input:focus{outline:none;border-color:var(--gold-dim)}
.mp-color{width:30px;height:22px;border:1px solid var(--border);border-radius:3px;background:none;cursor:pointer;padding:1px;flex-shrink:0}
/* Status bar */
#map-statusbar{height:24px;background:#060606;border-top:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:16px;font-family:var(--fm);font-size:10px;color:var(--text-secondary);flex-shrink:0;user-select:none}
.sb-stat{display:flex;gap:4px;align-items:center;white-space:nowrap}
.sb-stat b{color:var(--gold-light)}
#map-sel-name{margin-left:auto;color:var(--text-secondary);font-size:10px}
/* No map */
#map-no-map{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text-secondary)}
#map-no-map .icon{font-size:48px;opacity:.2}
#map-no-map .hint{font-family:var(--fu);font-size:12px;letter-spacing:1px;text-transform:uppercase}

/* â”€â”€ CHARTS â”€â”€ */
.curve-wrap{background:var(--bg-input);border:1px solid var(--border);border-radius:6px;overflow:hidden;position:relative}
#curve-canvas{display:block;cursor:crosshair}

/* â”€â”€ ASSETS â”€â”€ */
.asset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}
.asset-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:10px;text-align:center;cursor:pointer;transition:all .15s}
.asset-card:hover{border-color:var(--gold-dim);transform:translateY(-1px)}
.asset-icon{font-size:26px;margin-bottom:6px}
.asset-name{font-family:var(--fu);font-size:10px;letter-spacing:.5px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#asset-drop{border:2px dashed var(--border);border-radius:8px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px}
#asset-drop:hover,#asset-drop.over{border-color:var(--gold);background:rgba(201,162,39,.04)}

/* â”€â”€ MODAL â”€â”€ */
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;align-items:center;justify-content:center}
#modal-overlay.open{display:flex}
#modal{background:var(--bg-panel);border:1px solid var(--gold);border-radius:8px;padding:24px;min-width:440px;max-width:660px;max-height:88vh;overflow-y:auto;position:relative;animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(-10px)}to{opacity:1;transform:none}}
.modal-title{font-family:var(--fu);font-size:16px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid var(--border)}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--text-secondary);font-size:18px;cursor:pointer;transition:color .1s}
.modal-close:hover{color:var(--text-primary)}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:18px;right:18px;background:var(--bg-card);border:1px solid var(--gold);border-radius:6px;padding:9px 16px;font-family:var(--fu);font-size:12px;color:var(--gold);letter-spacing:.5px;z-index:600;opacity:0;transform:translateY(6px);transition:all .25s;pointer-events:none}
#toast.show{opacity:1;transform:none}
#online-bar{display:none;background:#0a0a0a;border-bottom:1px solid rgba(78,203,113,.18);padding:0 14px;height:26px;align-items:center;gap:6px;font-size:11px;font-family:var(--fm);overflow-x:auto;white-space:nowrap;flex-shrink:0}
#online-bar .ob-label{font-size:9px;font-family:var(--fu);letter-spacing:1.5px;color:var(--green);opacity:.7;text-transform:uppercase;flex-shrink:0}
.ob-user{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:3px;padding:1px 7px;font-size:10px}
.ob-user.is-self{border-color:rgba(78,203,113,.3)}
.ob-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.ob-name{font-weight:600}
.ob-loc{color:#555;margin-left:2px}

/* â”€â”€ UPDATE BANNER â”€â”€ */
#update-banner{display:none;padding:0 16px;height:32px;align-items:center;gap:10px;font-size:11px;font-family:var(--fm);flex-shrink:0;border-bottom:1px solid;transition:all .2s}
#update-banner.ub-info{background:rgba(78,203,113,.07);border-color:rgba(78,203,113,.25);color:var(--green)}
#update-banner.ub-warn{background:rgba(201,162,39,.09);border-color:rgba(201,162,39,.35);color:var(--gold)}
#update-banner .ub-msg{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#update-banner button{font-family:var(--fm);font-size:10px;border-radius:3px;padding:2px 10px;cursor:pointer;border:1px solid;transition:all .12s}
#update-banner .ub-apply{background:var(--gold);color:#000;border-color:var(--gold)}
#update-banner .ub-apply:hover{opacity:.85}
#update-banner .ub-dismiss{background:none;color:currentColor;border-color:currentColor;opacity:.5}
#update-banner .ub-dismiss:hover{opacity:1}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:160px;gap:8px;color:var(--text-secondary)}
.empty-icon{font-size:32px;opacity:.25}
.empty-txt{font-family:var(--fu);font-size:11px;letter-spacing:1px;text-transform:uppercase}

/* â”€â”€ DRAG OVER â”€â”€ */
.drag-over{border-color:var(--gold) !important;background:rgba(201,162,39,.06) !important}

/* â”€â”€ SELECTION â”€â”€ */
.disc-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}

/* â”€â”€ EXPORT CARD â”€â”€ */
.exp-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:16px;display:flex;flex-direction:column;gap:10px;transition:border-color .2s}
.exp-card:hover{border-color:var(--gold-dim)}
.exp-card-title{font-family:var(--fu);font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.exp-card-desc{font-size:11px;color:var(--text-secondary);line-height:1.5}

/* â”€â”€ CHECKLIST â”€â”€ */
.check-item{display:flex;align-items:center;gap:8px;padding:4px 0}
.check-item input[type="checkbox"]{accent-color:var(--gold);width:13px;height:13px;flex-shrink:0}
.check-item.done span{text-decoration:line-through;color:var(--text-secondary)}
input[type="color"]{width:32px;height:22px;border:1px solid var(--border);border-radius:3px;background:none;cursor:pointer;padding:1px}
input[type="range"]{accent-color:var(--gold);width:100%}

/* â”€â”€ FIELD SAVED INDICATOR â”€â”€ */
.save-flash{animation:saveFlash .5s ease}
@keyframes saveFlash{0%{background:rgba(78,203,113,.08)}100%{background:transparent}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE OVERLAY & HAMBURGER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:199}
#mob-overlay.active{display:block}
#mob-menu-btn{display:none;background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer;padding:4px 8px;line-height:1;flex-shrink:0;border-radius:4px}
#mob-menu-btn:hover{background:rgba(201,162,39,.1)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” TV / XL (â‰¥ 1800px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:1800px){
  :root{--sidebar-w:240px;--topbar-h:52px}
  body{font-size:14px}
  .mod-title{font-size:22px}
  .mod-body{padding:20px 28px}
  .btn{font-size:13px;padding:6px 18px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” Tablet (768px â€“ 1199px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1199px){
  .g4{grid-template-columns:1fr 1fr}
  #modal{min-width:min(440px,calc(100vw - 40px))}
  .mod-hdr{flex-wrap:wrap;gap:8px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” Mobile (< 768px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:767px){
  /* Sidebar becomes slide-in overlay */
  #sidebar{
    position:fixed;
    top:0;left:0;bottom:0;
    z-index:200;
    transform:translateX(-100%);
    transition:transform .25s ease;
    width:220px;
    box-shadow:4px 0 20px rgba(0,0,0,.6)
  }
  #sidebar.mob-open{transform:translateX(0)}

  /* Hamburger visible, topbar clutter hidden */
  #mob-menu-btn{display:flex!important;align-items:center}
  .tb-div{display:none!important}
  #tb-search{display:none!important}
  .lang-btn{display:none!important}
  #save-ind{display:none!important}
  #collab-ind{display:none!important}
  .tb-select{max-width:110px;font-size:11px}
  #cloud-btn{padding:4px 7px;font-size:10px}
  #cloud-lbl{display:none!important}

  /* Lifecycle bar: hide */
  #lifecycle{display:none!important}

  /* Topbar height adjustment */
  #topbar{padding:0 8px;gap:6px}
  .tb-logo span{display:none}

  /* Update banner & online bar: smaller */
  #update-banner{font-size:10px;height:auto;min-height:28px;flex-wrap:wrap;padding:4px 10px}
  #online-bar{font-size:10px;padding:3px 10px}

  /* Module header */
  .mod-hdr{padding:8px 12px;flex-wrap:wrap;gap:6px}
  .mod-title{font-size:13px;letter-spacing:1px}
  .mod-sub{display:none}
  .mod-body{padding:10px 10px}

  /* Grids: 2 col then 1 col at very small */
  .g4{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}

  /* Modal: near-fullscreen */
  #modal{
    min-width:auto!important;
    width:calc(100vw - 16px)!important;
    max-width:none!important;
    padding:14px!important;
    max-height:90vh!important;
    margin:0!important;
    border-radius:8px
  }

  /* Touch-friendly buttons */
  .btn{min-height:36px;font-size:12px}
  .btn-save{min-height:36px}

  /* Inputs: 16px prevents iOS auto-zoom */
  .fi,.fs,.fta{font-size:16px!important}

  /* GDD / LDD document layout */
  .doc-layout{flex-direction:column}
  .doc-nav{
    width:100%!important;
    border-right:none!important;
    border-bottom:1px solid var(--border);
    max-height:160px;
    padding:6px
  }
  .doc-content{padding:12px}

  /* Studying topics sidebar */
  #study-nav-panel{
    width:100%!important;
    border-right:none!important;
    border-bottom:1px solid var(--border);
    flex-direction:row!important;
    max-height:160px;
    overflow:hidden;
    flex-shrink:0!important
  }
  #study-nav-panel > div:first-child{display:none}/* hide "Topics" header on mobile */
  #study-topics-nav{padding:4px;overflow-x:auto;overflow-y:hidden;display:flex!important;flex-direction:row;gap:4px;white-space:nowrap;align-items:center}
  #study-nav-panel > div:last-child{display:none}/* hide add buttons on mobile (accessible via mod-hdr) */

  /* Notes lists sidebar */
  #notes-nav-panel{
    width:100%!important;
    border-right:none!important;
    border-bottom:1px solid var(--border);
    flex-direction:row!important;
    max-height:100px;
    flex-shrink:0!important
  }
  #notes-nav-panel > div:first-child{display:none}
  #notes-lists-nav{padding:4px;overflow-x:auto;overflow-y:hidden;display:flex!important;flex-direction:row;gap:4px;white-space:nowrap;align-items:center}
  #notes-nav-panel > div:last-child{display:none}

  /* Studying / Notes: stack panels vertically */
  #study-body,#notes-body{flex-direction:column!important}

  /* Map: hide side panels â€” canvas takes full width */
  #map-left-panel{display:none!important}
  #map-right-panel{display:none!important}
  #map-toolbar-top{gap:2px;padding:0 6px;overflow-x:auto;flex-wrap:nowrap}
  .mt{width:28px;height:28px;font-size:12px}

  /* Flowchart */
  #flowchart-canvas{height:55vh!important;min-height:300px}

  /* Kanban: already has overflow-x:auto â€” OK */

  /* Fixed-width selects in filter bars: allow to shrink */
  #f-status,#f-disc{width:auto!important;flex:1;min-width:90px}

  /* Beat table: horizontal scroll */
  #beat-table{min-width:0!important}
  #ldd-beat-wrap,table{overflow-x:auto}

  /* Calendar month label */
  #cal-month-label{min-width:0!important}

  /* Dashboard circular rings: scale down */
  .dash-ring svg{width:56px!important;height:56px!important}

  /* Asset grid: 2 col min */
  .asset-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” Small mobile (< 480px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:479px){
  .g4,.g3,.g2{grid-template-columns:1fr}
  .mod-title{font-size:12px}
  #topbar{gap:4px}
  .tb-select{max-width:90px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP EXPAND / FOCUS MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body.map-expand #sidebar,
body.map-expand #topbar,
body.map-expand #lifecycle,
body.map-expand #online-bar,
body.map-expand #update-banner { display:none!important }
body.map-expand #main { height:100vh!important }
body.map-expand #module-map { border-radius:0 }
#map-focus-btn { border-color:var(--gold-dim);color:var(--gold) }
body.map-expand #map-focus-btn { background:rgba(201,162,39,.12);border-color:var(--gold) }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOC-NAV RESIZABLE HANDLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.doc-nav { position:relative;min-width:120px;max-width:480px }
.nav-resize-handle {
  position:absolute;top:0;right:-4px;width:8px;height:100%;
  cursor:col-resize;z-index:10;border-radius:3px;
  transition:background .15s
}
.nav-resize-handle:hover,.nav-resize-handle.dragging { background:rgba(201,162,39,.35) }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOC IMAGE GALLERY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â”€â”€ PER-FIELD IMAGE GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Compact horizontal strip that sits below each textarea */
.doc-field-gallery{display:flex;flex-direction:row;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;gap:6px;padding:6px 2px 6px;margin-top:5px;scrollbar-width:thin;scrollbar-color:var(--gold-dim) transparent;align-items:flex-start;border-top:1px solid rgba(201,162,39,.12)}
.doc-field-gallery::-webkit-scrollbar{height:3px}
.doc-field-gallery::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px}
/* Image card: thumb + caption */
.doc-img-card{flex-shrink:0;width:110px;display:flex;flex-direction:column;gap:3px}
.doc-img-thumb{position:relative;border-radius:4px;overflow:hidden;border:1px solid var(--border);transition:border-color .15s}
.doc-img-thumb:hover{border-color:var(--gold)}
.doc-img-thumb img{display:block;width:110px;height:70px;object-fit:cover;cursor:zoom-in}
.doc-img-caption{width:100%;background:var(--bg-input);border:1px solid transparent;border-radius:3px;padding:2px 5px;font-size:9px;color:var(--text-secondary);font-family:var(--fb);outline:none;box-sizing:border-box}
.doc-img-caption:focus{border-color:var(--gold-dim);color:var(--text-primary)}
.doc-img-caption::placeholder{color:var(--text-muted)}
.doc-img-del{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.78);border:none;color:#fff;border-radius:50%;width:16px;height:16px;font-size:9px;cursor:pointer;line-height:16px;text-align:center;padding:0;opacity:0;transition:opacity .15s}
.doc-img-thumb:hover .doc-img-del{opacity:1}
.doc-img-add{flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;width:70px;height:70px;border:1px dashed var(--border);border-radius:4px;cursor:pointer;font-size:9px;color:var(--text-muted);font-family:var(--fu);letter-spacing:.3px;gap:3px;transition:all .15s;text-align:center;padding:4px;user-select:none}
.doc-img-add:hover{border-color:var(--gold);color:var(--gold);background:rgba(201,162,39,.05)}
.doc-img-add input{display:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYER CONTEXT MENU
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#layer-ctx-menu {
  position:fixed;z-index:9999;
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:6px;padding:4px 0;min-width:160px;
  box-shadow:0 6px 20px rgba(0,0,0,.55);
  display:none;
}
#layer-ctx-menu.open { display:block }
#layer-ctx-menu button {
  display:block;width:100%;text-align:left;
  background:none;border:none;
  padding:6px 14px;font-family:var(--fu);font-size:12px;
  color:var(--text-primary);cursor:pointer;line-height:1.4;
}
#layer-ctx-menu button:hover { background:rgba(201,162,39,.13);color:var(--gold) }
#layer-ctx-menu hr { border:none;border-top:1px solid var(--border);margin:3px 0 }
#layer-ctx-menu button.danger { color:var(--red) }
#layer-ctx-menu button.danger:hover { background:rgba(220,50,50,.12) }
</style>
</head>
<body>
<div id="mob-overlay" onclick="closeMobSidebar()"></div>
<div id="layer-ctx-menu"></div>
<!-- TOPBAR -->
<div id="topbar">
  <button id="mob-menu-btn" onclick="toggleMobSidebar()" title="Menu">â˜°</button>
  <div class="tb-logo">
    <svg viewBox="0 0 30 30" fill="none">
      <polygon points="15,2 27,8 27,22 15,28 3,22 3,8" stroke="#c9a227" stroke-width="1.5" fill="rgba(201,162,39,.06)"/>
      <text x="15" y="19" text-anchor="middle" font-family="Rajdhani" font-weight="700" font-size="10" fill="#c9a227">IG</text>
    </svg>
    <span>Invictus</span>
  </div>
  <div class="tb-div"></div>
  <select class="tb-select" id="project-sel" onchange="switchProject(this.value)">
    <option>Project Alpha</option><option>Dungeon Crawler</option><option>Platformer X</option>
  </select>
  <input id="tb-search" type="text" placeholder="Searchâ€¦">
  <div class="tb-spacer"></div>
  <button class="lang-btn active" id="lang-en" onclick="setLang('en')">EN</button>
  <button class="lang-btn" id="lang-es" onclick="setLang('es')">ES</button>
  <div class="tb-div"></div>
  <span id="collab-ind" style="font-family:var(--fm);font-size:11px;color:var(--blue);white-space:nowrap;display:none;padding:0 6px;border:1px solid rgba(74,158,255,.3);border-radius:3px;" title="Other tabs open"></span>
  <button id="cloud-btn" onclick="openFirebaseModal()" title="Firebase Realtime Sync" style="background:none;border:1px solid var(--border);border-radius:4px;padding:4px 10px;cursor:pointer;font-family:var(--fm);font-size:11px;color:var(--text-secondary);transition:all .15s;display:flex;align-items:center;gap:5px;white-space:nowrap">
    <span id="cloud-dot" style="width:7px;height:7px;border-radius:50%;background:var(--text-muted);display:inline-block;flex-shrink:0"></span>
    <span id="cloud-lbl">Firebaseâ€¦</span>
  </button>
  <span id="save-ind" class="saved">â— Saved</span>
  <button class="btn-save" onclick="saveAll()">Save</button>
</div>
<div id="online-bar">
  <span class="ob-label">ğŸŒ Online</span>
  <span id="online-bar-users"></span>
</div>

<!-- UPDATE NOTIFICATION BANNER -->
<div id="update-banner" class="ub-info">
  <span id="ub-icon">ğŸ“¥</span>
  <span class="ub-msg" id="ub-msg">Updates available</span>
  <button class="ub-apply" id="ub-apply-btn" onclick="applyPendingRemote()">âœ“ Apply Updates</button>
  <button class="ub-dismiss" onclick="dismissUpdateBanner()">âœ•</button>
</div>

<!-- LIFECYCLE BAR -->
<div id="lifecycle">
  <span id="lc-title">WORKFLOW</span>
  <div class="lc-step active" onclick="gotoLC('gdd')"><span class="lc-label">GDD</span></div>
  <span class="lc-arrow">â–¶</span>
  <div class="lc-step" onclick="gotoLC('ldd')"><span class="lc-label">LDD</span></div>
  <span class="lc-arrow">â–¶</span>
  <div class="lc-step" onclick="gotoLC('map')"><span class="lc-label">Map Blockout</span></div>
  <span class="lc-arrow">â–¶</span>
  <div class="lc-step" onclick="gotoLC('tasks')"><span class="lc-label">Tasks</span></div>
  <span class="lc-arrow">â–¶</span>
  <div class="lc-step" onclick="gotoLC('charts')"><span class="lc-label">Iteration</span></div>
  <span class="lc-arrow">â–¶</span>
  <div class="lc-step" onclick="gotoLC('export')"><span class="lc-label">Export</span></div>
</div>

<!-- MAIN -->
<div id="main">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-sec" data-i18n="navigation">Navigation</div>
    <div class="sb-item active" data-mod="dashboard" onclick="showModule('dashboard')">
      <svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6"/><rect x="9" y="1" width="6" height="6"/><rect x="1" y="9" width="6" height="6"/><rect x="9" y="9" width="6" height="6"/></svg>
      <span data-i18n="dashboard">Dashboard</span>
    </div>
    <div class="sb-item" data-mod="tasks" onclick="showModule('tasks')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="1,8 5,12 10,4"/><line x1="13" y1="4" x2="13" y2="12"/></svg>
      <span data-i18n="tasks">Tasks</span>
    </div>
    <div class="sb-item" data-mod="calendar" onclick="showModule('calendar')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="14" height="12" rx="1"/><line x1="5" y1="1" x2="5" y2="5"/><line x1="11" y1="1" x2="11" y2="5"/><line x1="1" y1="7" x2="15" y2="7"/></svg>
      <span data-i18n="calendar">Calendar</span>
    </div>
    <div class="sb-item" data-mod="gdd" onclick="showModule('gdd')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="1" width="12" height="14" rx="1"/><line x1="5" y1="5" x2="11" y2="5"/><line x1="5" y1="8" x2="11" y2="8"/><line x1="5" y1="11" x2="9" y2="11"/></svg>
      <span data-i18n="gdd">GDD</span>
    </div>
    <div class="sb-item" data-mod="ldd" onclick="showModule('ldd')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 14 L8 2 L14 14 Z"/><line x1="5" y1="10" x2="11" y2="10"/></svg>
      <span data-i18n="ldd">LDD</span>
    </div>
    <div class="sb-item" data-mod="map" onclick="showModule('map')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="1"/><rect x="4" y="4" width="3" height="3"/><rect x="9" y="4" width="3" height="3"/><rect x="4" y="9" width="3" height="3"/></svg>
      <span data-i18n="map">Map Editor</span>
    </div>
    <div class="sb-item" data-mod="charts" onclick="showModule('charts')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="1,14 5,8 9,11 13,4 15,6"/></svg>
      <span data-i18n="charts">Charts</span>
    </div>
    <div class="sb-item" data-mod="assets" onclick="showModule('assets')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="5" width="14" height="10" rx="1"/><polyline points="5,5 5,3 8,1 11,3 11,5"/></svg>
      <span data-i18n="assets">Assets</span>
    </div>
    <div class="sb-item" data-mod="export" onclick="showModule('export')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="8,1 8,11"/><polyline points="4,7 8,11 12,7"/><rect x="2" y="13" width="12" height="2"/></svg>
      <span data-i18n="export">Export</span>
    </div>

    <div class="sb-sec" style="margin-top:6px;" data-i18n="study">Study</div>
    <div class="sb-item" data-mod="studying" onclick="showModule('studying')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1 L15 4 L8 7 L1 4 Z"/><path d="M1 4 L1 11"/><path d="M4 5.5 L4 12 L8 14 L12 12 L12 5.5"/></svg>
      <span data-i18n="studying">Studying</span>
    </div>
    <div class="sb-item" data-mod="notes" onclick="showModule('notes')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="1" width="12" height="14" rx="1"/><line x1="5" y1="5" x2="11" y2="5"/><line x1="5" y1="8" x2="11" y2="8"/><line x1="5" y1="11" x2="9" y2="11"/><polyline points="3,4 4,5 3,6" stroke-width="1"/></svg>
      <span data-i18n="notes">Notes</span>
    </div>

    <div class="sb-bottom">
      <!-- ARGENTINA CLOCK IN SIDEBAR -->
      <div id="ar-clock-wrap">
        <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px;">
          <span id="ar-flag">ğŸ‡¦ğŸ‡·</span>
          <div id="ar-label" style="font-family:var(--fu);font-size:9px;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase">Argentina ART</div>
        </div>
        <div id="ar-clock"><div id="ar-clock-digits" style="display:flex;align-items:center;"></div></div>
      </div>
      <div style="height:1px;background:var(--border);margin:8px 0;"></div>
      <div class="sb-offline"><div class="sb-offline-dot"></div>Offline Ready</div>
      <div style="font-family:var(--fm);font-size:9px;color:var(--text-muted)">IndexedDB + LocalStorage</div>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="module active" id="module-dashboard">
      <div class="mod-hdr">
        <div class="mod-title">Dashboard</div>
        <div class="mod-sub">Project Overview</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <span id="dash-online-pill" style="display:none;align-items:center;gap:5px;background:rgba(78,203,113,.12);border:1px solid rgba(78,203,113,.3);border-radius:12px;padding:3px 12px;font-family:var(--fm);font-size:11px;color:var(--green);cursor:pointer" onclick="openFirebaseModal()">ğŸŒ 0 online</span>
          <span style="font-family:var(--fm);font-size:11px;color:var(--green)">â— Autosave ON</span>
        </div>
      </div>
      <div class="mod-body">
        <!-- Stat cards row -->
        <div class="g4" style="margin-bottom:14px;">
          <div class="stat-card sc-gold" onclick="showModule('tasks')" style="cursor:pointer">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div><div class="stat-val" id="s-total" style="color:var(--gold)">0</div><div class="stat-lbl">Total Tasks</div></div>
              <span style="font-size:22px;opacity:.18">ğŸ“‹</span>
            </div>
            <div class="pbar" style="margin-top:10px"><div class="pfill" id="s-total-p" style="background:var(--gold);width:0%"></div></div>
          </div>
          <div class="stat-card sc-green" onclick="showModule('tasks')" style="cursor:pointer">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div><div class="stat-val" id="s-done" style="color:var(--green)">0</div><div class="stat-lbl">Completed</div></div>
              <span style="font-size:22px;opacity:.18">âœ…</span>
            </div>
            <div class="pbar" style="margin-top:10px"><div class="pfill" id="s-done-p" style="background:var(--green);width:0%"></div></div>
          </div>
          <div class="stat-card sc-orange" onclick="showModule('tasks')" style="cursor:pointer">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div><div class="stat-val" id="s-ip" style="color:var(--orange)">0</div><div class="stat-lbl">In Progress</div></div>
              <span style="font-size:22px;opacity:.18">âš¡</span>
            </div>
            <div class="pbar" style="margin-top:10px"><div class="pfill" id="s-ip-p" style="background:var(--orange);width:0%"></div></div>
          </div>
          <div class="stat-card sc-red" onclick="showModule('tasks')" style="cursor:pointer">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div><div class="stat-val" id="s-bl" style="color:var(--red)">0</div><div class="stat-lbl">Blocked</div></div>
              <span style="font-size:22px;opacity:.18">ğŸ”’</span>
            </div>
            <div id="dash-health-bar" style="margin-top:10px;font-size:10px;font-family:var(--fm);color:var(--text-muted);min-height:6px"></div>
          </div>
        </div>

        <!-- Project health alerts row -->
        <div id="dash-alerts" style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap"></div>

        <!-- GDD/LDD + Team row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px">
          <div class="panel" style="padding:14px 16px">
            <div class="panel-title" style="margin-bottom:12px">ğŸ“– GDD / LDD</div>
            <div id="dash-doc-progress"></div>
          </div>
          <div class="panel" style="padding:14px 16px">
            <div class="panel-title" style="margin-bottom:12px">ğŸ“Š By Discipline</div>
            <div id="dash-disc"></div>
          </div>
          <div class="panel" style="padding:14px 16px">
            <div class="panel-title" style="margin-bottom:12px">ğŸŒ Team Online</div>
            <div id="dash-team"></div>
          </div>
        </div>

        <!-- Tasks + Deadlines row -->
        <div class="g2" style="margin-bottom:14px;">
          <div class="panel">
            <div class="panel-title" style="display:flex;align-items:center">
              ğŸ“‹ Recent Tasks
              <button class="btn btn-sm btn-gold" style="margin-left:auto;font-size:10px" onclick="showModule('tasks')">View All â†’</button>
            </div>
            <table class="ttable"><thead><tr><th>Title</th><th>Status</th><th>Priority</th><th>Discipline</th><th>Time Left</th></tr></thead>
            <tbody id="dash-tasks"></tbody></table>
          </div>
          <div class="panel">
            <div class="panel-title" style="display:flex;align-items:center">
              ğŸ“… Upcoming Deadlines
              <button class="btn btn-sm" style="margin-left:auto;font-size:10px" onclick="showModule('calendar')">Calendar â†’</button>
            </div>
            <div id="dash-events"></div>
          </div>
        </div>

        <!-- Maps + Notes row -->
        <div class="g2">
          <div class="panel">
            <div class="panel-title" style="display:flex;align-items:center">
              ğŸ—ºï¸ Maps
              <button class="btn btn-sm" style="margin-left:auto;font-size:10px" onclick="showModule('map')">Open Editor â†’</button>
            </div>
            <div id="dash-maps"></div>
          </div>
          <div class="panel">
            <div class="panel-title" style="display:flex;align-items:center;gap:8px;">
              âœ… Quick Notes
              <span id="dash-notes-count" style="font-family:var(--fm);font-size:10px;color:var(--text-muted);"></span>
              <button class="btn btn-sm" style="margin-left:auto;font-size:10px" onclick="showModule('notes')">Open Notes â†’</button>
            </div>
            <div style="margin-bottom:8px;">
              <input id="dash-note-input" class="fi" style="font-size:12px;" placeholder="Quick noteâ€¦ (Enter to add)" onkeydown="handleDashNoteKey(event,this)">
            </div>
            <div id="dash-notes-list" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== TASKS ===== -->
    <div class="module" id="module-tasks">
      <div class="mod-hdr">
        <div class="mod-title">Tasks</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button class="btn btn-gold btn-sm" onclick="openTaskModal()">+ New Task</button>
        </div>
      </div>
      <div style="padding:8px 20px;border-bottom:1px solid var(--border);flex-shrink:0;">
        <div class="tabs" id="task-tabs" style="margin-bottom:8px">
          <div class="tab active" onclick="switchTaskView('list')">List</div>
          <div class="tab" onclick="switchTaskView('kanban')">Kanban</div>
          <div class="tab" onclick="switchTaskView('calendar')">Calendar</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <select class="fs" style="width:130px;" id="f-status" onchange="filterTasks()">
            <option value="">All Status</option>
            <option>Backlog</option><option>To Do</option><option>In Progress</option>
            <option>Review</option><option>Blocked</option><option>Done</option>
          </select>
          <select class="fs" style="width:150px;" id="f-disc" onchange="filterTasks()">
            <option value="">All Disciplines</option>
            <option>Level Design</option><option>Game Design</option><option>Narrative</option>
            <option>Animator</option><option>3D Artist</option><option>Audio</option>
            <option>UI/UX</option><option>Programmer</option><option>QA</option>
          </select>
          <input class="fi" style="width:180px;" type="text" placeholder="Searchâ€¦" id="f-search" oninput="filterTasks()">
        </div>
      </div>
      <div style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
        <div class="tc active" id="tv-list" style="flex:1;overflow:auto;padding:0 20px 16px;">
          <table class="ttable" style="margin-top:10px;">
            <thead><tr><th></th><th>Title</th><th>Status</th><th>Priority</th><th>Discipline</th><th>Due Date</th><th>Est.</th><th></th></tr></thead>
            <tbody id="task-list-body"></tbody>
          </table>
        </div>
        <div class="tc" id="tv-kanban" style="flex:1;overflow:hidden;padding:10px 20px;">
          <div class="kb-board" id="kanban-board"></div>
        </div>
        <div class="tc" id="tv-calendar" style="flex:1;overflow:auto;padding:10px 20px;">
          <div id="task-cal"></div>
        </div>
      </div>
    </div>

    <!-- ===== CALENDAR ===== -->
    <div class="module" id="module-calendar">
      <div class="mod-hdr">
        <div class="mod-title">Calendar</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button class="btn btn-sm" onclick="calNav(-1)">â€¹</button>
          <span style="font-family:var(--fu);font-size:14px;font-weight:700;color:var(--gold);letter-spacing:1px;min-width:160px;text-align:center;" id="cal-month-label"></span>
          <button class="btn btn-sm" onclick="calNav(1)">â€º</button>
          <button class="btn btn-gold btn-sm" onclick="openCalEventModal()">+ Event</button>
          <button class="btn btn-sm" onclick="openTaskModal()">+ Task</button>
          <button class="btn btn-sm" onclick="exportICS()">ğŸ“¥ ICS</button>
        </div>
      </div>
      <div class="mod-body">
        <div class="cal-grid" id="cal-grid">
          <div class="cal-hdr">Mon</div><div class="cal-hdr">Tue</div><div class="cal-hdr">Wed</div>
          <div class="cal-hdr">Thu</div><div class="cal-hdr">Fri</div><div class="cal-hdr">Sat</div><div class="cal-hdr">Sun</div>
        </div>
      </div>
    </div>

    <!-- ===== GDD ===== -->
    <div class="module" id="module-gdd">
      <div class="mod-hdr">
        <div class="mod-title">GDD</div><div class="mod-sub">Game Design Document</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button class="btn btn-sm" onclick="exportGDDMarkdown()">MD</button>
          <button class="btn btn-sm" onclick="exportGDDJSON()">JSON</button>
          <button class="btn btn-gold btn-sm" onclick="exportGDDPDF()">PDF</button>
        </div>
      </div>
      <div class="doc-layout">
        <div class="doc-nav" id="gdd-nav"></div>
        <div class="doc-content" id="gdd-content"></div>
      </div>
    </div>

    <!-- ===== LDD ===== -->
    <div class="module" id="module-ldd">
      <div class="mod-hdr">
        <div class="mod-title">LDD</div><div class="mod-sub">Level Design Document</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <select class="fs" style="width:170px;" id="ldd-map-link"><option value="">Link to Mapâ€¦</option></select>
          <button class="btn btn-sm" onclick="exportLDDJSON()">JSON</button>
          <button class="btn btn-gold btn-sm" onclick="exportLDDPDF()">PDF</button>
        </div>
      </div>
      <div class="doc-layout">
        <div class="doc-nav" id="ldd-nav"></div>
        <div class="doc-content" id="ldd-content"></div>
      </div>
    </div>

    <!-- ===== MAP EDITOR ===== -->
    <div class="module" id="module-map" style="flex-direction:column;">
      <div class="mod-hdr">
        <div class="mod-title">Map Editor</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <select class="fs" style="width:170px;" id="map-sel" onchange="loadSelectedMap()"><option value="">Select Mapâ€¦</option></select>
          <button class="btn btn-gold btn-sm" onclick="newMap()">+ New Map</button>
          <button class="btn btn-sm" onclick="exportMapPNG()">PNG</button>
          <button class="btn btn-sm" onclick="exportMapJSON()">JSON</button>
          <button class="btn btn-sm" onclick="importMapJSON()">Import</button>
          <button class="btn btn-sm" style="border-color:var(--red);color:var(--red)" onclick="deleteCurrentMap()" title="Delete current map">ğŸ—‘ Delete Map</button>
          <button class="btn btn-sm" id="map-focus-btn" onclick="toggleMapFocus()" title="Expand map to full screen (F11)">â›¶ Expand</button>
        </div>
      </div>
      <div id="map-editor-wrap">
        <!-- TOP TOOLBAR -->
        <div id="map-toolbar-top">
          <div class="map-tool-group">
            <button class="mt active" id="tool-select" title="Select (W or V)" onclick="setTool('select')">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><path d="M2 2 L2 11 L5 8.5 L7 13 L8.5 12.3 L6.5 7.3 L10 7 Z"/></svg>
            </button>
            <button class="mt" id="tool-pan" title="Pan (H Â· Space)" onclick="setTool('pan')">âœ‹</button>
          </div>
          <div class="map-tool-group">
            <button class="mt" id="tool-rect" title="Rectangle (R)" onclick="setTool('rect')">â–­</button>
            <button class="mt" id="tool-wall" title="Wall (B)" onclick="setTool('wall')">â–®</button>
            <button class="mt" id="tool-poly" title="Polygon (P)" onclick="setTool('poly')">â¬¡</button>
            <button class="mt" id="tool-circle" title="Circle (C)" onclick="setTool('circle')">â—¯</button>
            <button class="mt" id="tool-text" title="Text (T)" onclick="setTool('text')">T</button>
            <button class="mt" id="tool-erase" title="Erase (E)" onclick="setTool('erase')">âœ•</button>
          </div>
          <div class="map-tool-group">
            <button class="mt" id="tool-stair" title="Stairs (S)" onclick="setTool('stair')" style="font-size:11px">âŠŸ</button>
            <button class="mt" id="tool-light" title="Light (L)" onclick="setTool('light')" style="font-size:11px">â—‰</button>
            <button class="mt" id="tool-person" title="Player/NPC (Y)" onclick="setTool('person')" style="font-size:13px">â˜º</button>
            <button class="mt" id="tool-enemy" title="Enemy (X)" onclick="setTool('enemy')" style="font-size:12px">â˜ </button>
            <button class="mt" id="tool-arrow" title="Arrow (A)" onclick="setTool('arrow')" style="font-size:13px">â¤</button>
            <button class="mt" id="tool-draw" title="Freehand Draw (D)" onclick="setTool('draw')" style="font-size:13px">âœ</button>
          </div>
          <div class="map-tool-group">
            <button class="mt" title="Undo (Ctrl+Z)" onclick="mapUndo()">â†©</button>
            <button class="mt" title="Redo (Ctrl+Y)" onclick="mapRedo()">â†ª</button>
          </div>
          <div class="map-tool-group">
            <button class="mt toggled" id="btn-grid" title="Toggle Grid (G)" onclick="toggleGrid()">âŠ</button>
            <button class="mt toggled" id="btn-snap" title="Toggle Snap (S)" onclick="toggleSnap()">âŠ•</button>
            <button class="mt" title="Fit to Screen (F)" onclick="fitToScreen()">â¤¢</button>
          </div>
          <div class="map-tool-group">
            <button class="mt" title="Zoom In (+)" onclick="zoomMap(1.2)">+</button>
            <button class="mt" title="Zoom Out (-)" onclick="zoomMap(0.83)">âˆ’</button>
          </div>
          <div class="map-tool-group">
            <button class="mt" title="Export PNG" onclick="exportMapPNG()">ğŸ“·</button>
            <button class="mt" title="Export JSON" onclick="exportMapJSON()">ğŸ’¾</button>
          </div>
          <div style="margin-left:auto;font-family:var(--fm);font-size:10px;color:var(--text-secondary);padding:0 8px;" id="map-tool-hint">Select: click to pick Â· Shift+click multi-select Â· Delete to remove</div>
        </div>
        <!-- MAIN MAP AREA -->
        <div id="map-main">
          <!-- LEFT: SHAPES PANEL -->
          <div id="map-left-panel">
            <div id="map-left-panel-hdr">
              <span style="font-family:var(--fu);font-size:10px;font-weight:700;color:var(--gold);letter-spacing:1px;flex:1">SHAPES</span>
            </div>
            <div id="map-shapes-body"></div>
          </div>
          <!-- CANVAS -->
          <div id="map-canvas-area">
            <canvas id="map-canvas" tabindex="0" style="outline:none"></canvas>
            <div id="map-no-map">
              <div class="icon">ğŸ—ºï¸</div>
              <div class="hint">Create or select a map to begin</div>
              <button class="btn btn-gold" onclick="newMap()">+ New Map</button>
            </div>
          </div>
          <!-- RIGHT: PROPERTIES + LAYERS -->
          <div id="map-right-panel">
            <div id="map-props-panel">
              <div id="map-props-hdr">Properties</div>
              <div id="map-props-body">
                <div class="empty"><div class="empty-icon">ğŸ–±ï¸</div><div class="empty-txt">Select an Object</div></div>
              </div>
            </div>
            <div id="map-layers-panel">
              <div id="map-layers-hdr">
                <span style="font-family:var(--fu);font-size:10px;font-weight:700;color:var(--gold);letter-spacing:1px;flex:1;text-transform:uppercase" data-i18n="layers">Layers</span>
                <span style="font-family:var(--fm);font-size:9px;color:var(--text-muted)" id="layers-count"></span>
                <button class="btn btn-sm" style="padding:2px 6px;font-size:10px;margin-left:4px" onclick="groupSelected()" title="Agrupar objetos seleccionados (2+)">ğŸ“ <span data-i18n="group">Group</span></button>
              </div>
              <div id="map-layers-list"></div>
            </div>
          </div>
        </div>
        <!-- STATUS BAR -->
        <div id="map-statusbar">
          <span class="sb-stat">X: <b id="sb-x">0</b></span>
          <span class="sb-stat">Y: <b id="sb-y">0</b></span>
          <span class="sb-stat">Zoom: <b id="sb-zoom">100</b>%</span>
          <span class="sb-stat">Grid: <b id="sb-grid">ON</b></span>
          <span class="sb-stat">Snap: <b id="sb-snap">ON</b></span>
          <span class="sb-stat">Objects: <b id="sb-objs">0</b></span>
          <span class="sb-stat">Layer: <b id="sb-layer">Walls</b></span>
          <span id="map-sel-name"></span>
        </div>
      </div>
    </div>

    <!-- ===== CHARTS ===== -->
    <div class="module" id="module-charts">
      <div class="mod-hdr">
        <div class="mod-title">Charts</div>
        <div style="margin-left:auto;"><button class="btn btn-sm" onclick="exportChartPNG()">Export PNG</button></div>
      </div>
      <div class="mod-body">
        <div class="tabs">
          <div class="tab active" onclick="switchChart('difficulty')">Difficulty</div>
          <div class="tab" onclick="switchChart('pacing')">Pacing</div>
          <div class="tab" onclick="switchChart('flow')">Flow</div>
        </div>
        <div class="g2">
          <div>
            <div class="panel-title" id="curve-title" style="margin-bottom:8px;">Difficulty Curve</div>
            <div class="curve-wrap"><canvas id="curve-canvas" width="600" height="300"></canvas></div>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
              <span style="font-size:11px;color:var(--text-secondary)">Click to add Â· Drag to move Â· Right-click to delete</span>
              <button class="btn btn-sm" onclick="clearCurve()" style="margin-left:auto">Clear</button>
            </div>
          </div>
          <div>
            <div class="panel-title">Curve Data</div>
            <div id="curve-pts" style="display:flex;flex-direction:column;gap:4px;max-height:280px;overflow-y:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ASSETS ===== -->
    <div class="module" id="module-assets">
      <div class="mod-hdr">
        <div class="mod-title">Assets</div>
        <div style="margin-left:auto;">
          <button class="btn btn-gold btn-sm" onclick="document.getElementById('asset-input').click()">+ Upload</button>
          <input type="file" id="asset-input" style="display:none;" multiple accept="image/*,.pdf,.json,.csv" onchange="uploadAssets(this)">
        </div>
      </div>
      <div class="mod-body">
        <div id="asset-drop" onclick="document.getElementById('asset-input').click()">
          <div style="font-size:24px;margin-bottom:6px;">ğŸ“</div>
          <div style="font-family:var(--fu);font-size:11px;letter-spacing:1px;color:var(--text-secondary)">Drop files here or click to upload</div>
        </div>
        <div class="asset-grid" id="asset-grid"></div>
      </div>
    </div>

    <!-- ===== EXPORT ===== -->
    <div class="module" id="module-export">
      <div class="mod-hdr"><div class="mod-title">Export</div></div>
      <div class="mod-body">
        <div class="g3">
          <div class="exp-card" style="border-color:var(--gold-dim);background:rgba(201,162,39,.04)"><div class="exp-card-title" style="color:var(--gold)">ğŸ“‘ Full PDF Report</div><div class="exp-card-desc">Complete project PDF: GDD + LDD + Maps in one document. Open browser print dialog to save as PDF.</div><button class="btn btn-gold" onclick="exportFullPDF()">Full PDF</button></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ“¦ Full Project</div><div class="exp-card-desc">Complete JSON backup of all GDD, LDD, Tasks, Maps, Charts and Assets. Reimport to continue editing.</div><button class="btn btn-gold" onclick="exportFullProject()">Export JSON</button></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ—ºï¸ Maps Package</div><div class="exp-card-desc">Export current map as PNG image or JSON data for re-editing.</div><div style="display:flex;gap:6px;"><button class="btn" onclick="exportMapJSON()">JSON</button><button class="btn" onclick="exportMapPNG()">PNG</button></div></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ“„ GDD</div><div class="exp-card-desc">Game Design Document as Markdown, JSON, or print as PDF.</div><div style="display:flex;gap:6px;"><button class="btn" onclick="exportGDDMarkdown()">MD</button><button class="btn" onclick="exportGDDJSON()">JSON</button><button class="btn btn-gold" onclick="exportGDDPDF()">PDF</button></div></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ“ LDD</div><div class="exp-card-desc">Level Design Document as JSON or print as PDF.</div><div style="display:flex;gap:6px;"><button class="btn" onclick="exportLDDJSON()">JSON</button><button class="btn btn-gold" onclick="exportLDDPDF()">PDF</button></div></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ“Š Charts</div><div class="exp-card-desc">Export difficulty, pacing and flow curves as PNG images.</div><button class="btn" onclick="exportChartPNG()">PNG</button></div>
          <div class="exp-card"><div class="exp-card-title">ğŸ“… Calendar</div><div class="exp-card-desc">All calendar events as ICS file for Google Calendar, Outlook, etc.</div><button class="btn" onclick="exportICS()">ICS</button></div>
        </div>
      </div>
    </div>

    <!-- ===== STUDYING ===== -->
    <div class="module" id="module-studying">
      <div class="mod-hdr">
        <div class="mod-title">ğŸ“š Studying</div>
        <div class="mod-sub">Knowledge Base &amp; Learning Hub</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button class="btn btn-gold btn-sm" onclick="openStudyNoteModal()">+ New Note</button>
          <button class="btn btn-sm" onclick="openStudyTopicModal()">+ Topic</button>
        </div>
      </div>
      <div id="study-body" style="display:flex;flex:1;overflow:hidden;">
        <!-- LEFT: Topic nav -->
        <div id="study-nav-panel" style="width:200px;background:var(--bg-panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;">
          <div style="padding:10px;border-bottom:1px solid var(--border);">
            <div class="panel-title" style="margin:0">Topics</div>
          </div>
          <div id="study-topics-nav" style="flex:1;overflow-y:auto;padding:6px;"></div>
          <div style="padding:8px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:4px;">
            <button class="btn btn-sm" style="width:100%" onclick="openStudyTopicModal()">+ Add Topic</button>
            <button class="btn btn-sm" style="width:100%;font-size:10px;color:var(--text-secondary);border-color:var(--border-dark)" onclick="openStudySectionModal()">â€” Add Section</button>
          </div>
        </div>
        <!-- RIGHT: Notes area -->
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
          <div style="padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;">
            <span style="font-family:var(--fu);font-size:14px;font-weight:700;color:var(--gold);letter-spacing:1px;" id="study-current-topic">All Notes</span>
            <input type="text" class="fi" style="max-width:200px;padding:3px 8px;font-size:11px;" placeholder="Search notesâ€¦" oninput="filterStudyNotes(this.value)" id="study-search" id="study-notes-search-row">
            <span style="font-family:var(--fm);font-size:10px;color:var(--text-secondary);" id="study-count"></span>
            <div style="margin-left:auto;display:flex;gap:4px;border-left:1px solid var(--border);padding-left:10px;">
              <button id="study-tab-notes" class="btn btn-sm" onclick="switchStudyView('notes')" style="font-size:10px;background:var(--gold);color:#000;border-color:var(--gold)">ğŸ“ Notes</button>
              <button id="study-tab-web" class="btn btn-sm" onclick="switchStudyView('web')" style="font-size:10px;">ğŸŒ Web Reader</button>
            </div>
          </div>
          <div id="study-notes-grid" style="flex:1;overflow-y:auto;padding:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;align-content:start;"></div>
          <!-- WEB READER PANEL -->
          <div id="study-webview-panel" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
            <div style="padding:6px 12px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center;flex-shrink:0;background:var(--bg-panel);">
              <input class="fi" id="study-url-bar" value="https://book.leveldesignbook.com/introduction" style="flex:1;font-size:11px;font-family:var(--fm);" placeholder="https://â€¦" onkeydown="if(event.key==='Enter')studyGoUrl()" onblur="studySaveUrl()">
              <button class="btn btn-gold btn-sm" onclick="studyGoUrl()" style="font-size:11px;">Go</button>
              <button class="btn btn-sm" onclick="window.open(document.getElementById('study-url-bar').value,'_blank')" style="font-size:11px;" title="Open in new tab">â†— New Tab</button>
              <button class="btn btn-sm" onclick="enterFocusMode()" style="font-size:11px;border-color:var(--gold-dim);color:var(--gold)" title="Focus mode â€” hide all panels">â›¶ Focus</button>
            </div>
            <div id="study-iframe-wrap" style="flex:1;position:relative;overflow:hidden;">
              <iframe id="study-iframe" style="width:100%;height:100%;border:none;display:block;" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>
              <div id="study-iframe-blocked" style="display:none;position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-main);gap:12px;">
                <div style="font-size:32px">ğŸš«</div>
                <div style="font-family:var(--fu);font-size:13px;color:var(--text-primary);">This site blocks embedding</div>
                <div style="font-size:11px;color:var(--text-secondary);max-width:320px;text-align:center">Some sites prevent being shown in iframes. Use the button below to open it in a new tab.</div>
                <button class="btn btn-gold" onclick="window.open(document.getElementById('study-url-bar').value,'_blank')">â†— Open in New Tab</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== NOTES / CHECKLIST ===== -->
    <div class="module" id="module-notes">
      <div class="mod-hdr">
        <div class="mod-title">âœ… Notes</div>
        <div class="mod-sub">Checklist &amp; Quick Notes</div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button class="btn btn-gold btn-sm" onclick="openNotesListModal()">+ New List</button>
        </div>
      </div>
      <div id="notes-body" style="display:flex;flex:1;overflow:hidden;">
        <!-- LEFT: Lists nav -->
        <div id="notes-nav-panel" style="width:200px;background:var(--bg-panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;">
          <div style="padding:10px;border-bottom:1px solid var(--border);">
            <div class="panel-title" style="margin:0">Lists</div>
          </div>
          <div id="notes-lists-nav" style="flex:1;overflow-y:auto;padding:6px;"></div>
          <div style="padding:8px;border-top:1px solid var(--border);">
            <button class="btn btn-sm" style="width:100%" onclick="openNotesListModal()">+ Add List</button>
          </div>
        </div>
        <!-- RIGHT: Checklist items -->
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
          <!-- Header -->
          <div style="padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;">
            <span id="notes-active-title" style="font-family:var(--fu);font-size:14px;font-weight:700;color:var(--gold);letter-spacing:1px;">All Notes</span>
            <span id="notes-progress-lbl" style="font-family:var(--fm);font-size:10px;color:var(--text-muted);"></span>
            <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
              <button class="btn btn-sm" style="font-size:10px;" onclick="clearDoneNotes()">Clear Done</button>
            </div>
          </div>
          <!-- Quick-add input -->
          <div style="padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0;">
            <input id="notes-quick-input" placeholder="âœ Type a note and press Enter to addâ€¦" onkeydown="if(event.key==='Enter'&&this.value.trim()){quickAddNote(this.value.trim());this.value='';}" autocomplete="off">
          </div>
          <!-- Items -->
          <div id="notes-items-list" style="flex:1;overflow-y:auto;padding:12px 16px;"></div>
        </div>
      </div>
    </div>

  </div><!-- #content -->
</div><!-- #main -->

<!-- FOCUS MODE EXIT BUTTON -->
<button id="focus-btn" class="btn btn-sm" onclick="exitFocusMode()" style="background:rgba(0,0,0,.7);border:1px solid var(--border);color:var(--text-secondary);font-size:11px;padding:4px 10px;border-radius:4px;cursor:pointer;align-items:center;gap:5px;">âœ• Exit Focus</button>

<!-- MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal-title" id="modal-title"></div>
    <div id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<!-- FIELD SAVED INDICATOR -->
<div class="field-saved" id="field-saved">âœ“ Saved</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECT STORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PS = {
  data: {
    currentProject: 'Project Alpha',
    docs: { gdd: {}, ldd: {} },
    maps: [], tasks: [], assets: [],
    charts: { difficulty: [], pacing: [], flow: [] },
    calendarEvents: [],
    studying: { topics: [], notes: [] },
    notes: { lists: [{ id:'nl_default', name:'General', color:'#c9a227', icon:'ğŸ“‹', items:[] }], activeList:'nl_default' },
    settings: { lang: 'en', autosave: true }
  },
  save() {
    try { localStorage.setItem('igs_v2', JSON.stringify(this.data)); } catch(e){}
    this._idbSave();
    setSaveStatus('saved');
  },
  load() {
    try {
      const r = localStorage.getItem('igs_v2');
      if (r) this._merge(JSON.parse(r));
    } catch(e){}
  },
  // granular=true â†’ only overwrite sections where remote timestamp is newer (collaborative mode)
  // granular=false â†’ full overwrite (local load, uploadMyData, first sync)
  _merge(p, granular) {
    if (!p) return;
    const keepLocalTs = this.data._localTs;
    const localSTs    = this.data._sectionTs || {};
    const remoteSTs   = p._sectionTs || {};
    // Returns the winning value for a section
    const _s = (key, def) => {
      if (!granular) return p[key] !== undefined ? p[key] : def;
      const rTs = remoteSTs[key] || 0;
      const lTs = localSTs[key]  || 0;
      return rTs > lTs ? (p[key] !== undefined ? p[key] : def)
                       : (this.data[key] !== undefined ? this.data[key] : def);
    };
    this.data.tasks          = _s('tasks', []);
    this.data.maps           = _s('maps', []);
    this.data.calendarEvents = _s('calendarEvents', []);
    this.data.assets         = _s('assets', []);
    this.data.charts         = _s('charts', { difficulty:[], pacing:[], flow:[] });
    this.data.docs           = _s('docs', { gdd:{}, ldd:{} });
    this.data.settings       = _s('settings', { lang:'en', autosave:true });
    this.data.currentProject = _s('currentProject', 'Project Alpha');
    this.data.studying       = _s('studying', { topics:[], notes:[] });
    this.data.notes          = _s('notes', { lists:[{id:'nl_default',name:'General',color:'#c9a227',icon:'ğŸ“‹',items:[]}], activeList:'nl_default' });
    // Merge _sectionTs â€” keep max per section so neither side forgets its own work
    if (!this.data._sectionTs) this.data._sectionTs = {};
    ['tasks','maps','calendarEvents','assets','charts','docs','settings','currentProject','studying','notes']
      .forEach(s => { this.data._sectionTs[s] = Math.max(remoteSTs[s]||0, localSTs[s]||0); });
    if (keepLocalTs) this.data._localTs = keepLocalTs;
  },
  _idbSave() {
    if (!window.indexedDB) return;
    const req = indexedDB.open('IGS2', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('s');
    req.onsuccess = e => {
      try { e.target.result.transaction('s','readwrite').objectStore('s').put(JSON.stringify(this.data),'main'); } catch(e){}
    };
  },
  loadIDB(cb) {
    if (!window.indexedDB) { cb(); return; }
    const req = indexedDB.open('IGS2', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('s');
    req.onsuccess = e => {
      try {
        const g = e.target.result.transaction('s','readonly').objectStore('s').get('main');
        g.onsuccess = ev => { if(ev.target.result) this._merge(JSON.parse(ev.target.result)); cb(); };
        g.onerror = () => cb();
      } catch(e) { cb(); }
    };
    req.onerror = () => cb();
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// I18N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const I18 = {
  en: {
    save:'Save', dashboard:'Dashboard', tasks:'Tasks', calendar:'Calendar',
    gdd:'GDD', ldd:'LDD', map:'Map Editor', charts:'Charts', assets:'Assets',
    export:'Export', studying:'Studying', notes:'Notes',
    navigation:'Navigation', study:'Study',
    layers:'Layers', objects:'objects', noObjects:'No objects',
    lockTip:'Locked â€” click to unlock', unlockTip:'Unlocked â€” click to lock',
    showTip:'Show', hideTip:'Hide', dragTip:'Drag to reorder',
    dblclickRename:'Double-click to rename',
    groupLocked:'Group locked', groupUnlocked:'Group unlocked',
    fitScreen:'Fit to screen', focusSelected:'Focus selection',
    tools:'Tools', select:'Select', pan:'Pan', rect:'Rectangle', wall:'Wall',
    circle:'Circle', text:'Text', poly:'Polygon', erase:'Erase',
    stair:'Stairs', light:'Light', person:'Person', enemy:'Enemy',
    arrow:'Arrow', draw:'Freehand',
    newMap:'New Map', deleteMap:'Delete Map', fitBtn:'Fit',
    grid:'Grid', snap:'Snap',
    newTask:'New Task', addTask:'Add taskâ€¦',
    saveAll:'Save All', saving:'Savingâ€¦', saved:'Saved',
    search:'Searchâ€¦', project:'Project',
    lock:'Lock', unlock:'Unlock', show:'Show', hide:'Hide',
    delete:'Delete', duplicate:'Duplicate', group:'Group', ungroup:'Ungroup',
    rename:'Rename', cancel:'Cancel', confirm:'Confirm',
    exportPDF:'Export PDF', exportJSON:'Export JSON',
    addImage:'Add Image', noCaption:'Add titleâ€¦',
    fKeyHint:'F = focus selected / fit all'
  },
  es: {
    save:'Guardar', dashboard:'Panel', tasks:'Tareas', calendar:'Calendario',
    gdd:'GDD', ldd:'LDD', map:'Editor de Mapas', charts:'GrÃ¡ficos', assets:'Assets',
    export:'Exportar', studying:'Estudio', notes:'Notas',
    navigation:'NavegaciÃ³n', study:'Estudio',
    layers:'Capas', objects:'objetos', noObjects:'Sin objetos',
    lockTip:'Bloqueado â€” click para desbloquear', unlockTip:'Desbloqueado â€” click para bloquear',
    showTip:'Mostrar', hideTip:'Ocultar', dragTip:'Arrastrar para reordenar',
    dblclickRename:'Doble-click para renombrar',
    groupLocked:'Grupo bloqueado', groupUnlocked:'Grupo desbloqueado',
    fitScreen:'Ajustar pantalla', focusSelected:'Enfocar selecciÃ³n',
    tools:'Herramientas', select:'Seleccionar', pan:'Mover', rect:'RectÃ¡ngulo', wall:'Pared',
    circle:'CÃ­rculo', text:'Texto', poly:'PolÃ­gono', erase:'Borrar',
    stair:'Escalera', light:'Luz', person:'Persona', enemy:'Enemigo',
    arrow:'Flecha', draw:'Dibujo libre',
    newMap:'Nuevo Mapa', deleteMap:'Eliminar Mapa', fitBtn:'Ajustar',
    grid:'Grilla', snap:'ImÃ¡n',
    newTask:'Nueva Tarea', addTask:'Agregar tareaâ€¦',
    saveAll:'Guardar Todo', saving:'Guardandoâ€¦', saved:'Guardado',
    search:'Buscarâ€¦', project:'Proyecto',
    lock:'Bloquear', unlock:'Desbloquear', show:'Mostrar', hide:'Ocultar',
    delete:'Eliminar', duplicate:'Duplicar', group:'Agrupar', ungroup:'Desagrupar',
    rename:'Renombrar', cancel:'Cancelar', confirm:'Confirmar',
    exportPDF:'Exportar PDF', exportJSON:'Exportar JSON',
    addImage:'Agregar Imagen', noCaption:'Agregar tÃ­tuloâ€¦',
    fKeyHint:'F = enfocar selecciÃ³n / ajustar todo'
  }
};
let lang = 'en';
function t(k) { return (I18[lang]&&I18[lang][k]) || (I18.en[k]) || k; }
function setLang(l) {
  lang = l;
  PS.data.settings.lang = l;
  document.getElementById('lang-en').classList.toggle('active', l==='en');
  document.getElementById('lang-es').classList.toggle('active', l==='es');
  // Apply translations to all [data-i18n] elements
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.dataset.i18n;
    const txt=t(key);
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA') el.placeholder=txt;
    else el.textContent=txt;
  });
  // Update placeholders with data-i18n-ph
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    el.placeholder=t(el.dataset.i18nPh);
  });
  autoSave();
  // Re-render active module to pick up translated strings
  renderMapLayers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARGENTINA CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _prevDigits = ['0','0',':','0','0',':','0','0'];
function updateARClock() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const arTime = new Date(utc - 3 * 3600000);
  const h = String(arTime.getHours()).padStart(2,'0');
  const m = String(arTime.getMinutes()).padStart(2,'0');
  const s = String(arTime.getSeconds()).padStart(2,'0');
  const chars = [h[0], h[1], ':', m[0], m[1], ':', s[0], s[1]];
  const DH = 22; // digit height in px

  const container = document.getElementById('ar-clock-digits');
  if (!container) return;
  if (container.children.length === 0) {
    container.innerHTML = '';
    chars.forEach((c, i) => {
      if (c === ':') {
        const sep = document.createElement('span');
        sep.className = 'colon-sep';
        sep.textContent = ':';
        container.appendChild(sep);
      } else {
        const digitWrap = document.createElement('div');
        digitWrap.className = 'digit';
        digitWrap.id = 'digit-' + i;
        const inner = document.createElement('div');
        inner.className = 'digit-inner';
        for (let n = 0; n <= 9; n++) {
          const dc = document.createElement('div');
          dc.className = 'digit-char';
          dc.textContent = String(n);
          inner.appendChild(dc);
        }
        digitWrap.appendChild(inner);
        container.appendChild(digitWrap);
      }
    });
  }

  chars.forEach((c, i) => {
    if (c === ':') return;
    const digitEl = document.getElementById('digit-' + i);
    if (!digitEl) return;
    const inner = digitEl.querySelector('.digit-inner');
    if (inner && c !== _prevDigits[i]) {
      const n = parseInt(c);
      inner.style.transform = `translateY(-${n * DH}px)`;
    }
  });
  _prevDigits = chars;
}
setInterval(updateARClock, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSaveStatus(s) {
  const el = document.getElementById('save-ind');
  if (!el) return;
  if (s === 'saving') { el.className = 'saving'; el.textContent = 'â— Savingâ€¦'; }
  else { el.className = 'saved'; el.textContent = 'â— Saved ' + new Date().toLocaleTimeString(); }
}

let _autoSaveTimer;
let _fbQuickTimer;
// Maps sidebar module id â†’ PS.data section key
const _MOD_SECTION = { tasks:'tasks', map:'maps', notes:'notes', calendar:'calendarEvents',
                       gdd:'docs', ldd:'docs', charts:'charts', assets:'assets', studying:'studying' };
// Sections locally modified but not yet confirmed pushed â€” protected from remote overwrite
const _ALL_SECTIONS = ['tasks','maps','calendarEvents','assets','charts','docs','settings','currentProject','studying','notes'];
let _localDirty = new Set();

function autoSave() {
  if (!PS.data.settings.autosave) return;
  // Tag which section changed based on the currently active module
  const mod = document.querySelector('.sb-item.active')?.dataset?.mod;
  const section = _MOD_SECTION[mod];
  if (section) {
    if (!PS.data._sectionTs) PS.data._sectionTs = {};
    PS.data._sectionTs[section] = Date.now();
    _localDirty.add(section);  // mark as unsaved local change
  }
  // Fast Firebase push â€” 800ms after last change (real-time feel)
  clearTimeout(_fbQuickTimer);
  _fbQuickTimer = setTimeout(() => { collectDocData(); mapSaveCurrent(); FIREBASE.push(); }, 800);
  // Full local save â€” 3s
  clearTimeout(_autoSaveTimer);
  _autoSaveTimer = setTimeout(() => {
    collectDocData(); mapSaveCurrent();
    PS.data._localTs = Date.now();
    PS.save();
    if (CLOUD.enabled) cloudPush();
    if (_BC) { clearTimeout(_bcTimer); _bcTimer = setTimeout(_bcBroadcastSave, 200); }
  }, 3000);
}

function saveAll() {
  setSaveStatus('saving');
  collectDocData();
  mapSaveCurrent();
  setTimeout(() => {
    // Mark all sections as saved now so future remote merges respect our full save
    const now = Date.now();
    if (!PS.data._sectionTs) PS.data._sectionTs = {};
    _ALL_SECTIONS.forEach(s => { PS.data._sectionTs[s] = now; });
    PS.data._localTs = now;
    PS.save();
    if (CLOUD.enabled) cloudPush();
    FIREBASE.push();
    if (_BC) _bcBroadcastSave();
  }, 100);
  showToast('Project saved âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModule(name) {
  closeMobSidebar();
  document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(s => s.classList.toggle('active', s.dataset.mod === name));
  const mod = document.getElementById('module-' + name);
  if (mod) mod.classList.add('active');
  if (name === 'dashboard') refreshDashboard();
  if (name === 'tasks') renderTasks();
  if (name === 'calendar') renderCalendar();
  if (name === 'map') { initMapEditor(); renderMapSelect(); }
  if (name === 'charts') initCurveEditor();
  if (name === 'assets') renderAssets();
  if (name === 'ldd') { populateLDDMapLink(); }
  if (name === 'studying') { ensureStudying(); renderStudyTopics(); renderStudyNotes(); }
  if (name === 'notes') { ensureNotes(); renderNotesLists(); renderNotesItems(); }
  // Update presence immediately so others see which module you switched to
  if (FIREBASE._ready) FIREBASE._writePresence();
}

function gotoLC(mod) {
  document.querySelectorAll('.lc-step').forEach((s,i) => {
    s.classList.toggle('active', ['gdd','ldd','map','tasks','charts','export'][i] === mod);
  });
  showModule(mod);
}

function switchProject(name) { PS.data.currentProject = name; autoSave(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.innerHTML = msg;  // supports HTML links for email reminders
  el.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL-TIME CROSS-TAB SYNC (BroadcastChannel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _BC = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel('invictus_sync') : null;
const _MY_TAB = Date.now().toString(36) + Math.random().toString(36).slice(2,5);
let _activeTabs = {};
let _bcSyncPending = false;

function _bcBroadcastSave() {
  if (!_BC) return;
  try { _BC.postMessage({type:'save',tab:_MY_TAB,payload:JSON.stringify(PS.data)}); } catch(e){}
}
function _bcBroadcastPresence() {
  if (!_BC) return;
  const mod = document.querySelector('.sb-item.active')?.dataset?.mod || 'dashboard';
  _BC.postMessage({type:'presence',tab:_MY_TAB,section:mod,time:Date.now()});
}
function _bcUpdateCollabUI() {
  const now = Date.now();
  Object.keys(_activeTabs).forEach(t=>{ if(now-_activeTabs[t].time>12000) delete _activeTabs[t]; });
  const cnt = Object.keys(_activeTabs).length;
  const el = document.getElementById('collab-ind');
  if (!el) return;
  if (cnt > 0) {
    const sections = [...new Set(Object.values(_activeTabs).map(t=>t.section))].join(', ');
    el.textContent = 'â— ' + cnt + ' tab' + (cnt>1?'s':'') + ' open Â· ' + sections;
    el.style.display = '';
  } else {
    el.style.display = 'none';
  }
}
function _bcApplyRemoteData(data) {
  try {
    PS._merge(data);
    // Re-render current module
    const mod = document.querySelector('.sb-item.active')?.dataset?.mod;
    if (mod) showModule(mod);
    showToast('ğŸ”„ Synced from another tab');
  } catch(e){}
}

if (_BC) {
  _BC.onmessage = function(e) {
    const d = e.data;
    if (!d || d.tab === _MY_TAB) return;
    if (d.type === 'save') {
      _activeTabs[d.tab] = {time:Date.now(), section:d.section||'â€“'};
      _bcUpdateCollabUI();
      if (!_bcSyncPending) {
        _bcSyncPending = true;
        setTimeout(()=>{ _bcSyncPending=false; try{_bcApplyRemoteData(JSON.parse(d.payload));}catch(ex){} }, 800);
      }
    } else if (d.type === 'presence') {
      _activeTabs[d.tab] = {time:Date.now(), section:d.section||'â€“'};
      _bcUpdateCollabUI();
    } else if (d.type === 'bye') {
      delete _activeTabs[d.tab];
      _bcUpdateCollabUI();
    }
  };
  window.addEventListener('beforeunload', ()=> { try{_BC.postMessage({type:'bye',tab:_MY_TAB});}catch(e){} });
  setInterval(_bcBroadcastPresence, 5000);
  setTimeout(_bcBroadcastPresence, 500);
}

let _bcTimer;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOUD SYNC â€” JSONBin.io (free, no server needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLOUD = {
  apiKey: '',
  binId: '',
  enabled: false,
  polling: null,
  lastVersion: null,
  pushing: false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE REALTIME DATABASE â€” real-time sync + presence + location
// REST API + SSE + polling fallback â€” no SDK needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _fbPresence = {};

const FIREBASE = {
  dbUrl:     'https://invictus-game-studio-default-rtdb.firebaseio.com',
  projectId: localStorage.getItem('fb_project') || 'default',
  userName:  localStorage.getItem('fb_username') || ('User_' + Math.random().toString(36).slice(2,5).toUpperCase()),
  sessionId: 'sess_' + Date.now().toString(36) + Math.random().toString(36).slice(2),
  _userInfo: { ip:'', city:'', country:'', flag:'ğŸŒ' },

  _throttleTimer: null, _throttleDelay: 200,
  _pendingWrite:  false,
  _stateSse:      null, _presSse: null,
  _heartbeat:     null, _pollTimer: null,
  _ready:         false, _writeQueue: false,
  _lastRemoteTs:  0,
  _pendingPayload: null,
  _log:           [],

  // â”€â”€ URLs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  get _stateUrl()  { return `${this.dbUrl}/projects/${this.projectId}/state.json`; },
  get _presUrl()   { return `${this.dbUrl}/projects/${this.projectId}/presence.json`; },
  get _myPresUrl() { return `${this.dbUrl}/projects/${this.projectId}/presence/${this.sessionId}.json`; },

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async init() {
    this._setStatus('connecting', 'Firebaseâ€¦');
    this._addLog('ğŸ”Œ Connecting ("' + this.projectId + '")â€¦');
    try {
      await this._fetchUserInfo();
      await this._loadState();
      this._subscribeState();
      this._subscribePresence();
      this._startHeartbeat();
      this._startPolling();
      this._ready = true;
      this._addLog('âœ“ Ready â€” SSE + polling active');
      if (this._writeQueue) { this._writeQueue = false; this._doWrite(); }
    } catch(err) {
      console.error('[Firebase] init failed:', err);
      this._setStatus('error', 'âš  Firebase offline');
      this._addLog('âœ— Init error: ' + err.message);
      showToast('âš  Firebase offline â€” ' + (err.message || 'check rules'));
    }
  },

  push() {
    if (!this._ready) { this._writeQueue = true; return; }
    if (this._throttleTimer) { this._pendingWrite = true; return; }
    this._doWrite();
    this._throttleTimer = setTimeout(() => {
      this._throttleTimer = null;
      if (this._pendingWrite) { this._pendingWrite = false; this.push(); }
    }, this._throttleDelay);
  },

  setProject(id) {
    if (!id || id === this.projectId) return;
    this._cleanup(); this.projectId = id;
    localStorage.setItem('fb_project', id);
    this._ready = false; this.init();
  },

  setUserName(name) {
    if (!name) return;
    this.userName = name; localStorage.setItem('fb_username', name);
  },

  // â”€â”€ Geo: fetch IP + city + country â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async _fetchUserInfo() {
    try {
      const res = await fetch('https://ipapi.co/json/', { cache:'force-cache' });
      if (!res.ok) return;
      const d = await res.json();
      const flag = d.country_code
        ? String.fromCodePoint(...[...d.country_code.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65))
        : 'ğŸŒ';
      this._userInfo = { ip: d.ip||'', city: d.city||'', country: d.country_name||'', flag };
    } catch(e) { this._userInfo = { ip:'', city:'', country:'', flag:'ğŸŒ' }; }
  },

  // â”€â”€ Load initial state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async _loadState() {
    const res = await fetch(this._stateUrl, { cache:'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status + ' â€” check Firebase rules');
    const payload = await res.json();

    if (payload && payload.data) {
      const firebaseTs    = payload.ts || 0;
      const localTs       = PS.data._localTs || 0;
      // Old-format Firebase data (no _sectionTs) should NEVER overwrite local
      const fbIsNewFormat = payload.data._sectionTs &&
                            Object.keys(payload.data._sectionTs).length > 0;

      if (firebaseTs > localTs && localTs > 0 && fbIsNewFormat) {
        // Firebase is newer, has new format, and we have a local ts â†’ safe to merge
        this._lastRemoteTs = firebaseTs;
        PS._merge(payload.data); _fbApply();
        this._addLog('âœ“ Firebase newer (new format) â€” merged');
      } else {
        // Local is newer, OR no local ts yet, OR Firebase has old-format data â†’ push local
        const reason = !fbIsNewFormat ? 'old-format data in Firebase' :
                       !localTs       ? 'first run' : 'local is newer';
        this._addLog('â¬† Pushing local â†’ Firebase (' + reason + ')');
        await this._doWrite();
      }
    } else {
      this._addLog('â„¹ Empty DB â€” seeding with local data');
      await this._doWrite();
    }
  },

  // â”€â”€ State SSE (instant push when anyone writes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _subscribeState() {
    if (this._stateSse) { try { this._stateSse.close(); } catch(e) {} }
    this._stateSse = new EventSource(this._stateUrl);
    this._stateSse.addEventListener('put', e => {
      try {
        const ev = JSON.parse(e.data);
        if (!ev || ev.data === null) return;
        const payload = ev.data;
        if (!payload || !payload.data) return;
        if (payload.sessionId === this.sessionId) return;          // our own echo â€” skip
        if (payload.ts && payload.ts <= this._lastRemoteTs) return; // already applied
        this._lastRemoteTs = payload.ts || Date.now();
        const sender = payload.userName || (payload.sessionId||'?').slice(0,8);
        this._addLog('â¬‡ ' + sender + ' updated');
        // Find which sections the remote actually changed
        const remSTs = (payload.data._sectionTs) || {};
        const locSTs = (PS.data._sectionTs)      || {};
        const changedSecs = _ALL_SECTIONS.filter(s => (remSTs[s]||0) > (locSTs[s]||0));
        const conflicts   = changedSecs.filter(s => _localDirty.has(s));
        if (conflicts.length > 0) {
          // Remote changed something we also modified locally â€” show banner, don't overwrite
          this._pendingPayload = payload;
          _showUpdateBanner(sender, changedSecs, conflicts);
          this._addLog('âš  Conflict on: ' + conflicts.join(', '));
        } else {
          // Safe to merge â€” no dirty conflict
          PS._merge(payload.data, true); _fbApply();
          _showUpdateBanner(sender, changedSecs, []);  // notification-only banner (no conflict)
        }
        this._setStatus('ok', 'â¬‡ Synced');
        setTimeout(() => this._setStatus('ok', this._lbl()), 3000);
      } catch(err) { console.warn('[Firebase] SSE put error:', err); }
    });
    this._stateSse.addEventListener('patch', e => {
      try {
        const ev = JSON.parse(e.data);
        if (!ev || !ev.data) return;
        const p = ev.data;
        if (p.sessionId === this.sessionId) return;
        if (p.data) { PS._merge(p.data); _fbApply(); }
      } catch(e) {}
    });
    this._stateSse.onerror = () => {
      this._addLog('âš  SSE dropped â€” reconnect in 5s');
      this._setStatus('error', 'âš  Reconnectingâ€¦');
      try { this._stateSse.close(); } catch(e) {}
      setTimeout(() => this._subscribeState(), 5000);
    };
  },

  // â”€â”€ Presence SSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _subscribePresence() {
    if (this._presSse) { try { this._presSse.close(); } catch(e) {} }
    this._presSse = new EventSource(this._presUrl);
    this._presSse.addEventListener('put', e => {
      try {
        const ev = JSON.parse(e.data);
        if (ev.path === '/') { _fbPresence = ev.data || {}; }
        else {
          const k = ev.path.replace(/^\//, '');
          if (ev.data === null) delete _fbPresence[k]; else _fbPresence[k] = ev.data;
        }
        _renderOnlineBar(); this._setStatus('ok', this._lbl());
      } catch(e) {}
    });
    this._presSse.addEventListener('patch', e => {
      try {
        const d = (JSON.parse(e.data)||{}).data || {};
        Object.keys(d).forEach(k => { if (d[k]===null) delete _fbPresence[k]; else _fbPresence[k]=d[k]; });
        _renderOnlineBar(); this._setStatus('ok', this._lbl());
      } catch(e) {}
    });
    this._presSse.onerror = () => {
      try { this._presSse.close(); } catch(e) {}
      setTimeout(() => this._subscribePresence(), 8000);
    };
  },

  // â”€â”€ Polling fallback every 5s (SSE backup) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startPolling() {
    if (this._pollTimer) clearInterval(this._pollTimer);
    this._pollTimer = setInterval(async () => {
      try {
        // Shallow fetch: gets sessionId+ts without downloading full PS.data
        const r = await fetch(this._stateUrl + '?shallow=true', { cache:'no-store' });
        if (!r.ok) return;
        const meta = await r.json();
        if (!meta || !meta.ts) return;
        if (meta.sessionId === this.sessionId) return;  // our own write
        if (meta.ts <= this._lastRemoteTs) return;       // already applied
        // New data from another user â€” fetch full payload
        this._addLog('â¬‡ Poll detected new data');
        const r2 = await fetch(this._stateUrl, { cache:'no-store' });
        if (!r2.ok) return;
        const payload = await r2.json();
        if (payload && payload.data) {
          this._lastRemoteTs = payload.ts || Date.now();
          const sender = payload.userName || (payload.sessionId||'?').slice(0,8);
          this._addLog('â¬‡ Poll: ' + sender + ' updated');
          const remSTs2 = (payload.data._sectionTs) || {};
          const locSTs2 = (PS.data._sectionTs)      || {};
          const changedSecs2 = _ALL_SECTIONS.filter(s => (remSTs2[s]||0) > (locSTs2[s]||0));
          const conflicts2   = changedSecs2.filter(s => _localDirty.has(s));
          if (conflicts2.length > 0) {
            this._pendingPayload = payload;
            _showUpdateBanner(sender, changedSecs2, conflicts2);
          } else {
            PS._merge(payload.data, true); _fbApply();
            _showUpdateBanner(sender, changedSecs2, []);
          }
          this._setStatus('ok', 'â¬‡ Synced');
          setTimeout(() => this._setStatus('ok', this._lbl()), 3000);
        }
      } catch(e) {}
    }, 5000);
  },

  // â”€â”€ Heartbeat: write presence every 8s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startHeartbeat() {
    this._writePresence();
    this._heartbeat = setInterval(() => { this._writePresence(); this._cleanStalePresence(); }, 8000);
    window.addEventListener('beforeunload', () => {
      fetch(this._myPresUrl, { method:'DELETE', keepalive:true }).catch(()=>{});
    });
  },

  _writePresence() {
    const mod  = document.querySelector('.sb-item.active')?.dataset?.mod || '';
    const info = { name:this.userName, ts:Date.now(), sessionId:this.sessionId, mod, ...this._userInfo };
    fetch(this._myPresUrl, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(info) })
      .catch(e => console.warn('[Firebase] presence error:', e));
  },

  _cleanStalePresence() {
    const cutoff = Date.now() - 25000;
    Object.entries(_fbPresence).forEach(([k,v]) => {
      if (v && v.ts < cutoff && k !== this.sessionId)
        fetch(`${this.dbUrl}/projects/${this.projectId}/presence/${k}.json`, { method:'DELETE' }).catch(()=>{});
    });
  },

  _cleanup() {
    if (this._stateSse) { try { this._stateSse.close(); } catch(e) {} this._stateSse = null; }
    if (this._presSse)  { try { this._presSse.close();  } catch(e) {} this._presSse  = null; }
    if (this._heartbeat) { clearInterval(this._heartbeat); this._heartbeat = null; }
    if (this._pollTimer) { clearInterval(this._pollTimer); this._pollTimer = null; }
    fetch(this._myPresUrl, { method:'DELETE', keepalive:true }).catch(()=>{});
  },

  // â”€â”€ Write state to Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async _doWrite() {
    const payload = { data: PS.data, sessionId: this.sessionId, ts: Date.now(), userName: this.userName };
    this._setStatus('saving', 'â¬† Savingâ€¦');
    try {
      const res = await fetch(this._stateUrl, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });
      if (res.ok) {
        this._addLog('â¬† Saved OK');
        this._setStatus('ok', this._lbl());
        _localDirty.clear();  // push confirmed â€” no longer dirty
      } else {
        this._addLog('âœ— Write HTTP ' + res.status);
        this._setStatus('error', 'âš  Write err ' + res.status);
        if (res.status === 401 || res.status === 403)
          showToast('âš  Firebase: Permission denied â€” update rules in Firebase Console');
        else showToast('âš  Firebase write error ' + res.status);
      }
    } catch(err) {
      this._addLog('âœ— Network: ' + err.message);
      this._setStatus('error', 'âš  Offline');
      showToast('âš  Firebase: no connection');
    }
  },

  // â”€â”€ Force sync (manual button) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â”€â”€ Upload local data â†’ Firebase (replaces whatever is there) â”€
  async uploadMyData() {
    this._addLog('â¬† Uploading local data to Firebaseâ€¦');
    showToast('â¬† Uploading your data to Firebaseâ€¦');
    try {
      collectDocData(); mapSaveCurrent();
      const now = Date.now();
      // Stamp ALL sections so the receiving tab's granular merge always applies our data
      if (!PS.data._sectionTs) PS.data._sectionTs = {};
      _ALL_SECTIONS.forEach(s => { PS.data._sectionTs[s] = now; });
      PS.data._localTs = now;
      PS.save();
      await this._doWrite();
      showToast('âœ“ Your data is now in Firebase!');
      this._addLog('âœ“ Upload complete â€” ts=' + PS.data._localTs);
    } catch(e) {
      showToast('âš  Upload failed: ' + e.message);
      this._addLog('âœ— Upload failed: ' + e.message);
    }
  },

  async forceSync() {
    this._addLog('â¬‡ Force syncâ€¦');
    showToast('ğŸ”„ Syncing from Firebaseâ€¦');
    try {
      const res = await fetch(this._stateUrl, { cache:'no-store' });
      if (!res.ok) { showToast('âš  HTTP ' + res.status); this._addLog('âœ— HTTP ' + res.status); return; }
      const payload = await res.json();
      if (payload && payload.data) {
        this._lastRemoteTs = payload.ts || 0;
        PS._merge(payload.data); _fbApply();
        showToast('âœ“ Synced!'); this._addLog('âœ“ Force sync OK');
      } else { showToast('Firebase path empty'); }
    } catch(e) { showToast('âš  ' + e.message); this._addLog('âœ— ' + e.message); }
  },

  // â”€â”€ Test connection diagnostic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async testConnection() {
    const el = document.getElementById('fb-test-result');
    if (el) el.innerHTML = '<span style="color:var(--gold)">Testingâ€¦</span>';
    let html = '';
    try {
      const res = await fetch(this._stateUrl + '?shallow=true', { cache:'no-store' });
      if (res.ok) { html += '<div style="color:var(--green)">âœ“ Read OK (HTTP ' + res.status + ')</div>'; }
      else {
        html += '<div style="color:var(--red)">âœ— Read FAILED â€” HTTP ' + res.status + '</div>';
        if (res.status===401||res.status===403)
          html += '<div style="color:var(--text-muted);font-size:10px">â†’ Firebase Console â†’ Realtime Database â†’ Rules â†’ set .read/.write = true</div>';
      }
    } catch(e) { html += '<div style="color:var(--red)">âœ— Read ERROR: ' + e.message + '</div>'; }
    try {
      const testUrl = `${this.dbUrl}/projects/${this.projectId}/__ping.json`;
      const res = await fetch(testUrl, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ts:Date.now()}) });
      if (res.ok) { html += '<div style="color:var(--green)">âœ“ Write OK</div>'; fetch(testUrl,{method:'DELETE'}).catch(()=>{}); }
      else html += '<div style="color:var(--red)">âœ— Write FAILED â€” HTTP ' + res.status + '</div>';
    } catch(e) { html += '<div style="color:var(--red)">âœ— Write ERROR: ' + e.message + '</div>'; }
    try {
      const res = await fetch(this._presUrl + '?shallow=true', { cache:'no-store' });
      if (res.ok) {
        const d = await res.json().catch(()=>null);
        html += '<div style="color:var(--green)">âœ“ Presence OK â€” ' + (d?Object.keys(d).length:0) + ' session(s)</div>';
      } else html += '<div style="color:var(--red)">âœ— Presence FAILED â€” HTTP ' + res.status + '</div>';
    } catch(e) { html += '<div style="color:var(--red)">âœ— Presence ERROR: ' + e.message + '</div>'; }
    if (el) el.innerHTML = html;
  },

  // â”€â”€ Live log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _addLog(msg) {
    const t = new Date().toLocaleTimeString();
    this._log.unshift('[' + t + '] ' + msg);
    if (this._log.length > 8) this._log.pop();
    const el = document.getElementById('fb-live-log');
    if (el) el.innerHTML = this._log.map(l => '<div>' + l + '</div>').join('');
  },

  _lbl() {
    const n = Object.values(_fbPresence).filter(u => u && u.ts > Date.now()-25000).length;
    return n > 1 ? `ğŸ”¥ ${n} online` : 'ğŸ”¥ Firebase';
  },

  _setStatus(type, label) {
    const dot = document.getElementById('cloud-dot');
    const lbl = document.getElementById('cloud-lbl');
    const btn = document.getElementById('cloud-btn');
    if (!dot || !lbl) return;
    const cfg = {
      connecting: { dot:'#c9a227', shadow:'none', border:'rgba(201,162,39,.4)', color:'#c9a227' },
      saving:     { dot:'#c9a227', shadow:'none', border:'rgba(201,162,39,.4)', color:'#c9a227' },
      ok:         { dot:'#4ecb71', shadow:'0 0 0 3px rgba(78,203,113,.2)', border:'rgba(78,203,113,.4)', color:'#4ecb71' },
      error:      { dot:'#e05252', shadow:'none', border:'rgba(224,82,82,.4)', color:'#e05252' }
    };
    const s = cfg[type] || cfg.ok;
    dot.style.background = s.dot; dot.style.boxShadow = s.shadow;
    lbl.textContent = label;
    if (btn) { btn.style.borderColor = s.border; btn.style.color = s.color; }
  }
};

// â”€â”€ Online users bar (shown below topbar when anyone is connected) â”€
const _MOD_LABEL = { tasks:'Tasks', map:'Map', notes:'Notes', calendar:'Calendar',
                     gdd:'GDD', ldd:'LDD', charts:'Charts', assets:'Assets',
                     studying:'Learning', dashboard:'Dashboard' };
function _renderOnlineBar() {
  const cutoff = Date.now() - 25000;
  const online = Object.values(_fbPresence).filter(u => u && u.ts > cutoff);
  const bar    = document.getElementById('online-bar');
  const users  = document.getElementById('online-bar-users');
  if (!bar || !users) return;
  if (online.length === 0) { bar.style.display = 'none'; }
  else {
    bar.style.display = 'flex';
    users.innerHTML = online.map(u => {
      const isSelf   = u.sessionId === FIREBASE.sessionId;
      const dotColor = isSelf ? '#4ecb71' : '#4a9eff';
      const loc      = [u.city, u.country].filter(Boolean).join(', ') || u.ip || '';
      const modLabel = u.mod ? (_MOD_LABEL[u.mod] || u.mod) : '';
      return '<span class="ob-user' + (isSelf ? ' is-self' : '') + '">' +
        '<span class="ob-dot" style="background:' + dotColor + '"></span>' +
        '<span>' + (u.flag||'ğŸŒ') + '</span>' +
        '<span class="ob-name" style="color:' + dotColor + '">' + (u.name||'User') + '</span>' +
        (modLabel ? '<span class="ob-loc" style="color:' + dotColor + ';opacity:.6"> Â· ' + modLabel + '</span>' : '') +
        (loc ? '<span class="ob-loc">' + loc + '</span>' : '') +
        (isSelf ? '<span class="ob-loc">(you)</span>' : '') +
        '</span>';
    }).join('');
  }
  // Update dashboard online count pill
  const pill = document.getElementById('dash-online-pill');
  if (pill) {
    if (online.length > 0) {
      pill.textContent = 'ğŸŒ ' + online.length + ' online';
      pill.style.display = 'inline-flex';
    } else { pill.style.display = 'none'; }
  }
  // Refresh dashboard team widget if on dashboard
  const onDash = document.querySelector('.sb-item.active')?.dataset?.mod === 'dashboard';
  if (onDash) {
    const teamEl = document.getElementById('dash-team');
    if (teamEl) {
      if (online.length) {
        teamEl.innerHTML = online.map(u=>{
          const isSelf = u.sessionId===FIREBASE.sessionId;
          const dotC   = isSelf?'#4ecb71':'#4a9eff';
          const modLbl = (_MOD_LABEL||{})[u.mod]||u.mod||'';
          return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-card);border-radius:6px;border:1px solid ${dotC}22;margin-bottom:6px">
            <span style="width:8px;height:8px;border-radius:50%;background:${dotC};flex-shrink:0;display:inline-block"></span>
            <span style="font-size:16px">${u.flag||'ğŸŒ'}</span>
            <div style="flex:1;min-width:0">
              <div style="font-family:var(--fu);font-size:11px;color:${dotC};font-weight:600">${u.name||'User'}${isSelf?' <span style="opacity:.5;font-size:9px">(you)</span>':''}</div>
              <div style="font-size:10px;color:var(--text-muted)">${[modLbl,u.city,u.country].filter(Boolean).join(' Â· ')}</div>
            </div>
          </div>`;
        }).join('');
      } else {
        teamEl.innerHTML = '<div style="font-size:11px;color:var(--text-muted);padding:8px 0">Connect via Firebase to see teammates</div>';
      }
    }
  }
}

// â”€â”€ Update banner (shows when remote changes arrive) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _bannerTimer;
function _showUpdateBanner(sender, changedSecs, conflicts) {
  const banner  = document.getElementById('update-banner');
  const msg     = document.getElementById('ub-msg');
  const applyBtn= document.getElementById('ub-apply-btn');
  const icon    = document.getElementById('ub-icon');
  if (!banner || !msg) return;
  const secNames = changedSecs.map(s => (_MOD_LABEL[s] || s)).join(', ');
  if (conflicts.length > 0) {
    // Conflict: user has unsaved edits on same section
    banner.className = 'ub-warn';
    icon.textContent = 'âš ';
    msg.textContent  = sender + ' also edited ' + secNames + ' â€” your edits are protected. Apply their version or keep yours.';
    applyBtn.style.display = 'inline-block';
  } else if (changedSecs.length > 0) {
    // Info: safe merge already applied, just notify
    banner.className = 'ub-info';
    icon.textContent = 'ğŸ“¥';
    msg.textContent  = sender + ' updated ' + secNames;
    applyBtn.style.display = 'none';
  } else { return; }  // nothing changed
  banner.style.display = 'flex';
  clearTimeout(_bannerTimer);
  if (conflicts.length === 0) _bannerTimer = setTimeout(dismissUpdateBanner, 5000);
}

function applyPendingRemote() {
  const payload = FIREBASE._pendingPayload;
  if (payload && payload.data) {
    PS._merge(payload.data, true); _fbApply();
    FIREBASE._pendingPayload = null;
    _localDirty.clear();
    showToast('âœ“ Remote changes applied');
  }
  dismissUpdateBanner();
}

function dismissUpdateBanner() {
  const b = document.getElementById('update-banner');
  if (b) b.style.display = 'none';
}

// â”€â”€ Apply remote state to currently visible module â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _fbApply() {
  try { if (typeof refreshDashboard === 'function') refreshDashboard(); } catch(e) {}
  const mod = document.querySelector('.sb-item.active')?.dataset?.mod;
  if (!mod) return;
  try {
    if      (mod === 'map')   { if (MAP.currentMapId) { renderMap(); renderMapLayers(); renderMapProps(); } }
    else if (mod === 'notes') { renderNotesLists(); renderNotesItems(); }
    else if (mod === 'tasks') { renderTasks(); }
    else if (mod === 'gdd')   { initGDD(); }
    else if (mod === 'ldd')   { initLDD(); }
  } catch(err) { console.warn('[Firebase] _fbApply error:', mod, err); }
}

function cloudLoadSettings() {
  CLOUD.apiKey = localStorage.getItem('igs_cloud_key') || '';
  CLOUD.binId = localStorage.getItem('igs_cloud_bin') || '';
  CLOUD.enabled = !!(CLOUD.apiKey && CLOUD.binId);
  // Only update the cloud indicator if JSONBin is enabled â€”
  // Firebase will own the indicator otherwise
  if (CLOUD.enabled) { _cloudUpdateUI(); cloudPull(); startCloudPolling(); }
}

function _cloudUpdateUI(status) {
  const dot = document.getElementById('cloud-dot');
  const lbl = document.getElementById('cloud-lbl');
  const btn = document.getElementById('cloud-btn');
  if (!dot || !lbl) return;
  if (!CLOUD.enabled) {
    dot.style.background = 'var(--text-muted)';
    lbl.textContent = 'Cloud OFF';
    btn.style.borderColor = 'var(--border)';
    btn.style.color = 'var(--text-secondary)';
  } else if (status === 'syncing') {
    dot.style.background = 'var(--orange)';
    lbl.textContent = 'â†‘ Syncingâ€¦';
    btn.style.borderColor = 'rgba(224,120,32,.5)';
    btn.style.color = 'var(--orange)';
  } else if (status === 'error') {
    dot.style.background = 'var(--red)';
    lbl.textContent = 'âœ• Sync Error';
    btn.style.borderColor = 'rgba(224,82,82,.5)';
    btn.style.color = 'var(--red)';
  } else if (status === 'pulling') {
    dot.style.background = 'var(--blue)';
    lbl.textContent = 'â†“ Receivingâ€¦';
    btn.style.borderColor = 'rgba(74,158,255,.5)';
    btn.style.color = 'var(--blue)';
  } else {
    // connected / idle
    dot.style.background = 'var(--green)';
    dot.style.boxShadow = '0 0 0 3px rgba(78,203,113,.2)';
    lbl.textContent = 'â˜ Live';
    btn.style.borderColor = 'rgba(78,203,113,.4)';
    btn.style.color = 'var(--green)';
  }
}

async function cloudPush() {
  if (!CLOUD.enabled || CLOUD.pushing) return;
  CLOUD.pushing = true;
  _cloudUpdateUI('syncing');
  try {
    const resp = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD.binId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': CLOUD.apiKey,
        'X-Bin-Versioning': 'false'
      },
      body: JSON.stringify(PS.data)
    });
    if (resp.ok) { _cloudUpdateUI(); }
    else { _cloudUpdateUI('error'); }
  } catch(e) { _cloudUpdateUI('error'); }
  CLOUD.pushing = false;
}

async function cloudPull(silent) {
  if (!CLOUD.enabled) return;
  if (!silent) _cloudUpdateUI('pulling');
  try {
    const resp = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD.binId}/latest`, {
      headers: { 'X-Master-Key': CLOUD.apiKey, 'X-Bin-Meta': 'true' }
    });
    if (!resp.ok) { _cloudUpdateUI('error'); return; }
    const data = await resp.json();
    const ver = data.metadata && data.metadata.version;
    if (ver && ver !== CLOUD.lastVersion) {
      CLOUD.lastVersion = ver;
      if (CLOUD.lastVersion && data.record) {
        // Apply remote data
        const remoteData = data.record;
        PS._merge(remoteData);
        // Re-render current module
        const mod = document.querySelector('.sb-item.active')?.dataset?.mod;
        if (mod) showModule(mod);
        if (!silent) showToast('ğŸ”„ Synced from cloud âœ“');
      }
    }
    _cloudUpdateUI();
  } catch(e) { _cloudUpdateUI('error'); }
}

function startCloudPolling() {
  if (CLOUD.polling) clearInterval(CLOUD.polling);
  if (!CLOUD.enabled) return;
  CLOUD.polling = setInterval(() => cloudPull(true), 10000); // poll every 10s
}

function stopCloudPolling() {
  if (CLOUD.polling) { clearInterval(CLOUD.polling); CLOUD.polling = null; }
}

async function cloudCreateBin(apiKey, name) {
  try {
    const resp = await fetch('https://api.jsonbin.io/v3/b', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': apiKey,
        'X-Bin-Name': name || 'Invictus Project',
        'X-Bin-Private': 'false'
      },
      body: JSON.stringify(PS.data)
    });
    if (resp.ok) {
      const d = await resp.json();
      return d.metadata && d.metadata.id;
    }
  } catch(e) {}
  return null;
}

// â”€â”€ Firebase settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFirebaseModal() {
  const proj   = FIREBASE.projectId;
  const uname  = FIREBASE.userName;
  const status = document.getElementById('cloud-lbl')?.textContent || 'â€¦';
  const cutoff = Date.now() - 20000;
  const online = Object.values(_fbPresence).filter(u => u && u.ts > cutoff);
  const othersHtml = online.length
    ? online.map(u => `<span style="display:inline-flex;align-items:center;gap:5px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:3px 8px;font-size:11px;margin:2px">${u.sessionId===FIREBASE.sessionId?'<span style="color:var(--green)">â—</span>':'<span style="color:var(--blue)">â—</span>'} ${u.name||'User'}</span>`).join('')
    : '<span style="font-size:11px;color:var(--text-muted)">No one else connected</span>';

  const logHtml = FIREBASE._log.length
    ? FIREBASE._log.map(l => '<div>' + l + '</div>').join('')
    : '<div style="color:var(--text-muted)">No events yet</div>';

  const body = `
    <div style="background:rgba(78,203,113,.06);border:1px solid rgba(78,203,113,.25);border-radius:8px;padding:12px;margin-bottom:14px">
      <div style="font-size:10px;font-family:var(--fu);letter-spacing:1px;color:var(--green);margin-bottom:8px">ğŸ”¥ FIREBASE â€” LIVE STATUS</div>
      <div style="font-size:12px;color:var(--text-primary);margin-bottom:6px"><strong>Status:</strong> ${status} &nbsp; <strong>Project:</strong> <code style="font-family:var(--fm);color:var(--gold)">${proj}</code></div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px"><strong>Online now:</strong></div>
      <div style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:10px">${othersHtml}</div>
      <div style="font-size:10px;font-family:var(--fu);letter-spacing:1px;color:var(--text-muted);margin-bottom:4px">EVENT LOG</div>
      <div id="fb-live-log" style="font-family:var(--fm);font-size:10px;color:var(--text-secondary);line-height:1.7;background:var(--bg-input);border-radius:4px;padding:6px 8px;max-height:110px;overflow-y:auto">${logHtml}</div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="btn btn-sm" style="font-size:11px" onclick="FIREBASE.forceSync()">ğŸ”„ Force Sync Now</button>
        <button class="btn btn-sm btn-gold" style="font-size:11px" onclick="FIREBASE.uploadMyData()">â¬† Upload My Data to Firebase</button>
        <button class="btn btn-sm" style="font-size:11px" onclick="FIREBASE._log=[];document.getElementById('fb-live-log').innerHTML='<div style=\'color:var(--text-muted)\'>Cleared</div>'">Clear Log</button>
      </div>
    </div>
    <div class="fg" style="margin-bottom:10px">
      <label class="fl">Your Display Name</label>
      <input class="fi" id="fb-name-input" value="${uname}" placeholder="e.g. Rodrigo" style="font-family:var(--fb)">
    </div>
    <div class="fg">
      <label class="fl">Project ID <span style="font-size:10px;color:var(--text-muted)">(shared with your team)</span></label>
      <input class="fi" id="fb-proj-input" value="${proj}" placeholder="default" style="font-family:var(--fm)">
      <div style="font-size:10px;color:var(--text-muted);margin-top:4px">
        Firebase path: <code style="font-family:var(--fm)">/projects/<strong id="fb-path-preview">${proj}</strong>/state</code>
      </div>
    </div>
    <div style="font-size:11px;color:var(--text-secondary);margin-top:12px;line-height:1.7;background:var(--bg-panel);border-radius:6px;padding:10px">
      <strong>How to use with a team:</strong><br>
      1. Everyone opens the same URL (GitHub Pages)<br>
      2. Use the same <em>Project ID</em> â€” everyone shares that save slot<br>
      3. Changes sync in ~1 sec to all open tabs/browsers<br>
      4. Presence heartbeat every 8 s â€” shows who is online
    </div>
    <div style="margin-top:12px;border:1px solid rgba(224,82,82,.25);border-radius:6px;padding:10px;background:rgba(224,82,82,.04)">
      <div style="font-size:10px;font-family:var(--fu);letter-spacing:1px;color:var(--red);margin-bottom:6px">âš  TROUBLESHOOTING â€” IF SYNC IS BROKEN</div>
      <div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:8px">
        Firebase <em>test mode</em> rules expire after <strong>30 days</strong>. If saves stop working, go to:<br>
        <strong>Firebase Console â†’ Realtime Database â†’ Rules</strong> and publish:<br>
        <code style="font-family:var(--fm);background:var(--bg-input);padding:2px 5px;border-radius:3px">{ "rules": { ".read": true, ".write": true } }</code>
      </div>
      <button class="btn btn-sm" style="font-size:11px" onclick="FIREBASE.testConnection()">ğŸ” Test Connection Now</button>
      <div id="fb-test-result" style="margin-top:8px;font-size:11px;line-height:1.7;font-family:var(--fm)"></div>
    </div>`;

  openModal('ğŸ”¥ Firebase Sync', body, [
    { label:'Cancel', cls:'btn', fn: closeModal },
    { label:'Save', cls:'btn btn-gold', fn: () => {
      const id   = document.getElementById('fb-proj-input')?.value?.trim();
      const name = document.getElementById('fb-name-input')?.value?.trim();
      if (name) FIREBASE.setUserName(name);
      if (id && id !== FIREBASE.projectId) {
        FIREBASE.setProject(id);
        showToast('Firebase reconnected â†’ "' + id + '"');
      } else {
        showToast('Name saved âœ“');
      }
      closeModal();
    }}
  ]);
  const inp  = document.getElementById('fb-proj-input');
  const prev = document.getElementById('fb-path-preview');
  if (inp && prev) inp.oninput = () => { prev.textContent = inp.value || 'default'; };
}

function openCloudModal() {
  const body = `
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:14px;line-height:1.7;background:rgba(74,158,255,.06);border:1px solid rgba(74,158,255,.2);border-radius:6px;padding:12px;">
      <strong style="color:var(--blue)">â˜ Como funciona:</strong><br>
      1. CreÃ¡ una cuenta gratis en <a href="https://jsonbin.io" target="_blank" style="color:var(--blue)">jsonbin.io</a><br>
      2. CopiÃ¡ tu <strong>Master Key</strong> (en la secciÃ³n API Keys)<br>
      3. PegÃ¡ la key abajo y hacÃ© click en <strong>"Crear Bin"</strong><br>
      4. CompartÃ­ el <strong>Bin ID</strong> con tu equipo â€” todos usan la misma key y bin.<br>
      5. Los cambios se sincronizan automÃ¡ticamente cada 10 segundos.
    </div>
    <div class="fg">
      <label class="fl">Master Key (API Key)</label>
      <input class="fi" id="cloud-key-inp" type="password" placeholder="$2b$10$..." value="${CLOUD.apiKey}" autocomplete="off">
    </div>
    <div class="fg">
      <label class="fl">Bin ID</label>
      <div style="display:flex;gap:8px;">
        <input class="fi" id="cloud-bin-inp" placeholder="64abc1234def..." value="${CLOUD.binId}" style="flex:1">
        <button class="btn btn-sm" onclick="cloudModalCreateBin()">Crear Bin</button>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:3px">DejÃ¡ vacÃ­o y hacÃ© click "Crear Bin" para crear uno nuevo automÃ¡ticamente</div>
    </div>
    <div id="cloud-modal-status" style="font-family:var(--fm);font-size:11px;min-height:16px;margin-top:4px"></div>`;
  const footer = `
    <button class="btn btn-danger btn-sm" onclick="cloudDisable()">Desactivar</button>
    <button class="btn btn-sm" onclick="closeModal()">Cancelar</button>
    <button class="btn btn-gold" onclick="cloudModalSave()">Activar Cloud Sync</button>`;
  openModal('â˜ Cloud Sync â€” JSONBin.io', body, footer);
}

async function cloudModalCreateBin() {
  const key = document.getElementById('cloud-key-inp').value.trim();
  if (!key) { document.getElementById('cloud-modal-status').textContent = 'âœ• IngresÃ¡ tu Master Key primero'; return; }
  document.getElementById('cloud-modal-status').textContent = 'â³ Creando binâ€¦';
  const id = await cloudCreateBin(key, PS.data.currentProject || 'Invictus Project');
  if (id) {
    document.getElementById('cloud-bin-inp').value = id;
    document.getElementById('cloud-modal-status').innerHTML = `âœ“ Bin creado: <strong style="color:var(--gold)">${id}</strong> â€” CompartÃ­ este ID con tu equipo`;
  } else {
    document.getElementById('cloud-modal-status').innerHTML = '<span style="color:var(--red)">âœ• Error â€” VerificÃ¡ tu API key</span>';
  }
}

function cloudModalSave() {
  const key = document.getElementById('cloud-key-inp').value.trim();
  const bin = document.getElementById('cloud-bin-inp').value.trim();
  if (!key || !bin) { document.getElementById('cloud-modal-status').textContent = 'âœ• CompletÃ¡ los dos campos'; return; }
  CLOUD.apiKey = key;
  CLOUD.binId = bin;
  CLOUD.enabled = true;
  CLOUD.lastVersion = null;
  localStorage.setItem('igs_cloud_key', key);
  localStorage.setItem('igs_cloud_bin', bin);
  closeModal();
  startCloudPolling();
  cloudPull();
  showToast('â˜ Cloud Sync activado âœ“');
}

function cloudDisable() {
  CLOUD.enabled = false; CLOUD.apiKey = ''; CLOUD.binId = '';
  localStorage.removeItem('igs_cloud_key'); localStorage.removeItem('igs_cloud_bin');
  stopCloudPolling(); _cloudUpdateUI(); closeModal();
  showToast('Cloud Sync desactivado');
}

// Field saved feedback
function flashSaved() {
  const el = document.getElementById('field-saved');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, body, footer) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = body;
  document.getElementById('modal-footer').innerHTML = footer || '';
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _PCOLOR = { Low:'var(--blue)', Medium:'var(--orange)', High:'var(--red)', Critical:'#ff2d2d' };
const _PICON  = { Low:'â†“ ', Medium:'â†’ ', High:'â†‘ ', Critical:'âš¡ ' };
function timeUntil(dateStr) {
  if (!dateStr) return 'â€”';
  const days = Math.ceil((new Date(dateStr) - new Date()) / 86400000);
  if (days < 0)  return `<span style="color:#e05252;font-weight:700">âš  ${-days}d ago</span>`;
  if (days === 0) return `<span style="color:#e05252;font-weight:700">Today!</span>`;
  if (days === 1) return `<span style="color:#c9a227;font-weight:600">Tomorrow</span>`;
  if (days <= 3)  return `<span style="color:#c9a227">${days}d left</span>`;
  if (days <= 7)  return `<span style="color:var(--text-secondary)">${days}d left</span>`;
  return `<span style="color:var(--text-muted)">${days}d</span>`;
}
function refreshDashboard() {
  const tk = PS.data.tasks;
  const total = tk.length;
  const done = tk.filter(t=>t.status==='Done').length;
  const ip = tk.filter(t=>t.status==='In Progress').length;
  const bl = tk.filter(t=>t.status==='Blocked').length;
  const pct = total ? Math.round(done/total*100) : 0;

  setText('s-total', total); setText('s-done', done);
  setText('s-ip', ip); setText('s-bl', bl);
  setStyle('s-total-p','width', pct+'%');
  setStyle('s-done-p','width', (total?Math.round(done/total*100):0)+'%');
  setStyle('s-ip-p','width', (total?Math.round(ip/total*100):0)+'%');

  const tb = document.getElementById('dash-tasks');
  tb.innerHTML = '';
  tk.slice(-6).reverse().forEach(t => {
    const tr = document.createElement('tr');
    tr.onclick = ()=>openTaskModal(t.id);
    const pCol = _PCOLOR[t.priority] || 'var(--text-muted)';
    const pIco = _PICON[t.priority]  || '';
    tr.innerHTML = `<td style="font-weight:500">${t.title}</td><td><span class="badge ${sClass(t.status)}">${t.status}</span></td><td style="color:${pCol};font-size:11px;font-weight:700;white-space:nowrap">${pIco}${t.priority||'â€”'}</td><td>${t.discipline||'â€”'}</td><td style="font-family:var(--fm);font-size:11px;white-space:nowrap">${timeUntil(t.due)}</td>`;
    tb.appendChild(tr);
  });

  const el = document.getElementById('dash-events');
  el.innerHTML = '';
  const now = new Date();
  const up = PS.data.calendarEvents.filter(e=>new Date(e.date)>=now).sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(0,5);
  up.forEach(ev => {
    const pCol = _PCOLOR[ev.priority] || 'var(--text-muted)';
    const pIco = _PICON[ev.priority]  || '';
    el.innerHTML += `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg-card);border-radius:4px;border:1px solid var(--border);margin-bottom:4px;cursor:pointer" onclick="showModule('calendar')">
      <span style="font-family:var(--fm);font-size:10px;color:var(--gold);min-width:72px">${ev.date}</span>
      <span style="flex:1;font-size:12px">${ev.title}</span>
      ${ev.priority?`<span style="color:${pCol};font-size:10px;font-weight:700;white-space:nowrap">${pIco}${ev.priority}</span>`:''}
      <span style="font-family:var(--fm);font-size:10px;white-space:nowrap">${timeUntil(ev.date)}</span>
    </div>`;
  });
  if (!up.length) el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-txt">No upcoming events</div></div>';

  // â”€â”€ Project Health alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const alerts = document.getElementById('dash-alerts');
  if (alerts) {
    const today = new Date(); today.setHours(0,0,0,0);
    const overdue   = tk.filter(t=>t.due && t.status!=='Done' && new Date(t.due)<today);
    const critical  = tk.filter(t=>t.priority==='Critical' && t.status!=='Done');
    const dueToday  = tk.filter(t=>t.due && t.status!=='Done' && Math.ceil((new Date(t.due)-today)/86400000)===0);
    const chip = (icon,label,color,cb) =>
      `<span onclick="${cb}" style="cursor:pointer;display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:11px;font-family:var(--fu);letter-spacing:.5px;font-weight:600;border:1px solid ${color}33;background:${color}11;color:${color}">${icon} ${label}</span>`;
    let html = '';
    if (overdue.length)  html += chip('âš ',''+overdue.length+' OVERDUE','#e05252',"showModule('tasks')");
    if (dueToday.length) html += chip('ğŸ”´',''+dueToday.length+' DUE TODAY','#e05252',"showModule('tasks')");
    if (critical.length) html += chip('âš¡',''+critical.length+' CRITICAL','#ff4444',"showModule('tasks')");
    if (!html && tk.length) html = chip('âœ…','All on track','#4ecb71','');
    alerts.innerHTML = html;
  }

  // â”€â”€ Discipline progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dp = document.getElementById('dash-disc');
  dp.innerHTML = '';
  ['Level Design','Game Design','Narrative','Programmer','QA'].forEach(disc => {
    const dt = tk.filter(t=>t.discipline===disc);
    if (!dt.length) return;
    const dd = dt.filter(t=>t.status==='Done').length;
    const dp2 = Math.round(dd/dt.length*100);
    dp.innerHTML += `<div style="margin-bottom:9px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:11px;font-family:var(--fu);letter-spacing:.5px;color:var(--text-secondary)">${disc}</span><span style="font-family:var(--fm);font-size:10px;color:${dColor(disc)}">${dd}/${dt.length} Â· ${dp2}%</span></div><div class="pbar" style="height:5px"><div class="pfill" style="width:${dp2}%;background:${dColor(disc)};border-radius:3px"></div></div></div>`;
  });
  if (!dp.innerHTML) dp.innerHTML = '<div style="font-size:11px;color:var(--text-muted)">No tasks with discipline yet</div>';

  // â”€â”€ Team online â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const teamEl = document.getElementById('dash-team');
  if (teamEl) {
    const cutoff = Date.now() - 25000;
    const online = Object.values(_fbPresence||{}).filter(u=>u&&u.ts>cutoff);
    if (online.length) {
      teamEl.innerHTML = online.map(u=>{
        const isSelf = u.sessionId===FIREBASE.sessionId;
        const dotC   = isSelf?'#4ecb71':'#4a9eff';
        const modLbl = (_MOD_LABEL||{})[u.mod]||u.mod||'';
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-card);border-radius:6px;border:1px solid ${dotC}22;margin-bottom:6px">
          <span style="width:8px;height:8px;border-radius:50%;background:${dotC};flex-shrink:0;display:inline-block"></span>
          <span style="font-size:16px">${u.flag||'ğŸŒ'}</span>
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--fu);font-size:11px;color:${dotC};font-weight:600">${u.name||'User'}${isSelf?' <span style="opacity:.5">(you)</span>':''}</div>
            <div style="font-size:10px;color:var(--text-muted)">${[modLbl,u.city,u.country].filter(Boolean).join(' Â· ')}</div>
          </div>
        </div>`;
      }).join('');
    } else {
      teamEl.innerHTML = '<div style="font-size:11px;color:var(--text-muted);padding:8px 0">Connect via Firebase to see teammates</div>';
    }
  }

  // â”€â”€ Maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ml = document.getElementById('dash-maps');
  ml.innerHTML = '';
  PS.data.maps.slice(0,5).forEach(m => {
    const d = document.createElement('div');
    d.style.cssText='display:flex;align-items:center;gap:10px;padding:7px 10px;background:var(--bg-card);border-radius:6px;border:1px solid var(--border);cursor:pointer;margin-bottom:5px;transition:border-color .12s';
    d.onmouseenter=()=>d.style.borderColor='var(--gold-dim)';
    d.onmouseleave=()=>d.style.borderColor='var(--border)';
    const objCount=(m.objects||[]).length;
    d.innerHTML=`<span style="font-size:18px">ğŸ—ºï¸</span>
      <div style="flex:1;min-width:0"><div style="font-family:var(--fu);font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.name}</div><div style="font-family:var(--fm);font-size:10px;color:var(--text-muted)">${objCount} object${objCount!==1?'s':''}</div></div>
      <span style="font-size:10px;color:var(--text-muted)">â†’</span>`;
    d.onclick=()=>{showModule('map');setTimeout(()=>{document.getElementById('map-sel').value=m.id;loadSelectedMap();},100)};
    ml.appendChild(d);
  });
  if (!PS.data.maps.length) ml.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ—ºï¸</div><div class="empty-txt">No maps yet</div></div>';

  // â”€â”€ Notes widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderDashNotes();

  // â”€â”€ GDD/LDD progress (circular-style big numbers) â”€â”€â”€â”€â”€â”€â”€â”€
  const docProg = document.getElementById('dash-doc-progress');
  if (docProg) {
    const gddPct = calcDocCompletion('gdd', GDD_SECS);
    const lddPct = calcDocCompletion('ldd', LDD_SECS);
    const ring = (pct, color, label, mod) => `
      <div onclick="showModule('${mod}')" style="cursor:pointer;display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border);margin-bottom:8px;transition:border-color .12s" onmouseover="this.style.borderColor='${color}55'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="position:relative;width:44px;height:44px;flex-shrink:0">
          <svg viewBox="0 0 36 36" style="width:44px;height:44px;transform:rotate(-90deg)">
            <circle cx="18" cy="18" r="15.9" fill="none" stroke="${color}22" stroke-width="2.5"/>
            <circle cx="18" cy="18" r="15.9" fill="none" stroke="${color}" stroke-width="2.5"
              stroke-dasharray="${pct} ${100-pct}" stroke-dashoffset="0" stroke-linecap="round"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--fm);font-size:10px;font-weight:700;color:${color}">${pct}%</div>
        </div>
        <div>
          <div style="font-family:var(--fu);font-size:13px;font-weight:700;color:${color}">${label}</div>
          <div style="font-size:10px;color:var(--text-muted)">${pct < 25 ? 'Getting started' : pct < 60 ? 'In progress' : pct < 90 ? 'Almost there' : 'Complete!'}</div>
        </div>
        <span style="margin-left:auto;font-size:10px;color:var(--text-muted)">â†’</span>
      </div>`;
    docProg.innerHTML = ring(gddPct,'var(--gold)','Game Design Doc','gdd') + ring(lddPct,'var(--blue)','Level Design Doc','ldd');
  }
}

function renderDashNotes() {
  ensureNotes();
  const list = document.getElementById('dash-notes-list');
  const countEl = document.getElementById('dash-notes-count');
  if (!list) return;
  // Show items from the default/first list
  const allItems = PS.data.notes.lists.flatMap(l=>l.items).slice(0,8);
  const done = allItems.filter(i=>i.done).length;
  if (countEl) countEl.textContent = `${done}/${allItems.length} done`;
  list.innerHTML = '';
  if (!allItems.length) { list.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:12px">No notes yet â€” type above to add</div>'; return; }
  allItems.forEach(item => {
    const row = document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:8px;padding:5px 6px;border-radius:4px;background:var(--bg-card);border:1px solid var(--border);';
    const cb = document.createElement('input');
    cb.type='checkbox'; cb.checked=item.done; cb.style.cssText='accent-color:var(--gold);width:14px;height:14px;flex-shrink:0;cursor:pointer;';
    cb.onchange=()=>{item.done=cb.checked;autoSave();renderDashNotes();};
    const label = document.createElement('span');
    label.textContent=item.text; label.style.cssText=`flex:1;font-size:11px;font-family:var(--fb);color:var(--text-${item.done?'muted':'secondary'});${item.done?'text-decoration:line-through;':''}`;
    row.appendChild(cb); row.appendChild(label);
    list.appendChild(row);
  });
}

function handleDashNoteKey(e,input){if(e.key==='Enter'&&input.value.trim()){dashQuickAddNote(input.value.trim());input.value='';}}
function dashQuickAddNote(text){ensureNotes();const list=PS.data.notes.lists[0];if(!list)return;list.items.push({id:'ni_'+Date.now(),text,done:false});autoSave();renderDashNotes();}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function setStyle(id,prop,v){const e=document.getElementById(id);if(e)e.style[prop]=v;}
function sClass(s){return{Backlog:'b-backlog','To Do':'b-todo','In Progress':'b-progress',Review:'b-review',Blocked:'b-blocked',Done:'b-done'}[s]||'b-backlog';}
function dColor(d){const c={'Level Design':'#c9a227','Game Design':'#4a9eff',Narrative:'#9b6bde',Animator:'#4ecb71','3D Artist':'#e07820',Audio:'#4ecb71','UI/UX':'#4a9eff',Programmer:'#e05252',QA:'#aaa'};return c[d]||'#555';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _curTaskView = 'list';
let _tempChecklist = [];

function openTaskModal(id) {
  const task = id ? PS.data.tasks.find(t=>t.id===id) : null;
  _tempChecklist = task && task.checklist ? JSON.parse(JSON.stringify(task.checklist)) : [];
  const ss = ['Backlog','To Do','In Progress','Review','Blocked','Done'];
  const pp = ['Low','Medium','High','Critical'];
  const dd = ['Level Design','Game Design','Narrative','Animator','3D Artist','Audio','UI/UX','Programmer','QA'];
  const maps = PS.data.maps;

  const clHTML = _tempChecklist.map((it,i)=>`<div class="check-item ${it.done?'done':''}"><input type="checkbox" ${it.done?'checked':''} onchange="window._tc[${i}].done=this.checked;this.closest('.check-item').classList.toggle('done',this.checked)"><span><input class="fi" value="${it.text||''}" style="background:transparent;border:none;border-bottom:1px solid var(--border)" oninput="window._tc[${i}].text=this.value"></span></div>`).join('');

  const body=`<div class="g2" style="gap:10px">
    <div class="fg" style="grid-column:1/-1"><label class="fl">Title</label><input class="fi" id="tf-title" value="${task?task.title:''}" placeholder="Task titleâ€¦"></div>
    <div class="fg" style="grid-column:1/-1"><label class="fl">Description</label><textarea class="fta" id="tf-desc">${task?task.description||'':''}</textarea></div>
    <div class="fg"><label class="fl">Status</label><select class="fs" id="tf-status">${ss.map(s=>`<option ${task&&task.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
    <div class="fg"><label class="fl">Priority</label><select class="fs" id="tf-priority">${pp.map(p=>`<option ${task&&task.priority===p?'selected':''}>${p}</option>`).join('')}</select></div>
    <div class="fg"><label class="fl">Discipline</label><select class="fs" id="tf-disc">${dd.map(d=>`<option ${task&&task.discipline===d?'selected':''}>${d}</option>`).join('')}</select></div>
    <div class="fg"><label class="fl">Due Date</label><input class="fi" type="date" id="tf-due" value="${task?task.due||'':''}"></div>
    <div class="fg"><label class="fl">Assigned To</label><input class="fi" id="tf-assigned" value="${task?task.assignedTo||'':''}" placeholder="Nameâ€¦"></div>
    <div class="fg"><label class="fl">Est. Hours</label><input class="fi" type="number" id="tf-est" value="${task?task.est||'':''}" placeholder="0"></div>
    <div class="fg"><label class="fl">Link to Map</label><select class="fs" id="tf-map"><option value="">None</option>${maps.map(m=>`<option value="${m.id}" ${task&&task.linkedMapId===m.id?'selected':''}>${m.name}</option>`).join('')}</select></div>
    <div class="fg" style="grid-column:1/-1"><label class="fl">Checklist</label><div id="tf-checklist">${clHTML}</div><button class="btn btn-sm" style="margin-top:6px" onclick="addCheckItem()">+ Add item</button></div>
  </div>`;

  const footer=`${task?`<button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">Delete</button>`:''}
    <button class="btn btn-sm" onclick="closeModal()">Cancel</button>
    <button class="btn btn-gold" onclick="saveTask('${task?task.id:''}')">Save Task</button>`;

  openModal(task ? 'Edit Task' : 'New Task', body, footer);
  window._tc = _tempChecklist;
}

function addCheckItem() {
  window._tc.push({text:'',done:false});
  const i = window._tc.length-1;
  const c = document.getElementById('tf-checklist');
  const div = document.createElement('div');
  div.className='check-item';
  div.innerHTML=`<input type="checkbox" onchange="window._tc[${i}].done=this.checked;this.closest('.check-item').classList.toggle('done',this.checked)"><span><input class="fi" value="" style="background:transparent;border:none;border-bottom:1px solid var(--border)" oninput="window._tc[${i}].text=this.value"></span>`;
  c.appendChild(div);
  div.querySelector('input[type=text],input.fi').focus();
}

function saveTask(id) {
  const title = document.getElementById('tf-title').value.trim();
  if (!title) { showToast('Title is required'); return; }
  const t = {
    id: id || 'task_'+Date.now(),
    title,
    description: document.getElementById('tf-desc').value,
    status: document.getElementById('tf-status').value,
    priority: document.getElementById('tf-priority').value,
    discipline: document.getElementById('tf-disc').value,
    due: document.getElementById('tf-due').value,
    assignedTo: document.getElementById('tf-assigned').value,
    est: document.getElementById('tf-est').value,
    linkedMapId: document.getElementById('tf-map').value,
    checklist: window._tc || [],
    createdAt: id ? (PS.data.tasks.find(t2=>t2.id===id)||{}).createdAt : new Date().toISOString()
  };
  const isNew = !id;
  if (id) {
    const idx = PS.data.tasks.findIndex(t2=>t2.id===id);
    if (idx>=0) PS.data.tasks[idx]={...PS.data.tasks[idx],...t}; else PS.data.tasks.push(t);
  } else PS.data.tasks.push(t);
  closeModal(); renderTasks(); refreshDashboard(); autoSave();
  showToast('Task saved âœ“');
  // Email notification for new tasks
  if (isNew) {
    const email = localStorage.getItem('igs_notify_email');
    if (email) {
      const prio = t.priority ? `[${t.priority}] ` : '';
      const sub  = encodeURIComponent(`ğŸ“‹ New Task: ${prio}${t.title}`);
      const body = encodeURIComponent(
        `New task added to Invictus Game Studio:\n\n` +
        `ğŸ“Œ ${t.title}\n` +
        `âš¡ Priority: ${t.priority||'â€”'}\n` +
        `ğŸ“‚ Discipline: ${t.discipline||'â€”'}\n` +
        `ğŸ”– Status: ${t.status||'â€”'}\n` +
        `ğŸ“… Due: ${t.due||'â€”'}\n` +
        `ğŸ‘¤ Assigned: ${t.assignedTo||'â€”'}\n` +
        (t.description ? `\nğŸ“ ${t.description}` : '')
      );
      window.open(`mailto:${email}?subject=${sub}&body=${body}`);
    }
  }
}

function deleteTask(id) {
  if (!confirm('Delete this task?')) return;
  PS.data.tasks = PS.data.tasks.filter(t=>t.id!==id);
  closeModal(); renderTasks(); refreshDashboard(); autoSave();
}

let _tFilters = {status:'',disc:'',search:''};
function filterTasks() {
  _tFilters.status = document.getElementById('f-status').value;
  _tFilters.disc = document.getElementById('f-disc').value;
  _tFilters.search = document.getElementById('f-search').value.toLowerCase();
  renderTasks();
}
function getFilteredTasks() {
  return PS.data.tasks.filter(t => {
    if (_tFilters.status && t.status!==_tFilters.status) return false;
    if (_tFilters.disc && t.discipline!==_tFilters.disc) return false;
    if (_tFilters.search && !t.title.toLowerCase().includes(_tFilters.search)) return false;
    return true;
  });
}

function renderTasks() {
  if (_curTaskView==='list') renderListView();
  else if (_curTaskView==='kanban') renderKanban();
  else renderTaskCal();
}
function switchTaskView(v) {
  _curTaskView=v;
  document.querySelectorAll('#task-tabs .tab').forEach((t,i)=>t.classList.toggle('active',['list','kanban','calendar'][i]===v));
  ['list','kanban','calendar'].forEach(view=>document.getElementById('tv-'+view).classList.toggle('active',view===v));
  renderTasks();
}

function renderListView() {
  const tasks = getFilteredTasks();
  const tbody = document.getElementById('task-list-body');
  tbody.innerHTML = '';
  if (!tasks.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">No tasks</div></div></td></tr>`; return; }
  const pi = {Low:'â†“',Medium:'â†’',High:'â†‘',Critical:'âš¡'};
  const pc = {Low:'var(--blue)',Medium:'var(--orange)',High:'var(--red)',Critical:'var(--red)'};
  tasks.forEach(t => {
    const tr = document.createElement('tr');
    tr.onclick = ()=>openTaskModal(t.id);
    tr.innerHTML=`<td><span class="disc-dot" style="background:${dColor(t.discipline)};width:8px;height:8px"></span></td><td style="font-weight:500">${t.title}</td><td><span class="badge ${sClass(t.status)}">${t.status}</span></td><td><span style="color:${pc[t.priority]||'#aaa'};font-weight:700">${pi[t.priority]||''}${t.priority||'â€”'}</span></td><td>${t.discipline||'â€”'}</td><td style="font-family:var(--fm);font-size:11px">${t.due||'â€”'}</td><td style="font-family:var(--fm);font-size:11px">${t.est?t.est+'h':'â€”'}</td><td><button class="btn btn-xs" onclick="event.stopPropagation();openTaskModal('${t.id}')">âœ</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderKanban() {
  const tasks = getFilteredTasks();
  const ss = ['Backlog','To Do','In Progress','Review','Blocked','Done'];
  const sc = {Backlog:'#555','To Do':'var(--blue)','In Progress':'var(--orange)',Review:'var(--purple)',Blocked:'var(--red)',Done:'var(--green)'};
  const board = document.getElementById('kanban-board');
  board.innerHTML = '';
  ss.forEach(status => {
    const col = document.createElement('div');
    col.className = 'kb-col';
    const cts = tasks.filter(t=>t.status===status);
    col.innerHTML=`<div class="kb-col-hdr" style="color:${sc[status]}"><span>${status}</span><span style="background:${sc[status]};color:#000;border-radius:3px;padding:1px 6px;font-size:10px">${cts.length}</span></div><div class="kb-col-body" id="kc-${status.replace(/\s/g,'_')}"></div>`;
    board.appendChild(col);
    const body = col.querySelector('.kb-col-body');
    cts.forEach(t => {
      const card = document.createElement('div');
      card.className='kb-card';
      card.style.borderLeftColor=dColor(t.discipline);
      card.innerHTML=`<div class="kb-card-title">${t.title}</div><div class="kb-card-meta"><span class="badge ${sClass(t.status)}" style="font-size:9px">${t.priority||'â€”'}</span><span style="font-size:10px;color:var(--text-secondary);margin-left:auto">${t.due||''}</span></div>`;
      card.onclick=()=>openTaskModal(t.id);
      body.appendChild(card);
    });
    const add = document.createElement('div');
    add.style.cssText='padding:6px;text-align:center;cursor:pointer;color:var(--text-muted);font-size:12px';
    add.textContent='+ Add';
    add.onclick=()=>{openTaskModal();setTimeout(()=>{const s=document.getElementById('tf-status');if(s)s.value=status;},100);};
    body.appendChild(add);
  });
}

function renderTaskCal() {
  const el = document.getElementById('task-cal');
  const tasks = getFilteredTasks().filter(t=>t.due);
  el.innerHTML='<div style="font-family:var(--fu);font-size:11px;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;text-transform:uppercase">Tasks with due dates</div>';
  if (!tasks.length) { el.innerHTML+='<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-txt">No tasks with due dates</div></div>'; return; }
  [...tasks].sort((a,b)=>new Date(a.due)-new Date(b.due)).forEach(t=>{
    const d=document.createElement('div');
    d.style.cssText='display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg-panel);border:1px solid var(--border);border-radius:5px;margin-bottom:5px;cursor:pointer';
    d.innerHTML=`<span style="font-family:var(--fm);font-size:11px;color:var(--gold);min-width:90px">${t.due}</span><span class="disc-dot" style="background:${dColor(t.discipline)}"></span><span style="font-weight:500">${t.title}</span><span class="badge ${sClass(t.status)}" style="margin-left:auto">${t.status}</span>`;
    d.onclick=()=>openTaskModal(t.id);
    el.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR (2026)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _calNow=new Date(); let calYear=_calNow.getFullYear(), calMonth=_calNow.getMonth();

function calNav(dir) {
  calMonth += dir;
  if (calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;}
  renderCalendar();
}

function renderCalendar() {
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-month-label').textContent = months[calMonth]+' '+calYear;
  const grid = document.getElementById('cal-grid');
  const headers = Array.from(grid.querySelectorAll('.cal-hdr'));
  grid.innerHTML='';
  headers.forEach(h=>grid.appendChild(h));

  const firstDay = new Date(calYear,calMonth,1).getDay();
  const offset = firstDay===0 ? 6 : firstDay-1;
  const daysInMonth = new Date(calYear,calMonth+1,0).getDate();
  const daysInPrev = new Date(calYear,calMonth,0).getDate();
  const today = new Date();

  for(let i=offset-1;i>=0;i--) grid.appendChild(makeCalCell(calYear,calMonth-1,daysInPrev-i,true));
  for(let d=1;d<=daysInMonth;d++){
    const isToday=d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    grid.appendChild(makeCalCell(calYear,calMonth,d,false,isToday));
  }
  const total=offset+daysInMonth;
  const rem=(7-(total%7))%7;
  for(let d=1;d<=rem;d++) grid.appendChild(makeCalCell(calYear,calMonth+1,d,true));
}

function makeCalCell(year,month,day,other,isToday) {
  const cell = document.createElement('div');
  cell.className='cal-cell'+(other?' other-month':'')+(isToday?' today':'');
  const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  cell.innerHTML=`<div class="cal-day-num">${day}</div>`;

  PS.data.calendarEvents.filter(e=>e.date===ds).forEach(ev=>{
    const e=document.createElement('div');
    e.className='cal-ev';
    e.textContent='ğŸ“Œ '+ev.title;
    e.onclick=ev2=>{ev2.stopPropagation();openCalEventModal(ev.id);};
    cell.appendChild(e);
  });
  PS.data.tasks.filter(t=>t.due===ds).slice(0,2).forEach(t=>{
    const e=document.createElement('div');
    e.className='cal-ev cal-task';
    e.textContent='âš‘ '+t.title;
    e.onclick=ev=>{ev.stopPropagation();openTaskModal(t.id);};
    cell.appendChild(e);
  });
  cell.onclick=()=>openCalEventModal(null,ds);
  return cell;
}

function openCalEventModal(id, prefill) {
  const ev = id ? PS.data.calendarEvents.find(e=>e.id===id) : null;
  const defaultEmail = localStorage.getItem('igs_notify_email') || '';
  const prioOpts = ['','Low','Medium','High','Critical'].map(p=>`<option value="${p}" ${(ev&&ev.priority||'')==p?'selected':''}>${p||'â€” No priority â€”'}</option>`).join('');
  const notifyOpts = ['','1','3','7'].map(d=>`<option value="${d}" ${(ev&&ev.notifyDays||'')==d?'selected':''}>${d?d+' day(s) before':'â€” No reminder â€”'}</option>`).join('');
  const body=`
    <div class="fg"><label class="fl">Event Title</label><input class="fi" id="ev-title" value="${ev?ev.title:''}" placeholder="Event nameâ€¦"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="fg"><label class="fl">Start Date</label><input class="fi" type="date" id="ev-date" value="${ev?ev.date:prefill||''}"></div>
      <div class="fg"><label class="fl">End Date <span style="font-size:9px;color:var(--text-muted)">(optional)</span></label><input class="fi" type="date" id="ev-end" value="${ev&&ev.endDate||''}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="fg"><label class="fl">Priority</label><select class="fs" id="ev-priority">${prioOpts}</select></div>
      <div class="fg"><label class="fl">Email Reminder</label><select class="fs" id="ev-notify-days">${notifyOpts}</select></div>
    </div>
    <div class="fg"><label class="fl">Notify Email <span style="font-size:9px;color:var(--text-muted)">(leave blank to skip email)</span></label>
      <input class="fi" id="ev-email" type="email" value="${ev&&ev.notifyEmail||defaultEmail}" placeholder="you@email.com" oninput="localStorage.setItem('igs_notify_email',this.value)"></div>
    <div class="fg"><label class="fl">Description</label><textarea class="fta" id="ev-desc">${ev?ev.description||'':''}</textarea></div>`;
  const footer=`${ev?`<button class="btn btn-danger btn-sm" onclick="deleteCalEv('${ev.id}')">Delete</button>`:''}
    <button class="btn btn-sm" onclick="closeModal()">Cancel</button>
    <button class="btn btn-gold" onclick="saveCalEv('${ev?ev.id:''}')">Save Event</button>`;
  openModal(ev?'Edit Event':'New Calendar Event', body, footer);
}

function saveCalEv(id) {
  const title=document.getElementById('ev-title').value.trim();
  if(!title){showToast('Title required');return;}
  const isNew = !id;
  const ev={
    id:id||'ev_'+Date.now(), title,
    date:document.getElementById('ev-date').value,
    endDate:document.getElementById('ev-end').value||'',
    priority:document.getElementById('ev-priority').value||'',
    notifyDays:document.getElementById('ev-notify-days').value||'',
    notifyEmail:document.getElementById('ev-email').value.trim()||'',
    description:document.getElementById('ev-desc').value,
    _notified: id ? (PS.data.calendarEvents.find(e=>e.id===id)||{})._notified : false
  };
  if(id){const idx=PS.data.calendarEvents.findIndex(e=>e.id===id);if(idx>=0)PS.data.calendarEvents[idx]=ev;else PS.data.calendarEvents.push(ev);}
  else PS.data.calendarEvents.push(ev);
  closeModal(); renderCalendar(); refreshDashboard(); autoSave();
  showToast('Event saved âœ“');
  if(isNew && ev.notifyEmail) _sendNewEventEmail(ev);
}
function deleteCalEv(id){PS.data.calendarEvents=PS.data.calendarEvents.filter(e=>e.id!==id);closeModal();renderCalendar();autoSave();}

function exportICS(){
  let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//InvictusGS//EN\n';
  PS.data.calendarEvents.forEach(ev=>{const d=(ev.date||'19700101').replace(/-/g,'');ics+=`BEGIN:VEVENT\nUID:${ev.id}@igs\nDTSTART:${d}\nSUMMARY:${ev.title}\nDESCRIPTION:${ev.description||''}\nEND:VEVENT\n`;});
  ics+='END:VCALENDAR';
  dlText(ics,'calendar.ics','text/calendar');
}

// â”€â”€ Notification system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Opens user's email client with pre-filled reminder email
function _sendNewEventEmail(ev) {
  if (!ev.notifyEmail) return;
  const prio = ev.priority ? `[${ev.priority}] ` : '';
  const sub  = encodeURIComponent(`ğŸ“… New Event Scheduled: ${prio}${ev.title}`);
  const body = encodeURIComponent(
    `A new event was added to Invictus Game Studio Editor:\n\n` +
    `ğŸ“Œ ${ev.title}\n` +
    `ğŸ“… Date: ${ev.date}${ev.endDate?' â†’ '+ev.endDate:''}\n` +
    `âš¡ Priority: ${ev.priority||'â€”'}\n` +
    `ğŸ“ ${ev.description||'No description'}\n\n` +
    `Reminder: ${ev.notifyDays ? ev.notifyDays + ' day(s) before event' : 'No reminder set'}`
  );
  window.open(`mailto:${ev.notifyEmail}?subject=${sub}&body=${body}`);
}

function _sendDeadlineEmail(ev, daysLeft) {
  if (!ev.notifyEmail) return;
  const prio = ev.priority ? `[${ev.priority}] ` : '';
  const urgency = daysLeft === 0 ? 'ğŸ”´ TODAY' : daysLeft === 1 ? 'ğŸŸ  TOMORROW' : `ğŸŸ¡ ${daysLeft} DAYS LEFT`;
  const sub  = encodeURIComponent(`â° ${urgency}: ${prio}${ev.title}`);
  const body = encodeURIComponent(
    `DEADLINE REMINDER â€” Invictus Game Studio\n\n` +
    `ğŸ“Œ ${ev.title}\n` +
    `ğŸ“… Date: ${ev.date}${ev.endDate?' â†’ '+ev.endDate:''}\n` +
    `âš¡ Priority: ${ev.priority||'â€”'}\n` +
    `â³ Time left: ${daysLeft === 0 ? 'TODAY!' : daysLeft + ' day(s)'}\n` +
    `ğŸ“ ${ev.description||''}\n\n` +
    `Open the editor: ${location.href}`
  );
  window.open(`mailto:${ev.notifyEmail}?subject=${sub}&body=${body}`);
}

// Browser Notification API â€” requests permission on first use
function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default')
    Notification.requestPermission();
}

function _showBrowserNotif(title, body, urgency) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const n = new Notification('Invictus GS â€” ' + title, {
    body, icon: 'https://em-content.zobj.net/source/google/387/calendar_1f4c5.png',
    tag: title, requireInteraction: urgency === 'high'
  });
  n.onclick = () => { window.focus(); showModule('calendar'); n.close(); };
}

// Check all events â€” fire browser notifs + offer email for approaching deadlines
function checkDeadlineNotifications() {
  const today = new Date(); today.setHours(0,0,0,0);
  const notified = JSON.parse(localStorage.getItem('igs_notif_sent')||'{}');
  let changed = false;
  PS.data.calendarEvents.forEach(ev => {
    if (!ev.date) return;
    const evDate = new Date(ev.date); evDate.setHours(0,0,0,0);
    const daysLeft = Math.ceil((evDate - today) / 86400000);
    const notifyDays = parseInt(ev.notifyDays) || 0;
    if (!notifyDays) return;
    // Fire notification when daysLeft is exactly notifyDays, or on the day itself
    const shouldNotify = daysLeft === notifyDays || daysLeft === 1 || daysLeft === 0;
    if (!shouldNotify) return;
    const notifKey = ev.id + '_d' + daysLeft;
    if (notified[notifKey]) return; // already sent today
    // Browser notification
    const urgency = daysLeft <= 1 ? 'high' : 'normal';
    const label = daysLeft === 0 ? 'TODAY' : daysLeft === 1 ? 'Tomorrow' : `in ${daysLeft} days`;
    _showBrowserNotif(ev.title, `${ev.priority?'['+ev.priority+'] ':''}Event: ${label}`, urgency);
    // Email â€” show toast with link so user can open mail client
    if (ev.notifyEmail) {
      const prio = ev.priority ? `[${ev.priority}] ` : '';
      const urgency2 = daysLeft === 0 ? 'ğŸ”´ TODAY' : daysLeft === 1 ? 'ğŸŸ  TOMORROW' : `ğŸŸ¡ ${daysLeft} DAYS`;
      const sub  = encodeURIComponent(`â° ${urgency2}: ${prio}${ev.title}`);
      const body2 = encodeURIComponent(`DEADLINE REMINDER\n\nğŸ“Œ ${ev.title}\nğŸ“… ${ev.date}\nâš¡ Priority: ${ev.priority||'â€”'}\nâ³ ${label}\n\n${ev.description||''}`);
      const link = `mailto:${ev.notifyEmail}?subject=${sub}&body=${body2}`;
      showToast(`â° ${ev.title} â€” ${label}  <a href="${link}" style="color:var(--gold)" onclick="event.stopPropagation()">Send email â†—</a>`);
    }
    notified[notifKey] = Date.now();
    changed = true;
  });
  if (changed) localStorage.setItem('igs_notif_sent', JSON.stringify(notified));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GDD EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Guide questions for GDD and LDD fields
const DOC_QUESTIONS = {
  gdd: {
    game_title: 'What is the official name? Does it communicate the game\'s tone or genre?',
    elevator_pitch: 'Can you explain this game to a stranger in 2-3 sentences? What game is it like and how is it different?',
    logline: 'Try: "It\'s [genre] meets [genre], where you play as [character] who must [goal] in [setting]."',
    genre: 'Is it action, RPG, puzzle, strategy, or hybrid? What sub-genres apply?',
    platform: 'PC, console, mobile? Does the platform shape the design?',
    target_audience: 'Who are your players? Age range? Casual or hardcore? What other games do they play?',
    usp: 'What can players do in your game that they can\'t do anywhere else?',
    player_promise: 'If you had to make ONE promise to the player about how they\'ll feel, what is it?',
    reference_games: 'List 3-5 games you\'re inspired by. What specifically are you borrowing from each?',
    core_verb: 'If your game were described by a single verb, what would it be? (Run, Build, Survive, Explore...)',
    loop_desc: 'What does the player do every 30 seconds? Every 5 minutes? Every session?',
    verbs: 'List everything the player can physically DO. Be exhaustive.',
    rewards: 'What do players get for playing well? Points, loot, story, power? How often?',
    loop_diagram: 'Describe: Player does X â†’ Game responds with Y â†’ Player wants Z â†’ repeat.',
    session_length: 'How long is a single session? Can it be picked up and put down easily?',
    hook: 'What makes a player say "just one more round"?',
    mech_list: 'Write one mechanic per line. Each mechanic = one rule the player can learn and master.',
    movement: 'How does the player move? Walk, run, jump, dash, fly? What are the limits?',
    controls: 'Map each button/key to an action. Think about discoverability.',
    combat: 'How does fighting/interaction work? What\'s the risk and reward?',
    progression: 'How does the player get stronger/better? XP, unlocks, story gates?',
    economy: 'What are the currencies? What can be bought? Can things be lost?',
    systems: 'What secondary systems support the core loop? Crafting, dialogue, stealth?',
    fail_state: 'What happens when the player fails? Permadeath? Checkpoint? What does failure teach?',
    emotional_arc: 'Map the emotions: wonder â†’ challenge â†’ mastery â†’ triumph. Where are the lows?',
    fantasy: 'What power fantasy does this fulfill? Hero? Survivor? Creator? Detective?',
    flow: 'How do you ensure the game is never too easy or too hard? What metrics do you watch?',
    difficulty_philosophy: 'Is this for everyone or a specific skill level? How do you signal difficulty?',
    accessibility: 'Colorblind mode? Subtitles? Difficulty scaling? Controller remapping?',
    premise: 'What is the "once upon a time..." of your game? Setup â†’ Problem â†’ Stakes.',
    theme: 'What is this game REALLY about beneath the surface? Redemption? Identity? Survival?',
    world_desc: 'Paint the setting in 4-5 sentences. Time period, geography, tone, conflicts.',
    lore: 'What happened before the game starts? Why does this world exist in this state?',
    characters: 'For each character: Name | Role | Motivation | Arc | Relationship to player.',
    protagonist: 'Where does the hero start emotionally? Where do they end? What changes them?',
    antagonist: 'What does the villain want and why? Are they the hero of their own story?',
    tone: 'List 5 adjectives that describe the tone. Serious? Whimsical? Gritty? Hopeful?',
    dialogue_style: 'Snappy one-liners or deep dialogue trees? Give an example of a memorable line.',
    enemy_design_pillars: 'What 3 principles guide ALL enemy design? (e.g. "readable silhouette, fair tells, escalating complexity")',
    enemy_list: 'For each enemy: Name | Type | Role in encounter | Special behavior | Weakness.',
    ai_behavior: 'Describe each AI state: Idle â†’ Alert â†’ Chase â†’ Attack â†’ Retreat. What triggers each?',
    enemy_encounters: 'What makes a well-designed encounter? What skills should it teach or test?',
    boss_design: 'For each boss: Phase 1/2/3 breakdown, tells before attacks, spectacle moment, fail state.',
    visual_style: 'Describe the art style in 3 sentences. Realistic? Stylized? 2D/3D? Pixel art?',
    art_pillars: 'Write 3-5 single words that ALL art must embody. (e.g. "ancient, decayed, golden")',
    references: 'Paste 3-5 reference images or describe games/films whose art you admire. Be specific.',
    color_palette: 'What are the 3 primary colors of your world? What do they represent emotionally?',
    character_design: 'Silhouette test: can you identify each character as a shadow? What are their visual "reads"?',
    environment_design: 'What does each biome/area look like? What\'s the geometry language (sharp? organic?)?',
    ui_style: 'Diegetic or HUD? Clean minimal or detailed? What emotion should the UI NOT feel?',
    vfx: 'Describe the hit-feel, impact, and juice. What makes actions feel satisfying visually?',
    audio_pillars: 'List 3 words for the audio identity. (e.g. "ancient, haunting, powerful")',
    music_style: 'Orchestral? Electronic? Acoustic? What games/films have similar music?',
    music_system: 'Does music react to gameplay? Vertical layering? Horizontal transitions? Adaptive stems?',
    sfx: 'What sounds define your game? What should hitting an enemy feel like sonically?',
    voice: 'Full VO, partial, or text only? What accents/tones fit the world?',
    engine: 'Unity, Unreal, Godot, custom? What version? Why this choice?',
    tools: 'What software is used for art, audio, version control, task management?',
    platforms: 'PC (Windows/Mac/Linux)? Console? Mobile? What are the minimum specs?',
    performance: 'Target FPS? Resolution? Load time budget? Memory budget?',
    tech_debt: 'What technical risks could derail the project? Plan for each.',
    timeline: 'Pre-production â†’ Alpha â†’ Beta â†’ Gold â†’ Launch. Dates for each milestone.',
    team: 'Who is on the team? What are their roles? Who is the decision-maker?',
    milestones: 'List each milestone with deliverables and acceptance criteria.',
    budget: 'Total budget breakdown by department. What can be cut if needed?',
    risks: 'List your top 5 risks (technical, scope, team, market). Mitigation plan for each.',
    post_launch: 'Patch plan, community management, DLC roadmap, live ops?',
    terms: 'Define every term a new team member might not know. Format: TERM â€” definition.',
    business_model: 'Free-to-play, premium ($), subscription, or hybrid? Justify your choice.',
    revenue_streams: 'List all sources of money: base game, DLC, cosmetics, battle pass, merchandise?',
    price_point: 'What is the price at launch? What does the market expect for this genre/quality?',
    market_position: 'Where does this sit on the market matrix (casualâ†”hardcore, actionâ†”narrative)?',
    competitors: 'List top 5 competitors. What do they do better than you? Worse?',
    differentiators: 'If a player owned all competitor games, why would they also buy yours?',
  },
  ldd: {
    level_name: 'What is the official level ID and public-facing name? (e.g. "L01_Prologue")',
    level_synopsis: 'Summarize this level in one paragraph. Setting, goal, and key moment.',
    primary_goals: 'What MUST the player do to advance? List 1-3 objectives max.',
    secondary_goals: 'What optional goals reward exploration or skill? List each with its reward.',
    hidden_goals: 'What secrets exist? Where? What\'s the reward? Is it missable?',
    success_criteria: 'What exact condition triggers "Level Complete"? What triggers "Level Failed"?',
    player_fantasy: 'How should the player FEEL when they finish this level? Triumphant? Terrified? Curious?',
    entry_point: 'What is the very first thing the player sees? What does it communicate?',
    path_desc: 'Write the golden path as numbered steps. "1. Player enters â†’ sees X â†’ moves toward Y..."',
    key_moments: 'What are the 3-5 moments players will remember from this level?',
    pacing_notes: 'Map the tension curve: slow-build â†’ conflict â†’ peak â†’ resolution â†’ exit.',
    exit_point: 'How does the level end? What emotion should the player carry into the next level?',
    encounter_list: 'Number each encounter. Location, enemies, player approach options, difficulty.',
    enemy_composition: 'What enemies appear together? Why this combination? What skill does it test?',
    enemy_behavior: 'How does each enemy behave in this level? Are any scripted specifically here?',
    arena_notes: 'Describe cover, verticality, flanks, bottlenecks in each combat arena.',
    difficulty_notes: 'How does challenge escalate through the level? Is there a skill gate?',
    checkpoint_list: 'List each checkpoint with: trigger condition, position in level (%), respawn point.',
    cp_logic: 'What conditions enable/disable checkpoints? Can checkpoints be lost?',
    respawn_notes: 'Where exactly does the player respawn? Are enemies reset? What state is restored?',
    visual_cues: 'What visual elements guide the player? Light, color, props, gaps, silhouettes?',
    audio_cues: 'What sounds telegraph danger, discovery, or direction?',
    env_guidance: 'How does the geometry itself funnel the player without explicit arrows or markers?',
    hud_elements: 'What unique HUD elements appear in this level? Minimaps, objective markers, timers?',
    negative_space: 'Where should the player NOT go? How are boundaries communicated?',
    tension_map: 'Rate tension 1-10 at each beat. Draw the curve in your head. Is it interesting?',
    rest_points: 'Where can players breathe, explore, and absorb story beats?',
    climax: 'What is the peak moment of this level? Combat climax? Story reveal? Environmental spectacle?',
    pacing_ratio: 'Roughly what % is combat, exploration, and story? Does that serve the level\'s purpose?',
    diff_curve: 'Describe how challenge grows: easy opener â†’ gradual escalation â†’ skill test â†’ relief.',
    skill_gates: 'What skills must the player have mastered before reaching this level?',
    fail_states: 'What causes death or failure here? What does each failure teach?',
    accessibility: 'Any unique accessibility needs for this level? Timed sections? Precision jumps?',
    set_pieces: 'List the 2-3 big wow moments. What makes them memorable and cinematic?',
    lore_objects: 'What readable or interactive lore is in the level? Where? What does it reveal?',
    visual_narrative: 'What story does the environment tell WITHOUT words? What happened here before?',
    audio_ambience: 'Describe the ambient soundscape. What music plays? Does music change during events?',
    triggers: 'List every trigger volume: position, condition, event fired, one-time or repeatable?',
    scripting: 'What must be scripted (cutscenes, enemy spawns, door locks, environmental events)?',
    performance: 'Any areas likely to cause framerate issues? Suggestions for optimization?',
    dependencies: 'What assets must be ready before this level can be built? Who owns each?',
  }
};

const GDD_SECS = [
  {grp:'Overview', items:[
    {key:'high_concept',icon:'ğŸ’¡',label:'High Concept',hint:'Elevator pitch: what is the game, who is it for, and why is it unique.',
     fields:[
       {k:'game_title',l:'Game Title & Working Title',rows:1},
       {k:'elevator_pitch',l:'Elevator Pitch (2-3 sentences)',rows:3},
       {k:'logline',l:'One-Line Logline (the X meets Y pitch)',rows:1},
       {k:'genre',l:'Genre & Sub-Genre',rows:1},
       {k:'platform',l:'Target Platform(s)',rows:1},
       {k:'target_audience',l:'Target Audience (age, interests, experience)',rows:2},
       {k:'usp',l:'Unique Selling Point â€” What makes this different?',rows:3},
       {k:'player_promise',l:'Player Promise â€” What experience do we deliver?',rows:2},
       {k:'reference_games',l:'Reference Games & Inspirations',rows:3},
     ]},
    {key:'core_loop',icon:'ğŸ”„',label:'Core Loop',hint:'The fundamental action cycle the player repeats. Every system should serve this loop.',
     fields:[
       {k:'core_verb',l:'Core Player Verb (what does the player DO?)',rows:1},
       {k:'loop_desc',l:'Core Loop (step by step)',rows:5},
       {k:'verbs',l:'All Player Verbs / Actions',rows:3},
       {k:'rewards',l:'Reward System & Feedback Loops',rows:4},
       {k:'loop_diagram',l:'Loop Diagram (describe)',rows:4},
       {k:'session_length',l:'Expected Session Length & Pacing',rows:2},
       {k:'hook',l:'The Just One More Hook',rows:2},
     ]},
    {key:'mechanics',icon:'âš™ï¸',label:'Core Mechanics',hint:'All rules, systems and interactions. This guides programmers and designers.',
     fields:[
       {k:'mech_list',l:'Core Mechanics List (numbered)',rows:6},
       {k:'movement',l:'Movement System',rows:3},
       {k:'controls',l:'Controls / Input Mapping',rows:4},
       {k:'combat',l:'Combat / Interaction System',rows:5},
       {k:'progression',l:'Progression & Upgrade System',rows:4},
       {k:'economy',l:'Resource / Economy System',rows:3},
       {k:'systems',l:'Secondary Game Systems',rows:5},
       {k:'fail_state',l:'Fail State & Consequences',rows:3},
     ]},
    {key:'player_experience',icon:'ğŸ­',label:'Player Experience',hint:'Define the emotional journey at each stage.',
     fields:[
       {k:'emotional_arc',l:'Emotional Arc (beginning to middle to end)',rows:5},
       {k:'fantasy',l:'Player Fantasy / Power Fantasy',rows:3},
       {k:'flow',l:'Flow State Design â€” keeping players in the zone',rows:3},
       {k:'difficulty_philosophy',l:'Difficulty Philosophy',rows:3},
       {k:'accessibility',l:'Accessibility Features',rows:3},
     ]},
  ]},
  {grp:'World & Story', items:[
    {key:'narrative',icon:'ğŸ“–',label:'Narrative Design',hint:'Story, characters, dialogue and lore.',
     fields:[
       {k:'premise',l:'Story Premise (setup, conflict, stakes)',rows:4},
       {k:'theme',l:'Core Theme(s) of the Game',rows:2},
       {k:'world_desc',l:'World / Setting Description',rows:4},
       {k:'lore',l:'Lore & History',rows:5},
       {k:'characters',l:'Key Characters (name, role, motivation)',rows:6},
       {k:'protagonist',l:'Protagonist Arc',rows:3},
       {k:'antagonist',l:'Antagonist / Central Conflict',rows:3},
       {k:'tone',l:'Tone & Voice',rows:2},
       {k:'dialogue_style',l:'Dialogue Style & Examples',rows:4},
     ]},
    {key:'enemies',icon:'ğŸ‘¾',label:'Enemies & AI Design',hint:'All enemy types, behaviors, roles and how they challenge the player.',
     fields:[
       {k:'enemy_design_pillars',l:'Enemy Design Pillars',rows:3},
       {k:'enemy_list',l:'Enemy Roster (name, role, behavior)',rows:7},
       {k:'ai_behavior',l:'AI Behavior Description',rows:4},
       {k:'enemy_encounters',l:'Encounter Design Philosophy',rows:3},
       {k:'boss_design',l:'Boss Design (one per boss)',rows:6},
       {k:'enemy_progression',l:'Enemy Difficulty Progression',rows:3},
     ]},
    {key:'world_design',icon:'ğŸŒ',label:'World Design',hint:'Level structure, world map, biomes and how areas connect.',
     fields:[
       {k:'world_structure',l:'World Structure (linear / open / hub)',rows:3},
       {k:'level_list',l:'Level / Area List (name, theme, purpose)',rows:6},
       {k:'biomes',l:'Biomes / Zones & Their Themes',rows:4},
       {k:'world_map',l:'World Map Description',rows:3},
       {k:'exploration',l:'Exploration Design & Discovery',rows:3},
     ]},
    {key:'art_direction',icon:'ğŸ¨',label:'Art Direction',hint:'The complete visual identity guiding all artists.',
     fields:[
       {k:'visual_style',l:'Visual Style Statement',rows:3},
       {k:'art_pillars',l:'Art Direction Pillars (3-5 words)',rows:2},
       {k:'references',l:'Visual References (games, films, art)',rows:3},
       {k:'color_palette',l:'Color Palette Description',rows:2},
       {k:'character_design',l:'Character Design Direction',rows:3},
       {k:'environment_design',l:'Environment Design Direction',rows:3},
       {k:'ui_style',l:'UI / HUD Style Direction',rows:3},
       {k:'vfx',l:'VFX Style Direction',rows:2},
     ]},
  ]},
  {grp:'Market & Money', items:[
    {key:'monetization',icon:'ğŸ’°',label:'Monetization',hint:'How the game generates revenue.',
     fields:[
       {k:'business_model',l:'Business Model (premium / F2P / subscription)',rows:2},
       {k:'revenue_streams',l:'Revenue Streams',rows:3},
       {k:'price_point',l:'Target Price Point & Rationale',rows:2},
       {k:'iap',l:'In-App Purchases (if any)',rows:3},
       {k:'dlc_plan',l:'DLC / Season Pass Plan',rows:3},
     ]},
    {key:'market_analysis',icon:'ğŸ“ˆ',label:'Market Analysis',hint:'Where does this game fit in the market?',
     fields:[
       {k:'market_position',l:'Market Positioning',rows:3},
       {k:'competitors',l:'Competitor Analysis (top 3-5)',rows:5},
       {k:'differentiators',l:'Key Differentiators',rows:3},
       {k:'market_size',l:'Target Market Size & Opportunity',rows:2},
     ]},
  ]},
  {grp:'Production', items:[
    {key:'audio_direction',icon:'ğŸµ',label:'Audio Direction',hint:'Music, SFX, ambient audio and voice direction.',
     fields:[
       {k:'audio_pillars',l:'Audio Direction Pillars',rows:2},
       {k:'music_style',l:'Music Style & Mood References',rows:3},
       {k:'music_system',l:'Dynamic Music System (if any)',rows:3},
       {k:'sfx',l:'Sound Design Philosophy',rows:3},
       {k:'voice',l:'Voice Acting Direction',rows:3},
       {k:'audio_tech',l:'Audio Tech & Middleware (FMOD / Wwise)',rows:2},
     ]},
    {key:'tech_requirements',icon:'ğŸ’»',label:'Technical Requirements',hint:'Engine, tools, platforms and performance budgets.',
     fields:[
       {k:'engine',l:'Engine & Version',rows:1},
       {k:'tools',l:'Development Tools & Pipeline',rows:3},
       {k:'platforms',l:'Target Platforms & OS Versions',rows:2},
       {k:'performance',l:'Performance Targets (FPS, resolution, load time)',rows:3},
       {k:'tech_debt',l:'Technical Constraints & Risks',rows:3},
       {k:'networking',l:'Networking / Multiplayer Requirements',rows:2},
       {k:'save_system',l:'Save System Design',rows:2},
     ]},
    {key:'production_scope',icon:'ğŸ“¦',label:'Production Scope',hint:'Timeline, team, budget and milestones.',
     fields:[
       {k:'version_history',l:'Version History / Changelog',rows:3},
       {k:'timeline',l:'Development Timeline',rows:4},
       {k:'team',l:'Team Structure & Roles',rows:4},
       {k:'milestones',l:'Key Milestones (with dates)',rows:6},
       {k:'budget',l:'Budget Overview',rows:3},
       {k:'risks',l:'Risks & Mitigation Plans',rows:4},
       {k:'post_launch',l:'Post-Launch Plan',rows:3},
     ]},
    {key:'glossary',icon:'ğŸ“š',label:'Glossary & Terms',hint:'Define all project-specific terms and abbreviations.',
     fields:[
       {k:'terms',l:'Project Glossary (TERM â€” definition)',rows:10},
       {k:'acronyms',l:'Acronyms & Abbreviations',rows:4},
       {k:'lore_terms',l:'Lore / In-Universe Terms',rows:5},
     ]},
  ]}
];

function calcDocCompletion(docKey, secs) {
  try {
    const data = PS.data.docs[docKey] || {};
    let total=0, filled=0;
    secs.forEach(grp=>{
      if(!grp.items) return;
      grp.items.forEach(sec=>{
        if(!sec.fields) return;
        sec.fields.forEach(f=>{
          total++;
          const raw = data[sec.key] ? data[sec.key][f.k] : undefined;
          const val = typeof raw === 'string' ? raw : '';
          if(val.trim().length>3) filled++;
        });
      });
    });
    return total?Math.round(filled/total*100):0;
  } catch(e) { return 0; }
}

function updateDocProgress(docKey, secs) {
  const pct = calcDocCompletion(docKey, secs);
  const bar = document.getElementById(docKey+'-progress-bar');
  const lbl = document.getElementById(docKey+'-progress-lbl');
  if(bar) bar.style.width = pct+'%';
  if(lbl) lbl.textContent = pct+'%';
}

function initGDD() {
  if (!PS.data.docs.gdd) PS.data.docs.gdd={};
  const nav = document.getElementById('gdd-nav');
  const content = document.getElementById('gdd-content');
  nav.innerHTML=''; content.innerHTML='';
  const pct = calcDocCompletion('gdd', GDD_SECS);
  const infoBox=`<div class="doc-info-box"><strong>ğŸ“‹ GDD â€” Game Design Document</strong><br>This is the central document of your project. It defines <em>what</em> the game is and <em>how</em> it plays. Each section autosaves as you type. Export as MD, JSON, or PDF when ready.
    <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
      <div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div id="gdd-progress-bar" style="height:100%;background:var(--gold);border-radius:3px;transition:width .4s;width:${pct}%"></div></div>
      <span id="gdd-progress-lbl" style="font-family:var(--fm);font-size:11px;color:var(--gold);min-width:32px">${pct}%</span>
      <span style="font-size:10px;color:var(--text-muted)">complete</span>
    </div></div>`;
  content.innerHTML=infoBox;

  let firstKey=null;
  GDD_SECS.forEach(grp => {
    const grpLabel=document.createElement('div');
    grpLabel.className='doc-nav-grp';
    grpLabel.textContent=grp.grp;
    nav.appendChild(grpLabel);

    grp.items.forEach((sec,idx)=>{
      if(!firstKey) firstKey=sec.key;
      const ni=document.createElement('div');
      ni.className='doc-nav-item'+(sec.key===firstKey?' active':'');
      ni.dataset.key=sec.key;
      ni.innerHTML=`${sec.icon} ${sec.label}`;
      ni.onclick=()=>switchDocSec('gdd',sec.key);
      nav.appendChild(ni);

      const section=document.createElement('div');
      section.className='doc-section'+(sec.key===firstKey?' active':'');
      section.id='gdd-sec-'+sec.key;

      let html=`<div class="doc-sec-title">${sec.icon} ${sec.label}</div>`;
      if(sec.hint) html+=`<div class="doc-info-box">${sec.hint}</div>`;

      sec.fields.forEach(field=>{
        const val=(PS.data.docs.gdd[sec.key]&&PS.data.docs.gdd[sec.key][field.k])||'';
        const q=DOC_QUESTIONS.gdd[field.k]||'';
        const imgKey=sec.key+'__'+field.k;
        html+=`<div class="doc-field-wrap">
          <div class="doc-field-label">${field.l}</div>
          ${q?`<div class="doc-guide-q">ğŸ’¬ ${q}</div>`:''}
          <textarea class="doc-ta" rows="${field.rows}" id="gdd-${sec.key}-${field.k}"
            placeholder="${field.ph||''}"
            oninput="onDocInput('gdd','${sec.key}','${field.k}',this.value)">${val}</textarea>
          <div class="doc-field-gallery" id="doc-imgs-gdd-${imgKey}">${_docImgGalleryHTML('gdd',imgKey)}</div>
        </div>`;
      });
      html+='<div class="doc-divider"></div>';
      section.innerHTML=html;
      content.appendChild(section);
    });
  });
  setTimeout(()=>_initNavResize('gdd-nav'),0);
}

function onDocInput(doc, secKey, fieldKey, val) {
  if (!PS.data.docs[doc][secKey]) PS.data.docs[doc][secKey]={};
  PS.data.docs[doc][secKey][fieldKey]=val;
  flashSaved();
  autoSave();
  updateDocProgress(doc, doc==='gdd'?GDD_SECS:LDD_SECS);
}

// â”€â”€ DOC IMAGE GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Compress before storing â€” keeps Firebase payload small (~100-200KB per image)
function _compressImg(dataURL, maxW=900, maxH=700, quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      if(w>maxW||h>maxH){const r=Math.min(maxW/w,maxH/h);w=Math.round(w*r);h=Math.round(h*r);}
      const c=document.createElement('canvas');c.width=w;c.height=h;
      const ctx2=c.getContext('2d');
      ctx2.fillStyle='#ffffff'; // white bg so PNG transparency doesn't become black
      ctx2.fillRect(0,0,w,h);
      ctx2.drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataURL);
    img.src=dataURL;
  });
}
function _docImgGalleryHTML(doc, key){
  const imgs=(PS.data.docs[doc][key]&&PS.data.docs[doc][key]._images)||[];
  let h='';
  imgs.forEach((img,i)=>{
    const tmpId='_dimgtmp_'+doc+'_'+key+'_'+i;
    window[tmpId]=img.data;
    const cap=(img.caption||'').replace(/"/g,'&quot;');
    h+=`<div class="doc-img-card">
      <div class="doc-img-thumb">
        <img src="${img.data}" onclick="_docImgZoom(window['${tmpId}'])" title="Click to expand">
        <button class="doc-img-del" onclick="docRemoveImage('${doc}','${key}',${i})" title="Remove">âœ•</button>
      </div>
      <input class="doc-img-caption" type="text" placeholder="Add title..." value="${cap}"
        onchange="docUpdateCaption('${doc}','${key}',${i},this.value)"
        oninput="docUpdateCaption('${doc}','${key}',${i},this.value)">
    </div>`;
  });
  h+=`<label class="doc-img-add" title="Add reference image (PNG, JPG, GIF, WebP)">
    <span style="font-size:22px;line-height:1">+</span>
    <span>Add Image</span>
    <input type="file" accept="image/*" multiple onchange="docAddImage('${doc}','${key}',this)">
  </label>`;
  return h;
}
function docAddImage(doc, key, input){
  const files=[...input.files];
  if(!files.length)return;
  if(!PS.data.docs[doc][key]) PS.data.docs[doc][key]={};
  if(!PS.data.docs[doc][key]._images) PS.data.docs[doc][key]._images=[];
  let loaded=0;
  const total=files.length;
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      // Compress to ~100-200KB JPEG so Firebase stays small
      _compressImg(ev.target.result).then(compressed=>{
        PS.data.docs[doc][key]._images.push({data:compressed,name:file.name});
        loaded++;
        if(loaded===total){
          autoSave();
          const el=document.getElementById('doc-imgs-'+doc+'-'+key);
          if(el) el.innerHTML=_docImgGalleryHTML(doc,key);
          showToast(total===1?'Image added âœ“':total+' images added âœ“');
        }
      });
    };
    reader.readAsDataURL(file);
  });
}
function docRemoveImage(doc, key, idx){
  if(PS.data.docs[doc]&&PS.data.docs[doc][key]&&PS.data.docs[doc][key]._images)
    PS.data.docs[doc][key]._images.splice(idx,1);
  autoSave();
  const el=document.getElementById('doc-imgs-'+doc+'-'+key);
  if(el) el.innerHTML=_docImgGalleryHTML(doc,key);
}
function docUpdateCaption(doc, key, idx, caption){
  const imgs=PS.data.docs[doc]&&PS.data.docs[doc][key]&&PS.data.docs[doc][key]._images;
  if(imgs&&imgs[idx]) imgs[idx].caption=caption;
  autoSave();
}
function _docImgZoom(src){
  // Open fullscreen lightbox overlay
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out';
  ov.onclick=()=>ov.remove();
  const img=document.createElement('img');
  img.src=src;img.style.cssText='max-width:90vw;max-height:90vh;border-radius:4px;box-shadow:0 8px 40px rgba(0,0,0,.6)';
  ov.appendChild(img);document.body.appendChild(ov);
}

function switchDocSec(doc, key) {
  document.querySelectorAll(`#${doc}-nav .doc-nav-item`).forEach(el=>el.classList.toggle('active',el.dataset.key===key));
  document.querySelectorAll(`#${doc}-content .doc-section`).forEach(el=>el.classList.toggle('active',el.id===`${doc}-sec-${key}`));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LDD EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LDD_SECS = [
  {grp:'Foundation', items:[
    {key:'level_goals',icon:'ğŸ¯',label:'Level Goals',hint:'What must the player achieve to complete this level? Define primary, secondary and hidden objectives.',
     fields:[{k:'level_name',l:'Level Name / ID',rows:1},{k:'level_synopsis',l:'Level Synopsis (1 paragraph)',rows:3},{k:'primary_goals',l:'Primary Objectives',rows:4},{k:'secondary_goals',l:'Secondary Objectives (Optional)',rows:3},{k:'hidden_goals',l:'Hidden/Collectible Goals',rows:3},{k:'success_criteria',l:'Win Condition & Fail State',rows:3},{k:'player_fantasy',l:'Player Fantasy (what should player feel?)',rows:2}]},
    {key:'golden_path',icon:'ğŸ›¤ï¸',label:'Golden Path',hint:'The optimal route a player takes from start to finish. Document key beats, landmarks, and narrative moments.',
     fields:[{k:'entry_point',l:'Entry Point & First Impression',rows:3},{k:'path_desc',l:'Golden Path Step-by-Step',rows:6},{k:'key_moments',l:'Key Gameplay Moments / Beats',rows:4},{k:'pacing_notes',l:'Pacing Notes (slow-fast-slow?)',rows:3},{k:'exit_point',l:'Exit / Completion Moment',rows:2}]},
    {key:'encounters',icon:'âš”ï¸',label:'Encounters & Combat',hint:'All combat, puzzle and challenge encounters. Include enemy types, positions, behavior, and arena notes.',
     fields:[{k:'encounter_list',l:'Encounter List (numbered)',rows:6},{k:'enemy_composition',l:'Enemy Composition per Encounter',rows:4},{k:'enemy_behavior',l:'Enemy Behavior & AI Notes',rows:4},{k:'arena_notes',l:'Arena Layout Notes',rows:4},{k:'difficulty_notes',l:'Difficulty Tuning Notes',rows:3}]},
    {key:'beat_table',icon:'ğŸ“Š',label:'Beat Sequence Table',hint:'Spreadsheet-style table: fill in Situation, Skills tested, Elements, Intensity and Time/Pacing for each beat.',
     isTable:true},
  ]},
  {grp:'Design', items:[
    {key:'flowchart',icon:'ğŸ”€',label:'Level Flowchart',hint:'Visual node-based map showing connections between areas, doors, triggers and paths.',
     isFlowchart:true},
    {key:'checkpoints',icon:'ğŸ',label:'Checkpoints',hint:'Player progression saves and restart points.',
     fields:[{k:'checkpoint_list',l:'Checkpoint Positions & Triggers',rows:4},{k:'cp_logic',l:'Checkpoint Logic & Conditions',rows:3},{k:'respawn_notes',l:'Respawn/Death Handling',rows:3}]},
    {key:'guidance',icon:'ğŸ§­',label:'Guidance System',hint:'How you guide the player without explicit UI. Environmental design is the primary tool.',
     fields:[{k:'visual_cues',l:'Visual Cues (lighting, color, geometry)',rows:3},{k:'audio_cues',l:'Audio Cues (music changes, diegetic audio)',rows:3},{k:'env_guidance',l:'Environmental Guidance (paths, silhouettes)',rows:4},{k:'hud_elements',l:'HUD/UI Elements Needed',rows:2},{k:'negative_space',l:'Negative Space & Forbidden Areas',rows:2}]},
    {key:'pacing_plan',icon:'ğŸ“ˆ',label:'Pacing Plan',hint:'The rhythm of tension, exploration, rest and action. Mirrors the difficulty curve chart.',
     fields:[{k:'tension_map',l:'Tension/Relaxation Map',rows:4},{k:'rest_points',l:'Rest & Exploration Moments',rows:3},{k:'climax',l:'Climax Moment(s)',rows:3},{k:'pacing_ratio',l:'Combat/Exploration/Story Ratio',rows:2}]},
    {key:'difficulty_plan',icon:'ğŸ“‰',label:'Difficulty Plan',hint:'How challenge scales across the level and how failure is handled.',
     fields:[{k:'diff_curve',l:'Difficulty Curve Description',rows:4},{k:'skill_gates',l:'Skill Gates (what must player know)',rows:3},{k:'fail_states',l:'Fail States & Recovery',rows:3},{k:'accessibility',l:'Accessibility Considerations',rows:2}]},
  ]},
  {grp:'Polish', items:[
    {key:'env_storytelling',icon:'ğŸ›ï¸',label:'Environmental Storytelling',hint:'How the space itself tells the story without cutscenes or dialogue.',
     fields:[{k:'set_pieces',l:'Set Pieces & Hero Moments',rows:4},{k:'lore_objects',l:'Lore Objects & Readable Details',rows:4},{k:'visual_narrative',l:'Visual Narrative Beats',rows:3},{k:'audio_ambience',l:'Audio Ambience & Music Transitions',rows:3}]},
    {key:'tech_notes',icon:'âš™ï¸',label:'Technical Notes',hint:'Implementation notes for programmers and level builders.',
     fields:[{k:'triggers',l:'Trigger Volumes & Events',rows:4},{k:'scripting',l:'Scripting Requirements',rows:4},{k:'performance',l:'Performance Budget Notes',rows:3},{k:'dependencies',l:'Asset Dependencies',rows:3}]},
    {key:'qa_checklist',icon:'âœ…',label:'QA Checklist',hint:'Quality assurance requirements before this level ships.',
     checklistKey:'qa_items',
     defaultItems:[
       'Player can reach all primary objectives',
       'All secondary objectives completable',
       'No out-of-bounds exploits found',
       'All trigger volumes fire correctly',
       'Enemy AI behaves as designed in all scenarios',
       'All checkpoints save and restore correctly',
       'Audio/SFX present and timed correctly',
       'No geometry clipping or visual artifacts',
       'Framerate stable throughout entire level',
       'All collectibles/secrets are reachable',
       'Win/fail conditions trigger correctly',
       'Level complete screen fires on exit',
       'No floating or misaligned objects',
       'All doors/locks/keys working',
       'Lighting baked correctly (if applicable)'
     ]},
  ]}
];

function initLDD() {
  if (!PS.data.docs.ldd) PS.data.docs.ldd={};
  const nav = document.getElementById('ldd-nav');
  const content = document.getElementById('ldd-content');
  nav.innerHTML=''; content.innerHTML='';

  const infoBox=`<div class="doc-info-box"><strong>ğŸ“ LDD â€” Level Design Document</strong><br>This document defines the specific design of one level. It bridges the GDD's vision with the Map Editor's execution. Each field autosaves. Link this document to a map using the selector above.</div>`;
  content.innerHTML=infoBox;

  let firstKey=null;
  LDD_SECS.forEach(grp => {
    const grpLabel=document.createElement('div');
    grpLabel.className='doc-nav-grp';
    grpLabel.textContent=grp.grp;
    nav.appendChild(grpLabel);

    grp.items.forEach(sec=>{
      if(!firstKey) firstKey=sec.key;
      const ni=document.createElement('div');
      ni.className='doc-nav-item'+(sec.key===firstKey?' active':'');
      ni.dataset.key=sec.key;
      ni.innerHTML=`${sec.icon} ${sec.label}`;
      ni.onclick=()=>switchDocSec('ldd',sec.key);
      nav.appendChild(ni);

      const section=document.createElement('div');
      section.className='doc-section'+(sec.key===firstKey?' active':'');
      section.id='ldd-sec-'+sec.key;

      let html=`<div class="doc-sec-title">${sec.icon} ${sec.label}</div>`;
      if(sec.hint) html+=`<div class="doc-info-box">${sec.hint}</div>`;

      if(sec.isTable) {
        // Excel-like beat table
        if(!PS.data.docs.ldd[sec.key]) PS.data.docs.ldd[sec.key]={rows:[]};
        if(!PS.data.docs.ldd[sec.key].rows||!PS.data.docs.ldd[sec.key].rows.length){
          PS.data.docs.ldd[sec.key].rows=Array.from({length:12},(_,i)=>({id:i+1,situation:'',skills:'',elements:'',intensity:'',time_pacing:''}));
        }
        html+=`<div class="doc-field-wrap">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div class="doc-field-label">Beat Sequence â€” click any cell to edit</div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-xs" onclick="addBeatRow()">+ Row</button>
              <button class="btn btn-xs btn-danger" onclick="clearBeatTable()">Clear</button>
            </div>
          </div>
          <div style="overflow-x:auto;">
            <table id="beat-table" style="width:100%;border-collapse:collapse;min-width:600px;">
              <thead><tr>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;width:28px;">#</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;">SITUATION</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;">SKILLS</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;">ELEMENTS</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;">INTENSITY/CHALLENGE</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:6px 8px;font-family:var(--fu);font-size:10px;letter-spacing:1px;color:var(--gold);text-transform:uppercase;">TIME/PACING</th>
                <th style="background:#1a1a0a;border:1px solid var(--border);padding:4px;width:24px;"></th>
              </tr></thead>
              <tbody id="beat-tbody"></tbody>
            </table>
          </div>
        </div>`;
      } else if(sec.isFlowchart) {
        // Node-based flowchart
        if(!PS.data.docs.ldd[sec.key]) PS.data.docs.ldd[sec.key]={nodes:[],connections:[]};
        html+=`<div class="doc-field-wrap">
          <div style="display:flex;align-items:center;flex-wrap:wrap;gap:5px;margin-bottom:8px;">
            <div class="doc-field-label" style="margin:0;flex:0 0 auto">Node Flowchart</div>
            <div style="display:flex;gap:4px;flex-wrap:wrap;margin-left:auto;">
              <button class="btn btn-xs" onclick="addFlowNode('start')">â–¶ Start</button>
              <button class="btn btn-xs" onclick="addFlowNode('area')" style="border-color:#4a9eff;color:#4a9eff">ğŸ›ï¸ Area</button>
              <button class="btn btn-xs" onclick="addFlowNode('combat')" style="border-color:#e05252;color:#e05252">âš”ï¸ Combat</button>
              <button class="btn btn-xs" onclick="addFlowNode('event')" style="border-color:#9b6bde;color:#9b6bde">âš¡ Event</button>
              <button class="btn btn-xs" onclick="addFlowNode('trigger')" style="border-color:#c9a227;color:#c9a227">ğŸ”® Trigger</button>
              <button class="btn btn-xs" onclick="addFlowNode('puzzle')" style="border-color:#4a9eff;color:#4a9eff">ğŸ§© Puzzle</button>
              <button class="btn btn-xs" onclick="addFlowNode('npc')" style="border-color:#4ecb71;color:#4ecb71">ğŸ’¬ NPC</button>
              <button class="btn btn-xs" onclick="addFlowNode('secret')" style="border-color:#9b6bde;color:#9b6bde">ğŸ” Secret</button>
              <button class="btn btn-xs" onclick="addFlowNode('note')" style="border-color:#c9a227;color:var(--text-secondary)">ğŸ“ Note</button>
              <button class="btn btn-xs" onclick="addFlowNode('exit')" style="border-color:#e05252;color:#e05252">ğŸšª Exit</button>
              <span style="width:1px;background:var(--border);margin:0 2px;align-self:stretch;display:inline-block"></span>
              <button class="btn btn-xs" onclick="fcUndo()" title="Undo (Ctrl+Z)">â†© Undo</button>
              <button class="btn btn-xs" onclick="fcRedo()" title="Redo (Ctrl+Y)">â†ª Redo</button>
              <button class="btn btn-xs btn-danger" onclick="clearFlowchart()">Clear All</button>
            </div>
          </div>
          <div id="flowchart-canvas" style="width:100%;height:480px;background:#080808;border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden;cursor:default;">
            <div id="flow-viewport" style="position:absolute;top:0;left:0;width:100%;height:100%;transform-origin:0 0;">
              <svg id="flow-svg" style="position:absolute;top:0;left:0;width:10000px;height:10000px;pointer-events:none;overflow:visible;"></svg>
              <div id="flow-nodes" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
            </div>
            <!-- Zoom controls -->
            <div style="position:absolute;top:8px;right:8px;display:flex;gap:3px;z-index:10;">
              <button class="btn btn-xs" onclick="fcZoom(1.2)" title="Zoom in (+)">+</button>
              <button class="btn btn-xs" onclick="fcZoom(1/1.2)" title="Zoom out (-)">âˆ’</button>
              <button class="btn btn-xs" onclick="fcFitAll()" title="Fit all nodes to screen">Fit</button>
              <button class="btn btn-xs" onclick="fcResetCam()" title="Reset zoom to 100%">1:1</button>
            </div>
            <!-- Zoom indicator -->
            <div id="fc-zoom-lbl" style="position:absolute;bottom:8px;right:10px;font-family:var(--fm);font-size:9px;color:var(--text-muted);pointer-events:none;">100%</div>
            <div style="position:absolute;bottom:8px;left:10px;font-family:var(--fm);font-size:9px;color:var(--text-muted);pointer-events:none;">Drag to move Â· Scroll to zoom Â· Middle-drag to pan Â· Right-click to delete</div>
          </div>
        </div>`;
      } else if(sec.checklistKey) {
        const items=(PS.data.docs.ldd[sec.key]&&PS.data.docs.ldd[sec.key][sec.checklistKey])||sec.defaultItems.map(t=>({text:t,done:false}));
        html+=`<div class="doc-field-wrap"><div class="doc-field-label">QA Items</div><div class="doc-checklist" id="ldd-qa-list">`;
        items.forEach((it,i)=>{html+=`<div class="doc-check-item ${it.done?'done':''}"><input type="checkbox" ${it.done?'checked':''} onchange="toggleLDDCheck(${i},this.checked)"><span class="doc-check-input" contenteditable="true" oninput="updateLDDCheck(${i},this.textContent)" style="flex:1;outline:none;cursor:text">${it.text}</span></div>`;});
        html+=`</div><button class="btn btn-sm" style="margin-top:8px" onclick="addLDDCheck()">+ Add Item</button></div>`;
        if(!PS.data.docs.ldd[sec.key]) PS.data.docs.ldd[sec.key]={};
        if(!PS.data.docs.ldd[sec.key][sec.checklistKey]) PS.data.docs.ldd[sec.key][sec.checklistKey]=sec.defaultItems.map(t=>({text:t,done:false}));
      } else {
        sec.fields.forEach(field=>{
          const val=(PS.data.docs.ldd[sec.key]&&PS.data.docs.ldd[sec.key][field.k])||'';
          const q=DOC_QUESTIONS.ldd[field.k]||'';
          const imgKey=sec.key+'__'+field.k;
          html+=`<div class="doc-field-wrap"><div class="doc-field-label">${field.l}</div>
            ${q?`<div class="doc-guide-q">ğŸ’¬ ${q}</div>`:''}
            <textarea class="doc-ta" rows="${field.rows}" id="ldd-${sec.key}-${field.k}"
              placeholder="${field.ph||''}"
              oninput="onDocInput('ldd','${sec.key}','${field.k}',this.value)">${val}</textarea>
            <div class="doc-field-gallery" id="doc-imgs-ldd-${imgKey}">${_docImgGalleryHTML('ldd',imgKey)}</div>
          </div>`;
        });
      }
      html+='<div class="doc-divider"></div>';
      section.innerHTML=html;
      content.appendChild(section);

      // Post-render for special sections
      if(sec.isTable) setTimeout(()=>renderBeatTable(),50);
      if(sec.isFlowchart) setTimeout(()=>renderFlowchart(),50);
    });
  });
  setTimeout(()=>_initNavResize('ldd-nav'),0);
}

function toggleLDDCheck(i, v) {
  const qa = PS.data.docs.ldd.qa_checklist;
  if (qa&&qa.qa_items&&qa.qa_items[i]) { qa.qa_items[i].done=v; autoSave(); }
}
function updateLDDCheck(i, v) {
  const qa = PS.data.docs.ldd.qa_checklist;
  if (qa&&qa.qa_items&&qa.qa_items[i]) { qa.qa_items[i].text=v; autoSave(); }
}
function addLDDCheck() {
  if (!PS.data.docs.ldd.qa_checklist) PS.data.docs.ldd.qa_checklist={qa_items:[]};
  if (!PS.data.docs.ldd.qa_checklist.qa_items) PS.data.docs.ldd.qa_checklist.qa_items=[];
  PS.data.docs.ldd.qa_checklist.qa_items.push({text:'New item',done:false});
  initLDD();
  switchDocSec('ldd','qa_checklist');
}

function populateLDDMapLink() {
  const sel=document.getElementById('ldd-map-link');
  if(!sel) return;
  sel.innerHTML='<option value="">Link to Mapâ€¦</option>';
  PS.data.maps.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.name;if(PS.data.docs.ldd&&PS.data.docs.ldd._mapLink===m.id)o.selected=true;sel.appendChild(o);});
  sel.onchange=()=>{if(!PS.data.docs.ldd)PS.data.docs.ldd={};PS.data.docs.ldd._mapLink=sel.value;autoSave();};
}

function collectDocData() {
  // GDD
  GDD_SECS.forEach(grp=>grp.items.forEach(sec=>{
    if(!sec.fields) return;
    sec.fields.forEach(f=>{
      const el=document.getElementById(`gdd-${sec.key}-${f.k}`);
      if(el){if(!PS.data.docs.gdd[sec.key])PS.data.docs.gdd[sec.key]={};PS.data.docs.gdd[sec.key][f.k]=el.value;}
    });
  }));
  // LDD
  LDD_SECS.forEach(grp=>grp.items.forEach(sec=>{
    if(!sec.fields) return;
    sec.fields.forEach(f=>{
      const el=document.getElementById(`ldd-${sec.key}-${f.k}`);
      if(el){if(!PS.data.docs.ldd[sec.key])PS.data.docs.ldd[sec.key]={};PS.data.docs.ldd[sec.key][f.k]=el.value;}
    });
  }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP EDITOR â€” PROFESSIONAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAP = {
  objects: [],
  layers: ['Ground','Walls','Props','Labels'],
  activeLayer: 'Walls',
  hiddenLayers: new Set(),
  lockedLayers: new Set(),
  selectedIds: new Set(),
  tool: 'select',
  // Camera (world to screen transform)
  cam: { x: 0, y: 0, zoom: 1 },
  showGrid: true,
  snapToGrid: true,
  gridSize: 32,
  // Drawing state
  isDrawing: false,
  drawStart: null,
  drawCurrent: null,
  polyPoints: [],
  drawPoints: null, // freehand draw
  shapePreset: null, // active shape preset from shapes panel
  assetPreset: null, // active image asset from shapes panel
  _imgCache: {}, // cached Image objects keyed by assetId
  _prevSpaceTool: null, // for Space=pan
  // Marquee (rubber-band) selection
  isMarquee: false,
  marqueeStart: null,  // {sx,sy} screen coords
  marqueeCurrent: null, // {sx,sy} screen coords
  // Group-bbox resize (multi-select)
  isGroupResizing: false,
  groupResizeHandle: null, // 'nw','ne','sw','se','n','s','e','w'
  groupResizeStart: null,  // {sx,sy, bbox:{x1,y1,x2,y2}, snaps:[{id,x,y,w,h,r,x2,y2}]}
  // Pan state
  isPanning: false,
  panStartMouse: null,
  panStartCam: null,
  // Drag state
  isDragging: false,
  dragStart: null,
  dragObjStarts: {},
  // Resize state
  isResizing: false,
  resizeHandle: null,
  resizeObjStart: null,
  // History
  history: [],
  future: [],
  currentMapId: null,
  // Groups (folders) for layers panel
  // [{id,name,childIds:[],collapsed:false,hidden:false,locked:false}]
  groups: [],
  // Canvas refs
  canvas: null,
  ctx: null,
  wrap: null
};

const HINTS = {
  select:'Click to select Â· Shift+click multi-select Â· Drag to move Â· Delete key to remove',
  pan:'Drag to pan Â· Scroll to zoom',
  rect:'Click and drag to draw a rectangle room',
  wall:'Click and drag to draw a wall/barrier',
  poly:'Click to add points Â· Double-click to close polygon Â· Esc to cancel',
  circle:'Click center then drag to set radius',
  text:'Click to place a text label',
  erase:'Click on any object to delete it',
  stair:'Click and drag to place a staircase',
  light:'Click to place a light source',
  person:'Click to place a player / NPC spawn point',
  enemy:'Click to place an enemy spawn point',
  arrow:'Click and drag to draw a directional arrow',
  draw:'Hold and drag to draw freehand â€” release to finish',
  asset:'Select an image asset from the Shapes panel, then click to place it on the map'
};

function initMapEditor() {
  MAP.wrap = document.getElementById('map-canvas-area');
  if (!MAP.wrap) return;
  
  if (!MAP.canvas) {
    MAP.canvas = document.getElementById('map-canvas');
    MAP.ctx = MAP.canvas.getContext('2d');

    function resize() {
      if (!MAP.canvas || !MAP.wrap) return;
      MAP.canvas.width = MAP.wrap.clientWidth;
      MAP.canvas.height = MAP.wrap.clientHeight;
      renderMap();
    }
    new ResizeObserver(resize).observe(MAP.wrap);
    resize();

    MAP.canvas.addEventListener('mousedown', mapMD);
    MAP.canvas.addEventListener('mousemove', mapMM);
    MAP.canvas.addEventListener('mouseup', mapMU);
    MAP.canvas.addEventListener('dblclick', mapDblClick);
    MAP.canvas.addEventListener('contextmenu', e=>{e.preventDefault();mapRC(e);});
    MAP.canvas.addEventListener('wheel', e=>{e.preventDefault();
      const f = e.deltaY < 0 ? 1.12 : 0.89;
      const rect = MAP.canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      const wx = (mx - MAP.wrap.clientWidth/2 - MAP.cam.x) / MAP.cam.zoom;
      const wy = (my - MAP.wrap.clientHeight/2 - MAP.cam.y) / MAP.cam.zoom;
      MAP.cam.zoom = Math.max(0.05, Math.min(8, MAP.cam.zoom * f));
      MAP.cam.x = mx - MAP.wrap.clientWidth/2 - wx * MAP.cam.zoom;
      MAP.cam.y = my - MAP.wrap.clientHeight/2 - wy * MAP.cam.zoom;
      renderMap();
      updateStatusBar(mx, my);
    }, {passive:false});
  } else {
    // Resize canvas to current container
    MAP.canvas.width = MAP.wrap.clientWidth;
    MAP.canvas.height = MAP.wrap.clientHeight;
  }

  const noMap = document.getElementById('map-no-map');
  if (noMap) noMap.style.display = MAP.currentMapId ? 'none' : 'flex';
  renderShapesPanel();
  renderMapLayers();
  renderMap();
}

// World â†” Screen conversions
function w2s(wx, wy) {
  const W = MAP.wrap.clientWidth/2, H = MAP.wrap.clientHeight/2;
  return { x: wx * MAP.cam.zoom + MAP.cam.x + W, y: wy * MAP.cam.zoom + MAP.cam.y + H };
}
function s2w(sx, sy) {
  const W = MAP.wrap.clientWidth/2, H = MAP.wrap.clientHeight/2;
  return { x: (sx - MAP.cam.x - W) / MAP.cam.zoom, y: (sy - MAP.cam.y - H) / MAP.cam.zoom };
}
function snap(v) { return MAP.snapToGrid ? Math.round(v / MAP.gridSize) * MAP.gridSize : v; }

function mapMD(e) {
  e.preventDefault();
  MAP.canvas.focus({preventScroll:true}); // keep keyboard shortcuts working
  _closeCtxMenu();
  const rect = MAP.canvas.getBoundingClientRect();
  const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
  const w = s2w(sx, sy);

  if (MAP.tool === 'pan' || e.button === 1) {
    e.preventDefault(); // prevent middle-click browser auto-scroll / focus loss
    MAP.isPanning = true;
    MAP.panStartMouse = {x: e.clientX, y: e.clientY};
    MAP.panStartCam = {x: MAP.cam.x, y: MAP.cam.y};
    MAP.canvas.style.cursor = 'grabbing';
    return;
  }

  if (MAP.tool === 'select') {
    // Ctrl+click = additive / deselect (Windows-style multi-select)
    if (e.ctrlKey && !e.altKey) {
      const hit = getObjectAt(w.x, w.y);
      if (hit) {
        if (MAP.selectedIds.has(hit.id)) MAP.selectedIds.delete(hit.id);
        else MAP.selectedIds.add(hit.id);
        renderMap(); renderMapProps(); renderMapLayers();
      }
      return;
    }
    // Alt+click = duplicate and drag copy
    if (e.altKey) {
      e.preventDefault(); // prevent browser alt-key menu / address-bar focus
      const hit = getObjectAt(w.x, w.y);
      if (hit) {
        mapPushHistory();
        const clone = JSON.parse(JSON.stringify(hit));
        clone.id = 'obj_'+Date.now();
        clone.x += 10; clone.y += 10;
        MAP.objects.push(clone);
        MAP.selectedIds.clear(); MAP.selectedIds.add(clone.id);
        MAP.isDragging = true;
        MAP.dragStart = {wx: w.x, wy: w.y};
        MAP.dragObjStarts = {[clone.id]:{x:clone.x,y:clone.y}};
        renderMap(); renderMapProps(); renderMapLayers();
      }
      return;
    }
    // Check group-bbox resize handles (multi-select)
    if (MAP.selectedIds.size > 1) {
      const gh = _getGroupHandle(sx, sy);
      if (gh) {
        const bb = _getGroupBBox();
        MAP.isGroupResizing = true;
        MAP.groupResizeHandle = gh;
        MAP.groupResizeStart = {
          sx, sy,
          bbox: {...bb},
          snaps: MAP.objects
            .filter(o=>MAP.selectedIds.has(o.id)&&!o.locked)
            .map(o=>({id:o.id,x:o.x,y:o.y,w:o.w,h:o.h,r:o.r,x2:o.x2,y2:o.y2}))
        };
        return;
      }
    }
    // Check resize handle first (single select)
    if (MAP.selectedIds.size === 1) {
      const obj = MAP.objects.find(o=>MAP.selectedIds.has(o.id));
      if (obj) {
        const handle = getResizeHandle(obj, sx, sy);
        if (handle) {
          MAP.isResizing = true;
          MAP.resizeHandle = handle;
          MAP.resizeObjStart = JSON.parse(JSON.stringify(obj));
          MAP.dragStart = {sx, sy};
          return;
        }
      }
    }
    // Check hit â€” cycle through overlapping objects
    const hit = getObjectAt(w.x, w.y);
    if (hit) {
      if (!e.shiftKey && MAP.selectedIds.size > 1 && MAP.selectedIds.has(hit.id)) {
        // Clicking inside a multi-selection â†’ keep the whole group, just start drag
      } else if (!e.shiftKey && MAP.selectedIds.size===1 && MAP.selectedIds.has(hit.id)) {
        // Clicking same single object â†’ cycle to one below
        const below = getObjectAtBelow(w.x, w.y, hit.id);
        const next = below || hit;
        MAP.selectedIds.clear(); MAP.selectedIds.add(next.id);
      } else {
        if (!e.shiftKey) MAP.selectedIds.clear();
        MAP.selectedIds.add(hit.id);
      }
      MAP.isDragging = true;
      MAP.dragStart = {wx: w.x, wy: w.y};
      MAP.dragObjStarts = {};
      MAP.selectedIds.forEach(id=>{
        const obj=MAP.objects.find(o=>o.id===id);
        if(obj) MAP.dragObjStarts[id]={x:obj.x,y:obj.y,x2:obj.x2,y2:obj.y2};
      });
      renderMap(); renderMapProps(); renderMapLayers();
    } else {
      // Start rubber-band marquee on empty canvas
      if (!e.shiftKey) MAP.selectedIds.clear();
      MAP.isMarquee = true;
      MAP.marqueeStart = {sx, sy};
      MAP.marqueeCurrent = {sx, sy};
      renderMap(); renderMapProps(); renderMapLayers();
    }
    return;
  }

  if (MAP.tool === 'erase') {
    const hit = getObjectAt(w.x, w.y);
    if (hit) { mapPushHistory(); MAP.objects = MAP.objects.filter(o=>o.id!==hit.id); MAP.selectedIds.delete(hit.id); renderMap(); renderMapProps(); autoSave(); mapSaveCurrent(); }
    return;
  }

  if (MAP.tool === 'poly') {
    if (MAP.polyPoints.length === 0) MAP.isDrawing = true;
    MAP.polyPoints.push({x: snap(w.x), y: snap(w.y)});
    renderMap();
    return;
  }

  if (MAP.tool === 'text') {
    const txt = prompt('Enter text label:') || '';
    if (!txt) return;
    mapPushHistory();
    const obj={id:'obj_'+Date.now(),type:'text',name:txt,text:txt,fontSize:14,layer:MAP.activeLayer,x:snap(w.x),y:snap(w.y),w:120,h:20,fill:'#c9a227',stroke:'transparent',opacity:1};
    MAP.objects.push(obj);
    MAP.selectedIds.clear(); MAP.selectedIds.add(obj.id);
    renderMap(); renderMapProps(); autoSave(); mapSaveCurrent();
    return;
  }

  // Click-to-place tools
  if (MAP.tool === 'light') {
    mapPushHistory();
    const r=48; const id='obj_'+Date.now();
    const obj={id,type:'light',name:'Light',layer:MAP.activeLayer,x:snap(w.x),y:snap(w.y),r,w:r*2,h:r*2,fill:'#ffcc55',opacity:0.6};
    MAP.objects.push(obj); MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); renderMapLayers(); autoSave(); mapSaveCurrent(); return;
  }
  if (MAP.tool === 'person') {
    mapPushHistory();
    const id='obj_'+Date.now();
    const obj={id,type:'person',name:'Player',layer:MAP.activeLayer,x:snap(w.x),y:snap(w.y),w:20,h:32,fill:'#4a9eff',opacity:1};
    MAP.objects.push(obj); MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); renderMapLayers(); autoSave(); mapSaveCurrent(); return;
  }
  if (MAP.tool === 'enemy') {
    mapPushHistory();
    const id='obj_'+Date.now();
    const obj={id,type:'enemy',name:'Enemy',layer:MAP.activeLayer,x:snap(w.x),y:snap(w.y),w:24,h:28,fill:'#e05252',opacity:1};
    MAP.objects.push(obj); MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); renderMapLayers(); autoSave(); mapSaveCurrent(); return;
  }
  if (MAP.tool === 'asset' && MAP.assetPreset) {
    mapPushHistory();
    const id='obj_'+Date.now();
    const ap=MAP.assetPreset;
    const obj={id,type:'asset',name:ap.name||'Asset',layer:MAP.activeLayer,
      assetId:ap.id, x:snap(w.x-ap.w/2), y:snap(w.y-ap.h/2), w:ap.w, h:ap.h, opacity:1};
    MAP.objects.push(obj); MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); renderMapLayers(); autoSave(); mapSaveCurrent(); return;
  }

  // Freehand draw start
  if (MAP.tool === 'draw') {
    MAP.isDrawing = true;
    MAP.drawPoints = [{x:snap(w.x), y:snap(w.y)}];
    return;
  }

  MAP.isDrawing = true;
  MAP.drawStart = {x: snap(w.x), y: snap(w.y)};
  MAP.drawCurrent = {x: snap(w.x), y: snap(w.y)};
}

function mapMM(e) {
  const rect = MAP.canvas.getBoundingClientRect();
  const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
  const w = s2w(sx, sy);
  updateStatusBar(sx, sy);

  if (MAP.isPanning) {
    MAP.cam.x = MAP.panStartCam.x + (e.clientX - MAP.panStartMouse.x);
    MAP.cam.y = MAP.panStartCam.y + (e.clientY - MAP.panStartMouse.y);
    renderMap(); return;
  }

  if (MAP.isMarquee && MAP.marqueeStart) {
    MAP.marqueeCurrent = {sx, sy};
    renderMap(); return;
  }

  if (MAP.isDragging) {
    mapPushHistoryOnce();
    const dx = w.x - MAP.dragStart.wx, dy = w.y - MAP.dragStart.wy;
    MAP.selectedIds.forEach(id => {
      const obj = MAP.objects.find(o=>o.id===id);
      const start = MAP.dragObjStarts[id];
      if (obj && start && !MAP.lockedLayers.has(obj.layer)) {
        obj.x = snap(start.x + dx);
        obj.y = snap(start.y + dy);
        if(obj.type==='arrow'&&start.x2!==undefined){obj.x2=snap(start.x2+dx);obj.y2=snap(start.y2+dy);}
      }
    });
    renderMap(); renderMapProps(); return;
  }

  if (MAP.isGroupResizing && MAP.groupResizeStart) {
    mapPushHistoryOnce();
    const gs = MAP.groupResizeStart;
    const bb = gs.bbox;
    const bbW = bb.x2 - bb.x1 || 1, bbH = bb.y2 - bb.y1 || 1;
    const h = MAP.groupResizeHandle;
    // Compute new bbox corners in world space
    const dsx = (sx - gs.sx) / MAP.cam.zoom;
    const dsy = (sy - gs.sy) / MAP.cam.zoom;
    let nx1=bb.x1,ny1=bb.y1,nx2=bb.x2,ny2=bb.y2;
    if(h.includes('e')) nx2=Math.max(bb.x1+8,snap(bb.x2+dsx));
    if(h.includes('s')) ny2=Math.max(bb.y1+8,snap(bb.y2+dsy));
    if(h.includes('w')) nx1=Math.min(bb.x2-8,snap(bb.x1+dsx));
    if(h.includes('n')) ny1=Math.min(bb.y2-8,snap(bb.y1+dsy));
    const scaleX=(nx2-nx1)/bbW, scaleY=(ny2-ny1)/bbH;
    gs.snaps.forEach(sn=>{
      const obj=MAP.objects.find(o=>o.id===sn.id);
      if(!obj)return;
      const relX=(sn.x-bb.x1), relY=(sn.y-bb.y1);
      obj.x=snap(nx1+relX*scaleX);
      obj.y=snap(ny1+relY*scaleY);
      if(sn.w!==undefined) obj.w=Math.max(4,snap(sn.w*scaleX));
      if(sn.h!==undefined) obj.h=Math.max(4,snap(sn.h*scaleY));
      if(sn.r!==undefined){obj.r=Math.max(2,snap(sn.r*Math.max(scaleX,scaleY)));obj.w=obj.r*2;obj.h=obj.r*2;}
      if(sn.x2!==undefined){const rx2=(sn.x2-bb.x1);obj.x2=snap(nx1+rx2*scaleX);}
      if(sn.y2!==undefined){const ry2=(sn.y2-bb.y1);obj.y2=snap(ny1+ry2*scaleY);}
    });
    renderMap(); renderMapProps(); return;
  }

  if (MAP.isResizing && MAP.resizeObjStart && MAP.dragStart) {
    mapPushHistoryOnce();
    const obj = MAP.objects.find(o=>MAP.selectedIds.has(o.id));
    if (obj && obj.type !== 'text') {
      const dsx = (sx - MAP.dragStart.sx) / MAP.cam.zoom;
      const dsy = (sy - MAP.dragStart.sy) / MAP.cam.zoom;
      const s = MAP.resizeObjStart;
      const h = MAP.resizeHandle;
      if (h.includes('e')) obj.w = Math.max(8, snap(s.w + dsx));
      if (h.includes('s')) obj.h = Math.max(8, snap(s.h + dsy));
      if (h.includes('w')) { obj.x = snap(s.x + dsx); obj.w = Math.max(8, snap(s.w - dsx)); }
      if (h.includes('n')) { obj.y = snap(s.y + dsy); obj.h = Math.max(8, snap(s.h - dsy)); }
      if (obj.type === 'circle') obj.r = Math.max(4, snap(obj.w/2));
      renderMap(); renderMapProps();
    }
    return;
  }

  if (MAP.isDrawing && MAP.tool === 'draw' && MAP.drawPoints) {
    const pt = {x:snap(w.x), y:snap(w.y)};
    const last = MAP.drawPoints[MAP.drawPoints.length-1];
    if (Math.hypot(pt.x-last.x, pt.y-last.y) > 6) { MAP.drawPoints.push(pt); renderMap(); }
    return;
  }

  if (MAP.isDrawing && MAP.tool !== 'poly' && MAP.tool !== 'draw') {
    MAP.drawCurrent = {x: snap(w.x), y: snap(w.y)};
    renderMap(); return;
  }

  // Cursor feedback
  if (MAP.tool === 'select') {
    if (MAP.selectedIds.size > 1) {
      const gh=_getGroupHandle(sx,sy);
      if(gh){MAP.canvas.style.cursor=resizeCursor(gh);return;}
    } else if (MAP.selectedIds.size === 1) {
      const obj = MAP.objects.find(o=>MAP.selectedIds.has(o.id));
      if (obj) { const h=getResizeHandle(obj,sx,sy); MAP.canvas.style.cursor=h?resizeCursor(h):'default'; return; }
    }
  }
  const cursors={select:'default',pan:'grab',rect:'crosshair',wall:'crosshair',poly:'crosshair',circle:'crosshair',text:'text',erase:'not-allowed'};
  MAP.canvas.style.cursor = cursors[MAP.tool]||'default';
}

function mapMU(e) {
  MAP.isPanning = false;
  MAP.canvas.style.cursor = 'default';

  if (MAP.isMarquee && MAP.marqueeStart && MAP.marqueeCurrent) {
    MAP.isMarquee = false;
    const {sx:x1,sy:y1}=MAP.marqueeStart, {sx:x2,sy:y2}=MAP.marqueeCurrent;
    const mw=Math.abs(x2-x1), mh=Math.abs(y2-y1);
    if(mw>4||mh>4){
      const hits=getObjectsInMarquee(x1,y1,x2,y2);
      hits.forEach(o=>MAP.selectedIds.add(o.id));
    }
    MAP.marqueeStart=null; MAP.marqueeCurrent=null;
    renderMap(); renderMapProps(); renderMapLayers(); return;
  }

  if (MAP.isDragging) {
    MAP.isDragging = false;
    MAP._histOnce = false;
    autoSave(); mapSaveCurrent(); return;
  }
  if (MAP.isGroupResizing) {
    MAP.isGroupResizing = false;
    MAP.groupResizeHandle = null;
    MAP.groupResizeStart = null;
    MAP._histOnce = false;
    autoSave(); mapSaveCurrent(); return;
  }
  if (MAP.isResizing) {
    MAP.isResizing = false;
    MAP._histOnce = false;
    if(MAP.tool!=='select') setTool('select'); // auto-switch to select after resize
    autoSave(); mapSaveCurrent(); return;
  }
  // Handle freehand draw finish
  if (MAP.tool === 'draw') {
    MAP.isDrawing = false;
    if (MAP.drawPoints && MAP.drawPoints.length >= 2) {
      mapPushHistory();
      const id='obj_'+Date.now(); const pts=MAP.drawPoints;
      const obj={id,type:'draw',name:'Drawing',layer:MAP.activeLayer,
        points:JSON.parse(JSON.stringify(pts)),
        x:Math.min(...pts.map(p=>p.x)),y:Math.min(...pts.map(p=>p.y)),
        w:Math.max(...pts.map(p=>p.x))-Math.min(...pts.map(p=>p.x)),
        h:Math.max(...pts.map(p=>p.y))-Math.min(...pts.map(p=>p.y)),
        fill:'transparent',stroke:'#4ecb71',opacity:1};
      MAP.objects.push(obj); MAP.drawPoints=null;
      MAP.selectedIds.clear(); MAP.selectedIds.add(id);
      renderMap(); renderMapProps(); autoSave(); mapSaveCurrent();
    } else { MAP.drawPoints=null; }
    return;
  }

  if (!MAP.isDrawing || MAP.tool === 'poly') return;
  MAP.isDrawing = false;

  const rect = MAP.canvas.getBoundingClientRect();
  const w = s2w(e.clientX - rect.left, e.clientY - rect.top);
  const s = MAP.drawStart, c = {x: snap(w.x), y: snap(w.y)};
  if (!s) return;

  mapPushHistory();
  const id='obj_'+Date.now();
  const layer=MAP.activeLayer;
  let obj=null;

  if (MAP.tool==='rect') {
    const x=Math.min(s.x,c.x), y=Math.min(s.y,c.y), w2=Math.abs(c.x-s.x), h=Math.abs(c.y-s.y);
    if(w2<4&&h<4) return;
    obj={id,type:'rect',name:'Room',layer,x,y,w:w2,h,fill:'#1e2e18',stroke:'#4a7a3a',opacity:1,collision:false,blocksPlayer:false,blocksAI:false};
  } else if (MAP.tool==='wall') {
    const x=Math.min(s.x,c.x), y=Math.min(s.y,c.y), w2=Math.abs(c.x-s.x), h=Math.abs(c.y-s.y);
    if(w2<4&&h<4) return;
    obj={id,type:'wall',name:'Wall',layer:'Walls',x,y,w:w2,h,fill:'#3a2a1a',stroke:'#c9a227',opacity:1,collision:true,blocksPlayer:true,blocksAI:true};
  } else if (MAP.tool==='circle') {
    const r=Math.max(4,Math.hypot(c.x-s.x,c.y-s.y));
    obj={id,type:'circle',name:'Circle',layer,x:s.x,y:s.y,r:snap(r),w:snap(r)*2,h:snap(r)*2,fill:'#1e2e18',stroke:'#4a7a3a',opacity:1};
  } else if (MAP.tool==='stair') {
    const x=Math.min(s.x,c.x), y=Math.min(s.y,c.y), w2=Math.abs(c.x-s.x), h=Math.abs(c.y-s.y);
    if(w2<4&&h<4) return;
    obj={id,type:'stair',name:'Stairs',layer,x,y,w:w2,h,fill:'#2a2010',stroke:'#c9a227',opacity:1,steps:4};
  } else if (MAP.tool==='arrow') {
    if(Math.hypot(c.x-s.x,c.y-s.y)<4) return;
    obj={id,type:'arrow',name:'Arrow',layer,x:s.x,y:s.y,x2:c.x,y2:c.y,w:Math.abs(c.x-s.x),h:Math.abs(c.y-s.y),fill:'#c9a227',stroke:'#c9a227',opacity:1};
  }
  if (obj) {
    // Apply shape preset overrides
    if(MAP.shapePreset) Object.assign(obj, MAP.shapePreset, {id:obj.id,x:obj.x,y:obj.y,w:obj.w,h:obj.h,layer:obj.layer});
    MAP.objects.push(obj);
    MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); renderMapLayers(); autoSave(); mapSaveCurrent();
  }
}

function mapDblClick(e) {
  if (MAP.tool==='poly' && MAP.polyPoints.length>=3) {
    mapPushHistory();
    const id='obj_'+Date.now();
    const obj={id,type:'poly',name:'Polygon',layer:MAP.activeLayer,points:JSON.parse(JSON.stringify(MAP.polyPoints)),
      x:Math.min(...MAP.polyPoints.map(p=>p.x)), y:Math.min(...MAP.polyPoints.map(p=>p.y)),
      w:Math.max(...MAP.polyPoints.map(p=>p.x))-Math.min(...MAP.polyPoints.map(p=>p.x)),
      h:Math.max(...MAP.polyPoints.map(p=>p.y))-Math.min(...MAP.polyPoints.map(p=>p.y)),
      fill:'#1e2e18',stroke:'#4a9eff',opacity:1,collision:false};
    MAP.objects.push(obj);
    MAP.polyPoints=[];MAP.isDrawing=false;
    MAP.selectedIds.clear(); MAP.selectedIds.add(id);
    renderMap(); renderMapProps(); autoSave(); mapSaveCurrent();
  }
}

function mapRC(e) {
  const rect=MAP.canvas.getBoundingClientRect();
  const w=s2w(e.clientX-rect.left,e.clientY-rect.top);
  if(MAP.tool==='poly'){MAP.polyPoints=[];MAP.isDrawing=false;renderMap();return;}
  const hit=getObjectAt(w.x,w.y);
  if(hit){mapPushHistory();MAP.objects=MAP.objects.filter(o=>o.id!==hit.id);MAP.selectedIds.delete(hit.id);renderMap();renderMapProps();autoSave();mapSaveCurrent();}
}

function _objHitTest(obj,wx,wy){
  if(obj.hidden||obj.locked) return false;
  if(obj.type==='circle'||obj.type==='light') return Math.hypot(wx-obj.x,wy-obj.y)<=(obj.r||32);
  if(obj.type==='poly') return pointInPoly(wx,wy,obj.points||[]);
  if(obj.type==='arrow') return _ptLineDist(wx,wy,obj.x,obj.y,obj.x2!==undefined?obj.x2:obj.x+64,obj.y2!==undefined?obj.y2:obj.y)<=8;
  if(obj.type==='draw') return obj.points&&_ptNearPath(wx,wy,obj.points,8);
  return wx>=obj.x&&wx<=obj.x+(obj.w||0)&&wy>=obj.y&&wy<=obj.y+(obj.h||0);
}
function _objArea(obj){
  if(obj.type==='circle'||obj.type==='light') return Math.PI*(obj.r||32)**2;
  if(obj.type==='arrow'||obj.type==='draw') return 500; // lines always preferred
  return (obj.w||64)*(obj.h||64);
}
function getObjectAt(wx, wy) {
  // Collect all hits then return smallest-area (easier to select small objects over large)
  const hits=[];
  for(let i=MAP.objects.length-1;i>=0;i--){
    const obj=MAP.objects[i];
    if(_objHitTest(obj,wx,wy)) hits.push(obj);
  }
  if(!hits.length) return null;
  hits.sort((a,b)=>_objArea(a)-_objArea(b));
  return hits[0];
}
function getObjectAtBelow(wx,wy,excludeId){
  let found=false;
  for(let i=MAP.objects.length-1;i>=0;i--){
    const obj=MAP.objects[i];
    if(obj.id===excludeId){found=true;continue;}
    if(found&&_objHitTest(obj,wx,wy)) return obj;
  }
  // wrap around â€” return first hit below
  for(let i=MAP.objects.length-1;i>=0;i--){
    const obj=MAP.objects[i];
    if(obj.id!==excludeId&&_objHitTest(obj,wx,wy)) return obj;
  }
  return null;
}
function _ptLineDist(px,py,x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1,l2=dx*dx+dy*dy;if(l2===0)return Math.hypot(px-x1,py-y1);const t=Math.max(0,Math.min(1,((px-x1)*dx+(py-y1)*dy)/l2));return Math.hypot(px-(x1+t*dx),py-(y1+t*dy));}
function _ptNearPath(px,py,pts,thresh){for(let i=0;i<pts.length-1;i++){if(_ptLineDist(px,py,pts[i].x,pts[i].y,pts[i+1].x,pts[i+1].y)<thresh)return true;}return false;}

function pointInPoly(x,y,pts){
  let inside=false;
  for(let i=0,j=pts.length-1;i<pts.length;j=i++){
    const xi=pts[i].x,yi=pts[i].y,xj=pts[j].x,yj=pts[j].y;
    if(((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi))inside=!inside;
  }
  return inside;
}

// Compute world bounding box of all currently selected objects
function _getGroupBBox(){
  const objs=MAP.objects.filter(o=>MAP.selectedIds.has(o.id)&&!o.hidden);
  if(!objs.length) return null;
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  objs.forEach(o=>{
    let ox1=o.x,oy1=o.y,ox2,oy2;
    if(o.type==='circle'||o.type==='light'){ox2=o.x+o.r*2;oy2=o.y+o.r*2;ox1=o.x-o.r;oy1=o.y-o.r;}
    else if(o.type==='arrow'){ox2=Math.max(o.x,o.x2||o.x+64);oy2=Math.max(o.y,o.y2||o.y);ox1=Math.min(o.x,o.x2||o.x+64);oy1=Math.min(o.y,o.y2||o.y);}
    else{ox2=o.x+(o.w||0);oy2=o.y+(o.h||0);}
    x1=Math.min(x1,ox1);y1=Math.min(y1,oy1);x2=Math.max(x2,ox2);y2=Math.max(y2,oy2);
  });
  return {x1,y1,x2,y2};
}
// Check if screen point (sx,sy) is near a group-bbox handle; returns handle name or null
function _getGroupHandle(sx,sy){
  const bb=_getGroupBBox();if(!bb)return null;
  const p1=w2s(bb.x1,bb.y1),p2=w2s(bb.x2,bb.y2);
  const mx=(p1.x+p2.x)/2,my=(p1.y+p2.y)/2;
  const pts=[
    {h:'nw',x:p1.x,y:p1.y},{h:'n',x:mx,y:p1.y},{h:'ne',x:p2.x,y:p1.y},
    {h:'w',x:p1.x,y:my},                          {h:'e',x:p2.x,y:my},
    {h:'sw',x:p1.x,y:p2.y},{h:'s',x:mx,y:p2.y},{h:'se',x:p2.x,y:p2.y},
  ];
  for(const p of pts){if(Math.hypot(sx-p.x,sy-p.y)<=8)return p.h;}
  return null;
}

// Returns all objects whose screen bounding box intersects the marquee rect
function getObjectsInMarquee(sx1,sy1,sx2,sy2){
  const rx1=Math.min(sx1,sx2),ry1=Math.min(sy1,sy2);
  const rx2=Math.max(sx1,sx2),ry2=Math.max(sy1,sy2);
  return MAP.objects.filter(obj=>{
    if(obj.hidden||obj.locked)return false;
    let ox1,oy1,ox2,oy2;
    const p=w2s(obj.x,obj.y);
    if(obj.type==='circle'||obj.type==='light'){
      const r=(obj.r||32)*MAP.cam.zoom;
      ox1=p.x-r;oy1=p.y-r;ox2=p.x+r;oy2=p.y+r;
    } else if(obj.type==='arrow'){
      const p2=w2s(obj.x2!==undefined?obj.x2:obj.x+64,obj.y2!==undefined?obj.y2:obj.y);
      ox1=Math.min(p.x,p2.x)-4;oy1=Math.min(p.y,p2.y)-4;ox2=Math.max(p.x,p2.x)+4;oy2=Math.max(p.y,p2.y)+4;
    } else if(obj.type==='draw'&&obj.points){
      const spts=obj.points.map(pt=>w2s(pt.x,pt.y));
      ox1=Math.min(...spts.map(p=>p.x));oy1=Math.min(...spts.map(p=>p.y));
      ox2=Math.max(...spts.map(p=>p.x));oy2=Math.max(...spts.map(p=>p.y));
    } else {
      const q=w2s(obj.x+(obj.w||0),obj.y+(obj.h||0));
      ox1=Math.min(p.x,q.x);oy1=Math.min(p.y,q.y);ox2=Math.max(p.x,q.x);oy2=Math.max(p.y,q.y);
    }
    return ox1<=rx2&&ox2>=rx1&&oy1<=ry2&&oy2>=ry1;
  });
}

function getResizeHandle(obj, sx, sy) {
  if (obj.type==='circle'||obj.type==='text'||obj.type==='poly'||obj.type==='light'||obj.type==='arrow'||obj.type==='draw'||obj.type==='person'||obj.type==='enemy') return null;
  const s = w2s(obj.x, obj.y);
  const ex = obj.x+obj.w, ey = obj.y+obj.h;
  const se = w2s(ex, ey);
  const sw = w2s(obj.x, ey);
  const ne = w2s(ex, obj.y);
  const nc = w2s((obj.x+obj.w/2), obj.y);
  const sc = w2s((obj.x+obj.w/2), ey);
  const wc = w2s(obj.x, (obj.y+obj.h/2));
  const ec = w2s(ex, (obj.y+obj.h/2));
  const handles = [{p:se,h:'se'},{p:sw,h:'sw'},{p:ne,h:'ne'},{p:s,h:'nw'},{p:nc,h:'n'},{p:sc,h:'s'},{p:wc,h:'w'},{p:ec,h:'e'}];
  for(const {p,h} of handles){if(Math.hypot(sx-p.x,sy-p.y)<7)return h;}
  return null;
}
function resizeCursor(h){const c={n:'ns-resize',s:'ns-resize',e:'ew-resize',w:'ew-resize',ne:'ne-resize',sw:'sw-resize',nw:'nw-resize',se:'se-resize'};return c[h]||'default';}

function updateStatusBar(sx, sy) {
  const w = s2w(sx, sy);
  document.getElementById('sb-x').textContent = Math.round(w.x);
  document.getElementById('sb-y').textContent = Math.round(w.y);
  document.getElementById('sb-zoom').textContent = Math.round(MAP.cam.zoom*100);
  document.getElementById('sb-grid').textContent = MAP.showGrid?'ON':'OFF';
  document.getElementById('sb-snap').textContent = MAP.snapToGrid?'ON':'OFF';
  document.getElementById('sb-objs').textContent = MAP.objects.length;
  document.getElementById('sb-layer').textContent = MAP.activeLayer;
  if(MAP.selectedIds.size===1){const obj=MAP.objects.find(o=>MAP.selectedIds.has(o.id));document.getElementById('map-sel-name').textContent=obj?obj.name:'';}
  else if(MAP.selectedIds.size>1){document.getElementById('map-sel-name').textContent=MAP.selectedIds.size+' selected';}
  else document.getElementById('map-sel-name').textContent='';
}

function renderMap() {
  if (!MAP.ctx) return;
  const canvas=MAP.canvas, ctx=MAP.ctx;
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);

  // Background
  ctx.fillStyle='#090909';
  ctx.fillRect(0,0,W,H);

  // Grid
  if (MAP.showGrid) {
    const gs=MAP.gridSize*MAP.cam.zoom;
    const ox=(MAP.cam.x+W/2)%gs, oy=(MAP.cam.y+H/2)%gs;
    ctx.strokeStyle='rgba(201,162,39,0.07)';
    ctx.lineWidth=1;
    for(let x=ox-gs;x<W+gs;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=oy-gs;y<H+gs;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    // Axis
    const origin=w2s(0,0);
    ctx.strokeStyle='rgba(201,162,39,0.18)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(origin.x,0);ctx.lineTo(origin.x,H);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,origin.y);ctx.lineTo(W,origin.y);ctx.stroke();
    // Origin dot
    ctx.fillStyle='rgba(201,162,39,0.4)';
    ctx.beginPath();ctx.arc(origin.x,origin.y,3,0,Math.PI*2);ctx.fill();
  }

  // Objects by layer
  MAP.layers.forEach(layer=>{
    if(MAP.hiddenLayers.has(layer)) return;
    MAP.objects.filter(o=>o.layer===layer).forEach(obj=>drawObj(obj,ctx));
  });

  // Selection
  MAP.objects.filter(o=>MAP.selectedIds.has(o.id)).forEach(obj=>{
    ctx.save();
    ctx.strokeStyle='#c9a227';
    ctx.lineWidth=2;
    ctx.setLineDash([5,3]);
    if(obj.type==='circle'||obj.type==='light'){
      const p=w2s(obj.x,obj.y),r=(obj.r||32)*MAP.cam.zoom;
      ctx.beginPath();ctx.arc(p.x,p.y,r+3,0,Math.PI*2);ctx.stroke();
    } else if(obj.type==='poly'){
      ctx.beginPath();
      const pts=obj.points.map(p=>w2s(p.x,p.y));
      ctx.moveTo(pts[0].x,pts[0].y);
      pts.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));
      ctx.closePath();ctx.stroke();
    } else if(obj.type==='arrow'){
      const p=w2s(obj.x,obj.y),p2=w2s(obj.x2!==undefined?obj.x2:obj.x+64,obj.y2!==undefined?obj.y2:obj.y);
      ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();
    } else if(obj.type==='draw'||obj.type==='person'||obj.type==='enemy'){
      const p=w2s(obj.x,obj.y),q=w2s(obj.x+(obj.w||24),obj.y+(obj.h||32));
      ctx.strokeRect(p.x-3,p.y-3,q.x-p.x+6,q.y-p.y+6);
    } else {
      const p=w2s(obj.x,obj.y),q=w2s(obj.x+obj.w,obj.y+obj.h);
      ctx.strokeRect(p.x-2,p.y-2,q.x-p.x+4,q.y-p.y+4);
      // Resize handles: only for single selection
      if(MAP.selectedIds.size===1){
        ctx.setLineDash([]);
        ctx.fillStyle='#c9a227';
        const handles=[{x:p.x,y:p.y},{x:q.x,y:p.y},{x:p.x,y:q.y},{x:q.x,y:q.y},
          {x:(p.x+q.x)/2,y:p.y},{x:(p.x+q.x)/2,y:q.y},{x:p.x,y:(p.y+q.y)/2},{x:q.x,y:(p.y+q.y)/2}];
        handles.forEach(h=>{ctx.fillRect(h.x-4,h.y-4,8,8);});
      }
    }
    ctx.restore();
  });

  // Multi-select: draw combined bounding box + resize handles
  if(MAP.selectedIds.size>1){
    const bb=_getGroupBBox();
    if(bb){
      const p1=w2s(bb.x1,bb.y1),p2=w2s(bb.x2,bb.y2);
      ctx.save();
      ctx.strokeStyle='rgba(201,162,39,0.55)';ctx.lineWidth=1;ctx.setLineDash([6,4]);
      ctx.strokeRect(p1.x-6,p1.y-6,p2.x-p1.x+12,p2.y-p1.y+12);
      // Resize handles
      ctx.setLineDash([]);ctx.fillStyle='#c9a227';
      const mx=(p1.x+p2.x)/2,my=(p1.y+p2.y)/2;
      const hpts=[{x:p1.x-6,y:p1.y-6},{x:mx,y:p1.y-6},{x:p2.x+6,y:p1.y-6},
                  {x:p1.x-6,y:my},                     {x:p2.x+6,y:my},
                  {x:p1.x-6,y:p2.y+6},{x:mx,y:p2.y+6},{x:p2.x+6,y:p2.y+6}];
      hpts.forEach(h=>ctx.fillRect(h.x-4,h.y-4,8,8));
      ctx.restore();
    }
  }

  // Draw preview
  if (MAP.isDrawing && MAP.drawStart && MAP.drawCurrent) {
    const s=w2s(MAP.drawStart.x,MAP.drawStart.y), c=w2s(MAP.drawCurrent.x,MAP.drawCurrent.y);
    ctx.save();
    ctx.strokeStyle='#c9a227';ctx.lineWidth=1.5;ctx.setLineDash([5,3]);ctx.globalAlpha=.7;
    if(MAP.tool==='circle'){const r=Math.hypot(c.x-s.x,c.y-s.y);ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);ctx.stroke();}
    else if(MAP.tool==='arrow'){
      ctx.setLineDash([]);ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(c.x,c.y);ctx.stroke();
      const ang=Math.atan2(c.y-s.y,c.x-s.x),al=14;
      ctx.beginPath();ctx.moveTo(c.x,c.y);ctx.lineTo(c.x-al*Math.cos(ang-.45),c.y-al*Math.sin(ang-.45));ctx.lineTo(c.x-al*Math.cos(ang+.45),c.y-al*Math.sin(ang+.45));ctx.closePath();ctx.fill();
    }
    else ctx.strokeRect(s.x,s.y,c.x-s.x,c.y-s.y);
    ctx.restore();
  }
  // Freehand draw preview
  if(MAP.tool==='draw'&&MAP.isDrawing&&MAP.drawPoints&&MAP.drawPoints.length>1){
    ctx.save();ctx.strokeStyle='#4ecb71';ctx.lineWidth=2;ctx.globalAlpha=.8;ctx.setLineDash([]);
    ctx.beginPath();const dps=MAP.drawPoints.map(p=>w2s(p.x,p.y));ctx.moveTo(dps[0].x,dps[0].y);dps.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();
  }

  // Polygon in progress
  if(MAP.tool==='poly' && MAP.polyPoints.length>0) {
    ctx.save();
    ctx.strokeStyle='#4a9eff';ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
    ctx.beginPath();
    const pts=MAP.polyPoints.map(p=>w2s(p.x,p.y));
    ctx.moveTo(pts[0].x,pts[0].y);
    pts.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.stroke();
    pts.forEach(p=>{ctx.fillStyle='#4a9eff';ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();});
    ctx.restore();
  }

  // Marquee (rubber-band) selection rectangle
  if(MAP.isMarquee&&MAP.marqueeStart&&MAP.marqueeCurrent){
    const {sx:x1,sy:y1}=MAP.marqueeStart,{sx:x2,sy:y2}=MAP.marqueeCurrent;
    ctx.save();
    ctx.strokeStyle='#c9a227';ctx.lineWidth=1;ctx.setLineDash([4,3]);ctx.globalAlpha=.9;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    ctx.fillStyle='rgba(201,162,39,0.07)';ctx.fillRect(x1,y1,x2-x1,y2-y1);
    ctx.restore();
  }

  document.getElementById('sb-zoom').textContent=Math.round(MAP.cam.zoom*100);
  document.getElementById('sb-objs').textContent=MAP.objects.length;
}

function drawObj(obj,ctx) {
  if(obj.hidden){return;}
  ctx.save();
  ctx.globalAlpha=obj.opacity!==undefined?obj.opacity:1;
  const p=w2s(obj.x,obj.y);

  if(obj.type==='circle'){
    const r=obj.r*MAP.cam.zoom;
    ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);
    ctx.fillStyle=obj.fill||'#1e2e18';ctx.fill();
    ctx.strokeStyle=obj.stroke||'#4a7a3a';ctx.lineWidth=1;ctx.stroke();
  } else if(obj.type==='text'){
    const fs=Math.max(4,(obj.fontSize||14)*MAP.cam.zoom);
    ctx.font=`bold ${fs}px Rajdhani,sans-serif`;
    ctx.textBaseline='top';
    ctx.fillStyle=obj.fill||'#c9a227';
    ctx.fillText(obj.text||'Text',p.x,p.y);
    // Update w/h based on measured text for accurate hit testing
    const mw=ctx.measureText(obj.text||'Text').width/MAP.cam.zoom;
    obj.w=Math.max(20,mw);obj.h=Math.max(10,(obj.fontSize||14)*1.4);
    ctx.textBaseline='alphabetic';
  } else if(obj.type==='poly'){
    const pts=obj.points.map(pt=>w2s(pt.x,pt.y));
    ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
    pts.slice(1).forEach(pt=>ctx.lineTo(pt.x,pt.y));
    ctx.closePath();
    ctx.fillStyle=obj.fill||'#1e2e18';ctx.fill();
    ctx.strokeStyle=obj.stroke||'#4a9eff';ctx.lineWidth=1;ctx.stroke();
  } else if(obj.type==='stair'){
    const q=w2s(obj.x+obj.w,obj.y+obj.h);
    const sw=q.x-p.x, sh=q.y-p.y;
    ctx.fillStyle=obj.fill||'#2a2010';ctx.fillRect(p.x,p.y,sw,sh);
    ctx.strokeStyle=obj.stroke||'#c9a227';ctx.lineWidth=Math.max(0.5,1.5*MAP.cam.zoom);ctx.strokeRect(p.x,p.y,sw,sh);
    const steps=obj.steps||4;
    ctx.strokeStyle=(obj.stroke||'#c9a227')+'66';ctx.lineWidth=0.5;ctx.setLineDash([2,2]);
    for(let i=1;i<steps;i++){
      ctx.beginPath();ctx.moveTo(p.x+sw*i/steps,p.y);ctx.lineTo(p.x+sw*i/steps,p.y+sh);ctx.stroke();
      ctx.beginPath();ctx.moveTo(p.x,p.y+sh*i/steps);ctx.lineTo(p.x+sw,p.y+sh*i/steps);ctx.stroke();
    }
    ctx.setLineDash([]);
    if(obj.name&&MAP.cam.zoom>0.3){ctx.font=`${Math.max(8,10*MAP.cam.zoom)}px Barlow`;ctx.fillStyle='rgba(201,162,39,0.7)';ctx.fillText(obj.name,p.x+3,p.y-3);}
  } else if(obj.type==='light'){
    const lr=(obj.r||48)*MAP.cam.zoom;
    const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,lr);
    const fc=obj.fill||'#ffcc55';
    grad.addColorStop(0,fc+'bb');grad.addColorStop(0.45,fc+'44');grad.addColorStop(1,fc+'00');
    ctx.beginPath();ctx.arc(p.x,p.y,lr,0,Math.PI*2);ctx.fillStyle=grad;ctx.fill();
    ctx.beginPath();ctx.arc(p.x,p.y,Math.max(3,5*MAP.cam.zoom),0,Math.PI*2);ctx.fillStyle=fc;ctx.fill();
    if(obj.name&&MAP.cam.zoom>0.3){ctx.font=`${Math.max(7,9*MAP.cam.zoom)}px Barlow`;ctx.fillStyle=fc;ctx.fillText(obj.name,p.x+6,p.y-lr*.6);}
  } else if(obj.type==='person'){
    const sz=Math.max(3,10*MAP.cam.zoom);
    const fc=obj.fill||'#4a9eff';
    ctx.beginPath();ctx.arc(p.x+sz*.6,p.y+sz*.7,sz*.6,0,Math.PI*2);ctx.fillStyle=fc;ctx.fill();
    ctx.beginPath();ctx.moveTo(p.x+sz*.6,p.y+sz*1.3);ctx.lineTo(p.x+sz*.6,p.y+sz*2.4);
    ctx.moveTo(p.x,p.y+sz*1.6);ctx.lineTo(p.x+sz*1.2,p.y+sz*1.6);
    ctx.moveTo(p.x+sz*.6,p.y+sz*2.4);ctx.lineTo(p.x+sz*.1,p.y+sz*3.2);
    ctx.moveTo(p.x+sz*.6,p.y+sz*2.4);ctx.lineTo(p.x+sz*1.1,p.y+sz*3.2);
    ctx.strokeStyle=fc;ctx.lineWidth=Math.max(1,1.5*MAP.cam.zoom);ctx.stroke();
    if(obj.name&&MAP.cam.zoom>0.4){ctx.font=`bold ${Math.max(8,10*MAP.cam.zoom)}px Barlow`;ctx.fillStyle=fc;ctx.fillText(obj.name,p.x-4,p.y-2);}
  } else if(obj.type==='enemy'){
    const sz=Math.max(3,9*MAP.cam.zoom);
    const fc=obj.fill||'#e05252';
    ctx.beginPath();ctx.moveTo(p.x+sz,p.y);ctx.lineTo(p.x+sz*2,p.y+sz*1.2);ctx.lineTo(p.x+sz,p.y+sz*2.4);ctx.lineTo(p.x,p.y+sz*1.2);ctx.closePath();
    ctx.fillStyle=fc+'33';ctx.fill();ctx.strokeStyle=fc;ctx.lineWidth=Math.max(1,1.5*MAP.cam.zoom);ctx.stroke();
    ctx.beginPath();ctx.moveTo(p.x+sz*.25,p.y+sz*.45);ctx.lineTo(p.x+sz*1.75,p.y+sz*1.95);
    ctx.moveTo(p.x+sz*1.75,p.y+sz*.45);ctx.lineTo(p.x+sz*.25,p.y+sz*1.95);
    ctx.strokeStyle=fc;ctx.lineWidth=Math.max(1,2*MAP.cam.zoom);ctx.stroke();
    if(obj.name&&MAP.cam.zoom>0.4){ctx.font=`bold ${Math.max(8,10*MAP.cam.zoom)}px Barlow`;ctx.fillStyle=fc;ctx.fillText(obj.name,p.x-4,p.y-2);}
  } else if(obj.type==='arrow'){
    const p2=w2s(obj.x2!==undefined?obj.x2:obj.x+64,obj.y2!==undefined?obj.y2:obj.y);
    const fc=obj.fill||'#c9a227';
    ctx.strokeStyle=fc;ctx.lineWidth=Math.max(1.5,2.5*MAP.cam.zoom);ctx.setLineDash([]);
    ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();
    const ang=Math.atan2(p2.y-p.y,p2.x-p.x),al=Math.max(10,14*MAP.cam.zoom);
    ctx.beginPath();ctx.moveTo(p2.x,p2.y);ctx.lineTo(p2.x-al*Math.cos(ang-.45),p2.y-al*Math.sin(ang-.45));ctx.lineTo(p2.x-al*Math.cos(ang+.45),p2.y-al*Math.sin(ang+.45));ctx.closePath();ctx.fillStyle=fc;ctx.fill();
    if(obj.name&&MAP.cam.zoom>0.4){ctx.font=`${Math.max(8,10*MAP.cam.zoom)}px Barlow`;ctx.fillStyle=fc;ctx.fillText(obj.name,(p.x+p2.x)/2+2,(p.y+p2.y)/2-4);}
  } else if(obj.type==='draw'){
    if(!obj.points||obj.points.length<2){ctx.restore();return;}
    const dpts=obj.points.map(pt=>w2s(pt.x,pt.y));
    ctx.beginPath();ctx.moveTo(dpts[0].x,dpts[0].y);dpts.slice(1).forEach(pt=>ctx.lineTo(pt.x,pt.y));
    ctx.strokeStyle=obj.stroke||'#4ecb71';ctx.lineWidth=Math.max(1,2*MAP.cam.zoom);ctx.stroke();
  } else if(obj.type==='asset'){
    const q=w2s(obj.x+obj.w,obj.y+obj.h);
    const iw=q.x-p.x, ih=q.y-p.y;
    if(!MAP._imgCache) MAP._imgCache={};
    if(obj.assetId && MAP._imgCache[obj.assetId]){
      const img=MAP._imgCache[obj.assetId];
      ctx.drawImage(img, p.x, p.y, iw, ih);
    } else if(obj.assetId){
      // Load image and cache
      const assetDef=(PS.data.mapAssets||[]).find(a=>a.id===obj.assetId);
      if(assetDef&&assetDef.src){
        const img=new Image();
        img.onload=()=>{MAP._imgCache[obj.assetId]=img;renderMap();};
        img.src=assetDef.src;
      } else {
        // Fallback placeholder
        ctx.fillStyle='rgba(201,162,39,.15)';ctx.fillRect(p.x,p.y,iw,ih);
        ctx.strokeStyle='rgba(201,162,39,.4)';ctx.lineWidth=1;ctx.strokeRect(p.x,p.y,iw,ih);
      }
    }
    if(obj.name&&MAP.cam.zoom>0.3){
      ctx.font=`${Math.max(8,10*MAP.cam.zoom)}px Barlow`;
      ctx.fillStyle='rgba(232,224,204,0.55)';
      ctx.fillText(obj.name,p.x+3,p.y-3);
    }
  } else {
    const q=w2s(obj.x+obj.w,obj.y+obj.h);
    const w=q.x-p.x, h=q.y-p.y;
    if(obj.type==='wall'){ctx.fillStyle=obj.fill||'#3a2a1a';}else{ctx.fillStyle=obj.fill||'#1e2e18';}
    ctx.fillRect(p.x,p.y,w,h);
    ctx.strokeStyle=obj.stroke||(obj.type==='wall'?'#c9a227':'#4a7a3a');
    ctx.lineWidth=obj.type==='wall'?Math.max(1,2*MAP.cam.zoom):Math.max(0.5,1*MAP.cam.zoom);
    ctx.strokeRect(p.x,p.y,w,h);
    // Object label
    if(obj.name && MAP.cam.zoom>0.3){
      ctx.font=`${Math.max(8,10*MAP.cam.zoom)}px Barlow`;
      ctx.fillStyle='rgba(232,224,204,0.45)';
      ctx.fillText(obj.name,p.x+3*MAP.cam.zoom,p.y-3*MAP.cam.zoom);
    }
  }
  // â”€â”€ Locked indicator (small padlock at top-right, non-obtrusive) â”€â”€
  if(obj.locked && MAP.cam.zoom>0.28){
    const ls=Math.max(5,7*MAP.cam.zoom); // lock size scales with zoom
    let lx,ly;
    if(obj.type==='circle'){
      const sr=(obj.r||32)*MAP.cam.zoom;
      lx=p.x+sr-ls-2; ly=p.y-sr+2;
    } else if(obj.type==='arrow'){
      const p2=w2s(obj.x2!==undefined?obj.x2:obj.x+64,obj.y2!==undefined?obj.y2:obj.y);
      lx=Math.max(p.x,p2.x)-ls-2; ly=Math.min(p.y,p2.y)+2;
    } else {
      const qlock=w2s(obj.x+(obj.w||64),obj.y);
      lx=qlock.x-ls-2; ly=qlock.y+2;
    }
    ctx.save();
    ctx.globalAlpha=0.72;
    // Lock body
    const bw=ls*.82,bh=ls*.58,sh=ls*.44;
    const bx=lx+(ls-bw)/2,by=ly+sh;
    ctx.fillStyle='#c9a227';
    ctx.beginPath();
    if(ctx.roundRect) ctx.roundRect(bx,by,bw,bh,1.2); else ctx.rect(bx,by,bw,bh);
    ctx.fill();
    // Shackle arc
    ctx.beginPath();
    ctx.arc(lx+ls/2,ly+sh,ls*.29,Math.PI,0);
    ctx.strokeStyle='#c9a227';
    ctx.lineWidth=Math.max(1,1.1*MAP.cam.zoom);
    ctx.stroke();
    ctx.restore();
  }
  ctx.restore();
}

let _histOnceFlag = false;
function mapPushHistory(){MAP.history.push(JSON.stringify(MAP.objects));if(MAP.history.length>60)MAP.history.shift();MAP.future=[];}
function mapPushHistoryOnce(){if(!MAP._histOnce){mapPushHistory();MAP._histOnce=true;}}
function mapUndo(){if(!MAP.history.length)return;MAP.future.push(JSON.stringify(MAP.objects));MAP.objects=JSON.parse(MAP.history.pop());MAP.selectedIds.clear();renderMap();renderMapProps();autoSave();mapSaveCurrent();}
function mapRedo(){if(!MAP.future.length)return;MAP.history.push(JSON.stringify(MAP.objects));MAP.objects=JSON.parse(MAP.future.pop());MAP.selectedIds.clear();renderMap();renderMapProps();autoSave();mapSaveCurrent();}

function setTool(tool) {
  MAP.tool=tool;
  MAP.polyPoints=[];MAP.isDrawing=false;MAP.drawPoints=null;
  document.querySelectorAll('.mt[id^="tool-"]').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('tool-'+tool);
  if(btn) btn.classList.add('active');
  const hintEl=document.getElementById('map-tool-hint');
  if(hintEl) hintEl.textContent=HINTS[tool]||'';
}

function toggleGrid(){MAP.showGrid=!MAP.showGrid;document.getElementById('btn-grid').classList.toggle('toggled',MAP.showGrid);document.getElementById('sb-grid').textContent=MAP.showGrid?'ON':'OFF';renderMap();}
function toggleSnap(){MAP.snapToGrid=!MAP.snapToGrid;document.getElementById('btn-snap').classList.toggle('toggled',MAP.snapToGrid);document.getElementById('sb-snap').textContent=MAP.snapToGrid?'ON':'OFF';}
function zoomMap(f){MAP.cam.zoom=Math.max(0.05,Math.min(8,MAP.cam.zoom*f));renderMap();}
function fitToScreen(){
  if(!MAP.objects.length){MAP.cam={x:0,y:0,zoom:1};renderMap();return;}
  const xs=MAP.objects.map(o=>o.x), ys=MAP.objects.map(o=>o.y);
  const xes=MAP.objects.map(o=>o.type==='circle'?o.x+o.r:o.x+(o.w||0));
  const yes=MAP.objects.map(o=>o.type==='circle'?o.y+o.r:o.y+(o.h||0));
  const minX=Math.min(...xs), minY=Math.min(...ys);
  const maxX=Math.max(...xes), maxY=Math.max(...yes);
  const W=MAP.wrap.clientWidth, H=MAP.wrap.clientHeight;
  const pad=60;
  const zx=(W-pad*2)/(maxX-minX||1), zy=(H-pad*2)/(maxY-minY||1);
  MAP.cam.zoom=Math.min(zx,zy,4);
  MAP.cam.x=-(minX+(maxX-minX)/2)*MAP.cam.zoom;
  MAP.cam.y=-(minY+(maxY-minY)/2)*MAP.cam.zoom;
  renderMap();
}

function focusOnSelected(){
  if(!MAP.selectedIds.size){fitToScreen();return;}
  const sel=MAP.objects.filter(o=>MAP.selectedIds.has(o.id));
  if(!sel.length){fitToScreen();return;}
  const pad=80;
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  sel.forEach(o=>{
    const ox1=o.type==='circle'?o.x-(o.r||32):o.x;
    const oy1=o.type==='circle'?o.y-(o.r||32):o.y;
    const ox2=o.type==='circle'?o.x+(o.r||32):o.x+(o.w||64);
    const oy2=o.type==='circle'?o.y+(o.r||32):o.y+(o.h||64);
    x1=Math.min(x1,ox1);y1=Math.min(y1,oy1);x2=Math.max(x2,ox2);y2=Math.max(y2,oy2);
  });
  const W=MAP.wrap.clientWidth,H=MAP.wrap.clientHeight;
  const zx=(W-pad*2)/Math.max(1,x2-x1),zy=(H-pad*2)/Math.max(1,y2-y1);
  MAP.cam.zoom=Math.min(zx,zy,4);
  MAP.cam.x=-(x1+(x2-x1)/2)*MAP.cam.zoom+W/2;
  MAP.cam.y=-(y1+(y2-y1)/2)*MAP.cam.zoom+H/2;
  renderMap();
}

function renderMapLayers() {
  const list=document.getElementById('map-layers-list');
  const countEl=document.getElementById('layers-count');
  if(!list) return;
  list.innerHTML='';
  if(countEl) countEl.textContent=MAP.objects.length+' obj';
  if(!MAP.objects.length&&!MAP.groups.length){
    list.innerHTML='<div style="text-align:center;padding:20px 8px;font-family:var(--fu);font-size:9px;color:var(--text-muted);letter-spacing:.5px">No objects</div>';
    return;
  }

  // â”€â”€ SVG icon helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const LOCK_CLOSED=`<svg width="11" height="11" viewBox="0 0 11 11" fill="none" style="display:block"><rect x="1.5" y="5" width="8" height="5.5" rx="1.3" fill="#c9a227"/><path d="M3.5 5V3.8a2 2 0 1 1 4 0V5" stroke="#c9a227" stroke-width="1.5"/></svg>`;
  const LOCK_OPEN=`<svg width="11" height="11" viewBox="0 0 11 11" fill="none" style="display:block"><rect x="1.5" y="5" width="8" height="5.5" rx="1.3" fill="currentColor" opacity=".32"/><path d="M7.5 5V3.8a2 2 0 1 0-4 0" stroke="currentColor" stroke-width="1.5" opacity=".32"/></svg>`;
  const EYE_ON=`<svg width="11" height="11" viewBox="0 0 11 11" fill="none" style="display:block"><path d="M1 5.5C2.5 3 4 2 5.5 2s3 1 4.5 3.5C8.5 8 7 9 5.5 9S2.5 8 1 5.5Z" stroke="currentColor" stroke-width="1.2"/><circle cx="5.5" cy="5.5" r="1.5" fill="currentColor"/></svg>`;
  const EYE_OFF=`<svg width="11" height="11" viewBox="0 0 11 11" fill="none" style="display:block"><path d="M1 5.5C2.5 3 4 2 5.5 2s3 1 4.5 3.5C8.5 8 7 9 5.5 9S2.5 8 1 5.5Z" stroke="currentColor" stroke-width="1.2" opacity=".3"/><line x1="1.5" y1="1.5" x2="9.5" y2="9.5" stroke="currentColor" stroke-width="1.3"/></svg>`;
  const DRAG_HANDLE=`<svg width="8" height="12" viewBox="0 0 8 12" fill="currentColor" style="display:block;opacity:.4"><circle cx="2" cy="2" r="1.2"/><circle cx="6" cy="2" r="1.2"/><circle cx="2" cy="6" r="1.2"/><circle cx="6" cy="6" r="1.2"/><circle cx="2" cy="10" r="1.2"/><circle cx="6" cy="10" r="1.2"/></svg>`;

  const TYPE_ICONS={rect:'â–­',wall:'â–®',circle:'â—¯',poly:'â¬¡',stair:'âŠŸ',light:'âœ¦',person:'â—‰',enemy:'âœ•',arrow:'â†—',draw:'~',asset:'âŠ'};
  const TYPE_COLORS={wall:'#c9a227',rect:'#5eaaff',circle:'#4ecb71',poly:'#cc7bdb',stair:'#d49a2a',light:'#ffcc55',person:'#4a9eff',enemy:'#e05252',arrow:'#c9a227aa',draw:'#4ecb71',text:'#c9a227',asset:'#ccaa77'};

  // â”€â”€ Build a single layer row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _mkRow(obj, indent) {
    const isSelected=MAP.selectedIds.has(obj.id);
    const isText=obj.type==='text';
    const row=document.createElement('div');
    row.className='layer-row'+(isSelected?' active':'')+(obj.hidden?' hidden-obj':'');
    row.dataset.id=obj.id;
    if(indent) row.style.paddingLeft='20px';

    const typeColor=TYPE_COLORS[obj.type]||'#888';
    const swatchColor=obj.fill||typeColor;
    const displayName=isText?(obj.text||obj.name||'Text'):(obj.name||obj.type);

    const typeIconHtml=isText
      ?`<span class="layer-type-text" title="Text">T</span>`
      :`<span class="layer-type-icon" style="color:${typeColor}">${TYPE_ICONS[obj.type]||'â–¡'}</span>`;

    // Text rows get a left accent
    if(isText) row.style.borderLeft='2px solid rgba(201,162,39,.45)';

    row.innerHTML=`
      <span style="color:var(--text-muted);cursor:grab;flex-shrink:0;padding:0 3px 0 1px;line-height:1;user-select:none" title="Arrastrar para reordenar">${DRAG_HANDLE}</span>
      <span class="layer-icon-btn" onclick="toggleObjVis('${obj.id}')" title="${obj.hidden?'Mostrar':'Ocultar'}">${obj.hidden?EYE_OFF:EYE_ON}</span>
      <span class="layer-icon-btn ${obj.locked?'layer-lock-closed':'layer-lock-open'}" onclick="toggleObjLock('${obj.id}')" title="${obj.locked?'Bloqueado â€” click para desbloquear':'Desbloqueado â€” click para bloquear'}">${obj.locked?LOCK_CLOSED:LOCK_OPEN}</span>
      <div class="layer-color-swatch" style="background:${swatchColor}"></div>
      ${typeIconHtml}
      <span class="layer-name${isText?' layer-name-text':''}" ondblclick="_layerRename(this,'${obj.id}')" title="Doble-click para renombrar">${displayName}</span>
      ${obj.locked?`<span style="font-size:7px;color:#c9a227;flex-shrink:0;font-family:var(--fu);letter-spacing:.3px;margin-left:2px">LCK</span>`:''}`;
    return row;
  }

  // Which object IDs are inside any group?
  const groupedIds=new Set(MAP.groups.flatMap(g=>g.childIds));

  // â”€â”€ GROUPS (folders) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MAP.groups.forEach(grp=>{
    const frow=document.createElement('div');
    frow.className='layer-row layer-folder'+(grp.hidden?' hidden-obj':'');
    frow.style.cssText='background:rgba(201,162,39,.07);border-left:2px solid var(--gold-dim);';
    frow.innerHTML=`
      <span style="color:var(--gold);font-size:10px;cursor:pointer;flex-shrink:0;padding:0 3px;line-height:1" onclick="toggleGroupCollapse('${grp.id}')">${grp.collapsed?'â–¶':'â–¼'}</span>
      <span class="layer-icon-btn" onclick="toggleGroupVis('${grp.id}')" title="${grp.hidden?'Mostrar':'Ocultar'}">${grp.hidden?EYE_OFF:EYE_ON}</span>
      <span class="layer-icon-btn ${grp.locked?'layer-lock-closed':'layer-lock-open'}" onclick="toggleGroupLock('${grp.id}')" title="${grp.locked?'Grupo bloqueado':'Grupo desbloqueado'}">${grp.locked?LOCK_CLOSED:LOCK_OPEN}</span>
      <span style="color:var(--gold);font-size:11px;flex-shrink:0;line-height:1;margin:0 2px">ğŸ“</span>
      <span class="layer-name" ondblclick="_groupRename(this,'${grp.id}')" style="color:var(--gold);font-weight:600">${grp.name}</span>
      <span style="font-size:8px;color:var(--gold-dim);margin-left:auto;padding-right:3px;font-family:var(--fu)">${grp.childIds.length}</span>`;
    frow.oncontextmenu=e=>{e.preventDefault();_layerContextMenu(e,null,grp.id);};
    frow.onclick=(ev)=>{
      if(ev.target.classList.contains('layer-icon-btn')) return;
      if(!ev.shiftKey) MAP.selectedIds.clear();
      grp.childIds.forEach(id=>MAP.selectedIds.add(id));
      renderMap();renderMapProps();renderMapLayers();
    };
    list.appendChild(frow);

    if(!grp.collapsed){
      grp.childIds.forEach(childId=>{
        const obj=MAP.objects.find(o=>o.id===childId);
        if(!obj) return;
        const crow=_mkRow(obj, true);
        crow.onclick=(ev)=>{
          if(ev.target.classList.contains('layer-icon-btn')) return;
          if(!ev.shiftKey) MAP.selectedIds.clear();
          MAP.selectedIds.add(obj.id);
          renderMap();renderMapProps();renderMapLayers();
        };
        crow.oncontextmenu=e=>{e.preventDefault();_layerContextMenu(e,obj.id,null);};
        list.appendChild(crow);
      });
    }
  });

  // â”€â”€ UNGROUPED OBJECTS (reverse = front first) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [...MAP.objects].reverse().forEach(obj=>{
    if(groupedIds.has(obj.id)) return;
    const row=_mkRow(obj, false);
    row.draggable=true;
    row.onclick=(e)=>{
      if(e.target.classList.contains('layer-icon-btn')) return;
      if(!e.shiftKey) MAP.selectedIds.clear();
      MAP.selectedIds.add(obj.id);
      renderMap();renderMapProps();renderMapLayers();
    };
    row.oncontextmenu=e=>{e.preventDefault();_layerContextMenu(e,obj.id,null);};

    // Drag-to-reorder with top/bottom insertion indicator
    row.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',obj.id);
      // Small delay so the row renders before going transparent
      setTimeout(()=>row.classList.add('dragging'),0);
    });
    row.addEventListener('dragend',()=>{
      row.classList.remove('dragging');
      list.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(r=>r.classList.remove('drag-over-top','drag-over-bottom'));
    });
    row.addEventListener('dragover',e=>{
      e.preventDefault();
      list.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(r=>r.classList.remove('drag-over-top','drag-over-bottom'));
      const {top,height}=row.getBoundingClientRect();
      row.classList.add(e.clientY<top+height/2?'drag-over-top':'drag-over-bottom');
    });
    row.addEventListener('dragleave',()=>row.classList.remove('drag-over-top','drag-over-bottom'));
    row.addEventListener('drop',e=>{
      e.preventDefault();
      const insertBefore=row.classList.contains('drag-over-top');
      row.classList.remove('drag-over-top','drag-over-bottom');
      const fromId=e.dataTransfer.getData('text/plain');
      const fromIdx=MAP.objects.findIndex(o=>o.id===fromId);
      const toIdx=MAP.objects.findIndex(o=>o.id===obj.id);
      if(fromIdx<0||toIdx<0||fromIdx===toIdx) return;
      mapPushHistory();
      const [moved]=MAP.objects.splice(fromIdx,1);
      const newTo=MAP.objects.findIndex(o=>o.id===obj.id);
      MAP.objects.splice(insertBefore?newTo:newTo+1,0,moved);
      renderMap();renderMapLayers();mapSaveCurrent();
    });
    list.appendChild(row);
  });
}

function toggleObjVis(id){const obj=MAP.objects.find(o=>o.id===id);if(obj){obj.hidden=!obj.hidden;renderMap();renderMapLayers();mapSaveCurrent();}}
function toggleObjLock(id){const obj=MAP.objects.find(o=>o.id===id);if(obj){obj.locked=!obj.locked;renderMapLayers();}}

function _layerRename(span, id){
  const obj=MAP.objects.find(o=>o.id===id);
  if(!obj)return;
  const oldName=obj.name||obj.type;
  const inp=document.createElement('input');
  inp.value=oldName;
  inp.style.cssText='width:100%;background:var(--bg-input);border:1px solid var(--gold);border-radius:2px;padding:1px 4px;font-family:var(--fu);font-size:11px;color:var(--text-primary);outline:none';
  span.replaceWith(inp);
  inp.focus();inp.select();
  const commit=()=>{
    const name=inp.value.trim()||oldName;
    obj.name=name;
    const newSpan=document.createElement('span');
    newSpan.className='layer-name';
    newSpan.dataset.id=id;
    newSpan.title='Double-click to rename';
    newSpan.ondblclick=()=>_layerRename(newSpan,id);
    newSpan.textContent=name;
    inp.replaceWith(newSpan);
    renderMap();renderMapProps();autoSave();mapSaveCurrent();
  };
  inp.onblur=commit;
  inp.onkeydown=e=>{if(e.key==='Enter')commit();if(e.key==='Escape'){inp.value=oldName;commit();}};
}

// â”€â”€ GROUP / FOLDER MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleGroupCollapse(id){
  const g=MAP.groups.find(g=>g.id===id);
  if(g){g.collapsed=!g.collapsed;renderMapLayers();}
}
function toggleGroupVis(id){
  const g=MAP.groups.find(g=>g.id===id);
  if(!g)return;
  g.hidden=!g.hidden;
  g.childIds.forEach(cid=>{const o=MAP.objects.find(o=>o.id===cid);if(o)o.hidden=g.hidden;});
  renderMap();renderMapLayers();mapSaveCurrent();
}
function toggleGroupLock(id){
  const g=MAP.groups.find(g=>g.id===id);
  if(!g)return;
  g.locked=!g.locked;
  g.childIds.forEach(cid=>{const o=MAP.objects.find(o=>o.id===cid);if(o)o.locked=g.locked;});
  renderMapLayers();mapSaveCurrent();
}
function _groupRename(span,id){
  const g=MAP.groups.find(g=>g.id===id);
  if(!g)return;
  const old=g.name;
  const inp=document.createElement('input');
  inp.value=old;
  inp.style.cssText='width:100%;background:var(--bg-input);border:1px solid var(--gold);border-radius:2px;padding:1px 4px;font-family:var(--fu);font-size:11px;color:var(--text-primary);outline:none';
  span.replaceWith(inp);inp.focus();inp.select();
  const commit=()=>{
    g.name=inp.value.trim()||old;
    renderMapLayers();mapSaveCurrent();
  };
  inp.onblur=commit;
  inp.onkeydown=e=>{if(e.key==='Enter')commit();if(e.key==='Escape'){g.name=old;commit();}};
}

function _groupRenameById(id){
  const g=MAP.groups.find(g=>g.id===id);
  if(!g)return;
  const name=prompt('Rename group:',g.name);
  if(name&&name.trim()){g.name=name.trim();renderMapLayers();mapSaveCurrent();}
}
function groupSelected(){
  if(MAP.selectedIds.size<2){showToast('Select 2+ objects to group');return;}
  const name=prompt('Group name:','Group '+(MAP.groups.length+1));
  if(!name)return;
  const id='grp_'+Date.now();
  MAP.groups.push({id,name,childIds:[...MAP.selectedIds],collapsed:false,hidden:false,locked:false});
  renderMapLayers();mapSaveCurrent();autoSave();
  showToast('Group "'+name+'" created');
}
function ungroupSelected(grpId){
  MAP.groups=MAP.groups.filter(g=>g.id!==grpId);
  renderMapLayers();mapSaveCurrent();autoSave();
  showToast('Group dissolved');
}
function addToGroup(objId,grpId){
  const g=MAP.groups.find(g=>g.id===grpId);
  if(g&&!g.childIds.includes(objId)) g.childIds.push(objId);
  renderMapLayers();mapSaveCurrent();
}
function removeFromGroup(objId,grpId){
  const g=MAP.groups.find(g=>g.id===grpId);
  if(g) g.childIds=g.childIds.filter(id=>id!==objId);
  if(g&&g.childIds.length===0) MAP.groups=MAP.groups.filter(x=>x.id!==grpId);
  renderMapLayers();mapSaveCurrent();
}

// Right-click context menu for layers panel
function _layerContextMenu(e,objId,grpId){
  e.preventDefault();
  const menu=document.getElementById('layer-ctx-menu');
  if(!menu)return;
  // Determine which group (if any) the object belongs to
  const parentGrp=objId ? MAP.groups.find(g=>g.childIds.includes(objId)) : null;
  let html='';
  if(grpId){
    // Clicked on a group folder row
    const g=MAP.groups.find(g=>g.id===grpId);
    html+=`<button onclick="_closeCtxMenu();_groupRenameById('${grpId}')">âœ Rename Group</button>`;
    html+=`<button onclick="_closeCtxMenu();ungroupSelected('${grpId}')">ğŸ“¤ Ungroup</button>`;
    if(g){
      html+=`<button onclick="_closeCtxMenu();toggleGroupVis('${grpId}')">${g.hidden?'ğŸ‘ Show All':'ğŸ™ˆ Hide All'}</button>`;
      html+=`<button onclick="_closeCtxMenu();toggleGroupLock('${grpId}')">${g.locked?'ğŸ”“ Unlock All':'ğŸ”’ Lock All'}</button>`;
    }
    html+=`<hr>`;
    if(MAP.selectedIds.size>=2){
      html+=`<button onclick="_closeCtxMenu();groupSelected()">ğŸ“ Group Selection</button>`;
    }
    html+=`<button class="danger" onclick="_closeCtxMenu();if(confirm('Delete group and all its objects?')){MAP.groups.find(g=>g.id===\\'${grpId}\\')?.childIds.forEach(id=>{MAP.objects=MAP.objects.filter(o=>o.id!==id);});MAP.groups=MAP.groups.filter(g=>g.id!==\\'${grpId}\\');renderMap();renderMapLayers();mapSaveCurrent();autoSave();}">ğŸ—‘ Delete Group + Objects</button>`;
  } else if(objId){
    // Clicked on an object row
    const obj=MAP.objects.find(o=>o.id===objId);
    html+=`<button onclick="_closeCtxMenu();MAP.selectedIds.clear();MAP.selectedIds.add('${objId}');renderMap();renderMapProps();renderMapLayers()">â˜‘ Select</button>`;
    html+=`<button onclick="_closeCtxMenu();duplicateMapObj('${objId}')">â˜ Duplicate</button>`;
    html+=`<hr>`;
    if(MAP.selectedIds.size>=2){
      html+=`<button onclick="_closeCtxMenu();groupSelected()">ğŸ“ Group Selection</button>`;
    }
    if(parentGrp){
      html+=`<button onclick="_closeCtxMenu();removeFromGroup('${objId}','${parentGrp.id}')">ğŸ“¤ Remove from "${parentGrp.name}"</button>`;
    } else if(MAP.groups.length>0){
      MAP.groups.forEach(g=>{
        html+=`<button onclick="_closeCtxMenu();addToGroup('${objId}','${g.id}')">ğŸ“ Add to "${g.name}"</button>`;
      });
    }
    html+=`<hr>`;
    html+=`<button class="danger" onclick="_closeCtxMenu();deleteMapObj('${objId}')">ğŸ—‘ Delete Object</button>`;
  } else {
    // Fallback: generic
    if(MAP.selectedIds.size>=2){
      html+=`<button onclick="_closeCtxMenu();groupSelected()">ğŸ“ Group Selection</button>`;
    }
  }
  menu.innerHTML=html;
  // Position menu near cursor, keep in viewport
  menu.classList.add('open');
  const mx=Math.min(e.clientX, window.innerWidth-170);
  const my=Math.min(e.clientY, window.innerHeight-menu.scrollHeight-8);
  menu.style.left=mx+'px';
  menu.style.top=my+'px';
  // Auto-close on outside click
  setTimeout(()=>{document.addEventListener('click',_closeCtxMenu,{once:true});},0);
}
function _closeCtxMenu(){
  const menu=document.getElementById('layer-ctx-menu');
  if(menu){menu.classList.remove('open');menu.innerHTML='';}
}

function deleteCurrentMap(){
  if(!MAP.currentMapId){showToast('No map loaded');return;}
  const map=PS.data.maps.find(m=>m.id===MAP.currentMapId);
  if(!confirm('Delete map "'+( map?.name||'this map')+'"? This cannot be undone.')) return;
  PS.data.maps=PS.data.maps.filter(m=>m.id!==MAP.currentMapId);
  MAP.currentMapId=null; MAP.objects=[]; MAP.groups=[]; MAP.selectedIds.clear();
  renderMapSelect();
  const noMap=document.getElementById('map-no-map');
  if(noMap) noMap.style.display='flex';
  renderMapLayers(); renderMap(); renderMapProps(); autoSave();
  showToast('Map deleted');
}

function renderShapesPanel(){
  const body=document.getElementById('map-shapes-body');
  if(!body) return;
  const categories=[
    {label:'Rooms & Terrain',shapes:[
      {icon:'â–­',label:'Room',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#1e2e18',stroke:'#4a7a3a',name:'Room'}}},
      {icon:'â–¬',label:'Corridor',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#141e14',stroke:'#3a6a3a',name:'Corridor'}}},
      {icon:'â– ',label:'Platform',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#1a2830',stroke:'#4a9eff',name:'Platform'}}},
      {icon:'â—»',label:'Open Area',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#0e1e0e',stroke:'#2a5a2a',name:'Open Area'}}},
      {icon:'ğŸŸ¦',label:'Water',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#0a1a3a',stroke:'#4a9eff',name:'Water',opacity:.7}}},
      {icon:'ğŸŸ¥',label:'Boss Room',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#2a0a0a',stroke:'#e05252',name:'Boss Room'}}},
    ]},
    {label:'Walls & Doors',shapes:[
      {icon:'â–®',label:'Wall',fn:()=>{setTool('wall');MAP.shapePreset=null}},
      {icon:'â¬›',label:'Thick Wall',fn:()=>{setTool('wall');MAP.shapePreset={fill:'#4a3a2a',stroke:'#c9a227',name:'Thick Wall'}}},
      {icon:'ğŸšª',label:'Door',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#3a2010',stroke:'#c9a227',name:'Door',type:'door'}}},
      {icon:'ğŸªŸ',label:'Window',fn:()=>{setTool('wall');MAP.shapePreset={fill:'#0a1a3a',stroke:'#4a9eff',name:'Window',opacity:.5}}},
      {icon:'â›©',label:'Gate',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#2a1a0a',stroke:'#c9a227',name:'Gate'}}},
      {icon:'ğŸ§±',label:'Pillar',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#3a2a18',stroke:'#8a6e1a',name:'Pillar'}}},
    ]},
    {label:'Stairs & Elevation',shapes:[
      {icon:'âŠŸ',label:'Stairs',fn:()=>{setTool('stair');MAP.shapePreset=null}},
      {icon:'âŠ',label:'Stair Up',fn:()=>{setTool('stair');MAP.shapePreset={fill:'#1a2040',stroke:'#4a9eff',name:'Stair Up',steps:5}}},
      {icon:'âŠŸ',label:'Stair Dn',fn:()=>{setTool('stair');MAP.shapePreset={fill:'#401a1a',stroke:'#e05252',name:'Stair Down',steps:5}}},
      {icon:'â–±',label:'Ramp',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#1a2818',stroke:'#4ecb71',name:'Ramp'}}},
      {icon:'ğŸ”²',label:'Elevator',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#1a1a2a',stroke:'#9b6bde',name:'Elevator'}}},
      {icon:'ğŸªœ',label:'Ladder',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#2a1a0a',stroke:'#c9a227',name:'Ladder'}}},
    ]},
    {label:'Markers & Spawns',shapes:[
      {icon:'â˜º',label:'Player',fn:()=>{setTool('person');MAP.shapePreset=null}},
      {icon:'â˜ ',label:'Enemy',fn:()=>{setTool('enemy');MAP.shapePreset=null}},
      {icon:'ğŸ',label:'Exit',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#0a3a1a',stroke:'#4ecb71',name:'Exit'}}},
      {icon:'â­',label:'Checkpoint',fn:()=>{setTool('circle');MAP.shapePreset={fill:'#3a3000',stroke:'#c9a227',name:'Checkpoint',r:24}}},
      {icon:'ğŸ’',label:'Pickup',fn:()=>{setTool('circle');MAP.shapePreset={fill:'#001a3a',stroke:'#4a9eff',name:'Pickup',r:16}}},
      {icon:'ğŸ¯',label:'Objective',fn:()=>{setTool('circle');MAP.shapePreset={fill:'#3a0000',stroke:'#e05252',name:'Objective',r:32}}},
    ]},
    {label:'Hazards & Objects',shapes:[
      {icon:'âš ',label:'Hazard',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#3a1a0a',stroke:'#e07820',name:'Hazard',opacity:.8}}},
      {icon:'ğŸ§¨',label:'Trap',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#3a0a0a',stroke:'#e05252',name:'Trap'}}},
      {icon:'â—‰',label:'Light',fn:()=>{setTool('light');MAP.shapePreset=null}},
      {icon:'ğŸº',label:'Prop',fn:()=>{setTool('rect');MAP.shapePreset={fill:'#1a1810',stroke:'#8a6e1a',name:'Prop'}}},
      {icon:'â¤',label:'Arrow',fn:()=>{setTool('arrow');MAP.shapePreset=null}},
      {icon:'âœ',label:'Draw',fn:()=>{setTool('draw');MAP.shapePreset=null}},
    ]},
  ];
  body.innerHTML='';
  categories.forEach(cat=>{
    const catDiv=document.createElement('div');catDiv.className='shape-cat';catDiv.textContent=cat.label;body.appendChild(catDiv);
    const grid=document.createElement('div');grid.className='shape-grid';
    cat.shapes.forEach(s=>{
      const btn=document.createElement('button');btn.className='shape-btn';btn.title=s.label;
      btn.innerHTML=`${s.icon}<span>${s.label}</span>`;
      btn.onclick=()=>{
        body.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active-shape'));
        btn.classList.add('active-shape');s.fn();
      };
      grid.appendChild(btn);
    });
    body.appendChild(grid);
  });

  // â”€â”€ IMAGE ASSETS category â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const assetCatDiv=document.createElement('div');
  assetCatDiv.className='shape-cat';
  assetCatDiv.textContent='Image Assets';
  body.appendChild(assetCatDiv);

  // Upload button
  const uploadRow=document.createElement('div');
  uploadRow.style.cssText='padding:4px 6px 8px';
  const fileInput=document.createElement('input');
  fileInput.type='file';fileInput.accept='image/*';fileInput.multiple=true;fileInput.style.display='none';fileInput.id='map-asset-file-input';
  fileInput.onchange=e=>{
    const files=[...e.target.files];
    if(!files.length)return;
    if(!PS.data.mapAssets) PS.data.mapAssets=[];
    let pending=files.length;
    files.forEach(file=>{
      const reader=new FileReader();
      reader.onload=ev=>{
        const id='asset_'+Date.now()+'_'+Math.random().toString(36).slice(2);
        PS.data.mapAssets.push({id,name:file.name.replace(/\.[^.]+$/,''),src:ev.target.result,w:64,h:64});
        pending--;
        if(pending===0){autoSave();renderShapesPanel();}
      };
      reader.readAsDataURL(file);
    });
    fileInput.value='';
  };
  const uploadBtn=document.createElement('button');
  uploadBtn.className='btn btn-sm';
  uploadBtn.style.cssText='width:100%;font-size:10px';
  uploadBtn.textContent='+ Upload Image(s)';
  uploadBtn.onclick=()=>fileInput.click();
  uploadRow.appendChild(fileInput);
  uploadRow.appendChild(uploadBtn);
  body.appendChild(uploadRow);

  // Render saved assets
  const assets=PS.data.mapAssets||[];
  if(assets.length){
    const assetGrid=document.createElement('div');assetGrid.className='shape-grid';
    assets.forEach(asset=>{
      const btn=document.createElement('button');btn.className='shape-btn';btn.title=asset.name;
      btn.innerHTML=`<img src="${asset.src}" style="width:28px;height:28px;object-fit:contain;border-radius:3px"><span>${asset.name.slice(0,8)}</span>`;
      btn.onclick=()=>{
        body.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active-shape'));
        btn.classList.add('active-shape');
        setTool('asset');
        MAP.assetPreset={id:asset.id,name:asset.name,src:asset.src,w:asset.w||64,h:asset.h||64};
      };
      // Right-click to delete
      btn.oncontextmenu=e=>{
        e.preventDefault();
        if(!confirm('Delete asset "'+asset.name+'"?')) return;
        PS.data.mapAssets=(PS.data.mapAssets||[]).filter(a=>a.id!==asset.id);
        delete MAP._imgCache[asset.id];
        autoSave();renderShapesPanel();
      };
      assetGrid.appendChild(btn);
    });
    body.appendChild(assetGrid);
  } else {
    const empty=document.createElement('div');
    empty.style.cssText='font-size:10px;color:var(--text-muted);padding:4px 8px 10px;font-family:var(--fb)';
    empty.textContent='Upload PNG/JPG images to place on the map';
    body.appendChild(empty);
  }
}

function setActiveLayer(l){MAP.activeLayer=l;document.getElementById('sb-layer').textContent=l;renderMapLayers();}
function toggleLayerVis(l){MAP.hiddenLayers.has(l)?MAP.hiddenLayers.delete(l):MAP.hiddenLayers.add(l);renderMapLayers();renderMap();}
function toggleLayerLock(l){MAP.lockedLayers.has(l)?MAP.lockedLayers.delete(l):MAP.lockedLayers.add(l);renderMapLayers();}
function addLayer(){const name=prompt('Layer name:');if(!name||MAP.layers.includes(name))return;MAP.layers.push(name);renderMapLayers();}

function renderMapProps() {
  const body=document.getElementById('map-props-body');
  const hdr=document.getElementById('map-props-hdr');
  if(!body) return;
  if(!MAP.selectedIds.size){
    hdr.textContent='Properties';
    body.innerHTML='<div class="empty"><div class="empty-icon">ğŸ–±ï¸</div><div class="empty-txt">Select an Object</div></div>';
    return;
  }
  // â”€â”€ Multi-select panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(MAP.selectedIds.size>1){
    const count=MAP.selectedIds.size;
    hdr.textContent=count+' Selected';
    body.innerHTML=`
      <div class="mp-section">
        <div class="mp-section-title">Move (offset)</div>
        <div class="mp-row"><span class="mp-label">Delta X</span><input class="mp-input" type="number" value="0" id="multi-dx" placeholder="px"></div>
        <div class="mp-row"><span class="mp-label">Delta Y</span><input class="mp-input" type="number" value="0" id="multi-dy" placeholder="px"></div>
        <button class="btn btn-sm" style="width:100%;margin-top:6px" onclick="applyMultiMove()">Apply Move</button>
      </div>
      <div class="mp-section">
        <div class="mp-section-title">Scale</div>
        <div class="mp-row"><span class="mp-label">Factor</span><input class="mp-input" type="number" value="1" step="0.1" min="0.1" id="multi-scale" placeholder="e.g. 1.5"></div>
        <button class="btn btn-sm" style="width:100%;margin-top:6px" onclick="applyMultiScale()">Apply Scale</button>
      </div>
      <div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
        <button class="btn btn-sm" onclick="duplicateSelected()">Duplicate</button>
        <button class="btn btn-danger btn-sm" onclick="deleteSelected()">Delete All</button>
      </div>`;
    return;
  }
  const id=[...MAP.selectedIds][0];
  const obj=MAP.objects.find(o=>o.id===id);
  if(!obj){body.innerHTML='';return;}
  hdr.textContent=obj.name||'Object';
  const numInput=(label,key,val)=>`<div class="mp-row"><span class="mp-label">${label}</span><input class="mp-input" type="number" value="${Math.round(val)}" oninput="updateMapObj('${id}','${key}',+this.value)"></div>`;
  body.innerHTML=`
    <div class="mp-section">
      <div class="mp-section-title">Identity</div>
      <div class="mp-row"><span class="mp-label">Name</span><input class="mp-input" value="${obj.name||''}" oninput="updateMapObj('${id}','name',this.value)"></div>
      <div class="mp-row"><span class="mp-label">Layer</span><select class="mp-input" onchange="updateMapObj('${id}','layer',this.value)">${MAP.layers.map(l=>`<option ${obj.layer===l?'selected':''}>${l}</option>`).join('')}</select></div>
      <div class="mp-row"><span class="mp-label">Type</span><span style="font-family:var(--fm);font-size:11px;color:var(--text-secondary)">${obj.type}</span></div>
    </div>
    <div class="mp-section">
      <div class="mp-section-title">Transform</div>
      ${numInput('X','x',obj.x)}
      ${numInput('Y','y',obj.y)}
      ${obj.type==='circle'?numInput('Radius','r',obj.r):obj.type==='text'?`${numInput('Font Size','fontSize',obj.fontSize||14)}`:`${numInput('Width','w',obj.w)}${numInput('Height','h',obj.h)}`}
    </div>
    ${obj.type==='text'?`<div class="mp-section"><div class="mp-section-title">Text Content</div>
      <div class="mp-row"><input class="mp-input" value="${(obj.text||'').replace(/"/g,'&quot;')}" oninput="updateMapObj('${id}','text',this.value);updateMapObj('${id}','name',this.value)"></div>
    </div>`:''}
    <div class="mp-section">
      <div class="mp-section-title">Visual</div>
      <div class="mp-row"><span class="mp-label">Fill</span><input type="color" class="mp-color" value="${obj.fill||'#1e2e18'}" oninput="updateMapObj('${id}','fill',this.value)"></div>
      <div class="mp-row"><span class="mp-label">Stroke</span><input type="color" class="mp-color" value="${obj.stroke||'#4a7a3a'}" oninput="updateMapObj('${id}','stroke',this.value)"></div>
      <div class="mp-row"><span class="mp-label">Opacity</span><input type="range" min="0" max="1" step="0.05" value="${obj.opacity!==undefined?obj.opacity:1}" oninput="updateMapObj('${id}','opacity',+this.value)"></div>
    </div>
    <div class="mp-section">
      <div class="mp-section-title">Gameplay</div>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:4px;cursor:pointer"><input type="checkbox" ${obj.collision?'checked':''} onchange="updateMapObj('${id}','collision',this.checked)" style="accent-color:var(--gold)"> Collision</label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:4px;cursor:pointer"><input type="checkbox" ${obj.blocksPlayer?'checked':''} onchange="updateMapObj('${id}','blocksPlayer',this.checked)" style="accent-color:var(--gold)"> Blocks Player</label>
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer"><input type="checkbox" ${obj.blocksAI?'checked':''} onchange="updateMapObj('${id}','blocksAI',this.checked)" style="accent-color:var(--gold)"> Blocks AI</label>
    </div>
    <div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
      <button class="btn btn-sm" onclick="duplicateMapObj('${id}')">Duplicate</button>
      <button class="btn btn-danger btn-sm" onclick="deleteMapObj('${id}')">Delete</button>
    </div>`;
}

function updateMapObj(id,key,val){
  const obj=MAP.objects.find(o=>o.id===id);
  if(obj){
    obj[key]=val;
    if(key==='r') {obj.w=val*2;obj.h=val*2;}
    if(key==='fontSize') obj[key]=Math.max(4,+val);
    renderMap();autoSave();mapSaveCurrent();
  }
}
function duplicateMapObj(id){
  const obj=MAP.objects.find(o=>o.id===id);
  if(!obj)return;
  mapPushHistory();
  const n=JSON.parse(JSON.stringify(obj));
  n.id='obj_'+Date.now();n.x+=MAP.gridSize;n.y+=MAP.gridSize;
  MAP.objects.push(n);MAP.selectedIds.clear();MAP.selectedIds.add(n.id);
  renderMap();renderMapProps();autoSave();mapSaveCurrent();
}
function deleteMapObj(id){
  mapPushHistory();MAP.objects=MAP.objects.filter(o=>o.id!==id);MAP.selectedIds.delete(id);
  renderMap();renderMapProps();autoSave();mapSaveCurrent();
}

// â”€â”€ Multi-select operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyMultiMove(){
  const dx=+(document.getElementById('multi-dx')?.value||0);
  const dy=+(document.getElementById('multi-dy')?.value||0);
  if(!dx&&!dy)return;
  mapPushHistory();
  MAP.selectedIds.forEach(id=>{
    const obj=MAP.objects.find(o=>o.id===id);
    if(obj&&!obj.locked){
      obj.x=snap(obj.x+dx); obj.y=snap(obj.y+dy);
      if(obj.type==='arrow'&&obj.x2!==undefined){obj.x2=snap(obj.x2+dx);obj.y2=snap(obj.y2+dy);}
    }
  });
  renderMap();renderMapProps();autoSave();mapSaveCurrent();
}
function applyMultiScale(){
  const factor=+(document.getElementById('multi-scale')?.value||1);
  if(factor<=0||factor===1)return;
  mapPushHistory();
  const objs=[...MAP.selectedIds].map(id=>MAP.objects.find(o=>o.id===id)).filter(o=>o&&!o.locked);
  if(!objs.length)return;
  // Scale around group center
  const cx=objs.reduce((s,o)=>s+(o.x+(o.w||0)/2),0)/objs.length;
  const cy=objs.reduce((s,o)=>s+(o.y+(o.h||0)/2),0)/objs.length;
  objs.forEach(obj=>{
    const ocx=obj.x+(obj.w||0)/2, ocy=obj.y+(obj.h||0)/2;
    const nx=cx+(ocx-cx)*factor, ny=cy+(ocy-cy)*factor;
    if(obj.w!==undefined){obj.w=Math.max(8,snap(obj.w*factor));obj.x=snap(nx-obj.w/2);}
    else{obj.x=snap(nx);}
    if(obj.h!==undefined){obj.h=Math.max(8,snap(obj.h*factor));obj.y=snap(ny-obj.h/2);}
    else{obj.y=snap(ny);}
    if(obj.r!==undefined){obj.r=Math.max(4,snap(obj.r*factor));obj.w=obj.r*2;obj.h=obj.r*2;}
  });
  renderMap();renderMapProps();autoSave();mapSaveCurrent();
}
function duplicateSelected(){
  if(!MAP.selectedIds.size)return;
  mapPushHistory();
  const newIds=[];
  [...MAP.selectedIds].forEach(id=>{
    const obj=MAP.objects.find(o=>o.id===id);
    if(!obj)return;
    const n=JSON.parse(JSON.stringify(obj));
    n.id='obj_'+Date.now()+'_'+Math.random().toString(36).slice(2);
    n.x+=MAP.gridSize; n.y+=MAP.gridSize;
    MAP.objects.push(n); newIds.push(n.id);
  });
  MAP.selectedIds=new Set(newIds);
  renderMap();renderMapProps();renderMapLayers();autoSave();mapSaveCurrent();
}
function deleteSelected(){
  if(!MAP.selectedIds.size)return;
  mapPushHistory();
  MAP.objects=MAP.objects.filter(o=>!MAP.selectedIds.has(o.id));
  MAP.selectedIds.clear();
  renderMap();renderMapProps();renderMapLayers();autoSave();mapSaveCurrent();
}

function newMap(){
  const name=prompt('Map name:');
  if(!name)return;
  // First make sure map module is visible
  showModule('map');
  // Wait one frame for DOM to render, then init
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      initMapEditor();
      const map={id:'map_'+Date.now(),name,objects:[],layers:['Ground','Walls','Props','Labels'],created:new Date().toISOString()};
      PS.data.maps.push(map);
      renderMapSelect();
      const sel=document.getElementById('map-sel');
      if(sel) sel.value=map.id;
      MAP.currentMapId=map.id;
      MAP.objects=[];
      MAP.layers=['Ground','Walls','Props','Labels'];
      MAP.groups=[];
      MAP.history=[];MAP.future=[];MAP.selectedIds.clear();
      const noMap=document.getElementById('map-no-map');
      if(noMap)noMap.style.display='none';
      renderMapLayers();
      if(MAP.canvas&&MAP.ctx){
        MAP.canvas.width=MAP.wrap.clientWidth||800;
        MAP.canvas.height=MAP.wrap.clientHeight||600;
        renderMap();
      }
      renderMapProps();
      autoSave();
      showToast('Map created: '+name);
    });
  });
}
function renderMapSelect(){
  const sel=document.getElementById('map-sel');
  if(!sel)return;
  sel.innerHTML='<option value="">Select Mapâ€¦</option>';
  PS.data.maps.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.name;if(MAP.currentMapId===m.id)o.selected=true;sel.appendChild(o);});
}
function loadSelectedMap(){
  const id=document.getElementById('map-sel').value;
  if(!id)return;
  mapSaveCurrent();
  const map=PS.data.maps.find(m=>m.id===id);
  if(!map)return;
  MAP.currentMapId=id;
  MAP.objects=map.objects?JSON.parse(JSON.stringify(map.objects)):[];
  MAP.layers=map.layers||['Ground','Walls','Props','Labels'];
  MAP.groups=map.groups?JSON.parse(JSON.stringify(map.groups)):[];
  MAP.history=[];MAP.future=[];MAP.selectedIds.clear();
  const noMap=document.getElementById('map-no-map');
  if(noMap)noMap.style.display='none';
  renderMapLayers();renderMap();renderMapProps();
  showToast('Loaded: '+map.name);
}
function mapSaveCurrent(){
  if(!MAP.currentMapId)return;
  const map=PS.data.maps.find(m=>m.id===MAP.currentMapId);
  if(map){
    map.objects=JSON.parse(JSON.stringify(MAP.objects));
    map.layers=[...MAP.layers];
    map.groups=JSON.parse(JSON.stringify(MAP.groups||[]));
  }
}

function exportMapPNG(){
  if(!MAP.canvas){showToast('No map loaded');return;}
  const link=document.createElement('a');link.download='map.png';link.href=MAP.canvas.toDataURL('image/png');link.click();
}
function exportMapJSON(){
  mapSaveCurrent();
  const map=PS.data.maps.find(m=>m.id===MAP.currentMapId);
  if(!map){showToast('No map loaded');return;}
  dlText(JSON.stringify(map,null,2),(map.name||'map')+'.json','application/json');
}
function importMapJSON(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0];const reader=new FileReader();
    reader.onload=ev=>{try{const map=JSON.parse(ev.target.result);if(!map.id)map.id='map_'+Date.now();const ex=PS.data.maps.findIndex(m=>m.id===map.id);if(ex>=0)PS.data.maps[ex]=map;else PS.data.maps.push(map);renderMapSelect();document.getElementById('map-sel').value=map.id;loadSelectedMap();autoSave();showToast('Map imported âœ“');}catch(err){showToast('Invalid JSON file');}};
    reader.readAsText(file);
  };
  input.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _curveChart='difficulty', _curveDrag=-1, _curveCanvas, _curveCtx;

function initCurveEditor(){
  _curveCanvas=document.getElementById('curve-canvas');
  if(!_curveCanvas)return;
  _curveCtx=_curveCanvas.getContext('2d');
  const wrap=_curveCanvas.parentElement;
  _curveCanvas.width=wrap.clientWidth||600;
  _curveCanvas.height=300;
  _curveCanvas.onmousedown=curveDown;
  _curveCanvas.onmousemove=curveMove;
  _curveCanvas.onmouseup=()=>{_curveDrag=-1;};
  _curveCanvas.oncontextmenu=e=>{e.preventDefault();curveRC(e);};
  renderCurve();renderCurvePts();
}
function getPts(){return PS.data.charts[_curveChart]||[];}
function switchChart(t){_curveChart=t;const titles={difficulty:'Difficulty Curve',pacing:'Pacing Curve',flow:'Flow Curve'};document.getElementById('curve-title').textContent=titles[t]||t;document.querySelectorAll('#module-charts .tab').forEach((tab,i)=>tab.classList.toggle('active',['difficulty','pacing','flow'][i]===t));renderCurve();renderCurvePts();}
function curveDown(e){
  const rect=_curveCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const W=_curveCanvas.width,H=_curveCanvas.height;
  const pts=getPts();
  for(let i=0;i<pts.length;i++){const px=pts[i].x*W,py=(1-pts[i].y)*H;if(Math.hypot(mx-px,my-py)<10){_curveDrag=i;return;}}
  pts.push({x:mx/W,y:1-my/H});pts.sort((a,b)=>a.x-b.x);
  renderCurve();renderCurvePts();autoSave();
}
function curveMove(e){
  if(_curveDrag<0)return;
  const rect=_curveCanvas.getBoundingClientRect();
  const W=_curveCanvas.width,H=_curveCanvas.height;
  const pts=getPts();
  pts[_curveDrag].x=Math.max(0,Math.min(1,(e.clientX-rect.left)/W));
  pts[_curveDrag].y=Math.max(0,Math.min(1,1-(e.clientY-rect.top)/H));
  pts.sort((a,b)=>a.x-b.x);
  renderCurve();renderCurvePts();autoSave();
}
function curveRC(e){
  const rect=_curveCanvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const W=_curveCanvas.width,H=_curveCanvas.height;
  const pts=getPts();
  for(let i=0;i<pts.length;i++){const px=pts[i].x*W,py=(1-pts[i].y)*H;if(Math.hypot(mx-px,my-py)<10){pts.splice(i,1);renderCurve();renderCurvePts();autoSave();return;}}
}
function clearCurve(){PS.data.charts[_curveChart]=[];renderCurve();renderCurvePts();autoSave();}

function renderCurve(){
  if(!_curveCtx)return;
  const W=_curveCanvas.width,H=_curveCanvas.height,ctx=_curveCtx;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(201,162,39,0.06)';ctx.lineWidth=1;
  for(let i=0;i<=10;i++){ctx.beginPath();ctx.moveTo(i*W/10,0);ctx.lineTo(i*W/10,H);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i*H/10);ctx.lineTo(W,i*H/10);ctx.stroke();}
  const pts=getPts();if(!pts.length)return;
  ctx.beginPath();ctx.moveTo(0,H);
  ctx.lineTo(pts[0].x*W,(1-pts[0].y)*H);
  for(let i=1;i<pts.length;i++){const cx=(pts[i-1].x+pts[i].x)/2*W;ctx.bezierCurveTo(cx,(1-pts[i-1].y)*H,cx,(1-pts[i].y)*H,pts[i].x*W,(1-pts[i].y)*H);}
  ctx.lineTo(pts[pts.length-1].x*W,H);ctx.closePath();
  const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'rgba(201,162,39,0.22)');g.addColorStop(1,'rgba(201,162,39,0.02)');
  ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();ctx.moveTo(pts[0].x*W,(1-pts[0].y)*H);
  for(let i=1;i<pts.length;i++){const cx=(pts[i-1].x+pts[i].x)/2*W;ctx.bezierCurveTo(cx,(1-pts[i-1].y)*H,cx,(1-pts[i].y)*H,pts[i].x*W,(1-pts[i].y)*H);}
  ctx.strokeStyle='#c9a227';ctx.lineWidth=2;ctx.stroke();
  pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x*W,(1-p.y)*H,5,0,Math.PI*2);ctx.fillStyle='#c9a227';ctx.fill();ctx.strokeStyle='#000';ctx.lineWidth=1.5;ctx.stroke();});
}

function renderCurvePts(){
  const list=document.getElementById('curve-pts');if(!list)return;
  const pts=getPts();list.innerHTML='';
  pts.forEach((p,i)=>{const d=document.createElement('div');d.style.cssText='display:flex;align-items:center;gap:8px;padding:4px 8px;background:var(--bg-card);border-radius:4px;font-family:var(--fm);font-size:11px';d.innerHTML=`<span style="color:var(--text-secondary);min-width:20px">#${i+1}</span><span>X:<b style="color:var(--gold)">${Math.round(p.x*100)}%</b></span><span>Y:<b style="color:var(--gold)">${Math.round(p.y*100)}%</b></span><button class="btn btn-danger btn-xs" style="margin-left:auto" onclick="removeCurvePt(${i})">âœ•</button>`;list.appendChild(d);});
}
function removeCurvePt(i){PS.data.charts[_curveChart].splice(i,1);renderCurve();renderCurvePts();autoSave();}
function exportChartPNG(){if(!_curveCanvas)return;const l=document.createElement('a');l.download=_curveChart+'_curve.png';l.href=_curveCanvas.toDataURL();l.click();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uploadAssets(input){
  const files=Array.from(input.files);
  files.forEach(file=>{const reader=new FileReader();reader.onload=ev=>{PS.data.assets.push({id:'asset_'+Date.now()+Math.random(),name:file.name,type:file.type,size:file.size,data:ev.target.result,uploadedAt:new Date().toISOString()});renderAssets();autoSave();};reader.readAsDataURL(file);});
  input.value='';
}
function renderAssets(){
  const grid=document.getElementById('asset-grid');if(!grid)return;grid.innerHTML='';
  if(!PS.data.assets.length){grid.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“</div><div class="empty-txt">No assets uploaded</div></div>';return;}
  PS.data.assets.forEach(a=>{
    const card=document.createElement('div');card.className='asset-card';
    const icon=a.type.includes('image')?'ğŸ–¼ï¸':a.type.includes('pdf')?'ğŸ“„':a.type.includes('json')?'âš™ï¸':'ğŸ“Š';
    const size=a.size>1024*1024?(a.size/1024/1024).toFixed(1)+'MB':(a.size/1024).toFixed(0)+'KB';
    card.innerHTML=`<div class="asset-icon">${icon}</div>${a.type.includes('image')?`<img src="${a.data}" style="width:100%;height:55px;object-fit:cover;border-radius:3px;margin-bottom:4px">`:''}
      <div class="asset-name">${a.name}</div><div style="font-family:var(--fm);font-size:9px;color:var(--text-muted);margin-top:2px">${size}</div>
      <div style="display:flex;gap:4px;margin-top:6px"><button class="btn btn-xs" onclick="dlAsset('${a.id}')" style="flex:1">â†“</button><button class="btn btn-danger btn-xs" onclick="delAsset('${a.id}')" style="flex:1">âœ•</button></div>`;
    grid.appendChild(card);
  });
}
function dlAsset(id){const a=PS.data.assets.find(x=>x.id===id);if(!a)return;const l=document.createElement('a');l.href=a.data;l.download=a.name;l.click();}
function delAsset(id){if(!confirm('Delete this asset?'))return;PS.data.assets=PS.data.assets.filter(a=>a.id!==id);renderAssets();autoSave();}

const drop=document.getElementById('asset-drop');
if(drop){drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over');});drop.addEventListener('dragleave',()=>drop.classList.remove('over'));drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');uploadAssets({files:e.dataTransfer.files,value:''});});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dlText(text,name,mime){const b=new Blob([text],{type:mime||'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

function exportFullProject(){collectDocData();mapSaveCurrent();dlText(JSON.stringify(PS.data,null,2),'invictus_project.json','application/json');showToast('Project exported âœ“');}

function exportGDDMarkdown(){collectDocData();let md='# Game Design Document\n\n';GDD_SECS.forEach(grp=>{md+=`## ${grp.grp}\n\n`;grp.items.forEach(sec=>{md+=`### ${sec.icon} ${sec.label}\n\n`;if(sec.fields)sec.fields.forEach(f=>{const val=(PS.data.docs.gdd[sec.key]&&PS.data.docs.gdd[sec.key][f.k])||'';md+=`**${f.l}**\n\n${val}\n\n`;});md+='---\n\n';});});dlText(md,'GDD.md','text/markdown');showToast('GDD exported as Markdown');}

function exportGDDJSON(){collectDocData();dlText(JSON.stringify(PS.data.docs.gdd,null,2),'GDD.json','application/json');}

// â”€â”€ Shared PDF stylesheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _pdfCSS(){
  return `*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--gold:#c9a227;--text:#1a1a1a;--muted:#777;--border:#e2dcc8;--bg:#faf9f5}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:var(--text);background:#fff;font-size:13px;line-height:1.75;-webkit-print-color-adjust:exact;print-color-adjust:exact}
/* COVER */
.cover{background:#0b0e18;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 60px;text-align:center;page-break-after:always;position:relative}
.cover-icon{font-size:72px;margin-bottom:28px}
.cover-title{font-family:Georgia,serif;font-size:48px;font-weight:bold;color:#c9a227;letter-spacing:3px;line-height:1.15;margin-bottom:14px}
.cover-subtitle{font-size:11px;color:#666;letter-spacing:5px;text-transform:uppercase;margin-bottom:50px}
.cover-line{width:80px;height:3px;background:#c9a227;margin:0 auto 48px}
.cover-stats{display:flex;gap:48px;justify-content:center;flex-wrap:wrap}
.cstat{text-align:center}
.cstat-val{font-family:Georgia,serif;font-size:38px;font-weight:bold;color:#c9a227;line-height:1}
.cstat-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#555;margin-top:8px}
.cprog{width:80px;height:3px;background:#1e2030;border-radius:2px;margin:8px auto 0}
.cprog-f{height:100%;background:#c9a227;border-radius:2px}
.cover-footer{position:absolute;bottom:36px;width:100%;text-align:center;font-size:10px;color:#444;letter-spacing:1px;text-transform:uppercase}
/* LAYOUT */
.wrap{max-width:800px;margin:0 auto;padding:0 56px 80px}
/* CHAPTER */
.chapter{padding-top:56px;page-break-before:always}
.ch-hdr{display:flex;align-items:center;gap:14px;padding-bottom:14px;border-bottom:3px solid #c9a227;margin-bottom:36px}
.ch-icon{font-size:28px;line-height:1}
.ch-title{font-family:Georgia,serif;font-size:27px;font-weight:bold;color:var(--text)}
.ch-badge{margin-left:auto;background:#c9a227;color:#000;font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:.5px;flex-shrink:0}
/* SECTION GROUP */
.sec-group{margin-bottom:36px}
.sec-grp-title{font-family:Georgia,serif;font-size:17px;font-weight:700;color:var(--text);border-left:4px solid #c9a227;padding-left:12px;margin-bottom:16px}
.sec-item{margin-bottom:18px}
.sec-item-hdr{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
/* FIELD */
.field-wrap{background:var(--bg);border:1px solid var(--border);border-left:3px solid #c9a227;border-radius:0 6px 6px 0;padding:11px 15px;margin-bottom:8px}
.field-lbl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#aaa;margin-bottom:5px}
.field-val{font-size:13px;color:var(--text);white-space:pre-wrap;font-family:Georgia,serif;line-height:1.8}
.field-empty{font-size:11px;color:#ccc;font-style:italic}
.sec-hr{border:none;border-top:1px solid var(--border);margin:24px 0}
/* BEAT TABLE */
.bt-wrap{overflow-x:auto;margin-top:12px}
.bt{width:100%;border-collapse:collapse;font-size:11px}
.bt th{background:#c9a227;color:#000;padding:8px 10px;text-align:left;font-weight:700;font-size:10px;letter-spacing:.5px;text-transform:uppercase}
.bt td{border:1px solid var(--border);padding:7px 10px;vertical-align:top;line-height:1.5}
.bt tr:nth-child(even) td{background:var(--bg)}
.bt .rn{text-align:center;color:#c9a227;font-weight:700;background:var(--bg);width:32px}
/* MAPS */
.map-card{display:flex;align-items:center;gap:18px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px 20px;margin-bottom:12px;page-break-inside:avoid}
.map-card-icon{font-size:38px;flex-shrink:0}
.map-card-name{font-size:15px;font-weight:700;margin-bottom:4px;font-family:Georgia,serif}
.map-card-meta{font-size:11px;color:var(--muted)}
.map-preview{max-width:100%;border:1px solid var(--border);border-radius:8px;margin-top:20px;display:block}
/* NOTES & TASKS */
.list-title{font-size:13px;font-weight:700;color:var(--text);border-left:4px solid #c9a227;padding:5px 12px;background:var(--bg);margin:20px 0 8px;border-radius:0 4px 4px 0;display:flex;align-items:center;gap:8px}
.list-count{font-size:10px;color:var(--muted);margin-left:auto}
.task-row{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px}
.task-cb{flex-shrink:0;font-size:15px;margin-top:1px}
.task-done{text-decoration:line-through;color:#bbb}
/* STANDALONE DOCUMENT HEADER */
.doc-header{padding:40px 0 28px;border-bottom:3px solid #c9a227;margin-bottom:36px;display:flex;align-items:center;gap:16px}
.doc-header-icon{font-size:36px}
.doc-header-title{font-family:Georgia,serif;font-size:30px;font-weight:bold;color:#1a1a1a;margin-bottom:4px}
.doc-header-meta{font-size:11px;color:#888;letter-spacing:.5px}
.doc-pct{margin-left:auto;background:#c9a227;color:#000;font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;flex-shrink:0}
/* PRINT */
@media print{body{font-size:11px}.chapter{page-break-before:always}.cover{page-break-after:always}.sec-group{page-break-inside:avoid}.field-wrap{page-break-inside:avoid}.map-card{page-break-inside:avoid}@page{margin:18mm 18mm 20mm}}`;
}

function _pdfCSSPro(){
  return `*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--gold:#c9a227;--text:#111;--muted:#666;--border:#d8d2be;--bg:#f7f5ef;--accent:#1a1814}
body{font-family:'Georgia','Times New Roman',serif;color:var(--text);background:#fff;font-size:12px;line-height:1.8;-webkit-print-color-adjust:exact;print-color-adjust:exact}
/* COVER */
.cover{background:var(--accent);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 60px;text-align:center;page-break-after:always;position:relative}
.cover-rule{width:60px;height:2px;background:var(--gold);margin:0 auto 36px}
.cover-title{font-family:Georgia,serif;font-size:52px;font-weight:bold;color:var(--gold);letter-spacing:4px;line-height:1.1;margin-bottom:12px;text-transform:uppercase}
.cover-subtitle{font-size:11px;color:#888;letter-spacing:6px;text-transform:uppercase;margin-bottom:48px}
.cover-rule2{width:40px;height:1px;background:rgba(201,162,39,.4);margin:0 auto 40px}
.cover-stats{display:flex;gap:52px;justify-content:center;flex-wrap:wrap}
.cstat{text-align:center}
.cstat-val{font-family:Georgia,serif;font-size:40px;font-weight:bold;color:var(--gold);line-height:1}
.cstat-lbl{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:#666;margin-top:6px}
.cprog{width:72px;height:2px;background:#2a2620;border-radius:1px;margin:10px auto 0}
.cprog-f{height:100%;background:var(--gold);border-radius:1px}
.cover-footer{position:absolute;bottom:32px;width:100%;text-align:center;font-size:9px;color:#555;letter-spacing:2px;text-transform:uppercase}
/* LAYOUT */
.wrap{max-width:840px;margin:0 auto;padding:0 64px 96px}
/* CHAPTER HEADER */
.chapter{padding-top:64px;page-break-before:always}
.ch-hdr{padding-bottom:16px;border-bottom:2px solid var(--gold);margin-bottom:40px}
.ch-eyebrow{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:10px}
.ch-title{font-family:Georgia,serif;font-size:30px;font-weight:bold;color:var(--text);letter-spacing:.5px}
.ch-badge{display:inline-block;margin-top:8px;background:var(--gold);color:#000;font-size:9px;font-weight:700;padding:3px 10px;letter-spacing:.5px;font-family:Arial,sans-serif}
/* SECTION */
.sec-group{margin-bottom:40px}
.sec-grp-title{font-family:Georgia,serif;font-size:18px;font-weight:700;color:var(--text);margin-bottom:18px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.sec-item{margin-bottom:24px}
.sec-item-hdr{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;font-family:Arial,sans-serif}
/* FIELD */
.field-wrap{background:var(--bg);border-left:3px solid var(--gold);padding:12px 16px;margin-bottom:10px}
.field-lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#aaa;margin-bottom:6px;font-family:Arial,sans-serif}
.field-val{font-size:12px;color:var(--text);white-space:pre-wrap;line-height:1.85;font-family:Georgia,serif}
.field-empty{font-size:11px;color:#ccc;font-style:italic;font-family:Georgia,serif}
.sec-hr{border:none;border-top:1px solid var(--border);margin:28px 0}
/* BEAT TABLE */
.bt-wrap{overflow-x:auto;margin-top:14px}
.bt{width:100%;border-collapse:collapse;font-size:11px;font-family:Arial,sans-serif}
.bt th{background:#1a1814;color:var(--gold);padding:9px 12px;text-align:left;font-weight:700;font-size:9px;letter-spacing:1px;text-transform:uppercase}
.bt td{border:1px solid var(--border);padding:8px 12px;vertical-align:top;line-height:1.6}
.bt tr:nth-child(even) td{background:var(--bg)}
.bt .rn{text-align:center;color:var(--gold);font-weight:700;background:var(--bg);width:32px}
/* CHART */
.chart-section{margin-bottom:36px;page-break-inside:avoid}
.chart-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;font-family:Arial,sans-serif}
.chart-img{display:block;width:100%;border:1px solid var(--border);border-radius:0}
/* STANDALONE DOCUMENT HEADER */
.doc-header{padding:48px 0 32px;border-bottom:2px solid var(--gold);margin-bottom:40px}
.doc-header-label{font-size:9px;letter-spacing:4px;text-transform:uppercase;color:var(--gold);margin-bottom:10px;font-family:Arial,sans-serif}
.doc-header-title{font-family:Georgia,serif;font-size:36px;font-weight:bold;color:var(--text);margin-bottom:8px}
.doc-header-meta{font-size:11px;color:var(--muted);letter-spacing:.3px;font-family:Arial,sans-serif}
.doc-pct{display:inline-block;margin-top:14px;background:var(--gold);color:#000;font-size:10px;font-weight:700;padding:4px 14px;letter-spacing:.5px;font-family:Arial,sans-serif}
/* MAPS */
.map-card{border:1px solid var(--border);padding:18px 22px;margin-bottom:14px;page-break-inside:avoid;background:var(--bg)}
.map-card-name{font-size:15px;font-weight:700;margin-bottom:4px;font-family:Georgia,serif}
.map-card-meta{font-size:10px;color:var(--muted);font-family:Arial,sans-serif}
.map-preview{max-width:100%;border:1px solid var(--border);margin-top:20px;display:block}
/* NOTES & TASKS */
.list-title{font-size:12px;font-weight:700;color:var(--text);border-left:3px solid var(--gold);padding:5px 14px;background:var(--bg);margin:20px 0 8px;font-family:Arial,sans-serif}
.list-count{font-size:9px;color:var(--muted);margin-left:8px}
.task-row{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);font-size:11px;font-family:Arial,sans-serif}
.task-cb{flex-shrink:0;font-size:14px;margin-top:1px}
.task-done{text-decoration:line-through;color:#bbb}
/* PRINT */
@media print{body{font-size:11px}.chapter{page-break-before:always}.cover{page-break-after:always}.sec-group{page-break-inside:avoid}.field-wrap{page-break-inside:avoid}.chart-section{page-break-inside:avoid}@page{margin:20mm 20mm 22mm}}`;
}

// Async helper: captures all 3 chart canvases as base64 dataURLs
// Returns {difficulty, pacing, flow}
async function _captureCharts(){
  if(!_curveCanvas) return null;
  const origChart=_curveChart;
  const charts={};
  const types=['difficulty','pacing','flow'];
  for(const t of types){
    switchChart(t);
    // Wait for render
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    charts[t]=_curveCanvas.toDataURL('image/png');
  }
  // Restore original
  switchChart(origChart);
  return charts;
}

function _pdfOpen(title){
  const win=window.open('','_blank');
  if(!win){showToast('Allow popups to export PDF');return null;}
  return win;
}

function _pdfImgsHTML(doc, key){
  const imgs=(PS.data.docs[doc][key]&&PS.data.docs[doc][key]._images)||[];
  if(!imgs.length) return '';
  return `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">`+
    imgs.map(img=>`<img src="${img.data}" style="height:110px;max-width:200px;object-fit:cover;border-radius:3px;border:1px solid #d8d2be" title="${img.name||''}">`).join('')+
  `</div>`;
}
function exportGDDPDF(){
  collectDocData();
  const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const projectName=PS.data.currentProject||'Game Project';
  const dateStr=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const pct=calcDocCompletion('gdd',GDD_SECS);
  let html=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>GDD â€” ${esc(projectName)}</title><style>${_pdfCSSPro()}</style></head><body><div class="wrap">`;
  html+=`<div class="doc-header">
    <div class="doc-header-title">GAME DESIGN DOCUMENT</div>
    <div class="doc-header-label" style="font-size:16px;letter-spacing:1px;color:var(--text);margin-bottom:8px;font-family:Georgia,serif">${esc(projectName)}</div>
    <div class="doc-header-meta">${dateStr}</div>
    <div class="doc-pct">${pct}% Complete</div>
  </div>`;
  GDD_SECS.forEach(grp=>{
    html+=`<div class="sec-group"><div class="sec-grp-title">${esc(grp.grp)}</div>`;
    grp.items.forEach(sec=>{
      if(!sec.fields)return;
      html+=`<div class="sec-item"><div class="sec-item-hdr">${esc(sec.label)}</div>`;
      sec.fields.forEach(f=>{
        const val=(PS.data.docs.gdd[sec.key]&&PS.data.docs.gdd[sec.key][f.k])||'';
        html+=`<div class="field-wrap"><div class="field-lbl">${esc(f.l)}</div>`;
        html+=val.trim()?`<div class="field-val">${esc(val)}</div>`:`<div class="field-empty">Not specified</div>`;
        html+=`</div>`;
      });
      html+=_pdfImgsHTML('gdd',sec.key);
      html+=`</div>`;
    });
    html+=`<hr class="sec-hr"></div>`;
  });
  html+=`</div></body></html>`;
  const win=_pdfOpen('GDD');if(!win)return;
  win.document.write(html);win.document.close();
  setTimeout(()=>win.print(),500);showToast('Opening GDD PDFâ€¦');
}

function exportLDDJSON(){collectDocData();dlText(JSON.stringify(PS.data.docs.ldd,null,2),'LDD.json','application/json');}

async function exportLDDPDF(){
  collectDocData();
  showToast('Preparing LDD PDFâ€¦');
  const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const projectName=PS.data.currentProject||'Game Project';
  const dateStr=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const pct=calcDocCompletion('ldd',LDD_SECS);

  // Capture chart images (only if charts module has been initialized)
  let charts=null;
  try{ charts=await _captureCharts(); }catch(e){}

  let html=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>LDD â€” ${esc(projectName)}</title><style>${_pdfCSSPro()}</style></head><body><div class="wrap">`;
  html+=`<div class="doc-header">
    <div class="doc-header-title">LEVEL DESIGN DOCUMENT</div>
    <div class="doc-header-label" style="font-size:16px;letter-spacing:1px;color:var(--text);margin-bottom:8px;font-family:Georgia,serif">${esc(projectName)}</div>
    <div class="doc-header-meta">${dateStr}</div>
    <div class="doc-pct">${pct}% Complete</div>
  </div>`;

  LDD_SECS.forEach(grp=>{
    html+=`<div class="sec-group"><div class="sec-grp-title">${esc(grp.grp)}</div>`;
    grp.items.forEach(sec=>{
      if(sec.isTable||sec.isFlowchart||sec.checklistKey) return; // handled separately
      if(!sec.fields)return;
      html+=`<div class="sec-item"><div class="sec-item-hdr">${esc(sec.label)}</div>`;
      sec.fields.forEach(f=>{
        const val=(PS.data.docs.ldd[sec.key]&&PS.data.docs.ldd[sec.key][f.k])||'';
        html+=`<div class="field-wrap"><div class="field-lbl">${esc(f.l)}</div>`;
        html+=val.trim()?`<div class="field-val">${esc(val)}</div>`:`<div class="field-empty">Not specified</div>`;
        html+=`</div>`;
      });
      html+=_pdfImgsHTML('ldd',sec.key);
      html+=`</div>`;
    });
    html+=`<hr class="sec-hr"></div>`;
  });

  // Beat Table
  const bt=PS.data.docs.ldd.beat_table;
  if(bt&&bt.rows&&bt.rows.some(r=>r.situation||r.skills||r.elements||r.intensity||r.time_pacing)){
    html+=`<div class="sec-group"><div class="sec-grp-title">Beat Sequence Table</div><div class="bt-wrap"><table class="bt"><thead><tr><th style="width:32px">#</th><th>Situation / Scene</th><th>Player Skills</th><th>Design Elements</th><th>Intensity</th><th>Time / Pacing</th></tr></thead><tbody>`;
    bt.rows.forEach((row,i)=>{
      if(!row.situation&&!row.skills&&!row.elements&&!row.intensity&&!row.time_pacing)return;
      html+=`<tr><td class="rn">${i+1}</td><td>${esc(row.situation||'')}</td><td>${esc(row.skills||'')}</td><td>${esc(row.elements||'')}</td><td>${esc(row.intensity||'')}</td><td>${esc(row.time_pacing||'')}</td></tr>`;
    });
    html+=`</tbody></table></div></div>`;
  }

  // Design Curves (Difficulty, Pacing, Flow)
  if(charts){
    const hasData=t=>(PS.data.charts&&PS.data.charts[t]&&PS.data.charts[t].length>0);
    const chartDefs=[
      {key:'difficulty',label:'Difficulty Curve',desc:'How challenge scales across the level. A well-designed difficulty curve introduces peaks and valleys to maintain engagement.'},
      {key:'pacing',label:'Pacing Curve',desc:'The rhythm of intensity, exploration, and rest. Mirrors the emotional journey of the player.'},
      {key:'flow',label:'Flow State Curve',desc:'How well the level keeps the player in the optimal engagement zone â€” challenged but not frustrated.'},
    ];
    const anyChart=chartDefs.some(c=>hasData(c.key));
    if(anyChart){
      html+=`<div class="sec-group"><div class="sec-grp-title">Design Curves</div>`;
      chartDefs.forEach(c=>{
        if(!hasData(c.key))return;
        html+=`<div class="chart-section">
          <div class="chart-title">${c.label}</div>
          <p style="font-size:11px;color:#777;margin-bottom:10px;font-family:Arial,sans-serif">${c.desc}</p>
          <img class="chart-img" src="${charts[c.key]}" alt="${c.label}">
        </div>`;
      });
      html+=`</div>`;
    }
  }

  html+=`</div></body></html>`;
  const win=_pdfOpen('LDD');if(!win)return;
  win.document.write(html);win.document.close();
  setTimeout(()=>win.print(),600);showToast('Opening LDD PDFâ€¦');
}

async function exportFullPDF(){
  collectDocData(); mapSaveCurrent();
  showToast('Preparing Full PDFâ€¦');
  const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const projectName=PS.data.currentProject||'My Game Project';
  const dateStr=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const gddPct=calcDocCompletion('gdd',GDD_SECS);
  const lddPct=calcDocCompletion('ldd',LDD_SECS);
  const mapImg=MAP.canvas?MAP.canvas.toDataURL('image/png'):null;
  const maps=PS.data.maps||[];
  const tasks=PS.data.tasks||[];
  const doneTasks=tasks.filter(t=>t.status==='Done').length;
  const noteLists=(PS.data.notes&&PS.data.notes.lists)||[];
  const allNoteItems=noteLists.flatMap(l=>l.items||[]);
  const doneNotes=allNoteItems.filter(i=>i.done).length;

  let charts=null;
  try{ charts=await _captureCharts(); }catch(e){}

  // â”€â”€ Cover page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${esc(projectName)}</title><style>${_pdfCSSPro()}</style></head><body>`;
  html+=`<div class="cover">
    <div class="cover-rule"></div>
    <div class="cover-title">${esc(projectName)}</div>
    <div class="cover-subtitle">Full Project Document</div>
    <div class="cover-rule2"></div>
    <div class="cover-stats">
      <div class="cstat"><div class="cstat-val">${gddPct}<span style="font-size:22px">%</span></div><div class="cstat-lbl">GDD Complete</div><div class="cprog"><div class="cprog-f" style="width:${gddPct}%"></div></div></div>
      <div class="cstat"><div class="cstat-val">${lddPct}<span style="font-size:22px">%</span></div><div class="cstat-lbl">LDD Complete</div><div class="cprog"><div class="cprog-f" style="width:${lddPct}%"></div></div></div>
      <div class="cstat"><div class="cstat-val">${maps.length}</div><div class="cstat-lbl">Maps</div></div>
      <div class="cstat"><div class="cstat-val">${doneTasks}<span style="font-size:22px">/${tasks.length}</span></div><div class="cstat-lbl">Tasks Done</div></div>
      <div class="cstat"><div class="cstat-val">${doneNotes}<span style="font-size:22px">/${allNoteItems.length}</span></div><div class="cstat-lbl">Notes Done</div></div>
    </div>
    <div class="cover-footer">Generated ${dateStr} &nbsp;&#183;&nbsp; Invictus Game Studio</div>
  </div>`;

  html+=`<div class="wrap">`;

  // â”€â”€ GDD chapter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html+=`<div class="chapter"><div class="ch-hdr"><div class="ch-eyebrow">Chapter 1</div><div class="ch-title">Game Design Document</div><div class="ch-badge">${gddPct}% Complete</div></div>`;
  GDD_SECS.forEach(grp=>{
    html+=`<div class="sec-group"><div class="sec-grp-title">${esc(grp.grp)}</div>`;
    grp.items.forEach(sec=>{
      if(!sec.fields)return;
      html+=`<div class="sec-item"><div class="sec-item-hdr">${esc(sec.label)}</div>`;
      sec.fields.forEach(f=>{
        const val=(PS.data.docs.gdd[sec.key]&&PS.data.docs.gdd[sec.key][f.k])||'';
        html+=`<div class="field-wrap"><div class="field-lbl">${esc(f.l)}</div>`;
        html+=val.trim()?`<div class="field-val">${esc(val)}</div>`:`<div class="field-empty">Not specified</div>`;
        html+=`</div>`;
      });
      html+=_pdfImgsHTML('gdd',sec.key);
      html+=`</div>`;
    });
    html+=`<hr class="sec-hr"></div>`;
  });
  html+=`</div>`;

  // â”€â”€ LDD chapter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html+=`<div class="chapter"><div class="ch-hdr"><div class="ch-eyebrow">Chapter 2</div><div class="ch-title">Level Design Document</div><div class="ch-badge">${lddPct}% Complete</div></div>`;
  LDD_SECS.forEach(grp=>{
    html+=`<div class="sec-group"><div class="sec-grp-title">${esc(grp.grp)}</div>`;
    grp.items.forEach(sec=>{
      if(sec.isTable||sec.isFlowchart||sec.checklistKey) return;
      if(!sec.fields)return;
      html+=`<div class="sec-item"><div class="sec-item-hdr">${esc(sec.label)}</div>`;
      sec.fields.forEach(f=>{
        const val=(PS.data.docs.ldd[sec.key]&&PS.data.docs.ldd[sec.key][f.k])||'';
        html+=`<div class="field-wrap"><div class="field-lbl">${esc(f.l)}</div>`;
        html+=val.trim()?`<div class="field-val">${esc(val)}</div>`:`<div class="field-empty">Not specified</div>`;
        html+=`</div>`;
      });
      html+=_pdfImgsHTML('ldd',sec.key);
      html+=`</div>`;
    });
    html+=`<hr class="sec-hr"></div>`;
  });
  // Beat Table
  const bt=PS.data.docs.ldd.beat_table;
  if(bt&&bt.rows&&bt.rows.some(r=>r.situation||r.skills||r.elements||r.intensity||r.time_pacing)){
    html+=`<div class="sec-group"><div class="sec-grp-title">Beat Sequence Table</div><div class="bt-wrap"><table class="bt"><thead><tr><th style="width:32px">#</th><th>Situation / Scene</th><th>Player Skills</th><th>Design Elements</th><th>Intensity</th><th>Time / Pacing</th></tr></thead><tbody>`;
    bt.rows.forEach((row,i)=>{
      if(!row.situation&&!row.skills&&!row.elements&&!row.intensity&&!row.time_pacing)return;
      html+=`<tr><td class="rn">${i+1}</td><td>${esc(row.situation||'')}</td><td>${esc(row.skills||'')}</td><td>${esc(row.elements||'')}</td><td>${esc(row.intensity||'')}</td><td>${esc(row.time_pacing||'')}</td></tr>`;
    });
    html+=`</tbody></table></div></div>`;
  }
  // Design Curves
  if(charts){
    const hasData=t=>(PS.data.charts&&PS.data.charts[t]&&PS.data.charts[t].length>0);
    const chartDefs=[
      {key:'difficulty',label:'Difficulty Curve',desc:'Challenge scaling across the level.'},
      {key:'pacing',label:'Pacing Curve',desc:'Rhythm of intensity, exploration and rest.'},
      {key:'flow',label:'Flow State Curve',desc:'Player engagement and flow zone over time.'},
    ];
    if(chartDefs.some(c=>hasData(c.key))){
      html+=`<div class="sec-group"><div class="sec-grp-title">Design Curves</div>`;
      chartDefs.forEach(c=>{
        if(!hasData(c.key))return;
        html+=`<div class="chart-section"><div class="chart-title">${c.label}</div><p style="font-size:11px;color:#777;margin-bottom:10px;font-family:Arial,sans-serif">${c.desc}</p><img class="chart-img" src="${charts[c.key]}" alt="${c.label}"></div>`;
      });
      html+=`</div>`;
    }
  }
  html+=`</div>`;

  // â”€â”€ Maps chapter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(maps.length){
    html+=`<div class="chapter"><div class="ch-hdr"><div class="ch-eyebrow">Chapter 3</div><div class="ch-title">Maps</div><div class="ch-badge">${maps.length} Map${maps.length>1?'s':''}</div></div>`;
    maps.forEach(m=>{
      html+=`<div class="map-card"><div class="map-card-name">${esc(m.name||'Untitled Map')}</div><div class="map-card-meta">${(m.objects||[]).length} objects &nbsp;&#183;&nbsp; Created ${new Date(m.created||Date.now()).toLocaleDateString()}</div>${m.description?'<p style="font-size:12px;color:#777;margin-top:6px">'+esc(m.description)+'</p>':''}</div>`;
    });
    if(mapImg)html+=`<div style="margin-top:28px"><div class="sec-grp-title" style="margin-bottom:14px">Current Map Preview</div><img class="map-preview" src="${mapImg}" alt="Map Preview"></div>`;
    html+=`</div>`;
  }

  // â”€â”€ Notes & Tasks chapter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const hasNotes=allNoteItems.length>0;
  const hasTasks=tasks.length>0;
  if(hasNotes||hasTasks){
    html+=`<div class="chapter"><div class="ch-hdr"><div class="ch-eyebrow">Chapter ${maps.length?4:3}</div><div class="ch-title">Notes &amp; Tasks</div><div class="ch-badge">${doneNotes+doneTasks}/${allNoteItems.length+tasks.length} Done</div></div>`;
    if(hasNotes){
      html+=`<div class="sec-group"><div class="sec-grp-title">Notes</div>`;
      noteLists.forEach(lst=>{
        if(!lst.items||!lst.items.length)return;
        const done=lst.items.filter(i=>i.done).length;
        html+=`<div class="list-title">${esc(lst.name)}<span class="list-count">${done}/${lst.items.length} done</span></div>`;
        html+=`<div style="border:1px solid #d8d2be;overflow:hidden;margin-bottom:16px">`;
        lst.items.forEach(item=>{html+=`<div class="task-row"><span class="task-cb">${item.done?'[x]':'[ ]'}</span><span class="${item.done?'task-done':''}">${esc(item.text||'')}</span></div>`;});
        html+=`</div>`;
      });
      html+=`</div>`;
    }
    if(hasTasks){
      html+=`<div class="sec-group"><div class="sec-grp-title">Tasks</div><div style="border:1px solid #d8d2be;overflow:hidden">`;
      tasks.forEach(t=>{
        const done=t.status==='Done';
        html+=`<div class="task-row"><span class="task-cb">${done?'[x]':'[ ]'}</span><div style="flex:1"><div class="${done?'task-done':''}" style="font-weight:600">${esc(t.title||'')}</div>`;
        if(t.description)html+=`<div style="font-size:11px;color:#888;margin-top:2px">${esc(t.description)}</div>`;
        const meta=[];if(t.priority)meta.push(t.priority+' priority');if(t.discipline)meta.push(t.discipline);if(t.due)meta.push('Due: '+t.due);if(t.assignedTo)meta.push(t.assignedTo);
        if(meta.length)html+=`<div style="font-size:10px;color:#aaa;margin-top:3px">${meta.map(esc).join(' &nbsp;&#183;&nbsp; ')}</div>`;
        html+=`</div><span style="font-size:10px;color:#aaa;flex-shrink:0;margin-top:2px;padding-left:10px">${esc(t.status||'')}</span></div>`;
      });
      html+=`</div></div>`;
    }
    html+=`</div>`;
  }

  html+=`</div></body></html>`;
  const win=_pdfOpen('Full PDF');if(!win)return;
  win.document.write(html);win.document.close();
  setTimeout(()=>win.print(),700);
  showToast('Opening Full PDFâ€¦');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEAT TABLE (LDD Excel-like)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBeatTable() {
  const tbody = document.getElementById('beat-tbody');
  if (!tbody) return;
  if (!PS.data.docs.ldd.beat_table) PS.data.docs.ldd.beat_table={rows:[]};
  if (!PS.data.docs.ldd.beat_table.rows.length) {
    PS.data.docs.ldd.beat_table.rows = Array.from({length:12},(_,i)=>({id:i+1,situation:'',skills:'',elements:'',intensity:'',time_pacing:''}));
  }
  tbody.innerHTML='';
  const cols=['situation','skills','elements','intensity','time_pacing'];
  PS.data.docs.ldd.beat_table.rows.forEach((row,ri)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="border:1px solid var(--border);padding:4px 6px;font-family:var(--fm);font-size:10px;color:var(--text-muted);text-align:center;background:#0d0d0d;width:28px;">${ri+1}</td>`;
    cols.forEach(col=>{
      const td=document.createElement('td');
      td.style.cssText='border:1px solid var(--border);padding:0;background:var(--bg-input);';
      const inp=document.createElement('input');
      inp.type='text';
      inp.value=row[col]||'';
      inp.style.cssText='width:100%;background:transparent;border:none;padding:5px 8px;color:var(--text-primary);font-family:var(--fb);font-size:12px;outline:none;';
      inp.addEventListener('focus',()=>{td.style.outline='2px solid var(--gold-dim)';td.style.outlineOffset='-2px';});
      inp.addEventListener('blur',()=>{td.style.outline='';});
      inp.addEventListener('input',()=>{row[col]=inp.value;autoSave();});
      inp.addEventListener('keydown',e=>{
        if(e.key==='Tab'){e.preventDefault();const inputs=Array.from(document.querySelectorAll('#beat-tbody input'));const idx=inputs.indexOf(inp);if(inputs[idx+1])inputs[idx+1].focus();}
        if(e.key==='Enter'){e.preventDefault();const inputs=Array.from(document.querySelectorAll(`#beat-tbody tr:nth-child(${ri+2}) input`));if(inputs[0])inputs[0].focus();}
      });
      td.appendChild(inp);
      tr.appendChild(td);
    });
    const tdDel=document.createElement('td');
    tdDel.style.cssText='border:1px solid var(--border);padding:2px;background:#0d0d0d;text-align:center;';
    const btn=document.createElement('button');
    btn.className='btn btn-xs btn-danger';
    btn.textContent='Ã—';
    btn.onclick=()=>{PS.data.docs.ldd.beat_table.rows.splice(ri,1);renderBeatTable();autoSave();};
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });
}

function addBeatRow() {
  if (!PS.data.docs.ldd.beat_table) PS.data.docs.ldd.beat_table={rows:[]};
  const id=PS.data.docs.ldd.beat_table.rows.length+1;
  PS.data.docs.ldd.beat_table.rows.push({id,situation:'',skills:'',elements:'',intensity:'',time_pacing:''});
  renderBeatTable();
  autoSave();
}
function clearBeatTable(){if(confirm('Clear all rows?')){PS.data.docs.ldd.beat_table={rows:[]};renderBeatTable();autoSave();}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOWCHART (LDD Node System)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOWCHART (LDD Node System) â€” PRO VERSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FC = {
  nodes: [], connections: [],
  selectedNode: null, connectFrom: null,
  dragging: null, dragOff: {x:0,y:0},
  history: [], future: [],
  _canvasInited: false,
  cam: {x:0, y:0, zoom:1},
  panning: false, panStart: null
};

const NODE_TYPES = {
  start:   {color:'#0a1e0a',border:'#4ecb71',icon:'â–¶',label:'Start',desc:'Entry point'},
  area:    {color:'#1a1e2a',border:'#4a9eff',icon:'ğŸ›ï¸',label:'Area',desc:'Room or zone'},
  combat:  {color:'#2a0a0a',border:'#e05252',icon:'âš”ï¸',label:'Combat',desc:'Fight encounter'},
  event:   {color:'#1a1a2e',border:'#9b6bde',icon:'âš¡',label:'Event',desc:'Scripted event'},
  trigger: {color:'#2a1e06',border:'#c9a227',icon:'ğŸ”®',label:'Trigger',desc:'Logic trigger'},
  secret:  {color:'#1a0e2a',border:'#9b6bde',icon:'ğŸ”',label:'Secret',desc:'Hidden area'},
  puzzle:  {color:'#0a1a2a',border:'#4a9eff',icon:'ğŸ§©',label:'Puzzle',desc:'Puzzle area'},
  npc:     {color:'#0a1e18',border:'#4ecb71',icon:'ğŸ’¬',label:'NPC',desc:'Character/dialogue'},
  exit:    {color:'#2a0f0f',border:'#e05252',icon:'ğŸšª',label:'Exit',desc:'Level exit'},
  note:    {color:'#1a1a0a',border:'#c9a227',icon:'ğŸ“',label:'Note',desc:'Design note'}
};

function fcPushHistory(){FC.history.push(JSON.stringify({nodes:FC.nodes,connections:FC.connections}));if(FC.history.length>50)FC.history.shift();FC.future=[];}
function fcUndo(){if(!FC.history.length)return;FC.future.push(JSON.stringify({nodes:FC.nodes,connections:FC.connections}));const s=JSON.parse(FC.history.pop());FC.nodes=s.nodes;FC.connections=s.connections;if(PS.data.docs.ldd.flowchart){PS.data.docs.ldd.flowchart.nodes=FC.nodes;PS.data.docs.ldd.flowchart.connections=FC.connections;}renderFlowNodes();renderFlowConnections();autoSave();}
function fcRedo(){if(!FC.future.length)return;FC.history.push(JSON.stringify({nodes:FC.nodes,connections:FC.connections}));const s=JSON.parse(FC.future.pop());FC.nodes=s.nodes;FC.connections=s.connections;if(PS.data.docs.ldd.flowchart){PS.data.docs.ldd.flowchart.nodes=FC.nodes;PS.data.docs.ldd.flowchart.connections=FC.connections;}renderFlowNodes();renderFlowConnections();autoSave();}

function renderFlowchart() {
  const container=document.getElementById('flow-nodes');
  const svg=document.getElementById('flow-svg');
  if(!container||!svg) return;
  FC._canvasInited=false; // force re-init since DOM was rebuilt
  const data=PS.data.docs.ldd.flowchart;
  if(data){FC.nodes=data.nodes?JSON.parse(JSON.stringify(data.nodes)):[];FC.connections=data.connections?JSON.parse(JSON.stringify(data.connections)):[];}
  initFlowCanvas();
  _applyFcCam(); // restore camera state
  renderFlowNodes();
  renderFlowConnections();
}

function _applyFcCam(){
  const vp=document.getElementById('flow-viewport');
  if(vp) vp.style.transform=`translate(${FC.cam.x}px,${FC.cam.y}px) scale(${FC.cam.zoom})`;
  const lbl=document.getElementById('fc-zoom-lbl');
  if(lbl) lbl.textContent=Math.round(FC.cam.zoom*100)+'%';
}
function _fcScreenToWorld(sx,sy){
  return {x:(sx-FC.cam.x)/FC.cam.zoom, y:(sy-FC.cam.y)/FC.cam.zoom};
}
function fcZoom(factor,cx,cy){
  const canvas=document.getElementById('flowchart-canvas');
  if(!canvas)return;
  if(cx===undefined){cx=canvas.clientWidth/2;cy=canvas.clientHeight/2;}
  const newZoom=Math.max(0.08,Math.min(3,FC.cam.zoom*factor));
  FC.cam.x=cx-(cx-FC.cam.x)*(newZoom/FC.cam.zoom);
  FC.cam.y=cy-(cy-FC.cam.y)*(newZoom/FC.cam.zoom);
  FC.cam.zoom=newZoom;
  _applyFcCam();
}
function fcFitAll(){
  const canvas=document.getElementById('flowchart-canvas');
  if(!canvas||!FC.nodes.length)return;
  const pad=40;
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  FC.nodes.forEach(n=>{x1=Math.min(x1,n.x);y1=Math.min(y1,n.y);x2=Math.max(x2,n.x+154);y2=Math.max(y2,n.y+120);});
  const W=canvas.clientWidth-pad*2, H=canvas.clientHeight-pad*2;
  const zoom=Math.min(W/Math.max(1,x2-x1),H/Math.max(1,y2-y1),2);
  FC.cam.zoom=zoom;FC.cam.x=pad-x1*zoom;FC.cam.y=pad-y1*zoom;
  _applyFcCam();
}
function fcResetCam(){
  FC.cam={x:0,y:0,zoom:1};_applyFcCam();
}

function initFlowCanvas(){
  if(FC._canvasInited) return;
  const canvas=document.getElementById('flowchart-canvas');
  if(!canvas) return;
  FC._canvasInited=true;

  // â”€â”€ WHEEL ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canvas.addEventListener('wheel',e=>{
    e.preventDefault();
    const cr=canvas.getBoundingClientRect();
    fcZoom(e.deltaY<0?1.15:1/1.15, e.clientX-cr.left, e.clientY-cr.top);
  },{passive:false});

  // â”€â”€ MIDDLE-MOUSE PAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canvas.addEventListener('mousedown',e=>{
    if(e.button===1){
      e.preventDefault();
      FC.panning=true;
      FC.panStart={sx:e.clientX,sy:e.clientY,cx:FC.cam.x,cy:FC.cam.y};
    }
  });

  // â”€â”€ MOUSE MOVE (drag node + pan) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canvas.addEventListener('mousemove',e=>{
    if(FC.panning&&FC.panStart){
      FC.cam.x=FC.panStart.cx+(e.clientX-FC.panStart.sx);
      FC.cam.y=FC.panStart.cy+(e.clientY-FC.panStart.sy);
      _applyFcCam(); return;
    }
    if(!FC.dragging) return;
    const cr=canvas.getBoundingClientRect();
    const w=_fcScreenToWorld(e.clientX-cr.left, e.clientY-cr.top);
    const node=FC.nodes.find(n=>n.id===FC.dragging);
    if(node){
      node.x=Math.max(0,w.x-FC.dragOff.x);
      node.y=Math.max(0,w.y-FC.dragOff.y);
      const el=document.getElementById('fnode-'+node.id);
      if(el){el.style.left=node.x+'px';el.style.top=node.y+'px';}
      renderFlowConnections();
    }
  });

  canvas.addEventListener('mouseup',e=>{
    if(FC.panning){FC.panning=false;FC.panStart=null;return;}
    if(FC.dragging){FC.dragging=null;saveFlowchart();}
  });
  canvas.addEventListener('mouseleave',()=>{FC.panning=false;FC.panStart=null;});

  // â”€â”€ CLICK on empty canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canvas.addEventListener('click',e=>{
    if(e.target===canvas||e.target.id==='flow-viewport'||e.target.id==='flow-nodes'){
      FC.connectFrom=null;FC.selectedNode=null;renderFlowNodes();
    }
  });

  // â”€â”€ RIGHT-CLICK DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  canvas.addEventListener('contextmenu',e=>{
    e.preventDefault();
    const cr=canvas.getBoundingClientRect();
    const w=_fcScreenToWorld(e.clientX-cr.left, e.clientY-cr.top);
    const hit=FC.nodes.find(n=>w.x>=n.x&&w.x<=n.x+154&&w.y>=n.y&&w.y<=n.y+120);
    if(hit){deleteFlowNode(hit.id);}
  });
}

function renderFlowNodes() {
  const container=document.getElementById('flow-nodes');
  if(!container) return;
  container.innerHTML='';
  FC.nodes.forEach(node=>{
    const nt=NODE_TYPES[node.type]||NODE_TYPES.area;
    const isSelected=FC.selectedNode===node.id;
    const isConnecting=FC.connectFrom===node.id;
    const div=document.createElement('div');
    div.id='fnode-'+node.id;
    div.className='fnode'+(isSelected?' fnode-selected':'')+(isConnecting?' fnode-connecting':'');
    div.style.cssText=`position:absolute;left:${node.x||60}px;top:${node.y||60}px;width:150px;min-height:70px;background:${nt.color};border:2px solid ${nt.border};border-radius:10px;padding:10px 10px 8px;cursor:move;user-select:none;z-index:${isSelected?20:10};transition:box-shadow .15s;`;
    if(isSelected) div.style.boxShadow=`0 0 0 2px ${nt.border},0 0 16px ${nt.border}44`;
    if(isConnecting) div.style.boxShadow=`0 0 0 2px #4a9eff,0 0 20px rgba(74,158,255,.5)`;

    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px;">
        <span style="font-size:13px;cursor:pointer;" title="Click to change icon" onclick="event.stopPropagation();changeNodeIcon('${node.id}')">${node.icon||nt.icon}</span>
        <span style="font-family:var(--fu);font-size:8px;color:${nt.border};letter-spacing:1px;text-transform:uppercase;flex:1">${nt.label}</span>
        <span style="font-size:9px;color:var(--red);cursor:pointer;padding:1px 4px;border:1px solid var(--red);border-radius:2px;line-height:1.4;" onclick="event.stopPropagation();deleteFlowNode('${node.id}')">Ã—</span>
      </div>
      <div contenteditable="true" spellcheck="false" id="fnlabel-${node.id}"
        style="font-family:var(--fb);font-size:12px;font-weight:500;color:var(--text-primary);outline:none;word-break:break-word;min-height:16px;line-height:1.4;border-bottom:1px solid ${nt.border}22;padding-bottom:4px;margin-bottom:6px;"
        oninput="updateNodeLabel('${node.id}',this.innerHTML)"
        onclick="event.stopPropagation()"
        onmousedown="event.stopPropagation()">${node.label||nt.label}</div>
      <div style="font-size:10px;color:${nt.border}88;min-height:12px;line-height:1.4;" 
        contenteditable="true" spellcheck="false" id="fndesc-${node.id}"
        oninput="updateNodeDesc('${node.id}',this.innerHTML)"
        onclick="event.stopPropagation()"
        onmousedown="event.stopPropagation()">${node.desc||''}</div>
      <div style="display:flex;gap:4px;margin-top:8px;align-items:center;">
        <span class="fnode-btn" style="color:${FC.connectFrom===node.id?'#4a9eff':nt.border};border-color:${FC.connectFrom===node.id?'#4a9eff':nt.border};" 
          onclick="event.stopPropagation();startConnect('${node.id}')" 
          title="Click to start/finish a connection">${FC.connectFrom===node.id?'â— linkingâ€¦':'â¬¡ link'}</span>
      </div>`;

    // Drag logic
    div.addEventListener('mousedown', e=>{
      if(e.target.contentEditable==='true'||e.target.className==='fnode-btn') return;
      const canvas=document.getElementById('flowchart-canvas');
      const cr=canvas.getBoundingClientRect();
      FC.dragging=node.id;
      const w=_fcScreenToWorld(e.clientX-cr.left, e.clientY-cr.top);
      FC.dragOff={x:w.x-node.x, y:w.y-node.y};
      FC.selectedNode=node.id;
      renderFlowNodes();
      e.preventDefault();e.stopPropagation();
    });
    container.appendChild(div);
  });

  initFlowCanvas();
}

function renderFlowConnections() {
  const svg=document.getElementById('flow-svg');
  if(!svg) return;
  svg.innerHTML=`<defs>
    <marker id="arrowGold" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c9a227" opacity="0.7"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4a9eff" opacity="0.7"/>
    </marker>
  </defs>`;
  FC.connections.forEach((conn,ci)=>{
    const a=FC.nodes.find(n=>n.id===conn.from);
    const b=FC.nodes.find(n=>n.id===conn.to);
    if(!a||!b) return;
    const x1=a.x+75,y1=a.y+75;
    const x2=b.x+75,y2=b.y+35;
    const cpx=(x1+x2)/2,cpy1=y1+Math.abs(y2-y1)*0.5,cpy2=y2-Math.abs(y2-y1)*0.3;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const d=`M${x1},${y1} C${cpx},${cpy1} ${cpx},${cpy2} ${x2},${y2}`;
    path.setAttribute('d',d);
    path.setAttribute('stroke',conn.color||'#8a6e1a');
    path.setAttribute('stroke-width','2');
    path.setAttribute('fill','none');
    path.setAttribute('marker-end',`url(#arrow${conn.color==='#4a9eff'?'Blue':'Gold'})`);
    path.style.cursor='pointer';
    path.style.pointerEvents='visibleStroke';
    path.setAttribute('stroke-dasharray',conn.dashed?'6,3':'');
    path.onclick=()=>editFlowConnection(ci);
    svg.appendChild(path);
    // Connection label
    const midX=(x1+x2)/2+10, midY=(y1+y2)/2;
    if(conn.label){
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      const labelTxt=conn.label.substring(0,32);
      const labelW=Math.max(44,labelTxt.length*5.5+14);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',midX-labelW/2);rect.setAttribute('y',midY-9);
      rect.setAttribute('width',String(labelW));rect.setAttribute('height','16');
      rect.setAttribute('rx','3');rect.setAttribute('fill','#1a1a0a');
      rect.setAttribute('stroke','#3a3020');
      const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',midX);txt.setAttribute('y',midY+3);
      txt.setAttribute('text-anchor','middle');txt.setAttribute('font-size','8');
      txt.setAttribute('fill','#c9a227');txt.setAttribute('font-family','Barlow');
      txt.textContent=labelTxt;
      g.appendChild(rect);g.appendChild(txt);
      g.style.cursor='pointer';
      g.onclick=()=>editFlowConnection(ci);
      svg.appendChild(g);
    }
  });
}

function editFlowConnection(idx){
  const conn=FC.connections[idx];
  if(!conn)return;
  const safeLabel=(conn.label||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  openModal('Edit Connection',
    `<div class="fg"><label class="fl">Label <small style="color:var(--text-muted)">(optional)</small></label>
     <input class="fi" id="fc-edit-label" value="${safeLabel}" placeholder="e.g. door, shortcut, requires keyâ€¦"></div>
     <div class="fg"><label class="fl">Line Color</label>
     <div style="display:flex;gap:8px;flex-wrap:wrap;">${_fcColorBtnsHtml(conn.color||'#8a6e1a','fc-edit')}</div>
     <input type="hidden" id="fc-edit-color" value="${conn.color||'#8a6e1a'}"></div>
     <div class="fg"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text-secondary);">
       <input type="checkbox" id="fc-edit-dashed" ${conn.dashed?'checked':''}> Dashed line (optional path)
     </label></div>`,
    `<button class="btn btn-danger btn-sm" onclick="deleteFlowConn(${idx})">ğŸ—‘ Delete</button>
     <button class="btn btn-sm" onclick="closeModal()">Cancel</button>
     <button class="btn btn-gold" onclick="saveFlowConn(${idx})">Save</button>`
  );
}
function saveFlowConn(idx){
  const conn=FC.connections[idx];
  if(!conn){closeModal();return;}
  fcPushHistory();
  conn.label=document.getElementById('fc-edit-label')?.value||'';
  conn.color=document.getElementById('fc-edit-color')?.value||'#8a6e1a';
  conn.dashed=document.getElementById('fc-edit-dashed')?.checked||false;
  if(PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart.connections=FC.connections;
  saveFlowchart();renderFlowConnections();closeModal();
}
function deleteFlowConn(idx){
  if(!confirm('Delete this connection?'))return;
  fcPushHistory();
  FC.connections.splice(idx,1);
  if(PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart.connections=FC.connections;
  saveFlowchart();renderFlowConnections();closeModal();
}

function addFlowNode(type) {
  const canvas=document.getElementById('flowchart-canvas');
  if(!canvas){showToast('Switch to LDD â†’ Level Flowchart first');return;}
  fcPushHistory();
  const nt=NODE_TYPES[type]||NODE_TYPES.area;
  const idx=FC.nodes.length;
  // Place in center of current viewport, with small offset per node
  const cx=(canvas.clientWidth/2 - FC.cam.x)/FC.cam.zoom - 77;
  const cy=(canvas.clientHeight/2 - FC.cam.y)/FC.cam.zoom - 60;
  const ox=(idx%5)*20 - 40, oy=Math.floor(idx/5)*20 - 20;
  const node={
    id:'fn_'+Date.now(),
    type,
    icon:nt.icon,
    label:nt.label+' '+(idx+1),
    desc:'',
    x:Math.max(10,cx+ox),
    y:Math.max(10,cy+oy)
  };
  FC.nodes.push(node);
  if(!PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart={nodes:[],connections:[]};
  PS.data.docs.ldd.flowchart.nodes=FC.nodes;
  renderFlowNodes();renderFlowConnections();saveFlowchart();
}

function changeNodeIcon(id){
  const node=FC.nodes.find(n=>n.id===id);
  if(!node)return;
  const emoji=prompt('Enter an emoji for this node:',node.icon||'ğŸ“');
  if(emoji!==null){node.icon=emoji||node.icon;if(PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart.nodes=FC.nodes;renderFlowNodes();saveFlowchart();}
}

let _pendingConn=null;
function _fcColorBtnsHtml(selectedColor,btnIdPrefix){
  const colors=[{v:'#8a6e1a',l:'Gold',t:'#c9a227'},{v:'#4a9eff',l:'Blue',t:'#4a9eff'},{v:'#4ecb71',l:'Green',t:'#4ecb71'},{v:'#e05252',l:'Red',t:'#e05252'}];
  return colors.map(c=>`<button type="button" onclick="setFcColor('${c.v}',this,'${btnIdPrefix}')" class="btn btn-sm" style="border-color:${c.v};color:${c.t};${selectedColor===c.v?'outline:2px solid '+c.t+';outline-offset:2px;':''}">${c.l}</button>`).join('');
}
function setFcColor(color,btn,prefix){
  document.getElementById(prefix+'-color').value=color;
  const btns=btn.closest('div');
  if(btns) btns.querySelectorAll('button').forEach(b=>{b.style.outline='none';});
  btn.style.outline=`2px solid ${color}`;btn.style.outlineOffset='2px';
}
function startConnect(fromId) {
  if(FC.connectFrom && FC.connectFrom!==fromId){
    if(!FC.connections.find(c=>c.from===FC.connectFrom&&c.to===fromId)){
      _pendingConn={from:FC.connectFrom,to:fromId};
      FC.connectFrom=null;
      renderFlowNodes();
      openModal('New Connection',
        `<div class="fg"><label class="fl">Label <small style="color:var(--text-muted)">(optional)</small></label>
         <input class="fi" id="fc-new-label" placeholder="e.g. door, shortcut, requires keyâ€¦" autofocus></div>
         <div class="fg"><label class="fl">Line Color</label>
         <div style="display:flex;gap:8px;flex-wrap:wrap;">${_fcColorBtnsHtml('#8a6e1a','fc-new')}</div>
         <input type="hidden" id="fc-new-color" value="#8a6e1a"></div>
         <div class="fg"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text-secondary);">
           <input type="checkbox" id="fc-new-dashed"> Dashed line (optional path)
         </label></div>`,
        `<button class="btn btn-sm" onclick="cancelFlowConn()">Cancel</button>
         <button class="btn btn-gold" onclick="confirmFlowConn()">Create Connection</button>`
      );
    } else {
      FC.connectFrom=null;
      renderFlowNodes();
    }
  } else {
    FC.connectFrom=fromId;
    showToast('Now click "link" on another node to connect');
    renderFlowNodes();
  }
}
function confirmFlowConn(){
  if(!_pendingConn)return;
  fcPushHistory();
  const label=document.getElementById('fc-new-label')?.value||'';
  const color=document.getElementById('fc-new-color')?.value||'#8a6e1a';
  const dashed=document.getElementById('fc-new-dashed')?.checked||false;
  FC.connections.push({from:_pendingConn.from,to:_pendingConn.to,label,color,dashed});
  if(!PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart={nodes:[],connections:[]};
  PS.data.docs.ldd.flowchart.connections=FC.connections;
  renderFlowConnections();saveFlowchart();
  closeModal();showToast('Connection created âœ“');
  _pendingConn=null;
}
function cancelFlowConn(){
  _pendingConn=null;FC.connectFrom=null;renderFlowNodes();closeModal();
}

function deleteFlowNode(id) {
  fcPushHistory();
  FC.nodes=FC.nodes.filter(n=>n.id!==id);
  FC.connections=FC.connections.filter(c=>c.from!==id&&c.to!==id);
  if(FC.selectedNode===id) FC.selectedNode=null;
  if(FC.connectFrom===id) FC.connectFrom=null;
  if(PS.data.docs.ldd.flowchart){PS.data.docs.ldd.flowchart.nodes=FC.nodes;PS.data.docs.ldd.flowchart.connections=FC.connections;}
  renderFlowNodes();renderFlowConnections();saveFlowchart();
}

function updateNodeLabel(id,html){
  const node=FC.nodes.find(n=>n.id===id);
  if(node){node.label=html;if(PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart.nodes=FC.nodes;autoSave();}
}
function updateNodeDesc(id,html){
  const node=FC.nodes.find(n=>n.id===id);
  if(node){node.desc=html;if(PS.data.docs.ldd.flowchart)PS.data.docs.ldd.flowchart.nodes=FC.nodes;autoSave();}
}
function clearFlowchart(){if(!confirm('Clear entire flowchart?'))return;fcPushHistory();FC.nodes=[];FC.connections=[];PS.data.docs.ldd.flowchart={nodes:[],connections:[]};renderFlowNodes();renderFlowConnections();saveFlowchart();}
function saveFlowchart(){autoSave();}


// STUDYING MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(!PS.data.studying) PS.data.studying={topics:[],notes:[]};
let _studyActiveTopic = null;
let _studyDragIdx = null;

function ensureStudying(){if(!PS.data.studying)PS.data.studying={topics:[],notes:[]};}

function openStudyTopicModal(){
  openModal('New Topic',
    `<div class="fg"><label class="fl">Topic Name</label><input class="fi" id="st-name" placeholder="e.g. Level Design Theory"></div>
     <div class="fg"><label class="fl">Icon (emoji)</label><input class="fi" id="st-icon" placeholder="ğŸ“–" maxlength="4" style="width:80px;font-size:18px"></div>
     <div class="fg"><label class="fl">Color</label><input type="color" id="st-color" value="#c9a227"></div>`,
    `<button class="btn btn-sm" onclick="closeModal()">Cancel</button>
     <button class="btn btn-gold" onclick="saveStudyTopic()">Create Topic</button>`
  );
}

function saveStudyTopic(){
  ensureStudying();
  const name=document.getElementById('st-name').value.trim();
  if(!name){showToast('Name required');return;}
  const topic={id:'topic_'+Date.now(),name,icon:document.getElementById('st-icon').value||'ğŸ“–',color:document.getElementById('st-color').value};
  PS.data.studying.topics.push(topic);
  closeModal();renderStudyTopics();
  if(!PS.data._sectionTs)PS.data._sectionTs={};
  PS.data._sectionTs['studying']=Date.now();
  if(typeof _localDirty!=='undefined')_localDirty.add('studying');
  saveAll();FIREBASE.push();showToast('Topic created âœ“');
}

function openStudyNoteModal(id){
  ensureStudying();
  const note=id?PS.data.studying.notes.find(n=>n.id===id):null;
  const topics=PS.data.studying.topics.filter(t=>!t.type||t.type==='topic');
  const body=`
    <div class="fg"><label class="fl">Title</label><input class="fi" id="sn-title" value="${note?note.title:''}" placeholder="Note titleâ€¦"></div>
    <div class="fg"><label class="fl">Topic</label>
      <select class="fs" id="sn-topic">
        <option value="">â€” No topic â€”</option>
        ${topics.map(t=>`<option value="${t.id}" ${note&&note.topicId===t.id?'selected':''}>${t.icon} ${t.name}</option>`).join('')}
      </select>
    </div>
    <div class="fg"><label class="fl">Content</label>
      <textarea class="fta" id="sn-content" style="min-height:200px;font-size:13px;line-height:1.7">${note?note.content||'':''}</textarea>
    </div>
    <div class="fg"><label class="fl">Tags (comma separated)</label>
      <input class="fi" id="sn-tags" value="${note&&note.tags?note.tags.join(', '):''}" placeholder="game design, level, ue5â€¦">
    </div>`;
  const footer=`${note?`<button class="btn btn-danger btn-sm" onclick="deleteStudyNote('${note.id}')">Delete</button>`:''}
    <button class="btn btn-sm" onclick="closeModal()">Cancel</button>
    <button class="btn btn-gold" onclick="saveStudyNote('${note?note.id:''}')">Save Note</button>`;
  openModal(note?'Edit Note':'New Study Note',body,footer);
}

function saveStudyNote(id){
  ensureStudying();
  const title=document.getElementById('sn-title').value.trim();
  if(!title){showToast('Title required');return;}
  const tags=document.getElementById('sn-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const note={
    id:id||'note_'+Date.now(),
    title,
    topicId:document.getElementById('sn-topic').value,
    content:document.getElementById('sn-content').value,
    tags,
    updatedAt:new Date().toISOString(),
    createdAt:id?(PS.data.studying.notes.find(n=>n.id===id)||{}).createdAt||new Date().toISOString():new Date().toISOString()
  };
  if(id){const idx=PS.data.studying.notes.findIndex(n=>n.id===id);if(idx>=0)PS.data.studying.notes[idx]=note;else PS.data.studying.notes.push(note);}
  else PS.data.studying.notes.push(note);
  closeModal();renderStudyNotes();
  if(!PS.data._sectionTs)PS.data._sectionTs={};
  PS.data._sectionTs['studying']=Date.now();
  if(typeof _localDirty!=='undefined')_localDirty.add('studying');
  saveAll();FIREBASE.push();showToast('Note saved âœ“');
}

function deleteStudyNote(id){
  if(!confirm('Delete note?'))return;
  PS.data.studying.notes=PS.data.studying.notes.filter(n=>n.id!==id);
  closeModal();renderStudyNotes();autoSave();
}

function renderStudyTopics(){
  ensureStudying();
  const nav=document.getElementById('study-topics-nav');
  if(!nav)return;
  nav.innerHTML='';
  // All notes row
  const allDiv=document.createElement('div');
  allDiv.style.cssText=`padding:6px 10px;cursor:pointer;font-family:var(--fu);font-size:12px;font-weight:500;color:${_studyActiveTopic===null?'var(--gold)':'var(--text-secondary)'};border-left:2px solid ${_studyActiveTopic===null?'var(--gold)':'transparent'};border-radius:0 4px 4px 0;transition:all .1s;text-transform:uppercase;letter-spacing:.5px;background:${_studyActiveTopic===null?'rgba(201,162,39,.08)':'transparent'};margin-bottom:2px;`;
  allDiv.innerHTML='ğŸ“š All Notes';
  allDiv.onclick=()=>{_studyActiveTopic=null;document.getElementById('study-current-topic').textContent='All Notes';renderStudyNotes();renderStudyTopics();};
  nav.appendChild(allDiv);

  const items=PS.data.studying.topics;
  items.forEach((item,idx)=>{
    // â”€â”€ SECTION HEADER â”€â”€
    if(item.type==='section'){
      const sDiv=document.createElement('div');
      sDiv.draggable=true;
      sDiv.style.cssText=`padding:10px 10px 3px;font-family:var(--fu);font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);display:flex;align-items:center;gap:4px;cursor:grab;position:relative;border-top:1px solid var(--border);margin-top:6px;margin-bottom:2px;user-select:none;`;
      const secLabel=document.createElement('span');
      secLabel.style.flex='1';
      secLabel.textContent='â€” '+item.name;
      const secActs=document.createElement('span');
      secActs.style.cssText='display:none;gap:2px;flex-shrink:0;';
      secActs.innerHTML=`<button title="Rename" onclick="event.stopPropagation();_studyRenameSection('${item.id}')" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-secondary);padding:1px 3px;line-height:1">âœ</button><button title="Delete section" onclick="event.stopPropagation();_studyDeleteSection('${item.id}')" style="background:none;border:none;cursor:pointer;font-size:11px;color:#e05252;padding:1px 3px;line-height:1">Ã—</button>`;
      sDiv.appendChild(secLabel);sDiv.appendChild(secActs);
      sDiv.onmouseenter=()=>{secActs.style.display='flex';};
      sDiv.onmouseleave=()=>{secActs.style.display='none';};
      sDiv.ondragstart=e=>{_studyDragIdx=idx;e.dataTransfer.effectAllowed='move';sDiv.style.opacity='.4';};
      sDiv.ondragend=()=>{sDiv.style.opacity='1';_studyDragIdx=null;};
      sDiv.ondragover=e=>{if(_studyDragIdx===null||_studyDragIdx===idx)return;e.preventDefault();sDiv.style.background='rgba(201,162,39,.1)';};
      sDiv.ondragleave=()=>{sDiv.style.background='';};
      sDiv.ondrop=e=>{e.preventDefault();sDiv.style.background='';_studyDrop(idx);};
      nav.appendChild(sDiv);
      return;
    }
    // â”€â”€ TOPIC ITEM â”€â”€
    const topic=item;
    const active=_studyActiveTopic===topic.id;
    const div=document.createElement('div');
    div.draggable=true;
    div.style.cssText=`padding:4px 6px 4px 10px;cursor:pointer;font-family:var(--fu);font-size:12px;font-weight:500;color:${active?topic.color:'var(--text-secondary)'};border-left:2px solid ${active?topic.color:'transparent'};border-radius:0 4px 4px 0;transition:all .1s;text-transform:uppercase;letter-spacing:.5px;background:${active?topic.color+'11':'transparent'};margin-bottom:2px;display:flex;align-items:center;gap:5px;position:relative;user-select:none;`;
    const count=PS.data.studying.notes.filter(n=>n.topicId===topic.id).length;
    div.innerHTML=`
      <span style="cursor:grab;opacity:.4;font-size:10px">â ¿</span>
      <span>${topic.icon}</span>
      <span class="st-name" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${topic.name}">${topic.name}</span>
      <span style="font-family:var(--fm);font-size:9px;opacity:.6">${count}</span>
      <span class="st-actions" style="display:none;gap:2px;flex-shrink:0">
        <button title="Rename" onclick="event.stopPropagation();_studyRenameTopic('${topic.id}')" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-secondary);padding:1px 3px;line-height:1" onmouseover="this.style.color='var(--gold)'" onmouseout="this.style.color='var(--text-secondary)'">âœ</button>
        <button title="Move up" onclick="event.stopPropagation();_studyMoveTopic('${topic.id}',-1)" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-secondary);padding:1px 3px;line-height:1;${idx===0?'opacity:.2;pointer-events:none':''}" onmouseover="this.style.color='var(--gold)'" onmouseout="this.style.color='var(--text-secondary)'">â†‘</button>
        <button title="Move down" onclick="event.stopPropagation();_studyMoveTopic('${topic.id}',1)" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--text-secondary);padding:1px 3px;line-height:1;${idx===items.length-1?'opacity:.2;pointer-events:none':''}" onmouseover="this.style.color='var(--gold)'" onmouseout="this.style.color='var(--text-secondary)'">â†“</button>
        <button title="Delete topic" onclick="event.stopPropagation();_studyDeleteTopic('${topic.id}')" style="background:none;border:none;cursor:pointer;font-size:11px;color:#e05252;padding:1px 3px;line-height:1" onmouseover="this.style.color='#ff6b6b'" onmouseout="this.style.color='#e05252'">Ã—</button>
      </span>`;
    const actions=div.querySelector('.st-actions');
    div.onmouseenter=()=>{actions.style.display='flex';};
    div.onmouseleave=()=>{actions.style.display='none';};
    div.ondragstart=e=>{_studyDragIdx=idx;e.dataTransfer.effectAllowed='move';div.style.opacity='.4';};
    div.ondragend=()=>{div.style.opacity='1';_studyDragIdx=null;};
    div.ondragover=e=>{if(_studyDragIdx===null||_studyDragIdx===idx)return;e.preventDefault();div.style.outline='1px dashed var(--gold)';};
    div.ondragleave=()=>{div.style.outline='';};
    div.ondrop=e=>{e.preventDefault();div.style.outline='';_studyDrop(idx);};
    div.onclick=()=>{
      const urlBar=document.getElementById('study-url-bar');
      if(_studyActiveTopic && urlBar){
        const prev=PS.data.studying.topics.find(t=>t.id===_studyActiveTopic);
        if(prev && urlBar.value.startsWith('http')) prev.url=urlBar.value;
      }
      _studyActiveTopic=topic.id;
      document.getElementById('study-current-topic').textContent=topic.icon+' '+topic.name;
      if(topic.url && urlBar){
        urlBar.value=topic.url;
        const iframe=document.getElementById('study-iframe');
        const blocked=document.getElementById('study-iframe-blocked');
        if(iframe){if(blocked)blocked.style.display='none';iframe.src=topic.url;}
        switchStudyView('web');
      } else {
        switchStudyView('notes');
      }
      renderStudyNotes();renderStudyTopics();
    };
    nav.appendChild(div);
  });
}

function _studyDrop(targetIdx){
  if(_studyDragIdx===null||_studyDragIdx===targetIdx)return;
  const arr=PS.data.studying.topics;
  const dragI=_studyDragIdx;
  _studyDragIdx=null;
  const [moved]=arr.splice(dragI,1);
  const insertAt=targetIdx>dragI?targetIdx-1:targetIdx;
  arr.splice(insertAt,0,moved);
  renderStudyTopics();
  if(!PS.data._sectionTs)PS.data._sectionTs={};
  PS.data._sectionTs['studying']=Date.now();
  if(typeof _localDirty!=='undefined')_localDirty.add('studying');
  autoSave();
}

function openStudySectionModal(){
  openModal('Add Section',
    `<div class="fg"><label class="fl">Section Title</label><input class="fi" id="ss-name" placeholder="e.g. Core Design, Referencesâ€¦"></div>`,
    `<button class="btn btn-sm" onclick="closeModal()">Cancel</button>
     <button class="btn btn-gold" onclick="saveStudySection()">Add Section</button>`
  );
  setTimeout(()=>document.getElementById('ss-name')?.focus(),100);
}

function saveStudySection(){
  ensureStudying();
  const name=document.getElementById('ss-name').value.trim();
  if(!name){showToast('Name required');return;}
  PS.data.studying.topics.push({type:'section',id:'sec_'+Date.now(),name});
  closeModal();renderStudyTopics();
  if(!PS.data._sectionTs)PS.data._sectionTs={};
  PS.data._sectionTs['studying']=Date.now();
  if(typeof _localDirty!=='undefined')_localDirty.add('studying');
  autoSave();FIREBASE.push();showToast('Section added âœ“');
}

function _studyRenameSection(id){
  ensureStudying();
  const sec=PS.data.studying.topics.find(t=>t.id===id&&t.type==='section');
  if(!sec)return;
  const name=prompt('Rename section:',sec.name);
  if(!name||!name.trim())return;
  sec.name=name.trim();
  renderStudyTopics();autoSave();
}

function _studyDeleteSection(id){
  ensureStudying();
  const sec=PS.data.studying.topics.find(t=>t.id===id&&t.type==='section');
  if(!confirm(`Delete section "${sec?.name}"?`))return;
  PS.data.studying.topics=PS.data.studying.topics.filter(t=>t.id!==id);
  renderStudyTopics();autoSave();showToast('Section deleted');
}

function filterStudyNotes(q){renderStudyNotes(q);}

function _studyRenameTopic(id) {
  ensureStudying();
  const topic = PS.data.studying.topics.find(t=>t.id===id);
  if (!topic) return;
  const name = prompt('Rename topic:', topic.name);
  if (!name || !name.trim()) return;
  topic.name = name.trim();
  if (_studyActiveTopic === id)
    document.getElementById('study-current-topic').textContent = topic.icon + ' ' + topic.name;
  renderStudyTopics(); autoSave();
}

function _studyMoveTopic(id, dir) {
  ensureStudying();
  const arr = PS.data.studying.topics;
  const idx = arr.findIndex(t=>t.id===id);
  const to  = idx + dir;
  if (to < 0 || to >= arr.length) return;
  [arr[idx], arr[to]] = [arr[to], arr[idx]];
  renderStudyTopics(); autoSave();
}

function _studyDeleteTopic(id) {
  ensureStudying();
  const topic = PS.data.studying.topics.find(t=>t.id===id);
  const noteCount = PS.data.studying.notes.filter(n=>n.topicId===id).length;
  const msg = noteCount
    ? `Delete "${topic?.name}"? This will also delete its ${noteCount} note(s).`
    : `Delete "${topic?.name}"?`;
  if (!confirm(msg)) return;
  PS.data.studying.topics = PS.data.studying.topics.filter(t=>t.id!==id);
  PS.data.studying.notes  = PS.data.studying.notes.filter(n=>n.topicId!==id);
  if (_studyActiveTopic === id) { _studyActiveTopic = null; document.getElementById('study-current-topic').textContent = 'All Notes'; }
  renderStudyTopics(); renderStudyNotes(); autoSave();
  showToast('Topic deleted');
}

function renderStudyNotes(search){
  ensureStudying();
  const grid=document.getElementById('study-notes-grid');
  const countEl=document.getElementById('study-count');
  if(!grid)return;
  const q=(search||document.getElementById('study-search')?.value||'').toLowerCase();
  let notes=PS.data.studying.notes;
  if(_studyActiveTopic) notes=notes.filter(n=>n.topicId===_studyActiveTopic);
  if(q) notes=notes.filter(n=>n.title.toLowerCase().includes(q)||(n.content||'').replace(/<[^>]+>/g,' ').toLowerCase().includes(q)||(n.tags||[]).some(t=>t.toLowerCase().includes(q)));
  if(countEl) countEl.textContent=notes.length+' note'+(notes.length!==1?'s':'');
  grid.innerHTML='';
  if(!notes.length){
    grid.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ“</div><div class="empty-txt">No notes yet â€” click "+ New Note"</div></div>';
    return;
  }
  [...notes].reverse().forEach(note=>{
    const topic=PS.data.studying.topics.find(t=>t.id===note.topicId);
    const accentColor=topic?topic.color:'#c9a227';
    const card=document.createElement('div');
    card.style.cssText=`background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;transition:all .15s;border-top:3px solid ${accentColor};`;
    card.onmouseenter=()=>{card.style.borderColor=accentColor;card.style.transform='translateY(-2px)';card.style.boxShadow='0 6px 16px rgba(0,0,0,.4)';};
    card.onmouseleave=()=>{card.style.borderColor='var(--border)';card.style.transform='';card.style.boxShadow='';card.style.borderTopColor=accentColor;};
    const plainText=(note.content||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    const preview=plainText.substring(0,110)+(plainText.length>110?'â€¦':'');
    const tags=(note.tags||[]).slice(0,4).map(t=>`<span style="background:rgba(201,162,39,.08);border:1px solid ${accentColor}44;color:${accentColor};border-radius:3px;padding:1px 6px;font-size:9px;font-family:var(--fu);letter-spacing:.5px;">${t}</span>`).join('');
    const isRich=note.content&&note.content.includes('<');
    card.innerHTML=`
      <div style="display:flex;align-items:flex-start;gap:6px;margin-bottom:6px;">
        <span style="font-size:16px">${topic?topic.icon:'ğŸ“'}</span>
        <div style="flex:1;">
          <div style="font-family:var(--fu);font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:2px;">${note.title}</div>
          ${topic?`<div style="font-size:9px;color:${accentColor};font-family:var(--fu);letter-spacing:.5px;text-transform:uppercase">${topic.name}</div>`:''}
        </div>
        ${isRich?'<span style="font-family:var(--fu);font-size:8px;color:var(--gold-dim);border:1px solid var(--gold-dim);border-radius:2px;padding:1px 4px;">ğŸ“–</span>':''}
      </div>
      <div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:8px;">${preview||'(empty)'}</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;">${tags}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-family:var(--fm);font-size:9px;color:var(--text-muted)">${new Date(note.updatedAt||note.createdAt).toLocaleDateString()}</span>
        <span style="font-family:var(--fu);font-size:9px;color:${accentColor};letter-spacing:.5px">READ â†’</span>
      </div>`;
    card.onclick=()=>openStudyNoteView(note.id);
    grid.appendChild(card);
  });
}

function openStudyNoteView(id){
  ensureStudying();
  const note=PS.data.studying.notes.find(n=>n.id===id);
  if(!note)return;
  const topic=PS.data.studying.topics.find(t=>t.id===note.topicId);
  const accentColor=topic?topic.color:'#c9a227';
  const isRich=note.content&&note.content.includes('<');
  const tags=(note.tags||[]).map(t=>`<span style="background:rgba(201,162,39,.08);border:1px solid ${accentColor}44;color:${accentColor};border-radius:3px;padding:2px 8px;font-size:10px;font-family:var(--fu);letter-spacing:.5px;">${t}</span>`).join('');
  const body=`<div style="max-height:72vh;overflow-y:auto;padding:4px 0 16px;">
    ${topic?`<div style="font-size:10px;color:${accentColor};font-family:var(--fu);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">${topic.icon} ${topic.name}</div>`:''}
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;">${tags}</div>
    <div class="study-note-content">${isRich?note.content:('<pre style="white-space:pre-wrap;font-family:var(--fb);font-size:13px;line-height:1.8;color:var(--text-primary);">'+(note.content||'(empty)').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</pre>')}</div>
  </div>`;
  const footer=`<button class="btn btn-sm" onclick="openStudyNoteModal('${id}');closeModal()">âœï¸ Edit</button>
    <button class="btn btn-danger btn-sm" onclick="deleteStudyNote('${id}')">Delete</button>
    <button class="btn btn-gold" onclick="closeModal()">Close</button>`;
  openModal(note.title,body,footer);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES / CHECKLIST MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ensureNotes(){
  if(!PS.data.notes)PS.data.notes={lists:[{id:'nl_default',name:'General',color:'#c9a227',icon:'ğŸ“‹',items:[]}],activeList:'nl_default'};
  if(!PS.data.notes.lists)PS.data.notes.lists=[];
  if(!PS.data.notes.lists.length)PS.data.notes.lists.push({id:'nl_default',name:'General',color:'#c9a227',icon:'ğŸ“‹',items:[]});
}

function renderNotesLists(){
  ensureNotes();
  const nav=document.getElementById('notes-lists-nav');
  if(!nav)return;
  nav.innerHTML='';
  PS.data.notes.lists.forEach(lst=>{
    const active=PS.data.notes.activeList===lst.id;
    const done=lst.items.filter(i=>i.done).length;
    const row=document.createElement('div');
    row.className='notes-list-row'+(active?' active':'');
    row.innerHTML=`<span style="font-size:14px">${lst.icon||'ğŸ“‹'}</span><span style="flex:1">${lst.name}</span><span style="font-family:var(--fm);font-size:9px;color:var(--text-muted)">${done}/${lst.items.length}</span>`;
    row.onclick=()=>{PS.data.notes.activeList=lst.id;renderNotesLists();renderNotesItems();};
    row.oncontextmenu=(e)=>{e.preventDefault();if(PS.data.notes.lists.length>1&&confirm('Delete list "'+lst.name+'"?')){PS.data.notes.lists=PS.data.notes.lists.filter(l=>l.id!==lst.id);PS.data.notes.activeList=PS.data.notes.lists[0].id;renderNotesLists();renderNotesItems();autoSave();}};
    nav.appendChild(row);
  });
}

function renderNotesItems(){
  ensureNotes();
  const container=document.getElementById('notes-items-list');
  const titleEl=document.getElementById('notes-active-title');
  const progEl=document.getElementById('notes-progress-lbl');
  if(!container)return;
  const lst=PS.data.notes.lists.find(l=>l.id===PS.data.notes.activeList)||PS.data.notes.lists[0];
  if(!lst){container.innerHTML='';return;}
  if(titleEl)titleEl.textContent=lst.icon+' '+lst.name;
  const done=lst.items.filter(i=>i.done).length;
  if(progEl)progEl.textContent=done+'/'+lst.items.length+' done';
  container.innerHTML='';
  if(!lst.items.length){
    container.innerHTML='<div style="text-align:center;padding:40px 20px;font-family:var(--fu);font-size:11px;color:var(--text-muted);letter-spacing:.5px">No notes yet â€” type above and press Enter</div>';
    return;
  }
  lst.items.forEach((item,i)=>{
    const row=document.createElement('div');
    row.className='note-item'+(item.done?' done':'');
    const cb=document.createElement('input');cb.type='checkbox';cb.checked=item.done;
    cb.onchange=()=>{item.done=cb.checked;autoSave();renderNotesItems();renderNotesLists();renderDashNotes&&renderDashNotes();};
    const span=document.createElement('span');span.className='note-item-text';span.contentEditable='true';span.textContent=item.text;
    span.oninput=()=>{item.text=span.textContent;autoSave();};
    span.onkeydown=(e)=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('notes-quick-input')?.focus();}};
    const del=document.createElement('span');del.className='note-del-btn';del.textContent='âœ•';
    del.onclick=()=>{lst.items.splice(i,1);autoSave();renderNotesItems();renderNotesLists();};
    row.appendChild(cb);row.appendChild(span);row.appendChild(del);
    container.appendChild(row);
  });
}

function quickAddNote(text){
  ensureNotes();
  const lst=PS.data.notes.lists.find(l=>l.id===PS.data.notes.activeList)||PS.data.notes.lists[0];
  if(!lst)return;
  lst.items.push({id:'ni_'+Date.now(),text,done:false});
  autoSave();renderNotesItems();renderNotesLists();renderDashNotes&&renderDashNotes();
}

function clearDoneNotes(){
  ensureNotes();
  const lst=PS.data.notes.lists.find(l=>l.id===PS.data.notes.activeList)||PS.data.notes.lists[0];
  if(!lst||!lst.items.filter(i=>i.done).length)return;
  if(!confirm('Remove all checked items?'))return;
  lst.items=lst.items.filter(i=>!i.done);
  autoSave();renderNotesItems();renderNotesLists();
}

function openNotesListModal(){
  openModal('New List',
    `<div class="fg"><label class="fl">Name</label><input class="fi" id="nl-name" placeholder="e.g. Game Ideas, Bugs, Featuresâ€¦"></div>
     <div class="fg" style="display:flex;gap:12px;"><div style="flex:1"><label class="fl">Icon (emoji)</label><input class="fi" id="nl-icon" placeholder="ğŸ“‹" maxlength="4" style="font-size:18px;width:60px"></div>
     <div style="flex:1"><label class="fl">Color</label><input type="color" id="nl-color" value="#c9a227" style="height:34px;width:100%;border:1px solid var(--border);border-radius:3px;background:none;cursor:pointer;"></div></div>`,
    `<button class="btn btn-sm" onclick="closeModal()">Cancel</button>
     <button class="btn btn-gold" onclick="saveNotesList()">Create</button>`
  );
  setTimeout(()=>document.getElementById('nl-name')?.focus(),50);
}

function saveNotesList(){
  ensureNotes();
  const name=document.getElementById('nl-name')?.value.trim();
  if(!name){showToast('Name required');return;}
  const icon=document.getElementById('nl-icon')?.value||'ğŸ“‹';
  const color=document.getElementById('nl-color')?.value||'#c9a227';
  const lst={id:'nl_'+Date.now(),name,icon,color,items:[]};
  PS.data.notes.lists.push(lst);
  PS.data.notes.activeList=lst.id;
  closeModal();autoSave();renderNotesLists();renderNotesItems();showToast('List created âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDYING â€” WEB READER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _studyView='notes';
function switchStudyView(view){
  _studyView=view;
  const notesGrid=document.getElementById('study-notes-grid');
  const webPanel=document.getElementById('study-webview-panel');
  const searchInput=document.querySelector('#study-search');
  const countEl=document.getElementById('study-count');
  const tabNotes=document.getElementById('study-tab-notes');
  const tabWeb=document.getElementById('study-tab-web');
  if(view==='notes'){
    if(notesGrid){notesGrid.style.display='grid';}
    if(webPanel){webPanel.style.display='none';}
    if(searchInput){searchInput.style.display='';}
    if(countEl){countEl.style.display='';}
    if(tabNotes){tabNotes.style.background='var(--gold)';tabNotes.style.color='#000';tabNotes.style.borderColor='var(--gold)';}
    if(tabWeb){tabWeb.style.background='';tabWeb.style.color='';tabWeb.style.borderColor='';}
  } else {
    if(notesGrid){notesGrid.style.display='none';}
    if(webPanel){webPanel.style.display='flex';}
    if(searchInput){searchInput.style.display='none';}
    if(countEl){countEl.style.display='none';}
    if(tabNotes){tabNotes.style.background='';tabNotes.style.color='';tabNotes.style.borderColor='';}
    if(tabWeb){tabWeb.style.background='var(--gold)';tabWeb.style.color='#000';tabWeb.style.borderColor='var(--gold)';}
    // Load URL if iframe is blank
    const iframe=document.getElementById('study-iframe');
    if(iframe&&(iframe.src==='about:blank'||!iframe.src)){
      studyGoUrl();
    }
  }
}
function studyGoUrl(){
  const urlBar=document.getElementById('study-url-bar');
  if(!urlBar)return;
  let url=urlBar.value.trim();
  if(!url)return;
  if(!url.startsWith('http://') && !url.startsWith('https://')) url='https://'+url;
  urlBar.value=url;
  // Persist URL to active topic
  if(_studyActiveTopic){
    ensureStudying();
    const topic=PS.data.studying.topics.find(t=>t.id===_studyActiveTopic);
    if(topic){
      topic.url=url;
      if(!PS.data._sectionTs)PS.data._sectionTs={};
      PS.data._sectionTs['studying']=Date.now();
      if(typeof _localDirty!=='undefined')_localDirty.add('studying');
      autoSave();
    }
  }
  const iframe=document.getElementById('study-iframe');
  const blocked=document.getElementById('study-iframe-blocked');
  if(!iframe)return;
  if(blocked){blocked.style.display='none';}
  iframe.src=url;
  iframe.onerror=()=>{if(blocked){blocked.style.display='flex';}};
}

function studySaveUrl(){
  const urlBar=document.getElementById('study-url-bar');
  if(!urlBar||!_studyActiveTopic)return;
  const url=urlBar.value.trim();
  if(!url.startsWith('http'))return;
  ensureStudying();
  const topic=PS.data.studying.topics.find(t=>t.id===_studyActiveTopic);
  if(topic && topic.url!==url){
    topic.url=url;
    if(!PS.data._sectionTs)PS.data._sectionTs={};
    PS.data._sectionTs['studying']=Date.now();
    if(typeof _localDirty!=='undefined')_localDirty.add('studying');
    autoSave();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDYING FOCUS MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterFocusMode(){document.body.classList.add('focus-mode');}
function exitFocusMode(){document.body.classList.remove('focus-mode');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Space=pan (hold), W=select
document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&!e.ctrlKey&&!e.metaKey){
    const tag=document.activeElement.tagName;
    if(tag==='INPUT'||tag==='TEXTAREA'||document.activeElement.contentEditable==='true') return;
    const mod=document.querySelector('.sb-item.active')?.dataset?.mod;
    if(mod==='map'){
      e.preventDefault();
      // Always save prev tool â€” if already pan, save 'select' as the return target
      if(!MAP._prevSpaceTool){
        MAP._prevSpaceTool = (MAP.tool==='pan') ? 'select' : MAP.tool;
        setTool('pan');
      }
    }
  }
});
document.addEventListener('keyup',e=>{
  if(e.code==='Space'&&MAP._prevSpaceTool){
    setTool(MAP._prevSpaceTool);MAP._prevSpaceTool=null;
  }
});
document.addEventListener('keydown', e => {
  if(e.ctrlKey||e.metaKey){
    if(e.key==='s'){e.preventDefault();saveAll();}
    // Context-aware undo/redo
    const activeModule = document.querySelector('.sb-item.active')?.dataset?.mod;
    if(e.key==='z'&&!e.shiftKey){
      e.preventDefault();
      if(activeModule==='ldd' && document.getElementById('flowchart-canvas')) fcUndo();
      else mapUndo();
    }
    if(e.key==='z'&&e.shiftKey){
      e.preventDefault();
      if(activeModule==='ldd' && document.getElementById('flowchart-canvas')) fcRedo();
      else mapRedo();
    }
    if(e.key==='y'){
      e.preventDefault();
      if(activeModule==='ldd' && document.getElementById('flowchart-canvas')) fcRedo();
      else mapRedo();
    }
    return;
  }
  if(e.key==='Escape'){closeModal();if(document.body.classList.contains('map-expand'))toggleMapFocus();if(MAP.polyPoints){MAP.polyPoints=[];MAP.isDrawing=false;renderMap();}FC.connectFrom=null;FC.selectedNode=null;renderFlowNodes();}
  const tag=document.activeElement.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT'||document.activeElement.contentEditable==='true') return;
  // Prevent Alt key from stealing focus away from map canvas
  if(e.key==='Alt'){
    const mod=document.querySelector('.sb-item.active')?.dataset?.mod;
    if(mod==='map') e.preventDefault();
    return;
  }
  const toolKeys={v:'select',w:'select',h:'pan',m:'pan',r:'rect',b:'wall',p:'poly',c:'circle',t:'text',e:'erase',g:'grid',f:'fit',s:'stair',l:'light',y:'person',x:'enemy',a:'arrow',d:'draw'};
  if(toolKeys[e.key]) {
    if(e.key==='g') toggleGrid();
    else if(e.key==='f'){ MAP.selectedIds.size?focusOnSelected():fitToScreen(); }
    else setTool(toolKeys[e.key]);
    e.preventDefault();
  }
  if(e.key==='Delete'||e.key==='Backspace'){
    const _aMod=document.querySelector('.sb-item.active')?.dataset?.mod;
    if(_aMod==='ldd'&&FC.selectedNode){deleteFlowNode(FC.selectedNode);return;}
    if(MAP.selectedIds.size){mapPushHistory();MAP.selectedIds.forEach(id=>{MAP.objects=MAP.objects.filter(o=>o.id!==id);});MAP.selectedIds.clear();renderMap();renderMapProps();renderMapLayers();autoSave();mapSaveCurrent();}
  }
  if(e.key==='+') zoomMap(1.2);
  if(e.key==='-') zoomMap(0.83);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seedLevelDesignBook() {
  ensureStudying();
  // Check if already seeded
  if(PS.data.studying.topics.find(t=>t.id==='topic_ldb')) return;
  
  const topicId='topic_ldb';
  PS.data.studying.topics.unshift({id:topicId,name:'Level Design Book',icon:'ğŸ“—',color:'#4ecb71'});
  
  const notes=[
    {id:'ldb_intro',title:'âœ¨ What is Level Design?',topicId,tags:['theory','fundamentals','overview'],content:`<h3>What is a Level?</h3>
A <strong>level</strong> is a space where a game happens. Examples: a Fortnite island, a Monopoly board, a basketball court. All game spaces set <em>boundaries</em> for players to move and interact.

Different levels offer <strong>variation</strong>. All basketball courts have similar shapes, but an outdoor court and indoor gym offer different experiences, cultures, and moods.

Level designers focus on how different game spaces make players <strong>feel</strong> and <strong>behave</strong>.

<h3>What is Level Design?</h3>
<blockquote>Level design is the practice of planning and building spaces for video games â€” usually first-person or third-person action shooters.</blockquote>

This definition is intentionally broad but with a disclaimer: most level design theory engages with 3D shooters as the default medium, dating back to the invention of the level designer role during the 1990s.

<h3>Level Design vs. Environment Art</h3>
<strong>Level Designers</strong> focus on shaping player behavior. They write documentation, draft layouts, build blockouts, observe playtests, and balance maps and encounters.

<strong>Environment Artists</strong> focus on graphics: models, materials, set dressing, and lighting to refine visual appearance.

Two ways to understand level design:
â€¢ <em>Formal industrial sense</em>: Level Design without environment art
â€¢ <em>Broad common sense</em>: level design includes all visuals in a level

<h3>Room Design vs. World Design</h3>
Level designers can spend days or even weeks designing a single room. But for huge open worlds, a <strong>world designer</strong> considers flow and wayfinding for neighborhoods instead of houses, biomes instead of places. 

â€” To build a directed scripted experience: obsess over every room like an <strong>architect</strong>.
â€” For player-heavy system-heavy games: use the lighter touch of an <strong>urban planner</strong>.

<h3>Philosophy: "Go Map"</h3>
The only way to become a level designer is to make levels. In the Quake community, when someone asks too many questions, the tradition is to reply: <strong>"go map."</strong>

Stop procrastinating. You'll figure it out. Now go try to do it â€” you're ready.

<h3>How to Use The Level Design Book</h3>
ğŸ“– <strong>Process</strong> â€” Core concepts, workflows, and language. Start here.
ğŸ¦œ <strong>Culture</strong> â€” Level design history, architecture primers, lighting.
ğŸ” <strong>Studies</strong> â€” Detailed analysis of how specific levels work.
ğŸ’ <strong>Projects</strong> â€” Self-guided tutorials and project ideas.

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/introduction" target="_blank">book.leveldesignbook.com/introduction</a>`},

    {id:'ldb_process',title:'ğŸ—ºï¸ How to Make a Level â€” Process Overview',topicId,tags:['process','workflow','production'],content:`<h3>The Level Design Process</h3>
A professional level goes through these stages:

<strong>1. Pre-Production</strong>
â€¢ Define the level's goals, player fantasy, and emotional arc
â€¢ Write the LDD (Level Design Document)
â€¢ Plan the golden path and key beats
â€¢ Block out on paper first

<strong>2. Layout / Paper Design</strong>
â€¢ Top-down 2D sketch of the level
â€¢ Define zones, paths, shortcuts, chokepoints
â€¢ Test flow on paper before building anything
â€¢ Critical Path analysis

<strong>3. Blockout (Greybox)</strong>
â€¢ Build a rough 3D version with placeholder geometry
â€¢ Focus on scale, proportions, and player feel
â€¢ NO art yet â€” pure gameplay testing
â€¢ Playtest early and often

<strong>4. Encounter Design</strong>
â€¢ Place enemies, scripted events, hazards
â€¢ Design each combat arena's cover, verticality, flanking
â€¢ Balance intensity and pacing

<strong>5. Scripting / Events</strong>
â€¢ Implement triggers, cutscenes, spawns
â€¢ Door locks, environmental changes
â€¢ Narrative moments tied to gameplay

<strong>6. Lighting</strong>
â€¢ Functional lighting first (guides the player)
â€¢ Then atmospheric lighting
â€¢ Baked vs. dynamic decisions

<strong>7. Environment Art Pass</strong>
â€¢ Replace blockout geometry with final assets
â€¢ Set dressing, props, materials
â€¢ Environmental storytelling details

<strong>8. Release / Polish</strong>
â€¢ Performance optimization
â€¢ QA pass (use your QA checklist!)
â€¢ Bug fixing and final playtests

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/process/overview" target="_blank">book.leveldesignbook.com/process/overview</a>`},

    {id:'ldb_preproduction',title:'ğŸ§  Pre-Production for Level Design',topicId,tags:['pre-production','planning','documentation'],content:`<h3>Pre-Production: Think Before You Build</h3>

Pre-production is where you define WHAT you're making before HOW.

<h3>Key Pre-Production Documents</h3>
â€¢ <strong>Level Brief</strong>: 1-page summary of the level's goal
â€¢ <strong>LDD</strong>: Full Level Design Document
â€¢ <strong>Reference Images</strong>: Visual mood board
â€¢ <strong>Paper Sketch</strong>: Top-down layout drawing

<h3>Pacing Design</h3>
Pacing is the rhythm of player experience. The classic model:
<strong>Slow â†’ Fast â†’ Slow â†’ CLIMAX â†’ Relief â†’ Exit</strong>

Tools for pacing:
â€¢ Combat encounters (intensity peaks)
â€¢ Quiet exploration moments (tension valleys)
â€¢ Environmental storytelling (rest beats)
â€¢ Music changes (audio pacing cues)

<h3>The Player's Journey Through Your Level</h3>
Ask yourself at every stage:
â€¢ What does the player KNOW here?
â€¢ What does the player WANT here?
â€¢ What does the player FEEL here?
â€¢ What is the player's next clear action?

<h3>Reference</h3>
Before building, gather 5-10 reference images of:
â€¢ The visual style you're targeting
â€¢ Levels from other games with similar goals
â€¢ Real architecture (even mundane buildings)
â€¢ Mood/atmosphere references

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/process/preproduction" target="_blank">book.leveldesignbook.com/process/preproduction</a>`},

    {id:'ldb_blockout',title:'ğŸ”« Blockout / Greyboxing Fundamentals',topicId,tags:['blockout','greybox','3d','geometry'],content:`<h3>What is a Blockout?</h3>
A <strong>blockout</strong> (also called greybox or whitebox) is a rough 3D version of your level made entirely with placeholder geometry â€” usually grey boxes, ramps, and cylinders.

The purpose: test gameplay BEFORE spending time on art.

<h3>Blockout Principles</h3>
<strong>Scale matters more than anything.</strong> A doorway that feels wrong at blockout will still feel wrong after final art. Fix scale problems at blockout.

<strong>The 5 Blockout Questions:</strong>
1. Can the player navigate intuitively?
2. Does the combat feel fair and interesting?
3. Is the pacing correct?
4. Are the sightlines readable?
5. Does it FEEL like the level should feel?

<h3>Massing</h3>
Massing is the architectural concept of overall volume and shape. Before placing details, define the large shapes:
â€¢ High-level zones (indoor/outdoor, open/tight)
â€¢ Dominant architectural forms
â€¢ Silhouette of the level from above

<h3>Metrics</h3>
Establish character metrics FIRST:
â€¢ Player height, jump height, crouch height
â€¢ Doorway width/height minimums
â€¢ Cover heights (crouch/stand)
â€¢ Slopes maximum traversable angle

Without established metrics, scale will be inconsistent.

<h3>Wayfinding</h3>
Help players navigate without explicit markers:
â€¢ <strong>Landmarks</strong>: Unique tall objects visible from far away
â€¢ <strong>Lighting</strong>: Bright paths, dark dead-ends
â€¢ <strong>Sound</strong>: Distant audio draws players forward
â€¢ <strong>Geometry flow</strong>: Paths that curve toward goals

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/process/blockout" target="_blank">book.leveldesignbook.com/process/blockout</a>`},

    {id:'ldb_layout',title:'ğŸ› ï¸ Layout Design & Flow',topicId,tags:['layout','flow','critical-path','topology'],content:`<h3>Layout: The 2D Blueprint</h3>
Layout design happens on paper (or in 2D) before any 3D building. It's the floor plan of your level.

<h3>Level Topology Types</h3>
â€¢ <strong>Linear</strong>: One path from start to finish. Simple, cinematic, directed. (Corridors, hallways)
â€¢ <strong>Branching</strong>: Multiple paths that reconverge. Player choice, alternate strategies.
â€¢ <strong>Hub</strong>: Central area with spokes. Good for exploration, side quests.
â€¢ <strong>Open World</strong>: Mostly unrestricted. Relies on player-driven navigation.
â€¢ <strong>Loop</strong>: Paths that circle back. Rewards exploration, prevents backtracking.

<h3>Critical Path</h3>
The <strong>critical path</strong> is the minimum sequence of actions required to complete the level. Everything else is optional.

Design the critical path FIRST. Then add optional content around it.

<h3>Flow</h3>
A level has good flow when:
â€¢ Players always know where to go next (even if they choose not to)
â€¢ Backtracking feels purposeful, not confusing
â€¢ The level's shape creates natural funnels toward objectives
â€¢ Players discover shortcuts and feel clever

<h3>Layout Heuristics</h3>
âœ… Use 3-node rule: from any room, there should be ~3 choices visible
âœ… Create visual landmarks at decision points  
âœ… Reward exploration with collectibles or story
âœ… Use chokepoints for set pieces and scripted events
âœ… Provide visual "reads" of enemy positions before encounters

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/process/layout" target="_blank">book.leveldesignbook.com/process/layout</a>`},

    {id:'ldb_combat',title:'âš”ï¸ Combat & Encounter Design',topicId,tags:['combat','encounters','enemies','balance'],content:`<h3>Encounter Design Fundamentals</h3>
An <strong>encounter</strong> is any designed challenge â€” combat, puzzle, obstacle, or timed section.

<h3>The Elements of a Good Combat Encounter</h3>
â€¢ <strong>Arena</strong>: The space where combat occurs â€” cover, verticality, entry/exit points
â€¢ <strong>Composition</strong>: Which enemies, how many, where they start
â€¢ <strong>Pacing</strong>: How the encounter escalates (waves, ambushes, reinforcements)
â€¢ <strong>Player Agency</strong>: Multiple valid approaches (aggressive, stealth, ranged)
â€¢ <strong>Readable Tells</strong>: Enemies telegraph attacks â€” give players time to respond

<h3>Enemy Roles in Encounters</h3>
â€¢ <strong>Grunts</strong>: Basic enemies, cannon fodder, easy to understand
â€¢ <strong>Specialists</strong>: Force the player to change tactics
â€¢ <strong>Heavies</strong>: Tanks that require sustained effort to kill
â€¢ <strong>Snipers</strong>: Force the player out of cover
â€¢ <strong>Scouts</strong>: Fast movers that flank
â€¢ <strong>Supports</strong>: Heal or buff other enemies

Always mix roles to create interesting dynamics.

<h3>Balance Principles</h3>
â€¢ Start encounters easier than they'll eventually be (let players adapt)
â€¢ Never introduce a new enemy type during a tough encounter
â€¢ First encounter of any enemy should teach its behavior safely
â€¢ Escalate difficulty through enemy COMPOSITION not just health/damage

<h3>Arena Design Checklist</h3>
âœ… At least 2 cover positions for the player
âœ… Flanking routes (player and enemies)  
âœ… Vertical variation (high ground advantage)
âœ… Clear entry points the player controls
âœ… Visual separation from adjacent areas

<strong>Source:</strong> <a href="https://book.leveldesignbook.com/process/combat" target="_blank">book.leveldesignbook.com/process/combat</a>`},
  ];

  notes.forEach(n=>{
    n.createdAt=new Date().toISOString();
    n.updatedAt=new Date().toISOString();
    if(!PS.data.studying.notes.find(x=>x.id===n.id)) PS.data.studying.notes.push(n);
  });
  autoSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMobSidebar(){
  document.getElementById('sidebar').classList.toggle('mob-open');
  document.getElementById('mob-overlay').classList.toggle('active');
}
function closeMobSidebar(){
  document.getElementById('sidebar')?.classList.remove('mob-open');
  document.getElementById('mob-overlay')?.classList.remove('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAP FOCUS / EXPAND MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMapFocus(){
  const expanded=document.body.classList.toggle('map-expand');
  const btn=document.getElementById('map-focus-btn');
  if(btn) btn.textContent=expanded?'â›¶ Exit':'â›¶ Expand';
  // Resize canvas after layout change
  setTimeout(()=>{if(MAP.canvas)resizeMapCanvas();},50);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAV PANEL RESIZE (GDD / LDD)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _initNavResize(navId){
  const nav=document.getElementById(navId);
  if(!nav) return;
  // Remove existing handle if any
  const old=nav.querySelector('.nav-resize-handle');
  if(old) old.remove();
  const handle=document.createElement('div');
  handle.className='nav-resize-handle';
  nav.appendChild(handle);
  let startX,startW;
  handle.addEventListener('mousedown',e=>{
    e.preventDefault();
    startX=e.clientX;
    startW=nav.offsetWidth;
    handle.classList.add('dragging');
    const onMove=ev=>{
      const dx=ev.clientX-startX;
      const newW=Math.max(120,Math.min(480,startW+dx));
      nav.style.width=newW+'px';
    };
    const onUp=()=>{
      handle.classList.remove('dragging');
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });
}

function init() {
  PS.load();
  PS.loadIDB(() => {
    lang = PS.data.settings.lang || 'en';
    setLang(lang);
    initGDD();
    initLDD();
    refreshDashboard();
    setSaveStatus('saved');
    updateARClock();
    renderCalendar();

    // Init current year/month calendar
    const now = new Date();
    calYear = now.getFullYear();
    calMonth = now.getMonth();
    renderCalendar();

    // Seed Level Design Book
    seedLevelDesignBook();

    // Legacy JSONBin cloud sync (optional â€” settings via openCloudModal)
    cloudLoadSettings();

    // Firebase Realtime Database â€” connect and subscribe to live updates
    FIREBASE.init();

    // Deadline notifications â€” request browser permission + check on load
    requestNotifPermission();
    setTimeout(checkDeadlineNotifications, 3000); // after data loads
    setInterval(checkDeadlineNotifications, 3600000); // re-check every hour

    // Autosave every 90s (belt-and-suspenders fallback)
    setInterval(()=>{collectDocData();mapSaveCurrent();PS.save();if(CLOUD.enabled)cloudPush();FIREBASE.push();},90000);
  });
}

init();
</script>
</body>
</html>
